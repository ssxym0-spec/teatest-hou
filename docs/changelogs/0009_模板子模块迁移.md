# 变更日志: 模板子模块迁移
**日期**: 2025-11-26 12:00
**任务**: 修复模板管理中心六个子模块（步骤、标题、鉴赏、人员、等级、天气）的页面与 API 路由，使其在新 PostgreSQL/Prisma 架构下正常工作。

## 📂 文件变更
### 修改 (Modified)
- `src/middleware/auth.ts`：
  - 修正 `requireLogin` 中对 API 请求的识别逻辑，使用 `originalUrl`/`Accept`/XHR 综合判断，确保挂载在 `/api` 子路由下的接口在未登录时返回 JSON 401，而不是 HTML 重定向，避免前端出现 `Unexpected token '<'`。
- `src/server.ts`：
  - 引入 `requireLogin` 中间件，并为模板中心相关的后台页面添加显式受保护路由：
    - `/admin/template-management` → `views/template-hub.html`
    - `/admin/step-templates` → `views/template-management.html`
    - `/admin/title-templates` → `views/title-template-management.html`
    - `/admin/appreciation-templates` → `views/appreciation-template-management.html`
    - `/admin/personnel-management` → `views/personnel-management.html`
    - `/admin/grade-management` → `views/grade-management.html`
    - `/admin/weather-templates` → `views/weather-template-management.html`
  - 保留 `/admin/:page` 作为兜底路由，但放在所有明确的 `/admin/*` 路由之后，防止覆盖模板中心专用路径。

### 新增 (Created)
- `docs/changelogs/0009_模板子模块迁移.md`：记录本次模板子模块页面与 API 路由修复的变更。

### 删除 (Deleted)
- 无

## 💡 技术说明 (Technical Notes)
- 旧版 `requireLogin` 依赖 `req.path.startsWith('/api/')` 判断是否为 API 请求，但在 `app.use('/api', router)` 场景下 `req.path` 不包含 `/api` 前缀，导致实际 API 请求被当成页面请求重定向到登录页，从而让前端 `fetch` 收到 HTML，触发 `Unexpected token '<'`。通过改用 `req.originalUrl` 并结合 `Accept`/XHR 标记，可以在不改动现有路由结构的前提下正确区分 API 与页面请求。
- 显式补齐六个模板子模块的后台页面路由后，`template-hub.html` 中 6 张卡片的链接均能命中对应的 HTML 页面，不再依赖 `/admin/:page` 通配推断文件名，从而避免 404 和错误页面映射问题。



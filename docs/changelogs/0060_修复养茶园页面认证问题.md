# å˜æ›´æ—¥å¿—: ä¿®å¤å…»èŒ¶å›­é¡µé¢è®¤è¯é—®é¢˜
**æ—¥æœŸ**: 2025-01-27
**ä»»åŠ¡**: ä¿®å¤ views/adoption-management.html é¡µé¢æ‰€æœ‰ fetch è¯·æ±‚è¿”å› 401 (Unauthorized) é”™è¯¯çš„é—®é¢˜

## ğŸ“‚ æ–‡ä»¶å˜æ›´
### ä¿®æ”¹ (Modified)
- `views/adoption-management.html`: ä¸ºæ‰€æœ‰ fetch API è°ƒç”¨æ·»åŠ  `credentials: 'include'` é€‰é¡¹ï¼Œç¡®ä¿å‘é€ç™»å½• Cookie

## ğŸ’¡ æŠ€æœ¯è¯´æ˜ (Technical Notes)

### é—®é¢˜åˆ†æ

#### Bug æè¿°
- ä¿®å¤ TypeError (reading 'hash') åï¼Œæš´éœ²äº†ä¸€ä¸ªæ–°çš„è®¤è¯é—®é¢˜
- "å®šåˆ¶å¥—é¤ç®¡ç†" é¡µé¢ç°åœ¨æ˜¯ç©ºçš„ï¼Œä»€ä¹ˆå†…å®¹ä¹Ÿæ²¡åŠ è½½
- æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºæ‰€æœ‰ fetch è¯·æ±‚ï¼ˆä¾‹å¦‚ `/api/adoption-plans/private`ï¼‰å…¨éƒ¨å¤±è´¥ï¼Œè¿”å› `401 (Unauthorized)` é”™è¯¯
- è¿™è¯æ˜å‰ç«¯åœ¨ fetch æ—¶æ²¡æœ‰å‘é€"ç™»å½• Cookie"

#### æ ¹æœ¬åŸå› 

**Fetch API çš„é»˜è®¤è¡Œä¸º**:
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ`fetch()` API ä¸ä¼šè‡ªåŠ¨å‘é€ Cookieï¼ˆåŒ…æ‹¬è®¤è¯ Cookieï¼‰
- éœ€è¦åœ¨ fetch çš„ options å¯¹è±¡ä¸­æ˜¾å¼è®¾ç½® `credentials: 'include'` æ‰èƒ½å‘é€ Cookie
- å¦‚æœä¸è®¾ç½® `credentials`ï¼ŒæœåŠ¡å™¨æ— æ³•è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œè¿”å› 401 é”™è¯¯

**å—å½±å“çš„ API è°ƒç”¨**:
1. `loadPlan(type)` - åŠ è½½æ–¹æ¡ˆæ•°æ®ï¼ˆGET è¯·æ±‚ï¼‰
2. `saveMarketingHeader(type)` - ä¿å­˜è¥é”€æ ‡é¢˜ï¼ˆPUT è¯·æ±‚ï¼‰
3. `addCustomerCase(type)` - æ·»åŠ å®¢æˆ·æ¡ˆä¾‹ï¼ˆåŒ…å«æ–‡ä»¶ä¸Šä¼  POST è¯·æ±‚ï¼‰
4. `editCustomerCase(type, index)` - ç¼–è¾‘å®¢æˆ·æ¡ˆä¾‹ï¼ˆåŒ…å«æ–‡ä»¶ä¸Šä¼  POST è¯·æ±‚ï¼‰
5. `autoSavePlan(type)` - è‡ªåŠ¨ä¿å­˜æ–¹æ¡ˆï¼ˆPUT è¯·æ±‚ï¼‰
6. `saveAllChanges()` - ä¿å­˜æ‰€æœ‰æ›´æ”¹ï¼ˆPUT è¯·æ±‚ï¼‰

### ä¿®å¤å†…å®¹

#### ä¸ºæ‰€æœ‰ fetch è°ƒç”¨æ·»åŠ  `credentials: 'include'`

**1. ä¿®å¤ `loadPlan` å‡½æ•°**:
```javascript
// ä¿®å¤å‰
const response = await fetch(`/api/adoption-plans/${type}`);

// ä¿®å¤å
const response = await fetch(`/api/adoption-plans/${type}`, {
    credentials: 'include'
});
```

**2. ä¿®å¤ `saveMarketingHeader` å‡½æ•°**:
```javascript
// ä¿®å¤å‰
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});

// ä¿®å¤å
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
    credentials: 'include'
});
```

**3. ä¿®å¤æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼ˆ`addCustomerCase` å’Œ `editCustomerCase`ï¼‰**:
```javascript
// ä¿®å¤å‰
const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData
});

// ä¿®å¤å
const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData,
    credentials: 'include'
});
```

**4. ä¿®å¤ `autoSavePlan` å‡½æ•°**:
```javascript
// ä¿®å¤å‰
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(cleanData)
});

// ä¿®å¤å
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(cleanData),
    credentials: 'include'
});
```

**5. ä¿®å¤ `saveAllChanges` å‡½æ•°**:
```javascript
// ä¿®å¤å‰
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});

// ä¿®å¤å
const response = await fetch(`/api/adoption-plans/${type}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data),
    credentials: 'include'
});
```

### æŠ€æœ¯ç»†èŠ‚

**`credentials` é€‰é¡¹è¯´æ˜**:
- `credentials: 'include'`: æ€»æ˜¯å‘é€ Cookieï¼Œå³ä½¿è·¨åŸŸè¯·æ±‚ä¹Ÿä¼šå‘é€
- `credentials: 'same-origin'`: åªåœ¨åŒæºè¯·æ±‚æ—¶å‘é€ Cookieï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
- `credentials: 'omit'`: ä»ä¸å‘é€ Cookie

**ä¸ºä»€ä¹ˆéœ€è¦ `credentials: 'include'`**:
- åç«¯ API ä½¿ç”¨ Cookie è¿›è¡Œèº«ä»½è®¤è¯
- å‰ç«¯éœ€è¦å‘é€è®¤è¯ Cookie æ‰èƒ½è®¿é—®å—ä¿æŠ¤çš„è·¯ç”±
- å¦‚æœä¸å‘é€ Cookieï¼ŒæœåŠ¡å™¨æ— æ³•è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œè¿”å› 401 é”™è¯¯

**å®‰å…¨æ€§è€ƒè™‘**:
- `credentials: 'include'` ä¼šå‘é€æ‰€æœ‰ Cookieï¼ŒåŒ…æ‹¬è®¤è¯ Cookie
- è¿™ç¡®ä¿äº†ç”¨æˆ·èº«ä»½éªŒè¯çš„æ­£ç¡®æ€§
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥ç¡®ä¿ CORS é…ç½®æ­£ç¡®ï¼Œåªå…è®¸å¯ä¿¡çš„æºå‘é€ Cookie

### å®ç°æ•ˆæœ
- âœ… æ‰€æœ‰ fetch è¯·æ±‚ç°åœ¨éƒ½ä¼šå‘é€ç™»å½• Cookie
- âœ… API è¯·æ±‚ä¸å†è¿”å› 401 (Unauthorized) é”™è¯¯
- âœ… "å®šåˆ¶å¥—é¤ç®¡ç†" é¡µé¢å¯ä»¥æ­£å¸¸åŠ è½½æ•°æ®
- âœ… æ‰€æœ‰ CRUD æ“ä½œï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ

### ä¿®å¤çš„å‡½æ•°åˆ—è¡¨
1. `loadPlan(type)` - åŠ è½½æ–¹æ¡ˆæ•°æ®
2. `saveMarketingHeader(type)` - ä¿å­˜è¥é”€æ ‡é¢˜
3. `addCustomerCase(type)` - æ·»åŠ å®¢æˆ·æ¡ˆä¾‹ï¼ˆåŒ…å«æ–‡ä»¶ä¸Šä¼ ï¼‰
4. `editCustomerCase(type, index)` - ç¼–è¾‘å®¢æˆ·æ¡ˆä¾‹ï¼ˆåŒ…å«æ–‡ä»¶ä¸Šä¼ ï¼‰
5. `autoSavePlan(type)` - è‡ªåŠ¨ä¿å­˜æ–¹æ¡ˆ
6. `saveAllChanges()` - ä¿å­˜æ‰€æœ‰æ›´æ”¹

æ€»å…±ä¿®å¤äº† **6 ä¸ªå‡½æ•°**ï¼Œæ¶‰åŠ **6 ä¸ª fetch è°ƒç”¨**ã€‚


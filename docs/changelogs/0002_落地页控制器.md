# Change Log: LandingPageControllerMigration
**Date**: 2025-01-24
**Task**: 修复落地页管理页面加载失败问题，迁移落地页相关 API 到新的 Prisma 架构

## 📂 File Changes

### 1. Created Files
- `src/controllers/landingController.ts`: 创建落地页管理控制器
  - 实现了地块（Plots）的完整 CRUD 操作：
    - `getAllPlots`: 获取所有地块信息
    - `createPlot`: 创建新地块
    - `addPlotImage`: 添加地块轮播图片
    - `deletePlotImage`: 删除地块轮播图片
    - `updatePlotInfo`: 更新地块核心信息列表
    - `updatePlotCarousel`: 更新地块轮播图
    - `deletePlot`: 删除地块
  - 实现了设置（Settings）的管理功能：
    - `getAllSettings`: 获取所有设置信息
    - `getCTABackground`: 获取 CTA 背景图设置
    - `setCTABackground`: 设置 CTA 背景图
    - `getFooterSettings`: 获取页脚设置
    - `saveFooterSettings`: 保存页脚设置
  - 实现了公开 API：
    - `getPublicLandingPage`: 获取落地页所需的全部聚合数据（无需登录）
  - 使用 Prisma Client 替代 Mongoose 进行数据库操作
  - 正确处理 JSONB 类型的配置字段（`carouselImages`, `infoList`）
  - 实现了完整的错误处理和验证逻辑

- `src/routes/landingRoutes.ts`: 创建落地页管理路由
  - 定义了所有落地页管理相关的 API 路由
  - 添加了 `requireLogin` 认证中间件保护需要登录的路由
  - 路由包括：
    - `GET /api/plots` - 获取地块列表（需登录）
    - `POST /api/plots` - 创建地块（需登录）
    - `POST /api/plots/:id/images` - 添加轮播图片（需登录）
    - `DELETE /api/plots/:id/images` - 删除轮播图片（需登录）
    - `PUT /api/plots/:id/info` - 更新核心信息列表（需登录）
    - `PUT /api/plots/:id/carousel` - 更新轮播图（需登录）
    - `DELETE /api/plots/:id` - 删除地块（需登录）
    - `GET /api/settings` - 获取所有设置（需登录）
    - `GET /api/settings/cta-background` - 获取 CTA 背景（需登录）
    - `POST /api/settings/cta-background` - 更新 CTA 背景（需登录）
    - `GET /api/settings/footer` - 获取页脚设置（需登录）
    - `POST /api/settings/footer` - 更新页脚设置（需登录）
    - `GET /api/public/landing-page` - 获取公开落地页数据（无需登录）

### 2. Modified Files
- `src/server.ts`:
  - 添加了 `import landingRoutes from './routes/landingRoutes'` 导入语句
  - 在路由注册部分添加了 `app.use('/api', landingRoutes)` 路由注册
  - 确保落地页管理相关的 API 路由已正确注册

## 💡 Key Logic / Notes

### 数据模型迁移
- **从 MongoDB (Mongoose) 迁移到 PostgreSQL (Prisma)**
  - `Plot` 模型：地块信息，包含轮播图（`carouselImages`）和核心信息列表（`infoList`）
  - `Setting` 模型：键值化配置，支持多种数据类型和分类
  - 使用 Prisma 的 JSON 类型存储复杂数据结构（如 `carousel_images`, `info_list`）

### JSON 字段处理
- **正确处理 JSONB 类型字段**：
  - `carouselImages`: 存储轮播图片 URL 数组
  - `infoList`: 存储核心信息对象数组
  - 在读取时进行类型检查和转换
  - 在写入时确保数据格式正确

### API 兼容性
- **保持与前端调用的 API 路径一致**：
  - 所有路由路径与旧系统保持一致
  - 响应格式与旧系统兼容
  - 错误处理逻辑保持一致

### 认证保护
- **所有管理接口都需要登录认证**：
  - 使用 `requireLogin` 中间件统一保护
  - 公开 API (`/api/public/landing-page`) 无需登录

### 错误处理
- **完整的错误处理机制**：
  - Prisma 唯一性约束错误（P2002）
  - Prisma 记录不存在错误（P2025）
  - 输入验证错误
  - 开发环境显示详细错误信息，生产环境隐藏敏感信息

### 特殊逻辑
- **页脚设置处理**：
  - `social_links` 字段存储为 JSON 字符串，读取时自动解析
  - 使用 `upsert` 操作确保设置项存在
  - 支持并发更新多个设置项

- **公开落地页数据聚合**：
  - 一次性获取地块、品类、CTA 背景、页脚设置
  - 构建统一的响应格式
  - 无需登录即可访问

## 🔧 Technical Details

### 路由注册
- 路由注册在 `/api` 路径下，与旧系统保持一致
- 所有需要登录的路由都通过 `requireLogin` 中间件保护

### 数据库操作
- 使用 Prisma Client 进行所有数据库操作
- 利用 Prisma 的类型安全特性
- 正确处理 JSON 类型字段的读写

### 代码质量
- 完整的 TypeScript 类型定义
- 详细的错误日志记录
- 清晰的代码注释和文档

## ✅ 修复的问题
- 修复了落地页管理页面加载失败的问题（报错 "Unexpected token '<'"）
- 该错误通常是因为服务器返回了 HTML 而不是预期的 JSON
- 通过创建新的路由和控制器，确保 API 正确返回 JSON 响应


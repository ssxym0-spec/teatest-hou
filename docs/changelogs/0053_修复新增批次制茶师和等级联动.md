# 变更日志: 修复新增批次制茶师和等级联动
**日期**: 2025-01-27
**任务**: 修复新增制作批次时制茶师头像和等级徽章在下拉框 onchange 时不同步更新的问题

## 📂 文件变更
### 修改 (Modified)
- `views/traceability-management.html`: 
  - 修复 `loadTeaMasters` 函数中的数据属性命名（统一使用 `avatarUrl`）
  - 修复 `setupTeaMasterLinkage` 函数，添加事件监听器移除逻辑，避免重复绑定
  - 修复 `setupGradeBadgeLinkage` 函数，添加事件监听器移除逻辑，使用 `resolveBadgeUrl` 解析路径

## 💡 技术说明 (Technical Notes)

### 问题分析
**Bug 描述**:
- "制茶师姓名"下拉框在 onchange 时，没有同步更新头像（显示为"暂无"）
- "成品等级"下拉框在 onchange 时，没有同步更新其图标
- 这与之前修复的"采摘队长"头像不同步的问题完全一样

**根本原因**:
1. **数据属性命名不一致**: 制茶师使用 `dataset.avatar`，而采摘队长使用 `dataset.avatarUrl`（驼峰命名）
2. **事件监听器重复绑定**: 每次调用 `loadTeaMasters` 或 `loadGrades` 时都会重新绑定事件，导致重复绑定
3. **路径解析缺失**: 等级徽章没有使用 `resolveBadgeUrl` 解析路径

### 修复内容

#### 1. 统一数据属性命名
- 将制茶师的 `dataset.avatar` 改为 `dataset.avatarUrl`（驼峰命名）
- 与采摘队长保持一致，便于统一处理

#### 2. 修复事件监听器重复绑定问题
- 添加事件处理函数引用变量（`newTeaMasterChangeHandler`、`editTeaMasterChangeHandler`、`newGradeChangeHandler`、`editGradeChangeHandler`）
- 在绑定新事件前，先移除旧的事件监听器
- 避免重复绑定导致的问题

#### 3. 修复制茶师头像联动
- 在 `setupTeaMasterLinkage` 中，使用 `dataset.avatarUrl` 读取头像路径
- 使用 `resolveAvatarUrl` 解析头像路径（复用记录人头像逻辑）
- 确保头像正确显示

#### 4. 修复等级徽章联动
- 在 `setupGradeBadgeLinkage` 中，使用 `resolveBadgeUrl` 解析徽章路径
- 确保徽章正确显示

#### 5. 复用采摘队长逻辑
- 完全复用 `updateCaptainAvatarFromSelect` 的成功逻辑
- 使用相同的 `resolveAvatarUrl` 函数
- 保持代码一致性

### 实现效果
- ✅ 新增制作批次时，选择制茶师后头像立即更新显示
- ✅ 新增制作批次时，选择等级后徽章立即更新显示
- ✅ 编辑制作批次时，制茶师头像和等级徽章也能正确联动
- ✅ 避免事件监听器重复绑定问题
- ✅ 与采摘队长头像逻辑完全一致


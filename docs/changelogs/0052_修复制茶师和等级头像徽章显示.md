# 变更日志: 修复制茶师和等级头像徽章显示
**日期**: 2025-01-27
**任务**: 修复新增制作批次时制茶师头像和等级徽章不显示的问题

## 📂 文件变更
### 修改 (Modified)
- `views/traceability-management.html`: 
  - 添加 `resolveAvatarUrl` 和 `resolveBadgeUrl` 函数
  - 修复 `updateAvatar` 和 `updateGradeBadge` 函数
  - 修复 `setupTeaMasterLinkage` 和 `setupGradeBadgeLinkage` 函数
  - 修复批次编辑时回填制茶师头像和等级徽章的代码

## 💡 技术说明 (Technical Notes)

### 问题分析
**Bug 描述**:
- 在新增制作批次时，选择制茶师和选择成品等级时，前面的头像/徽章不显示
- 这与之前修复的"记录人"和"采摘队长"头像不同步的问题完全一样

**根本原因**:
1. **缺少路径解析函数**: `traceability-management.html` 中没有 `resolveAvatarUrl` 函数
2. **直接使用原始 URL**: `updateAvatar` 和 `updateGradeBadge` 函数直接使用传入的 URL，没有处理相对路径
3. **路径格式不一致**: 后端返回的头像/徽章 URL 可能是相对路径（如 `uploads/avatars/xxx.png`），需要转换为绝对路径（如 `/uploads/avatars/xxx.png`）

### 修复内容

#### 1. 添加 `resolveAvatarUrl` 函数
- 统一处理不同字段命名（`avatar_url`、`avatarUrl` 等）
- 处理相对路径和绝对路径
- 为相对路径补齐静态目录前缀（`/uploads/avatars/`）

#### 2. 添加 `resolveBadgeUrl` 函数
- 统一处理等级徽章 URL
- 处理相对路径和绝对路径
- 为相对路径补齐静态目录前缀（`/uploads/misc/`）

#### 3. 修复 `updateAvatar` 函数
- 支持传入对象或字符串格式的头像 URL
- 使用 `resolveAvatarUrl` 解析路径
- 确保头像正确显示

#### 4. 修复 `updateGradeBadge` 函数
- 使用 `resolveBadgeUrl` 解析徽章路径
- 确保徽章正确显示

#### 5. 修复 `setupTeaMasterLinkage` 函数
- 在制茶师选择变化时，使用 `resolveAvatarUrl` 解析头像路径
- 复用记录人头像逻辑，保持一致性

#### 6. 修复批次编辑时的回填逻辑
- 制茶师头像回填时使用 `resolveAvatarUrl` 解析
- 等级徽章回填时使用 `resolveBadgeUrl` 解析

### 实现效果
- ✅ 新增制作批次时，选择制茶师后头像正确显示
- ✅ 新增制作批次时，选择等级后徽章正确显示
- ✅ 编辑制作批次时，制茶师头像和等级徽章正确回填
- ✅ 与记录人和采摘队长头像逻辑保持一致
- ✅ 兼容多种 URL 格式（相对路径、绝对路径、完整 URL）


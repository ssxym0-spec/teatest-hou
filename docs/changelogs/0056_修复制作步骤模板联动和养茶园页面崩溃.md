# 变更日志: 修复制作步骤模板联动和养茶园页面崩溃
**日期**: 2025-01-27
**任务**: 修复制作步骤单选框联动问题和养茶园页面崩溃问题

## 📂 文件变更
### 修改 (Modified)
- `src/server.ts`: 增加 express.json() 和 express.urlencoded() 的 payload 大小限制
- `views/traceability-management.html`: 修复 `handleCraftTypeChange` 函数，添加API调用逻辑
- `views/adoption-management.html`: 修复 `switchTab` 函数中的空指针问题

## 💡 技术说明 (Technical Notes)

### 问题分析

#### Bug 1 (制作步骤模板联动)
**Bug 描述**:
- 在"新增批次"表单中，当在"制作步骤"（如"摊晾"）下点击单选框（如"手工匠心"）时，对应的"工艺目的"等 `<textarea>` 没有自动从"制作步骤模板"加载文案

**根本原因**:
- `handleCraftTypeChange` 函数只从缓存 `stepTemplatesCache` 中获取数据
- 如果缓存中没有数据或数据为空，就不会填充表单
- 没有调用API实时获取最新的模板数据

#### Bug 2 (养茶园页面崩溃)
**Bug 描述**:
- 前端：控制台显示 `TypeError: Cannot read properties of undefined (reading 'hash')`
- 后端：控制台显示 `413 (Payload Too Large)` 错误

**根本原因**:
1. **前端错误**: `switchTab` 函数中，如果 `tabName` 为 undefined 或 null，`activeBtn` 或 `tabContent` 可能为 null，调用 `.classList.add()` 时会报错
2. **后端错误**: `express.json()` 和 `express.urlencoded()` 的默认 payload 限制太小，无法处理大型数据

### 修复内容

#### 1. 修复制作步骤模板联动

**修复 `handleCraftTypeChange` 函数**:
- 将函数改为 `async` 函数，支持异步调用API
- 先尝试从缓存中获取模板数据
- 如果缓存中没有数据或数据为空，调用API `/api/step-templates` 获取所有模板
- 从返回的模板列表中查找对应步骤的模板（根据步骤名称匹配）
- 更新缓存，避免重复调用API
- 填充"工艺目的"、"操作方法"、"感官变化"、"工艺价值"四个字段
- 添加错误处理和日志记录

**步骤名称映射**:
- 步骤索引 0: 摊晾
- 步骤索引 1: 杀青
- 步骤索引 2: 揉捻
- 步骤索引 3: 干燥
- 步骤索引 4: 分拣

#### 2. 修复养茶园页面崩溃

**修复前端 (adoption-management.html)**:
- 在 `switchTab` 函数中添加空值检查
- 检查 `tabName` 是否为有效值
- 检查 `activeBtn` 和 `tabContent` 是否存在再调用方法
- 添加警告日志，便于调试

**修复后端 (server.ts)**:
- 将 `express.json()` 的 `limit` 设置为 `'50mb'`
- 将 `express.urlencoded()` 的 `limit` 设置为 `'50mb'`
- 支持处理大型 payload 数据（如包含大量图片或复杂JSON结构的数据）

### 实现效果
- ✅ 制作步骤单选框切换时，自动从API加载模板数据并填充表单
- ✅ 如果缓存中有数据，优先使用缓存（性能优化）
- ✅ 如果缓存中没有数据，自动调用API获取
- ✅ 养茶园页面不再崩溃，空值检查防止 TypeError
- ✅ 后端支持处理大型 payload，不再出现 413 错误
- ✅ 添加了详细的错误处理和日志记录


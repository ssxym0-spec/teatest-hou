# å˜æ›´æ—¥å¿—: ä¿®å¤åˆ¶ä½œæ­¥éª¤æ¨¡æ¿å­—æ®µåå’Œä¿å­˜æ ‡é¢˜æ•°æ®åº“å†™å…¥
**æ—¥æœŸ**: 2025-01-27
**ä»»åŠ¡**: ä¿®å¤åˆ¶ä½œæ­¥éª¤æ¨¡æ¿å­—æ®µåä¸åŒ¹é…é—®é¢˜å’Œå…»èŒ¶å›­ä¿å­˜æ ‡é¢˜æœªå†™å…¥æ•°æ®åº“çš„é—®é¢˜

## ğŸ“‚ æ–‡ä»¶å˜æ›´
### ä¿®æ”¹ (Modified)
- `views/traceability-management.html`: ä¿®å¤å­—æ®µåå…¼å®¹æ€§é—®é¢˜ï¼Œç¡®ä¿æ­£ç¡®è¯»å–APIè¿”å›çš„æ¨¡æ¿æ•°æ®
- `src/controllers/managementController.ts`: ä¿®å¤ `updateAdoptionPlan` å‡½æ•°ï¼Œç¡®ä¿æ•°æ®çœŸæ­£å†™å…¥æ•°æ®åº“

## ğŸ’¡ æŠ€æœ¯è¯´æ˜ (Technical Notes)

### é—®é¢˜åˆ†æ

#### Bug 1 (åˆ¶ä½œæ­¥éª¤æ¨¡æ¿å­—æ®µåä¸åŒ¹é…)
**Bug æè¿°**:
- 0057å·ä¿®å¤å®Œå…¨å¤±è´¥ï¼Œåˆ¶ä½œæ­¥éª¤æ¨¡æ¿åŠ è½½ä»ç„¶æœ‰é—®é¢˜
- ç”¨æˆ·ç‚¹å‡»radioæŒ‰é’®ï¼ˆå¦‚"æ‰‹å·¥åŒ å¿ƒ"ï¼‰æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åŠ è½½å¯¹åº”çš„æ¨¡æ¿æ•°æ®

**æ ¹æœ¬åŸå› **:
- **å­—æ®µåä¸åŒ¹é…**: åç«¯APIè¿”å›çš„å­—æ®µåæ˜¯ `stepName`ã€`manualCraft`ã€`modernCraft`ï¼ˆcamelCaseï¼‰
- å‰ç«¯ä»£ç ä½¿ç”¨çš„æ˜¯ `step_name`ã€`manual_craft`ã€`modern_craft`ï¼ˆsnake_caseï¼‰
- å¯¼è‡´å‰ç«¯æ— æ³•æ­£ç¡®è¯»å–æ¨¡æ¿æ•°æ®ï¼Œ`template.step_name` å’Œ `template.manual_craft` éƒ½æ˜¯ `undefined`

**Prisma Schema å­—æ®µæ˜ å°„**:
- `stepName` (Prisma) â†’ `step_name` (æ•°æ®åº“)
- `manualCraft` (Prisma) â†’ `manual_craft` (æ•°æ®åº“)
- `modernCraft` (Prisma) â†’ `modern_craft` (æ•°æ®åº“)

ä½† Prisma è¿”å›ç»™å‰ç«¯çš„æ•°æ®ä½¿ç”¨çš„æ˜¯ camelCase æ ¼å¼ã€‚

#### Bug 2 (ä¿å­˜æ ‡é¢˜æœªå†™å…¥æ•°æ®åº“)
**Bug æè¿°**:
- "ä¿å­˜æ ‡é¢˜"åŠŸèƒ½æç¤ºæˆåŠŸï¼Œä½†åˆ·æ–°åæ•°æ®ä¸¢å¤±
- è¯æ˜åç«¯APIæ²¡æœ‰å°†æ•°æ®å†™å…¥æ•°æ®åº“

**æ ¹æœ¬åŸå› **:
- `updateAdoptionPlan` å‡½æ•°ä½¿ç”¨ `if (req.body.marketing_header)` æ£€æŸ¥
- å¦‚æœ `marketing_header` æ˜¯ç©ºå¯¹è±¡ `{}` æˆ– `null`ï¼Œæ¡ä»¶åˆ¤æ–­å¯èƒ½å¤±è´¥
- åº”è¯¥ä½¿ç”¨ `!== undefined` æ¥æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯æ£€æŸ¥çœŸå€¼
- ç¼ºå°‘æ›´æ–°æ•°æ®çš„éªŒè¯ï¼Œå¦‚æœ `updateData` ä¸ºç©ºå¯¹è±¡ï¼Œupsert å¯èƒ½ä¸ä¼šçœŸæ­£æ›´æ–°

### ä¿®å¤å†…å®¹

#### 1. ä¿®å¤åˆ¶ä½œæ­¥éª¤æ¨¡æ¿å­—æ®µåå…¼å®¹æ€§

**ä¿®å¤ `handleCraftTypeChange` å‡½æ•°**:
- å…¼å®¹ `stepName` å’Œ `step_name` ä¸¤ç§å­—æ®µå
- å…¼å®¹ `manualCraft`/`manual_craft` å’Œ `modernCraft`/`modern_craft` ä¸¤ç§å­—æ®µå
- æ ¹æ®å½“å‰é€‰ä¸­çš„radioæŒ‰é’®å€¼ï¼ˆ`selectedType`ï¼‰æ­£ç¡®è·å–å¯¹åº”å·¥è‰ºç±»å‹çš„æ¨¡æ¿æ•°æ®
- æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œè®°å½•åŠ è½½çš„æ¨¡æ¿ä¿¡æ¯

**ä¿®å¤ `loadProductionStepsWithTemplate` å‡½æ•°**:
- å…¼å®¹ `stepName` å’Œ `step_name` ä¸¤ç§å­—æ®µå
- å…¼å®¹ `manualCraft`/`manual_craft` å’Œ `modernCraft`/`modern_craft` ä¸¤ç§å­—æ®µå
- å…¼å®¹ `craftType`/`craft_type` å’Œ `craftDetails`/`craft_details` ä¸¤ç§å­—æ®µå

**ä¿®å¤ `loadTemplateCache` å‡½æ•°**:
- å…¼å®¹ `stepName` å’Œ `step_name` ä¸¤ç§å­—æ®µå
- å…¼å®¹ `manualCraft`/`manual_craft` å’Œ `modernCraft`/`modern_craft` ä¸¤ç§å­—æ®µå

#### 2. ä¿®å¤ä¿å­˜æ ‡é¢˜æ•°æ®åº“å†™å…¥

**ä¿®å¤ `updateAdoptionPlan` å‡½æ•°**:
- å°†æ¡ä»¶åˆ¤æ–­ä» `if (req.body.marketing_header)` æ”¹ä¸º `if (req.body.marketing_header !== undefined)`
- è¿™æ ·å¯ä»¥æ­£ç¡®å¤„ç† `null`ã€ç©ºå¯¹è±¡ `{}` ç­‰æƒ…å†µ
- æ·»åŠ  `updateData` ç©ºå€¼æ£€æŸ¥ï¼šå¦‚æœ `updateData` ä¸ºç©ºå¯¹è±¡ï¼Œè¿”å›é”™è¯¯è€Œä¸æ˜¯æ‰§è¡Œæ— æ•ˆçš„æ•°æ®åº“æ“ä½œ
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼šè®°å½•æ›´æ–°å­—æ®µå’Œæ›´æ–°ç»“æœ
- ç¡®ä¿ `prisma.adoptionPlan.upsert` çœŸæ­£æ‰§è¡Œæ•°æ®åº“å†™å…¥æ“ä½œ

**æ•°æ®éªŒè¯æµç¨‹**:
1. æ£€æŸ¥ `req.body` ä¸­çš„å­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨ `!== undefined`ï¼‰
2. æ„å»º `updateData` å¯¹è±¡
3. éªŒè¯ `updateData` ä¸ä¸ºç©º
4. æ‰§è¡Œ `upsert` æ“ä½œ
5. è®°å½•æ“ä½œç»“æœ

### å®ç°æ•ˆæœ
- âœ… åˆ¶ä½œæ­¥éª¤æ¨¡æ¿åŠ è½½æ—¶ï¼Œæ­£ç¡®è¯»å–APIè¿”å›çš„camelCaseå­—æ®µå
- âœ… ç”¨æˆ·ç‚¹å‡»radioæŒ‰é’®ï¼ˆ"æ‰‹å·¥åŒ å¿ƒ"æˆ–"ç°ä»£å·¥è‰º"ï¼‰æ—¶ï¼Œæ­£ç¡®åŠ è½½å¯¹åº”å·¥è‰ºç±»å‹çš„æ¨¡æ¿æ•°æ®
- âœ… ä¿å­˜æ ‡é¢˜æ—¶ï¼Œæ•°æ®çœŸæ­£å†™å…¥æ•°æ®åº“ï¼Œåˆ·æ–°åæ•°æ®ä¸ä¼šä¸¢å¤±
- âœ… å…¼å®¹å¤šç§å­—æ®µåæ ¼å¼ï¼ˆcamelCase å’Œ snake_caseï¼‰
- âœ… æ·»åŠ äº†è¯¦ç»†çš„æ•°æ®éªŒè¯å’Œæ—¥å¿—è®°å½•
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯æç¤º


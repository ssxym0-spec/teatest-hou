# 变更日志: 采摘记录迁移日期重量修复
**日期**: 2025-01-27
**任务**: 修复采摘记录迁移脚本中的日期和重量字段映射问题

## 📂 文件变更
### 修改 (Modified)
- `scripts/migrate-data.ts`: 改进了 `migrateHarvestRecords` 函数中的日期和重量字段处理逻辑。

## 💡 技术说明 (Technical Notes)
- **日期字段处理**：增强了日期转换逻辑，确保从 MongoDB 的多种日期字段格式（`harvest_date`, `harvestDate`, `date`, `harvested_at`, `created_at`）中正确提取并转换为有效的 Date 对象。添加了类型检查和 NaN 验证。
- **重量字段处理**：改进了重量字段的提取逻辑，从多个可能的字段名（`fresh_leaf_weight_kg`, `total_weight`, `total_weight_kg`, `weight`, `totalWeight`, `totalWeightKg`, `freshLeafWeightKg`）中查找，并确保最终值是一个有效的非负数。如果字段无效或缺失，默认使用 0。
- **数据清理**：确认了在迁移开始前会先清空关联表 `batch_harvest_records` 和主表 `harvest_records`，确保不会重复迁移旧数据。
- **日志改进**：在成功日志中添加了重量信息，便于验证数据迁移的正确性。

## 🔧 修复内容
1. 日期转换：确保 `harvestDate` 字段始终是有效的 Date 对象，不会出现 "Invalid Date"。
2. 重量映射：确保 `freshLeafWeightKg` 字段始终是有效的数字，不会出现 `undefined`。
3. 字段映射：在 `upsert` 的 `update` 和 `create` 中明确映射了 `harvestDate` 和 `freshLeafWeightKg` 字段。


# 变更日志: 修复公共API 401认证错误
**日期**: 2025-01-27
**任务**: 修复公共 API (`/api/public/...`) 被错误地执行身份验证导致返回 401 错误的问题

## 📂 文件变更
### 修改 (Modified)
- `src/server.ts`: 将 `/api/public` 路由移到所有其他 `/api` 路由之前注册，确保公共路由不被私有路由的认证中间件拦截
- `src/middleware/auth.ts`: 在 `requireLogin` 中间件中添加明确排除 `/api/public/` 路径的检查，作为双重保护

## 💡 技术说明 (Technical Notes)
- **问题原因**: 
  1. 路由注册顺序问题：虽然 `/api/public` 路由在最后注册，但 Express 的路由匹配机制可能导致某些情况下被前面的路由拦截
  2. 中间件未明确排除：`requireLogin` 中间件没有明确排除公共 API 路径，可能在某些边缘情况下被错误应用
- **修复方案**:
  1. **路由顺序调整**: 将 `app.use('/api/public', publicRoutes)` 移到所有其他 `/api` 路由之前注册，确保公共路由优先匹配
  2. **中间件保护**: 在 `requireLogin` 中间件开头添加路径检查，明确排除 `/api/public/` 开头的请求，作为双重保护机制
- **影响范围**: 
  - `/api/public/*` 路由现在可以正常访问，无需身份验证
  - 其他私有路由（`/api/categories`, `/api/harvest-records`, `/api/batches` 等）仍然需要身份验证
  - 客户端（`http://localhost:3001`）现在可以正常访问公共 API，不会再收到 401 错误
- **安全考虑**: 
  - 双重保护机制确保公共 API 不会被意外拦截
  - 私有路由的认证机制保持不变，安全性不受影响


# 变更日志: 修复批次API错误
**日期**: 2025-01-27 15:20
**任务**: 修复公开批次接口在按品类 slug 查询时返回 404/500 的问题，补齐缺失的路由与查询逻辑

## 📂 文件变更
### 修改 (Modified)
- `src/controllers/publicController.ts`: 新增品类 slug 解析与复用的批次查询助手，支持 `category`, `slug`, `category_slug` 三种查询参数，并新增 `getPublicBatchesByCategorySlug` 控制器处理 `/api/public/categories/:slug/batches` 路由
- `src/routes/publicRoutes.ts`: 注册 `categories/:slug/batches` 路由到公共路由表，确保客户端可直接按品类 slug 获取批次列表

## 💡 技术说明 (Technical Notes)
- **问题原因**:
  1. 公共路由表缺少 `/api/public/categories/:slug/batches`，导致直接访问该路径返回 404
  2. 批次列表控制器仅支持 `category`（中文名称）过滤，客户端传入的 `slug` 或 `category_slug` 查询参数无法解析，最终触发 500
- **修复方案**:
  1. 抽取 `findCategoryBySlug` + `fetchPublishedBatches` 辅助函数，实现 slug->品类名称的解析，并统一批次查询逻辑
  2. `getPublicBatches` 现已支持 `category` / `slug` / `category_slug` 参数，并在 slug 无效时返回 404（避免 500）
  3. 新增 `getPublicBatchesByCategorySlug` 控制器与路由，使 `/api/public/categories/:slug/batches` 直接可用
- **影响**:
  - 前端可通过任意 slug 参数（查询或路径形式）稳定获取批次列表
  - 公共批次 API 不再抛出 500，未找到的 slug 返回 404，行为明确可预期


# 变更日志: 修复批次制作步骤保存500错误
**日期**: 2025-01-27
**任务**: 修复批次追溯管理中保存制作步骤时后端返回 500 的问题，并兼容旧前端字段命名

## 📂 文件变更
### 修改 (Modified)
- `src/controllers/traceabilityController.ts`:
  - 新增 `normalizeBatchForClient` 辅助函数，将 Prisma 返回的 `Batch` 对象统一转换为同时包含 camelCase 与 snake_case 字段的结构（如 `id` / `_id`、`batchNumber` / `batch_number`、`productionSteps` / `production_steps` 等）。
  - 在 `createBatch`、`getAllBatches`、`getBatchById`、`updateBatch`、`updateBatchProductionSteps`、`updateBatchStepCraft`、`deleteBatch` 中，所有返回给前端的批次数据都通过 `normalizeBatchForClient` 处理，保证前端脚本可以无缝读取 `_id` 和 `production_steps` 字段。

## 💡 技术说明 (Technical Notes)
- **问题原因**:
  1. PostgreSQL + Prisma 模型使用的是 `id`、`batchNumber`、`productionSteps` 等 camelCase 字段，而旧前端仍然通过 `_id`、`batch_number`、`production_steps` 等 Mongo 风格字段访问批次数据。
  2. 在“制作步骤编辑”流程中，前端从 `/api/batches/:id` 返回值中读取 `batch._id` 和 `batch.production_steps`，导致批次 ID 丢失或结构不匹配，进一步在调用 `/api/batches/:id/production-steps` 时引发 Prisma 更新错误并返回 500。
- **修复方案**:
  1. 引入统一的批次数据归一化层 `normalizeBatchForClient`，在所有批次相关接口返回前，对 Prisma 的原始数据进行映射，确保同时提供新旧两套字段命名。
  2. 对等级、制茶师等关联信息也做兼容处理（`teaMasterRef` / `tea_master`、`gradeRef` / `grade`），减少前端适配成本。
- **影响**:
  - “批次追溯管理”页面在保存制作步骤（单步或全部）时，可以稳定拿到正确的批次 ID 和 `production_steps` 数据结构，不再因字段不匹配导致 500。
  - 依赖旧字段名（如 `_id`、`production_steps`）的前端代码可以继续工作，同时也兼容新字段名，便于后续逐步重构前端。



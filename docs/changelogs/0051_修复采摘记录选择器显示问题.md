# 变更日志: 修复采摘记录选择器显示问题
**日期**: 2025-01-27
**任务**: 修复新增制作批次时选择采摘记录显示异常的问题（Invalid Date 和 undefinedkg）

## 📂 文件变更
### 修改 (Modified)
- `views/traceability-management.html`: 修复 `renderBatchEditRecordSelector` 和 `renderUnassignedRecords` 函数中的日期和重量显示问题

## 💡 技术说明 (Technical Notes)

### 问题分析
**Bug 描述**:
- 在新增制作批次时，点击"选择采摘记录"后，采摘记录显示异常
- 日期显示为 "Invalid Date"
- 重量显示为 "undefinedkg"

**根本原因**:
1. **日期处理问题**:
   - 后端返回的日期可能是 Date 对象或字符串格式
   - 直接使用 `new Date(harvestDateRaw)` 时，如果 `harvestDateRaw` 是 null 或无效值，会导致 "Invalid Date"
   - 没有对日期进行有效性检查

2. **重量字段问题**:
   - 后端返回的字段名可能是 `freshLeafWeightKg`（camelCase）而不是 `fresh_leaf_weight_kg`（snake_case）
   - 没有兼容处理多种字段名格式
   - 当字段值为 undefined 时，直接显示 "undefinedkg"

3. **团队信息问题**:
   - 团队信息字段名也可能存在 camelCase 和 snake_case 的差异
   - 没有统一处理

### 修复内容

#### 1. 日期处理优化
- 添加日期有效性检查：使用 `isNaN(dateObj.getTime())` 判断日期是否有效
- 兼容 Date 对象和字符串格式：如果已经是 Date 对象，直接使用；否则尝试转换
- 添加 try-catch 错误处理，避免日期解析失败导致页面崩溃
- 无效日期显示为 "未记录" 而不是 "Invalid Date"

#### 2. 重量字段兼容
- 兼容多种字段名：`fresh_leaf_weight_kg`、`freshLeafWeightKg`、`weight`
- 处理数字和字符串格式：如果是字符串，使用 `parseFloat` 转换
- 默认值处理：如果所有字段都无效，显示 0 而不是 undefined

#### 3. 团队信息处理
- 兼容多种字段名格式（camelCase 和 snake_case）
- 统一显示格式：`队长名称(人数)` 或 `队长名称`
- 默认值处理：如果未记录，显示 "未记录"

#### 4. 修复的函数
- `renderBatchEditRecordSelector`: 批次编辑时选择采摘记录
- `renderUnassignedRecords`: 新建批次时选择未归属的采摘记录

### 实现效果
- ✅ 日期正确显示，不再出现 "Invalid Date"
- ✅ 重量正确显示，不再出现 "undefinedkg"
- ✅ 团队信息正确显示
- ✅ 兼容后端返回的多种字段名格式（camelCase 和 snake_case）
- ✅ 添加了错误处理，提高代码健壮性


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ¶ä½œæ­¥éª¤æ¨¡æ¿ç®¡ç† - èŒ¶å›­ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fff5e6 0%, #ffe0b2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .header h1 { 
            color: #d84315; 
            font-size: 1.8rem; 
            margin-bottom: 0.5rem; 
        }
        
        .header .subtitle { 
            color: #666; 
            font-size: 0.9rem; 
        }
        
        .nav-buttons { 
            margin-top: 1rem; 
            display: flex; 
            gap: 1rem; 
        }
        
        .nav-btn {
            background: #6c757d; 
            color: white; 
            text-decoration: none;
            padding: 0.5rem 1rem; 
            border-radius: 5px; 
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .nav-btn:hover { background: #5a6268; }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 2rem 4rem; 
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            color: #0d47a1;
        }
        
        .info-box strong {
            color: #1565c0;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .template-card {
            background: white; 
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; 
            padding: 1.5rem 2rem;
            font-size: 1.3rem; 
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body { 
            padding: 2rem; 
        }
        
        .craft-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .craft-title {
            color: #d84315;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ff6b6b;
        }
        
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        
        .form-group label {
            display: block; 
            color: #333; 
            font-weight: 500; 
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #e0e0e0;
            border-radius: 8px; 
            font-size: 0.9rem; 
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none; 
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px; 
            resize: vertical; 
            font-family: inherit;
        }
        
        .btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; 
            border: none; 
            padding: 0.75rem 2rem;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600; 
            transition: all 0.3s; 
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ åˆ¶ä½œæ­¥éª¤æ¨¡æ¿ç®¡ç†</h1>
        <p class="subtitle">è®¾ç½®åˆ¶ä½œæ­¥éª¤çš„é»˜è®¤æ–‡æ¡ˆæ¨¡æ¿ï¼Œå°†åœ¨æ–°å¢æ‰¹æ¬¡æ—¶è‡ªåŠ¨å¡«å……</p>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">ğŸ  è¿”å›ä»ªè¡¨æ¿</a>
            <a href="/admin/template-management" class="nav-btn">ğŸ“ è¿”å›æ¨¡æ¿ç®¡ç†</a>
        </div>
    </div>

    <div class="container">
        <div id="message-container"></div>
        
        <div class="info-box">
            <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜</strong>
            <p>åœ¨è¿™é‡Œä¸ºäº”ä¸ªåˆ¶ä½œæ­¥éª¤ï¼ˆæ‘Šæ™¾ã€æ€é’ã€æ‰æ»ã€å¹²ç‡¥ã€åˆ†æ‹£ï¼‰è®¾ç½®é»˜è®¤çš„æ–‡æ¡ˆæ¨¡æ¿ã€‚</p>
            <p>å½“ç®¡ç†å‘˜æ–°å¢æ‰¹æ¬¡æˆ–ç¼–è¾‘æœªå¡«å†™çš„æ‰¹æ¬¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½è¿™äº›é»˜è®¤æ–‡æ¡ˆï¼Œå¤§å¤§æé«˜å·¥ä½œæ•ˆç‡ã€‚</p>
        </div>

        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ¨¡æ¿...</div>
        
        <div id="templates-container" class="hidden">
            <!-- æ‘Šæ™¾ -->
            <div class="template-card">
                <div class="card-header">
                    <span>æ­¥éª¤ 1ï¼šæ‘Šæ™¾</span>
                    <button class="btn btn-success" onclick="saveTemplate('æ‘Šæ™¾')">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                </div>
                <div class="card-body">
                    <div class="craft-section">
                        <div class="craft-title">æ‰‹å·¥åŒ å¿ƒ</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-manual-purpose" placeholder="ä¾‹å¦‚ï¼šæ•£å‘æ°´åˆ†ï¼Œæå‡èŒ¶å¶é²œçˆ½åº¦..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-manual-method" placeholder="ä¾‹å¦‚ï¼šå°†é²œå¶å‡åŒ€æ‘Šæ”¾åœ¨ç«¹å¸­ä¸Š..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-manual-sensory-change" placeholder="ä¾‹å¦‚ï¼šå¶ç‰‡é€æ¸å˜è½¯ï¼Œé¦™æ°”åˆæ˜¾..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-manual-value" placeholder="ä¾‹å¦‚ï¼šä¿ç•™èŒ¶å¶åŸå§‹é¦™æ°”..."></textarea>
                        </div>
                    </div>
                    
                    <div class="craft-section">
                        <div class="craft-title">ç°ä»£å·¥è‰º</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-modern-purpose" placeholder="ä¾‹å¦‚ï¼šç²¾ç¡®æ§åˆ¶æ°´åˆ†æ•£å‘é€Ÿåº¦..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-modern-method" placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨æ¸©æ¹¿åº¦å¯æ§çš„æ‘Šæ™¾æœº..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-modern-sensory-change" placeholder="ä¾‹å¦‚ï¼šå¶ç‰‡çŠ¶æ€æ›´åŠ å‡åŒ€..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ‘Šæ™¾-modern-value" placeholder="ä¾‹å¦‚ï¼šæé«˜ç”Ÿäº§æ•ˆç‡å’Œå“è´¨ç¨³å®šæ€§..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ€é’ -->
            <div class="template-card">
                <div class="card-header">
                    <span>æ­¥éª¤ 2ï¼šæ€é’</span>
                    <button class="btn btn-success" onclick="saveTemplate('æ€é’')">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                </div>
                <div class="card-body">
                    <div class="craft-section">
                        <div class="craft-title">æ‰‹å·¥åŒ å¿ƒ</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ€é’-manual-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ€é’-manual-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ€é’-manual-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ€é’-manual-value"></textarea>
                        </div>
                    </div>
                    
                    <div class="craft-section">
                        <div class="craft-title">ç°ä»£å·¥è‰º</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ€é’-modern-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ€é’-modern-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ€é’-modern-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ€é’-modern-value"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰æ» -->
            <div class="template-card">
                <div class="card-header">
                    <span>æ­¥éª¤ 3ï¼šæ‰æ»</span>
                    <button class="btn btn-success" onclick="saveTemplate('æ‰æ»')">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                </div>
                <div class="card-body">
                    <div class="craft-section">
                        <div class="craft-title">æ‰‹å·¥åŒ å¿ƒ</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ‰æ»-manual-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ‰æ»-manual-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ‰æ»-manual-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ‰æ»-manual-value"></textarea>
                        </div>
                    </div>
                    
                    <div class="craft-section">
                        <div class="craft-title">ç°ä»£å·¥è‰º</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="æ‰æ»-modern-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="æ‰æ»-modern-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="æ‰æ»-modern-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="æ‰æ»-modern-value"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¹²ç‡¥ -->
            <div class="template-card">
                <div class="card-header">
                    <span>æ­¥éª¤ 4ï¼šå¹²ç‡¥</span>
                    <button class="btn btn-success" onclick="saveTemplate('å¹²ç‡¥')">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                </div>
                <div class="card-body">
                    <div class="craft-section">
                        <div class="craft-title">æ‰‹å·¥åŒ å¿ƒ</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="å¹²ç‡¥-manual-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="å¹²ç‡¥-manual-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="å¹²ç‡¥-manual-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="å¹²ç‡¥-manual-value"></textarea>
                        </div>
                    </div>
                    
                    <div class="craft-section">
                        <div class="craft-title">ç°ä»£å·¥è‰º</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="å¹²ç‡¥-modern-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="å¹²ç‡¥-modern-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="å¹²ç‡¥-modern-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="å¹²ç‡¥-modern-value"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æ‹£ -->
            <div class="template-card">
                <div class="card-header">
                    <span>æ­¥éª¤ 5ï¼šåˆ†æ‹£</span>
                    <button class="btn btn-success" onclick="saveTemplate('åˆ†æ‹£')">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                </div>
                <div class="card-body">
                    <div class="craft-section">
                        <div class="craft-title">æ‰‹å·¥åŒ å¿ƒ</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="åˆ†æ‹£-manual-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="åˆ†æ‹£-manual-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="åˆ†æ‹£-manual-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="åˆ†æ‹£-manual-value"></textarea>
                        </div>
                    </div>
                    
                    <div class="craft-section">
                        <div class="craft-title">ç°ä»£å·¥è‰º</div>
                        <div class="form-group">
                            <label>å·¥è‰ºç›®çš„</label>
                            <textarea class="form-control" id="åˆ†æ‹£-modern-purpose"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæ–¹æ³•</label>
                            <textarea class="form-control" id="åˆ†æ‹£-modern-method"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ„Ÿå®˜å˜åŒ–</label>
                            <textarea class="form-control" id="åˆ†æ‹£-modern-sensory-change"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å·¥è‰ºä»·å€¼</label>
                            <textarea class="form-control" id="åˆ†æ‹£-modern-value"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡æ¿æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            loadTemplates();
        });

        async function loadTemplates() {
            try {
                const response = await fetch('/api/step-templates');
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + result.message, 'error');
                    return;
                }
                
                const templates = (result.data || []).map((template) => ({
                    ...template,
                    stepName: template.stepName ?? template.step_name ?? '',
                    manualCraft: template.manualCraft ?? template.manual_craft ?? {},
                    modernCraft: template.modernCraft ?? template.modern_craft ?? {},
                }));
                
                // å¡«å……è¡¨å•æ•°æ®
                templates.forEach(template => {
                    const stepName = template.stepName;
                    if (!stepName) {
                        console.warn('[StepTemplates] ç¼ºå°‘ stepNameï¼Œå·²è·³è¿‡ï¼š', template);
                        return;
                    }
                    
                    // å¡«å……æ‰‹å·¥åŒ å¿ƒ
                    if (template.manualCraft) {
                        document.getElementById(`${stepName}-manual-purpose`).value = template.manualCraft.purpose || '';
                        document.getElementById(`${stepName}-manual-method`).value = template.manualCraft.method || '';
                        document.getElementById(`${stepName}-manual-sensory-change`).value = template.manualCraft.sensory_change || template.manualCraft.sensoryChange || '';
                        document.getElementById(`${stepName}-manual-value`).value = template.manualCraft.value || '';
                    }
                    
                    // å¡«å……ç°ä»£å·¥è‰º
                    if (template.modernCraft) {
                        document.getElementById(`${stepName}-modern-purpose`).value = template.modernCraft.purpose || '';
                        document.getElementById(`${stepName}-modern-method`).value = template.modernCraft.method || '';
                        document.getElementById(`${stepName}-modern-sensory-change`).value = template.modernCraft.sensory_change || template.modernCraft.sensoryChange || '';
                        document.getElementById(`${stepName}-modern-value`).value = template.modernCraft.value || '';
                    }
                });
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('templates-container').classList.remove('hidden');
                showMessage('æ¨¡æ¿åŠ è½½æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveTemplate(stepName) {
            try {
                // æ”¶é›†æ‰‹å·¥åŒ å¿ƒæ•°æ®
                const manual_craft = {
                    purpose: document.getElementById(`${stepName}-manual-purpose`).value.trim(),
                    method: document.getElementById(`${stepName}-manual-method`).value.trim(),
                    sensory_change: document.getElementById(`${stepName}-manual-sensory-change`).value.trim(),
                    value: document.getElementById(`${stepName}-manual-value`).value.trim()
                };
                
                // æ”¶é›†ç°ä»£å·¥è‰ºæ•°æ®
                const modern_craft = {
                    purpose: document.getElementById(`${stepName}-modern-purpose`).value.trim(),
                    method: document.getElementById(`${stepName}-modern-method`).value.trim(),
                    sensory_change: document.getElementById(`${stepName}-modern-sensory-change`).value.trim(),
                    value: document.getElementById(`${stepName}-modern-value`).value.trim()
                };
                
                showMessage(`æ­£åœ¨ä¿å­˜ ${stepName} æ¨¡æ¿...`, 'info');
                
                const response = await fetch(`/api/step-templates/${encodeURIComponent(stepName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manual_craft, modern_craft })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${stepName} æ¨¡æ¿ä¿å­˜æˆåŠŸï¼`, 'success');
                } else {
                    showMessage(`âŒ ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>


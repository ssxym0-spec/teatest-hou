<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‰´èµæ¨¡æ¿ç®¡ç† - èŒ¶å›­ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .header h1 { 
            color: #8e24aa; 
            font-size: 1.8rem; 
            margin-bottom: 0.5rem; 
        }
        
        .header .subtitle { 
            color: #666; 
            font-size: 0.9rem; 
        }
        
        .nav-buttons { 
            margin-top: 1rem; 
            display: flex; 
            gap: 1rem; 
        }
        
        .nav-btn {
            background: #6c757d; 
            color: white; 
            text-decoration: none;
            padding: 0.5rem 1rem; 
            border-radius: 5px; 
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .nav-btn:hover { background: #5a6268; }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 2rem 4rem; 
        }
        
        .info-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            color: #e65100;
        }
        
        .info-box strong {
            color: #f57c00;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .template-card {
            background: white; 
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #8e24aa 0%, #ba68c8 100%);
            color: white; 
            padding: 1.5rem 2rem;
            font-size: 1.3rem; 
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body { 
            padding: 2rem; 
        }
        
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        
        .form-group label {
            display: block; 
            color: #333; 
            font-weight: 500; 
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #e0e0e0;
            border-radius: 8px; 
            font-size: 0.9rem; 
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none; 
            border-color: #8e24aa;
            box-shadow: 0 0 0 3px rgba(142, 36, 170, 0.1);
        }
        
        textarea.form-control {
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit;
        }
        
        .btn {
            background: linear-gradient(135deg, #8e24aa 0%, #ba68c8 100%);
            color: white; 
            border: none; 
            padding: 0.75rem 2rem;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600; 
            transition: all 0.3s; 
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 36, 170, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            margin-bottom: 2rem;
        }
        
        .btn-add:hover {
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.3);
        }
        
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .hidden {
            display: none !important;
        }
        
        .new-template-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .new-template-form h3 {
            color: #333;
            margin-bottom: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .category-name-input {
            width: 100%;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>â˜• é‰´èµæ¨¡æ¿ç®¡ç†</h1>
        <p class="subtitle">è®¾ç½®ä¸åŒèŒ¶å¶å“ç±»çš„æˆå“é‰´èµé»˜è®¤æ–‡æ¡ˆï¼ŒåŒ…æ‹¬å“é‰´ç¬”è®°ã€å†²æ³¡å»ºè®®å’Œå‚¨å­˜æ–¹æ³•</p>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">ğŸ  è¿”å›ä»ªè¡¨æ¿</a>
            <a href="/admin/template-management" class="nav-btn">ğŸ“ è¿”å›æ¨¡æ¿ç®¡ç†</a>
        </div>
    </div>

    <div class="container">
        <div id="message-container"></div>
        
        <div class="info-box">
            <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜</strong>
            <p>åœ¨è¿™é‡Œä¸ºä¸åŒèŒ¶å¶å“ç±»è®¾ç½®æˆå“é‰´èµçš„é»˜è®¤æ–‡æ¡ˆã€‚å½“ç®¡ç†å‘˜æ–°å¢æ‰¹æ¬¡æˆ–ç¼–è¾‘æ‰¹æ¬¡æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®é€‰æ‹©çš„èŒ¶å¶å“ç±»è‡ªåŠ¨å¡«å……å¯¹åº”çš„å“é‰´ç¬”è®°ã€å†²æ³¡å»ºè®®å’Œå‚¨å­˜æ–¹æ³•ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚</p>
        </div>

        <!-- æ–°å¢æ¨¡æ¿è¡¨å• -->
        <div id="new-template-section" class="new-template-form hidden">
            <h3>â• æ–°å¢é‰´èµæ¨¡æ¿</h3>
            <div class="form-group">
                <label>èŒ¶å¶å“ç±»åç§°</label>
                <input type="text" class="form-control category-name-input" id="new-category-name" placeholder="ä¾‹å¦‚ï¼šæ˜å‰èŒ¶ã€é›¨å‰èŒ¶ç­‰">
            </div>
            <div class="form-group">
                <label>å“é‰´ç¬”è®°</label>
                <textarea class="form-control" id="new-tasting-notes" placeholder="æè¿°èŒ¶å¶çš„å¤–å½¢ã€æ±¤è‰²ã€é¦™æ°”ã€æ»‹å‘³ã€å¶åº•ç­‰..."></textarea>
            </div>
            <div class="form-group">
                <label>å†²æ³¡å»ºè®®</label>
                <textarea class="form-control" id="new-brewing-suggestion" placeholder="æ°´æ¸©ã€èŒ¶æ°´æ¯”ä¾‹ã€æµ¸æ³¡æ—¶é—´ã€å†²æ³¡å™¨å…·ç­‰..."></textarea>
            </div>
            <div class="form-group">
                <label>å‚¨å­˜æ–¹æ³•</label>
                <textarea class="form-control" id="new-storage-method" placeholder="å‚¨å­˜æ¸©åº¦ã€æ¹¿åº¦ã€å®¹å™¨ã€ä¿è´¨æœŸç­‰..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-success" onclick="createNewTemplate()">âœ… åˆ›å»ºæ¨¡æ¿</button>
                <button class="btn" onclick="cancelNewTemplate()">âŒ å–æ¶ˆ</button>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="btn btn-add" onclick="showNewTemplateForm()">â• æ–°å¢èŒ¶å¶å“ç±»æ¨¡æ¿</button>
        </div>

        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ¨¡æ¿...</div>
        
        <div id="templates-container" class="hidden"></div>
    </div>

    <script>
        let allTemplates = [];
        const DOM_KEY_REGEX = /[^\w-]/g;

        const normalizeTemplate = (template) => ({
            ...template,
            categoryName: template.categoryName ?? template.category_name ?? '',
            tastingNotes: template.tastingNotes ?? template.tasting_notes ?? '',
            brewingSuggestion: template.brewingSuggestion ?? template.brewing_suggestion ?? '',
            storageMethod: template.storageMethod ?? template.storage_method ?? '',
        });

        const getCategoryName = (template) => template?.categoryName ?? template?.category_name ?? '';
        const getDomKey = (categoryName) =>
            (categoryName ? categoryName.replace(DOM_KEY_REGEX, '_') : '').trim() || 'category';
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡æ¿æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            loadTemplates();
        });

        async function loadTemplates() {
            try {
                const response = await fetch('/api/appreciation-templates');
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + result.message, 'error');
                    return;
                }
                
                allTemplates = (result.data || []).map(normalizeTemplate);
                renderTemplates();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('templates-container').classList.remove('hidden');
                
                if (allTemplates.length > 0) {
                    showMessage(`âœ… æˆåŠŸåŠ è½½ ${allTemplates.length} ä¸ªé‰´èµæ¨¡æ¿`, 'success');
                } else {
                    showMessage('æš‚æ— æ¨¡æ¿ï¼Œè¯·ç‚¹å‡»"æ–°å¢èŒ¶å¶å“ç±»æ¨¡æ¿"æŒ‰é’®åˆ›å»º', 'info');
                }
                
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            
            if (allTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">æš‚æ— æ¨¡æ¿æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = '';

            allTemplates.forEach((template) => {
                const categoryName = getCategoryName(template);
                if (!categoryName) {
                    console.warn('[Appreciation] æ¨¡æ¿ç¼ºå°‘ categoryNameï¼Œå·²è·³è¿‡ï¼š', template);
                    return;
                }
                const domKey = getDomKey(categoryName);
                const encodedCategory = encodeURIComponent(categoryName);

                const card = document.createElement('div');
                card.className = 'template-card';
                card.dataset.category = encodedCategory;
                card.dataset.domKey = domKey;
                card.innerHTML = `
                    <div class="card-header">
                        <span>${categoryName}</span>
                        <div>
                            <button class="btn btn-success template-save-btn">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                            <button class="btn template-delete-btn" style="margin-left: 0.5rem;">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>å“é‰´ç¬”è®°</label>
                            <textarea class="form-control" id="tasting-notes-${domKey}" placeholder="æè¿°èŒ¶å¶çš„å¤–å½¢ã€æ±¤è‰²ã€é¦™æ°”ã€æ»‹å‘³ã€å¶åº•ç­‰...">${template.tastingNotes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>å†²æ³¡å»ºè®®</label>
                            <textarea class="form-control" id="brewing-suggestion-${domKey}" placeholder="æ°´æ¸©ã€èŒ¶æ°´æ¯”ä¾‹ã€æµ¸æ³¡æ—¶é—´ã€å†²æ³¡å™¨å…·ç­‰...">${template.brewingSuggestion || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚¨å­˜æ–¹æ³•</label>
                            <textarea class="form-control" id="storage-method-${domKey}" placeholder="å‚¨å­˜æ¸©åº¦ã€æ¹¿åº¦ã€å®¹å™¨ã€ä¿è´¨æœŸç­‰...">${template.storageMethod || ''}</textarea>
                        </div>
                    </div>
                `;

                const saveBtn = card.querySelector('.template-save-btn');
                const deleteBtn = card.querySelector('.template-delete-btn');

                if (saveBtn) {
                    saveBtn.addEventListener('click', () => saveTemplate(categoryName, domKey));
                }
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteTemplate(categoryName));
                }

                container.appendChild(card);
            });
        }

        async function saveTemplate(categoryName, domKey = getDomKey(categoryName)) {
            try {
                const tastingField = document.getElementById(`tasting-notes-${domKey}`);
                const brewingField = document.getElementById(`brewing-suggestion-${domKey}`);
                const storageField = document.getElementById(`storage-method-${domKey}`);

                if (!tastingField || !brewingField || !storageField) {
                    showMessage('æ— æ³•å®šä½å¯¹åº”çš„è¡¨å•å…ƒç´ ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'error');
                    return;
                }

                const tastingNotes = tastingField.value.trim();
                const brewingSuggestion = brewingField.value.trim();
                const storageMethod = storageField.value.trim();
                
                showMessage(`æ­£åœ¨ä¿å­˜ ${categoryName} æ¨¡æ¿...`, 'info');
                
                const response = await fetch(`/api/appreciation-templates/${encodeURIComponent(categoryName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tasting_notes: tastingNotes,
                        brewing_suggestion: brewingSuggestion,
                        storage_method: storageMethod
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${categoryName} æ¨¡æ¿ä¿å­˜æˆåŠŸï¼`, 'success');
                } else {
                    showMessage(`âŒ ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteTemplate(categoryName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${categoryName}" æ¨¡æ¿å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/appreciation-templates/${encodeURIComponent(categoryName)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(`âœ… ${categoryName} æ¨¡æ¿å·²åˆ é™¤`, 'success');
                    await loadTemplates();
                } else {
                    showMessage(`âŒ åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showNewTemplateForm() {
            document.getElementById('new-template-section').classList.remove('hidden');
            document.getElementById('new-category-name').focus();
        }

        function cancelNewTemplate() {
            document.getElementById('new-template-section').classList.add('hidden');
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-tasting-notes').value = '';
            document.getElementById('new-brewing-suggestion').value = '';
            document.getElementById('new-storage-method').value = '';
        }

        async function createNewTemplate() {
            try {
                const categoryName = document.getElementById('new-category-name').value.trim();
                const tastingNotes = document.getElementById('new-tasting-notes').value.trim();
                const brewingSuggestion = document.getElementById('new-brewing-suggestion').value.trim();
                const storageMethod = document.getElementById('new-storage-method').value.trim();
                
                if (!categoryName) {
                    showMessage('è¯·è¾“å…¥èŒ¶å¶å“ç±»åç§°', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (allTemplates.some((t) => getCategoryName(t) === categoryName)) {
                    showMessage(`å“ç±» "${categoryName}" å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç¼–è¾‘æˆ–ä½¿ç”¨å…¶ä»–åç§°`, 'error');
                    return;
                }
                
                showMessage(`æ­£åœ¨åˆ›å»º ${categoryName} æ¨¡æ¿...`, 'info');
                
                const response = await fetch(`/api/appreciation-templates/${encodeURIComponent(categoryName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tasting_notes: tastingNotes,
                        brewing_suggestion: brewingSuggestion,
                        storage_method: storageMethod
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${categoryName} æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼`, 'success');
                    cancelNewTemplate();
                    // é‡æ–°åŠ è½½æ¨¡æ¿åˆ—è¡¨
                    await loadTemplates();
                } else {
                    showMessage(`âŒ åˆ›å»ºå¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºæ¨¡æ¿æ—¶å‡ºé”™:', error);
                showMessage(`âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>


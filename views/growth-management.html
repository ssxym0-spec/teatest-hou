<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿé•¿è¿‡ç¨‹ç®¡ç† - å®Œæ•´ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .header h1 { color: #2e7d32; font-size: 1.8rem; margin-bottom: 0.5rem; }
        .header .subtitle { color: #666; font-size: 0.9rem; }
        .nav-buttons { margin-top: 1rem; display: flex; gap: 1rem; }
        .nav-btn {
            background: #6c757d; color: white; text-decoration: none;
            padding: 0.5rem 1rem; border-radius: 5px; font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        .nav-btn:hover { background: #5a6268; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem 4rem; }
        
        /* å·¦å³åˆ†æ å¸ƒå±€ */
        .split-layout {
            display: flex;
            gap: 2rem;
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 250px);
        }
        
        /* å·¦ä¾§æ—¥å†æ  */
        .calendar-sidebar {
            width: 350px;
            flex-shrink: 0;
            border-right: 2px solid #e0e0e0;
            padding: 2rem 1.5rem;
            overflow-y: auto;
            background: #fafafa;
        }
        
        /* å³ä¾§å†…å®¹åŒº */
        .content-main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* æ—¥å†ç»„ä»¶æ ·å¼ */
        .calendar-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #66bb6a;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .calendar-nav-btn {
            background: #66bb6a;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .calendar-nav-btn:hover {
            background: #43a047;
            transform: scale(1.1);
        }
        
        .calendar-month-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2e7d32;
            min-width: 120px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .calendar-year-select {
            width: 100%;
            max-width: 100%;
            padding: 0.4rem 0.8rem;
            border: 2px solid #66bb6a;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #2e7d32;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .calendar-year-select:hover {
            background: #e8f5e9;
        }
        
        .calendar-grid {
            margin-top: 1rem;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            padding: 0.5rem 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
        }
        
        /* æ—¥æœŸçŠ¶æ€é¢œè‰² */
        .calendar-day.empty {
            background: #ffffff;
            color: #ccc;
            cursor: default;
        }
        
        .calendar-day.no-record {
            background: #ffffff;
            color: #999;
        }
        
        .calendar-day.has-record {
            background: #fff9c4;
            color: #333;
            font-weight: 600;
        }
        
        .calendar-day.has-harvest {
            background: #c8e6c9;
            color: #1b5e20;
            font-weight: 600;
        }
        
        .calendar-day.has-farming {
            background: #bbdefb;
            color: #0d47a1;
            font-weight: 600;
        }
        
        .calendar-day.today {
            border-color: #42a5f5;
            box-shadow: 0 0 0 1px #42a5f5;
        }
        
        .calendar-day.selected {
            border-color: #f57c00;
            box-shadow: 0 0 8px rgba(245, 124, 0, 0.4);
            transform: scale(1.05);
        }
        
        .calendar-day:not(.empty):hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* æ—¥å†ç»Ÿè®¡é¢æ¿ */
        .calendar-stats {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stats-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .stat-harvest { color: #2e7d32; }
        .stat-farming { color: #1565c0; }
        .stat-normal { color: #f57f17; }
        .stat-empty { color: #999; }
        
        /* å›¾ä¾‹è¯´æ˜ */
        .calendar-legend {
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .legend-color.harvest { background: #c8e6c9; }
        .legend-color.farming { background: #bbdefb; }
        .legend-color.normal { background: #fff9c4; }
        .legend-color.empty { background: #ffffff; border: 1px solid #ddd; }
        
        /* å¿«æ·æ“ä½œ */
        .calendar-actions {
            margin-top: 1.5rem;
        }
        
        .action-btn {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn-primary {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white;
        }
        
        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }
        
        .action-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        .action-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs-navigation {
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-button {
            flex: 1;
            padding: 1.2rem;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .tab-button.active {
            background: white;
            color: #2e7d32;
            border-bottom-color: #66bb6a;
        }
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .tab-content.active {
            display: block;
        }
        
        /* è¡¨å•å¡ç‰‡æ ·å¼ */
        .form-card {
            background: white; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; margin-bottom: 2rem;
        }
        .card-header {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white; padding: 1.5rem 2rem;
            font-size: 1.3rem; font-weight: 600;
        }
        .card-header-secondary {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }
        .card-body { padding: 2rem; }
        .section-title {
            color: #2e7d32; font-size: 1.1rem; font-weight: 600;
            margin-bottom: 1rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid #66bb6a;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block; color: #333; font-weight: 500; margin-bottom: 0.5rem;
        }
        .form-group label .required { color: #dc3545; margin-left: 3px; }
        .form-control {
            width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 0.9rem; transition: all 0.3s;
        }
        .form-control:focus {
            outline: none; border-color: #66bb6a;
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.1);
        }
        textarea.form-control {
            min-height: 100px; resize: vertical; font-family: inherit;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .image-upload-area {
            border: 2px dashed #66bb6a; border-radius: 8px; padding: 2rem;
            text-align: center; background: #f5f5f5; cursor: pointer;
            transition: all 0.3s;
        }
        .image-upload-area:hover {
            background: #e8f5e9; border-color: #43a047;
        }
        .image-preview-container { margin-top: 1rem; position: relative; }
        .image-preview {
            max-width: 100%; max-height: 300px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .image-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem;
        }
        .gallery-item {
            position: relative; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .gallery-item img {
            width: 100%; height: 150px; object-fit: cover;
        }
        .gallery-item .remove-btn {
            position: absolute; top: 5px; right: 5px; background: #dc3545;
            color: white; border: none; border-radius: 50%;
            width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .gallery-item .remove-btn:hover {
            background: #c82333; transform: scale(1.1);
        }
        .btn {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white; border: none; padding: 0.75rem 2rem;
            border-radius: 8px; cursor: pointer; font-size: 1rem;
            font-weight: 600; transition: all 0.3s; display: inline-block;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #78909c 0%, #546e7a 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
        }
        .btn-small {
            padding: 0.5rem 1rem; font-size: 0.85rem;
        }
        .readonly-field {
            background: #f8f9fa; color: #666; cursor: not-allowed;
        }
        .info-box {
            background: #e3f2fd; border-left: 4px solid #2196f3;
            padding: 1rem; border-radius: 5px; margin-bottom: 1rem;
        }
        .info-box .info-icon {
            display: inline-block; margin-right: 0.5rem; font-weight: 600;
        }
        .success-message {
            background: #d4edda; color: #155724; padding: 1rem;
            border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da; color: #721c24; padding: 1rem;
            border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f5c6cb;
        }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .save-button-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        .save-button-container .btn {
            font-size: 1.1rem;
            padding: 1rem 3rem;
        }
        /* æ­¥éª¤æŒ‡ç¤ºå™¨æ ·å¼ */
        .form-step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .step-number {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .step-item.active .step-number {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
        }
        .step-label {
            font-size: 0.9rem;
            color: #999;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .step-item.active .step-label {
            color: #1e88e5;
            font-weight: 600;
        }
        .step-line {
            width: 80px;
            height: 2px;
            background: #e0e0e0;
            margin: 0 1rem;
        }
        /* è¡¨å•é¡µé¢åˆ‡æ¢ */
        .form-page {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* è¡¨å•å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .form-navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e0e0;
        }
        .form-navigation-buttons .btn {
            flex: 1;
            max-width: 200px;
            padding: 0.875rem 2rem;
            font-size: 1rem;
        }
        .form-navigation-buttons .btn-secondary {
            background: linear-gradient(135deg, #90a4ae 0%, #78909c 100%);
        }
        .form-navigation-buttons .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 144, 156, 0.3);
        }
        .form-navigation-buttons .btn-primary {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }
        .form-navigation-buttons .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.3);
        }
        .form-navigation-buttons .btn-success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        .form-navigation-buttons .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }
        .logs-list {
            margin-top: 1rem;
        }
        .log-item {
            background: #f8f9fa;
            border-left: 4px solid #42a5f5;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .log-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .log-item-info h4 {
            color: #1e88e5;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        .log-item-info p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }
        .log-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .query-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }
        .query-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .editing-mode-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editing-mode-banner strong {
            font-size: 1.05rem;
        }
        
        /* æœˆä»½æ€»ç»“ç‰¹å®šæ ·å¼ */
        .summary-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .summary-section {
            margin-bottom: 2rem;
        }
        .summary-section h3 {
            color: #2e7d32;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2e7d32;
        }
        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* æœˆä»½æ€»ç»“æ—¶é—´è½´é€‰æ‹©å™¨ */
        .timeline-selector {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .timeline-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .timeline-year-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .year-nav-btn {
            background: #66bb6a;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .year-nav-btn:hover {
            background: #43a047;
            transform: scale(1.1);
        }
        
        .current-year-display {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2e7d32;
            min-width: 100px;
            text-align: center;
        }
        
        .timeline-months {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .month-card {
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .month-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .month-card.has-summary {
            background: #c8e6c9;
            border-color: #66bb6a;
        }
        
        .month-card.has-logs {
            background: #fff9c4;
            border-color: #fbc02d;
        }
        
        .month-card.empty {
            background: #ffffff;
            border-color: #e0e0e0;
            color: #999;
        }
        
        .month-card.selected {
            border-color: #f57c00;
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.2);
            transform: translateY(-4px) scale(1.05);
        }
        
        .month-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .month-status {
            font-size: 0.8rem;
            color: #666;
        }
        
        .month-card.has-summary .month-status {
            color: #1b5e20;
        }
        
        .month-card.has-logs .month-status {
            color: #f57f17;
        }
        
        .timeline-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e0e0;
            font-size: 0.9rem;
        }
        
        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timeline-legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .timeline-legend-color.summary { background: #c8e6c9; border: 2px solid #66bb6a; }
        .timeline-legend-color.logs { background: #fff9c4; border: 2px solid #fbc02d; }
        .timeline-legend-color.empty { background: #ffffff; border: 2px solid #e0e0e0; }
        
        .year-quick-select {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .year-quick-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .year-quick-btn:hover {
            background: #e8f5e9;
            border-color: #66bb6a;
        }
        
        .year-quick-btn.active {
            background: #66bb6a;
            color: white;
            border-color: #66bb6a;
        }
        
        @media (max-width: 1200px) {
            .split-layout {
                flex-direction: column;
            }
            
            .calendar-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            
            .timeline-months {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            /* åŸºç¡€å¸ƒå±€ä¼˜åŒ– */
            .container { 
                padding: 0 0.75rem; 
            }
            
            .header {
                padding: 1rem 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header .subtitle {
                font-size: 0.85rem;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-btn {
                text-align: center;
            }
            
            /* å¡ç‰‡æ ·å¼ä¼˜åŒ– */
            .card-header { 
                padding: 1rem 1rem; 
                font-size: 1.1rem;
            }
            
            .card-body { 
                padding: 1rem; 
            }
            
            .form-card {
                margin-bottom: 1rem;
                border-radius: 10px;
            }
            
            /* è¡¨å•å¸ƒå±€ä¼˜åŒ– */
            .form-row { 
                grid-template-columns: 1fr; 
                gap: 0.75rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            
            .form-control {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            textarea.form-control {
                min-height: 80px;
            }
            
            /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            .image-upload-area {
                padding: 1.5rem 1rem;
            }
            
            .image-upload-area p {
                font-size: 0.9rem !important;
            }
            
            .image-upload-area small {
                font-size: 0.75rem !important;
            }
            
            /* å›¾ç‰‡é¢„è§ˆä¼˜åŒ– */
            .image-preview {
                max-height: 200px;
            }
            
            .image-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .image-actions .btn {
                width: 100%;
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
            
            /* å›¾ç‰‡ç”»å»Šä¼˜åŒ– */
            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .gallery-item img {
                height: 120px;
            }
            
            .gallery-item .remove-btn {
                width: 26px;
                height: 26px;
                font-size: 1rem;
            }
            
            /* è®°å½•äººå¤´åƒåŒºåŸŸä¼˜åŒ– */
            #recorder-name {
                font-size: 0.9rem;
            }
            
            #recorder-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 0.75rem;
            }
            
            /* æ¸©åº¦èŒƒå›´è¾“å…¥ä¼˜åŒ– */
            .form-group div[style*="display: flex"] input {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            
            .form-group div[style*="display: flex"] span {
                font-size: 0.85rem;
            }
            
            /* ç« èŠ‚æ ‡é¢˜ä¼˜åŒ– */
            .section-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.4rem;
            }
            
            /* ä¿¡æ¯æç¤ºæ¡†ä¼˜åŒ– */
            .info-box {
                padding: 0.75rem;
                font-size: 0.85rem;
                margin-bottom: 0.75rem;
            }
            
            .info-box p {
                font-size: 0.85rem;
            }
            
            .info-box strong {
                font-size: 0.9rem;
            }
            
            /* åªè¯»å­—æ®µä¼˜åŒ– */
            .readonly-field {
                font-size: 0.85rem;
                padding: 0.6rem;
            }
            
            /* æŒ‰é’®ä¼˜åŒ– */
            .btn {
                padding: 0.65rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .btn-small {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            /* è¡¨å•å¯¼èˆªæŒ‰é’®ä¼˜åŒ– */
            .form-navigation-buttons {
                flex-direction: column;
                gap: 0.75rem;
                margin-top: 1.5rem;
                padding-top: 1rem;
            }
            
            .form-navigation-buttons .btn {
                max-width: 100%;
                width: 100%;
                font-size: 0.95rem;
                padding: 0.75rem 1rem;
            }
            
            /* ä¿å­˜æŒ‰é’®å®¹å™¨ä¼˜åŒ– */
            .save-button-container {
                padding: 1.5rem 1rem;
                margin-bottom: 1rem;
            }
            
            .save-button-container .btn {
                font-size: 1rem;
                padding: 0.85rem 2rem;
                width: 100%;
            }
            
            /* æ ‡ç­¾é¡µä¼˜åŒ– */
            .tab-button { 
                font-size: 0.9rem; 
                padding: 0.85rem 0.5rem; 
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            /* æ—¥å¿—åˆ—è¡¨é¡¹ä¼˜åŒ– */
            .log-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }
            
            .log-item-actions {
                margin-top: 0.75rem;
                width: 100%;
                flex-wrap: wrap;
            }
            
            .log-item-actions .btn {
                flex: 1 1 45%;
                min-width: 120px;
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
            
            /* æŸ¥è¯¢è¡Œä¼˜åŒ– */
            .query-row {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .query-row .form-group {
                width: 100%;
            }
            
            .query-row .btn {
                width: 100%;
            }
            
            /* æ—¥å†ä¾§è¾¹æ ä¼˜åŒ– */
            .calendar-sidebar {
                padding: 1rem 0.75rem;
            }
            
            .calendar-header {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                gap: 0.75rem;
            }
            
            .calendar-month-title {
                font-size: 1rem;
                min-width: 100px;
            }
            
            .calendar-nav-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            
            .calendar-year-select {
                padding: 0.4rem 0.6rem;
                font-size: 0.85rem;
            }
            
            .calendar-day {
                font-size: 0.85rem;
            }
            
            .calendar-stats {
                padding: 1rem;
                margin-top: 1.5rem;
            }
            
            .stats-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .stat-item {
                padding: 0.6rem 0;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .stat-value {
                font-size: 0.9rem;
            }
            
            .calendar-legend {
                padding: 0.75rem;
                font-size: 0.8rem;
            }
            
            .legend-title {
                font-size: 0.85rem;
                margin-bottom: 0.6rem;
            }
            
            .legend-item {
                gap: 0.4rem;
                margin-bottom: 0.4rem;
                font-size: 0.8rem;
            }
            
            .legend-color {
                width: 20px;
                height: 20px;
            }
            
            /* å¿«æ·æ“ä½œæŒ‰é’®ä¼˜åŒ– */
            .calendar-actions {
                margin-top: 1rem;
            }
            
            .action-btn {
                padding: 0.65rem;
                font-size: 0.85rem;
            }
            
            /* æ—¶é—´è½´æœˆä»½ä¼˜åŒ– */
            .timeline-months {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            
            .timeline-month {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            
            /* æ—¶é—´è½´å›¾ä¾‹ä¼˜åŒ– */
            .timeline-legend {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .timeline-legend-item {
                font-size: 0.8rem;
            }
            
            /* æ­¥éª¤æŒ‡ç¤ºå™¨ä¼˜åŒ– */
            .form-step-indicator {
                padding: 0.75rem 0.5rem;
                margin-bottom: 1rem;
            }
            
            .step-item {
                gap: 0.3rem;
            }
            
            .step-number {
                width: 36px;
                height: 36px;
                font-size: 0.95rem;
            }
            
            .step-label {
                font-size: 0.75rem;
            }
            
            .step-line {
                width: 30px;
                margin: 0 0.3rem;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ–ï¼ˆæ‰‹æœºç«–å±ï¼‰ */
        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header {
                padding: 0.75rem 0.5rem;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .card-header {
                font-size: 1rem;
                padding: 0.85rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .form-group {
                margin-bottom: 0.85rem;
            }
            
            .form-group label {
                font-size: 0.85rem;
            }
            
            .form-control {
                padding: 0.55rem;
                font-size: 0.85rem;
            }
            
            .image-upload-area {
                padding: 1.25rem 0.75rem;
            }
            
            .gallery-grid {
                grid-template-columns: 1fr;
            }
            
            .gallery-item img {
                height: 150px;
            }
            
            #recorder-avatar {
                width: 35px !important;
                height: 35px !important;
            }
            
            .section-title {
                font-size: 0.95rem;
            }
            
            .info-box {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
            
            .form-navigation-buttons .btn {
                font-size: 0.9rem;
                padding: 0.7rem 0.85rem;
            }
            
            .tab-button {
                font-size: 0.85rem;
                padding: 0.75rem 0.4rem;
            }
            
            .calendar-sidebar {
                padding: 0.75rem 0.5rem;
            }
            
            .calendar-header {
                gap: 0.5rem;
            }
            
            .calendar-month-title {
                font-size: 0.95rem;
                min-width: 90px;
            }
            
            .calendar-nav {
                gap: 0.5rem;
            }
            
            .calendar-nav-btn {
                width: 26px;
                height: 26px;
                font-size: 0.95rem;
            }
            
            .calendar-year-select {
                font-size: 0.8rem;
                padding: 0.35rem 0.5rem;
            }
            
            .calendar-day {
                font-size: 0.8rem;
            }
            
            .timeline-months {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .step-label {
                font-size: 0.7rem;
            }
            
            .step-line {
                width: 20px;
                margin: 0 0.2rem;
            }
            
            /* éšè—æ­¥éª¤é—´çš„è¿æ¥çº¿ï¼Œæ”¹ä¸ºå‚ç›´å¸ƒå±€ */
            .form-step-indicator {
                flex-direction: column;
                padding: 0.5rem;
            }
            
            .step-line {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ¿ ç”Ÿé•¿è¿‡ç¨‹ç®¡ç†</h1>
        <p class="subtitle">è®°å½•å¹¶ç®¡ç†èŒ¶å›­çš„æ¯æ—¥ç”Ÿé•¿æƒ…å†µå’Œæœˆåº¦æ€»ç»“</p>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">â† è¿”å›ä»ªè¡¨æ¿</a>
        </div>
    </div>

    <div class="container">
        <!-- æç¤ºä¿¡æ¯ -->
        <div id="message-container"></div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs-navigation">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="daily">ğŸ“… æ¯æ—¥ç”Ÿé•¿ç®¡ç†</button>
                <button class="tab-button" data-tab="monthly">ğŸ“Š æœˆä»½æ€»ç»“</button>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <!-- ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µï¼šæ¯æ—¥ç”Ÿé•¿ç®¡ç† -->
        <div id="daily-tab" class="tab-content active">
            <!-- å·¦å³åˆ†æ å¸ƒå±€ -->
            <div class="split-layout">
                <!-- å·¦ä¾§æ—¥å†æ  -->
                <div class="calendar-sidebar">
                    <!-- æ—¥å†å¤´éƒ¨ -->
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">â–¼</button>
                            <span class="calendar-month-title" id="calendar-title">2025å¹´10æœˆ</span>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">â–²</button>
                        </div>
                        <select class="calendar-year-select" id="calendar-year-select" onchange="changeYear(this.value)">
                            <!-- åŠ¨æ€å¡«å……è¿‘3å¹´ -->
                        </select>
                    </div>
                    
                    <!-- æ—¥å†ç½‘æ ¼ -->
                    <div class="calendar-grid">
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">æ—¥</div>
                            <div class="calendar-weekday">ä¸€</div>
                            <div class="calendar-weekday">äºŒ</div>
                            <div class="calendar-weekday">ä¸‰</div>
                            <div class="calendar-weekday">å››</div>
                            <div class="calendar-weekday">äº”</div>
                            <div class="calendar-weekday">å…­</div>
                        </div>
                        <div class="calendar-days" id="calendar-days">
                            <!-- åŠ¨æ€ç”Ÿæˆæ—¥æœŸ -->
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡é¢æ¿ -->
                    <div class="calendar-stats">
                        <div class="stats-title">ğŸ“Š æœ¬æœˆç»Ÿè®¡</div>
                        <div class="stat-item">
                            <span class="stat-label">ğŸŸ¢ é‡‡æ‘˜æ—¥</span>
                            <span class="stat-value stat-harvest" id="stat-harvest">0 å¤©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ğŸ”µ å†œäº‹æ—¥</span>
                            <span class="stat-value stat-farming" id="stat-farming">0 å¤©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ğŸŸ¡ æ™®é€šè®°å½•</span>
                            <span class="stat-value stat-normal" id="stat-normal">0 å¤©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">âšª æœªè®°å½•</span>
                            <span class="stat-value stat-empty" id="stat-empty">0 å¤©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ğŸ“ˆ è®°å½•ç‡</span>
                            <span class="stat-value" id="stat-rate">0%</span>
                        </div>
                    </div>
                    
                    <!-- å›¾ä¾‹è¯´æ˜ -->
                    <div class="calendar-legend">
                        <div class="legend-title">ğŸ“– å›¾ä¾‹è¯´æ˜</div>
                        <div class="legend-item">
                            <div class="legend-color harvest"></div>
                            <span>æœ‰é‡‡æ‘˜è®°å½•</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color farming"></div>
                            <span>æœ‰å†œäº‹æ´»åŠ¨</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color normal"></div>
                            <span>æœ‰æ™®é€šè®°å½•</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color empty"></div>
                            <span>æ— è®°å½•</span>
                        </div>
                    </div>
                    
                    <!-- å¿«æ·æ“ä½œ -->
                    <div class="calendar-actions">
                        <button class="action-btn action-btn-primary" onclick="quickAddToday()">
                            ğŸ“ æ–°å¢ä»Šæ—¥è®°å½•
                        </button>
                        <button class="action-btn action-btn-secondary" onclick="jumpToToday()">
                            ğŸ“… è·³è½¬åˆ°ä»Šå¤©
                        </button>
                    </div>
                </div>
                
                <!-- å³ä¾§å†…å®¹åŒº -->
                <div class="content-main">
                    <!-- ç¼–è¾‘æ¨¡å¼æç¤º -->
                    <div id="editing-mode-banner" class="editing-mode-banner hidden">
                        <div>
                            <strong>ğŸ“ ç¼–è¾‘æ¨¡å¼</strong>
                            <span id="editing-date-display" style="margin-left: 1rem; color: #666;"></span>
                        </div>
                        <button type="button" class="btn btn-warning btn-small" onclick="cancelEdit()">
                            âŒ å–æ¶ˆç¼–è¾‘
                        </button>
                    </div>

                    <!-- éšè—å­—æ®µï¼šå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„æ—¥å¿—ID -->
                    <input type="hidden" id="editing-log-id">

            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="form-step-indicator">
                <div class="step-item active" id="step-indicator-1">
                    <div class="step-number">1</div>
                    <div class="step-label">å¡ç‰‡ä¿¡æ¯</div>
                </div>
                <div class="step-line"></div>
                <div class="step-item" id="step-indicator-2">
                    <div class="step-number">2</div>
                    <div class="step-label">è¯¦æƒ…ä¿¡æ¯</div>
                </div>
            </div>

            <!-- ä¸»è¡¨å• -->
            <form id="daily-log-form">
                <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šå¡ç‰‡ä¿¡æ¯ -->
                <div class="form-card form-page" id="card-info-section">
                    <div class="card-header">ğŸ“‹ æ¯æ—¥æ—¥å¿—å¡ç‰‡ä¿¡æ¯</div>
                    <div class="card-body">
                        <!-- ä¸»å›¾ -->
                        <div class="form-group">
                            <label>ä¸»å›¾ <span class="required">*</span></label>
                            <div class="image-upload-area" onclick="document.getElementById('main-image-input').click()">
                                <p style="margin: 0; font-size: 1rem; color: #666;">
                                    ğŸ“· ç‚¹å‡»ä¸Šä¼ ä¸»å›¾<br>
                                    <small style="color: #999;">æ”¯æŒ JPGã€PNGã€AVIF æ ¼å¼ï¼Œæœ€å¤§ 5MB</small>
                                </p>
                            </div>
                            <input type="file" id="main-image-input" accept="image/*" style="display: none;">
                            
                            <div id="main-image-preview-container" class="image-preview-container hidden">
                                <img id="main-image-preview" class="image-preview" alt="ä¸»å›¾é¢„è§ˆ">
                                <div class="image-actions">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('main-image-input').click()">
                                        ğŸ”„ æ›¿æ¢å›¾ç‰‡
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="removeMainImage()">
                                        ğŸ—‘ï¸ åˆ é™¤ä¸»å›¾
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="main-image-url">
                        </div>

                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-date">æ—¥æœŸ <span class="required">*</span></label>
                                <input type="date" id="log-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="weather">å¤©æ°”</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <img id="weather-icon-preview" src="" alt="" style="width: 32px; height: 32px; display: none; object-fit: contain;">
                                    <select id="weather" class="form-control" style="flex: 1;">
                                        <option value="">åŠ è½½ä¸­...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>æ¸©åº¦èŒƒå›´</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="min-temperature" class="form-control" placeholder="æœ€ä½æ¸©" style="flex: 1;">
                                    <span>~</span>
                                    <input type="number" id="max-temperature" class="form-control" placeholder="æœ€é«˜æ¸©" style="flex: 1;">
                                    <span>â„ƒ</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plot-id">åœ°å—ä¿¡æ¯</label>
                                <select id="plot-id" class="form-control">
                                    <option value="">åŠ è½½ä¸­...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recorder-name">è®°å½•äºº</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div id="recorder-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: #999; font-size: 0.8rem;">æš‚æ— </span>
                                    </div>
                                    <select id="recorder-name" class="form-control" style="flex: 1;" onchange="handleRecorderChange()">
                                        <option value="">é€‰æ‹©è®°å½•äºº...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="farm-activity-type">å†œäº‹æ´»åŠ¨</label>
                                <select id="farm-activity-type" class="form-control">
                                    <option value="æ— ">æ— </option>
                                    <option value="æ–½è‚¥">ğŸŒ± æ–½è‚¥</option>
                                    <option value="ä¿®å‰ª">âœ‚ï¸ ä¿®å‰ª</option>
                                    <option value="çŒæº‰">ğŸ’§ çŒæº‰</option>
                                    <!-- âŒ é‡‡æ‘˜é€‰é¡¹å·²ç§»é™¤ - è¯·åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­å½•å…¥é‡‡æ‘˜è®°å½• -->
                                    <option value="å¼‚å¸¸">âš ï¸ å¼‚å¸¸</option>
                                </select>
                            </div>
                        </div>

                        <!-- â„¹ï¸ é‡‡æ‘˜è®°å½•ç»Ÿä¸€ç®¡ç†è¯´æ˜ -->
                        <div class="info-box" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                            <strong>ğŸ“¢ é‡‡æ‘˜è®°å½•ç®¡ç†è¯´æ˜ï¼š</strong>
                            <p style="margin: 0.5rem 0 0 0;">
                                æ‰€æœ‰é‡‡æ‘˜è®°å½•è¯·å‰å¾€ <a href="/admin/traceability-management" style="color: #d84315; font-weight: 600; text-decoration: none;">ğŸ” æ‰¹æ¬¡è¿½æº¯ç®¡ç†</a> é¡µé¢è¿›è¡Œç»Ÿä¸€å½•å…¥å’Œç®¡ç†ã€‚
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="summary">æ ¸å¿ƒæ—¥å¿—æ‘˜è¦ <span class="required">*</span></label>
                            <textarea id="summary" class="form-control" rows="4" required placeholder="è¯·ç®€è¦æè¿°ä»Šæ—¥èŒ¶å›­ç”Ÿé•¿æƒ…å†µ..."></textarea>
                        </div>

                        <!-- å¯¼èˆªæŒ‰é’® -->
                        <div class="form-navigation-buttons">
                            <button type="button" class="btn btn-secondary" onclick="cancelCardEdit()">
                                â† å–æ¶ˆ
                            </button>
                            <button type="button" class="btn btn-primary" onclick="goToDetailSection()">
                                ä¸‹ä¸€æ­¥ â†’
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¦æƒ…é¡µä¿¡æ¯ -->
                <div class="form-card form-page" id="detail-section" style="display: none;">
                    <div class="card-header">ğŸ“¸ æ¯æ—¥ç”Ÿé•¿è¯¦æƒ…é¡µä¿¡æ¯</div>
                    <div class="card-body">
                        <!-- å›¾ç‰‡ç”»å»Š -->
                        <div class="form-group">
                            <label>å›¾ç‰‡ç”»å»Š</label>
                            <div class="image-upload-area" onclick="document.getElementById('gallery-input').click()">
                                <p style="margin: 0; font-size: 1rem; color: #666;">
                                    ğŸ“· ç‚¹å‡»ä¸Šä¼ å¤šå¼ å›¾ç‰‡<br>
                                    <small style="color: #999;">å¯ä¸€æ¬¡é€‰æ‹©å¤šå¼ å›¾ç‰‡</small>
                                </p>
                            </div>
                            <input type="file" id="gallery-input" accept="image/*" multiple style="display: none;">
                            <div id="gallery-preview" class="gallery-grid"></div>
                        </div>

                        <!-- åªè¯»è”åŠ¨ä¿¡æ¯ -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸ“Œ æ‹æ‘„ä¿¡æ¯ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</div>
                        <div class="info-box">
                            <span class="info-icon">â„¹ï¸</span>
                            ä»¥ä¸‹ä¿¡æ¯å°†è‡ªåŠ¨ä»ä¸Šæ–¹"å¡ç‰‡ä¿¡æ¯"ä¸­åŒæ­¥
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ‹æ‘„æ—¥æœŸ</label>
                                <input type="text" id="photo-date" class="form-control readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label>åœ°å—ä¿¡æ¯</label>
                                <input type="text" id="photo-plot" class="form-control readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label>æ‹æ‘„äºº</label>
                                <input type="text" id="photo-person" class="form-control readonly-field" readonly>
                            </div>
                        </div>

                        <!-- ç¯å¢ƒæ•°æ® -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸŒ¡ï¸ ç¯å¢ƒæ•°æ®</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sunshine-hours">æ—¥ç…§æ—¶é—´</label>
                                <input type="text" id="sunshine-hours" class="form-control" placeholder="ä¾‹å¦‚ï¼š8å°æ—¶">
                            </div>
                            <div class="form-group">
                                <label for="rainfall">ä»Šæ—¥é™æ°´</label>
                                <input type="text" id="rainfall" class="form-control" placeholder="ä¾‹å¦‚ï¼š5mm">
                            </div>
                            <div class="form-group">
                                <label for="avg-temperature">å¹³å‡æ¸©åº¦</label>
                                <input type="text" id="avg-temperature" class="form-control" placeholder="ä¾‹å¦‚ï¼š22Â°C">
                            </div>
                            <div class="form-group">
                                <label for="humidity">æ¹¿åº¦</label>
                                <input type="text" id="humidity" class="form-control" placeholder="ä¾‹å¦‚ï¼š65%">
                            </div>
                        </div>

                        <!-- è¯¦ç»†æ—¥è®° -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸ“ è¯¦ç»†æ—¥è®°</div>
                        <div class="form-group">
                            <label for="full-log">ç”Ÿé•¿æ—¥è®°</label>
                            <textarea id="full-log" class="form-control" rows="6" placeholder="è¯¦ç»†è®°å½•ä»Šæ—¥èŒ¶å›­ç”Ÿé•¿æƒ…å†µ..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="phenological-observation">ç‰©å€™è§‚å¯Ÿ</label>
                            <textarea id="phenological-observation" class="form-control" rows="4" placeholder="è®°å½•æ¤ç‰©ç”Ÿé•¿é˜¶æ®µã€ç‰©å€™ç°è±¡ç­‰..."></textarea>
                        </div>

                        <!-- å†œäº‹æ´»åŠ¨è¯¦æƒ… -->
                        <div id="farm-activity-detail-section" class="hidden">
                            <div class="section-title" style="margin-top: 2rem;">ğŸšœ å†œäº‹æ´»åŠ¨è¯¦æƒ…</div>
                            <div class="form-group">
                                <label id="activity-details-label" for="farm-activity-log">æ´»åŠ¨è¯¦ç»†è®°å½•</label>
                                <textarea id="farm-activity-log" class="form-control" rows="5" placeholder="è¯¦ç»†æè¿°å†œäº‹æ´»åŠ¨çš„å†…å®¹ã€è¿‡ç¨‹ç­‰..."></textarea>
                            </div>
                        </div>

                        <!-- å¼‚å¸¸äº‹ä»¶è®°å½• -->
                        <div id="abnormal-event-section" class="hidden">
                            <div class="section-title" style="margin-top: 2rem;">âš ï¸ å¼‚å¸¸äº‹ä»¶è®°å½•</div>
                            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1rem;">
                                <span class="info-icon">ğŸ’¡</span>
                                å¦‚æœå½“å¤©å‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼ˆå¦‚ç—…è™«å®³ã€è‡ªç„¶ç¾å®³ç­‰ï¼‰ï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ã€‚
                            </div>
                            <div class="form-group">
                                <label for="abnormal-title">å¼‚å¸¸æ ‡é¢˜</label>
                                <input type="text" id="abnormal-title" class="form-control" placeholder="ä¾‹å¦‚ï¼šå‘ç°ç—…è™«å®³">
                            </div>
                            <div class="form-group">
                                <label for="abnormal-description">å¼‚å¸¸æè¿°</label>
                                <textarea id="abnormal-description" class="form-control" rows="3" placeholder="è¯¦ç»†æè¿°å¼‚å¸¸æƒ…å†µ..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="abnormal-measures">å·²é‡‡å–æªæ–½</label>
                                <input type="text" id="abnormal-measures" class="form-control" placeholder="ä¾‹å¦‚ï¼šå·²å–·æ´’æœ‰æœºå†œè¯">
                            </div>
                        </div>

                        <!-- å¯¼èˆªæŒ‰é’® - ç¬¬äºŒé¡µ -->
                        <div class="form-navigation-buttons">
                            <button type="button" class="btn btn-secondary" onclick="goToPreviousPage()">
                                â† ä¸Šä¸€æ­¥
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveLog()" id="save-btn">
                                ğŸ’¾ ä¿å­˜æ—¥å¿—
                            </button>
                        </div>
                    </div>
                </div>
            </form>
                </div>
                <!-- å³ä¾§å†…å®¹åŒºç»“æŸ -->
            </div>
            <!-- å·¦å³åˆ†æ å¸ƒå±€ç»“æŸ -->
        </div>
        <!-- ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µç»“æŸ -->

        <!-- ç¬¬äºŒä¸ªæ ‡ç­¾é¡µï¼šæœˆä»½æ€»ç»“ -->
        <div id="monthly-tab" class="tab-content">
            <!-- ç¼–è¾‘æ¨¡å¼æç¤º -->
            <div id="editing-summary-banner" class="editing-mode-banner hidden">
                <div>
                    <strong>ğŸ“ ç¼–è¾‘æ¨¡å¼</strong>
                    <p style="margin: 0.25rem 0 0 0;">æ­£åœ¨ç¼–è¾‘æœˆåº¦æ€»ç»“ï¼Œä¿®æ”¹å®Œæˆåç‚¹å‡»ä¿å­˜æŒ‰é’®</p>
                </div>
                <button type="button" class="btn btn-warning btn-small" onclick="cancelSummaryEdit()">
                    âŒ å–æ¶ˆç¼–è¾‘ / æ–°å¢æ€»ç»“
                </button>
            </div>

            <!-- éšè—å­—æ®µï¼šå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„æ€»ç»“ID -->
            <input type="hidden" id="editing-summary-id">

            <!-- æ—¶é—´è½´é€‰æ‹©å™¨ -->
            <div class="timeline-selector">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ“… æœˆåº¦æ€»ç»“æ—¶é—´è½´</div>
                    <div class="timeline-year-nav">
                        <button class="year-nav-btn" onclick="changeTimelineYear(-1)">â—€</button>
                        <span class="current-year-display" id="timeline-year">2025å¹´</span>
                        <button class="year-nav-btn" onclick="changeTimelineYear(1)">â–¶</button>
                    </div>
                </div>
                
                <div class="timeline-months" id="timeline-months">
                    <!-- åŠ¨æ€ç”Ÿæˆ12ä¸ªæœˆä»½å¡ç‰‡ -->
                </div>
                
                <div class="timeline-legend">
                    <div class="timeline-legend-item">
                        <div class="timeline-legend-color summary"></div>
                        <span>ğŸŸ¢ å·²ç”Ÿæˆæ€»ç»“</span>
                    </div>
                    <div class="timeline-legend-item">
                        <div class="timeline-legend-color logs"></div>
                        <span>ğŸŸ¡ å¾…ç”Ÿæˆæ€»ç»“</span>
                    </div>
                    <div class="timeline-legend-item">
                        <div class="timeline-legend-color empty"></div>
                        <span>âšª æ— æ•°æ®</span>
                    </div>
                </div>
                
                <div class="year-quick-select" id="year-quick-select">
                    <!-- åŠ¨æ€ç”Ÿæˆè¿‘3å¹´çš„å¿«é€Ÿé€‰æ‹©æŒ‰é’® -->
                </div>
            </div>

            <div class="form-card">
                <div class="card-header">ğŸ“Š æœˆåº¦æ±‡æ€»ç®¡ç†</div>
                <div class="card-body">
                    <div class="query-row">
                        <div class="form-group">
                            <label for="summary-month">é€‰æ‹©æœˆä»½</label>
                            <input type="month" id="summary-month" class="form-control">
                        </div>
                        <button type="button" class="btn" onclick="generateSummary()">ğŸ”„ ç”Ÿæˆ/åˆ·æ–°æœ¬æœˆæ€»ç»“</button>
                    </div>

                    <!-- æ±‡æ€»æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="summary-display" class="summary-display hidden">
                        <div class="info-box" style="background: #e8f5e9; border-left-color: #66bb6a;">
                            <span class="info-icon">âœï¸</span>
                            æ‰€æœ‰æ•°æ®å‡å¯æ‰‹åŠ¨ç¼–è¾‘ã€‚ä¿®æ”¹åè¯·ç‚¹å‡»åº•éƒ¨çš„"ä¿å­˜æ‰€æœ‰æ€»ç»“ä¿®æ”¹"æŒ‰é’®ã€‚
                        </div>

                        <!-- é¡¶éƒ¨å½±åƒç”»å»Šç®¡ç† -->
                        <div class="summary-section">
                            <h3>ğŸ–¼ï¸ é¡¶éƒ¨å½±åƒç”»å»Š</h3>
                            <div class="form-group">
                                <label>ä¸Šä¼ å›¾ç‰‡/è§†é¢‘</label>
                                <div class="image-upload-area" onclick="document.getElementById('gallery-upload-input').click()">
                                    <p style="margin: 0; font-size: 1rem; color: #666;">
                                        ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘<br>
                                        <small style="color: #999;">å¯ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ”¯æŒ JPGã€PNGã€AVIFã€MP4 ç­‰æ ¼å¼</small>
                                    </p>
                                </div>
                                <input type="file" id="gallery-upload-input" accept="image/*,video/*" multiple style="display: none;">
                            </div>

                            <!-- ç”»å»Šé¢„è§ˆåŒºåŸŸ -->
                            <div id="top-gallery-preview" class="gallery-grid"></div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“ˆ é‡‡æ‘˜ç»Ÿè®¡</h3>
                            <div class="info-box" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                                <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    é‡‡æ‘˜ç»Ÿè®¡æ•°æ®ç”±ç³»ç»Ÿè‡ªåŠ¨ä» <a href="/admin/traceability-management" style="color: #d84315; font-weight: 600; text-decoration: none;">ğŸ” æ‰¹æ¬¡è¿½æº¯ç®¡ç†</a> ä¸­çš„é‡‡æ‘˜è®°å½•è®¡ç®—ç”Ÿæˆã€‚
                                    <br>å¦‚éœ€ä¿®æ”¹é‡‡æ‘˜æ•°æ®ï¼Œè¯·å‰å¾€è¯¥é¡µé¢è¿›è¡Œç®¡ç†ã€‚
                                </p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="harvest-count">é‡‡æ‘˜æ¬¡æ•°ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                                    <input type="number" id="harvest-count" class="form-control" min="0" step="1" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label for="harvest-weight">æ€»é‡é‡ï¼ˆå…¬æ–¤ï¼‰ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                                    <input type="number" id="harvest-weight" class="form-control" min="0" step="0.1" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“… å†œäº‹æ—¥å†</h3>
                            <div class="form-group">
                                <textarea id="farm-calendar-display" class="form-control" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;3æ—¥ æ–½è‚¥&#10;15æ—¥ ä¿®å‰ª&#10;28æ—¥ é‡‡æ‘˜"></textarea>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>âš ï¸ å¼‚å¸¸äº‹ä»¶æ±‡æ€»</h3>
                            <div class="form-group">
                                <textarea id="abnormal-events-display" class="form-control" rows="5" placeholder="ä¾‹å¦‚ï¼š&#10;2025-01-15 å‘ç°ç—…è™«å®³ï¼Œå·²å–·æ´’æœ‰æœºå†œè¯&#10;2025-01-20 éƒ¨åˆ†èŒ¶æ ‘å¶ç‰‡å‘é»„ï¼Œå¢åŠ æ–½è‚¥"></textarea>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸŒ¤ï¸ æ°”å€™æ€»ç»“</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="avg-temp-display">å¹³å‡æ¸©åº¦</label>
                                    <input type="text" id="avg-temp-display" class="form-control" placeholder="ä¾‹å¦‚ï¼š17~25â„ƒ">
                                </div>
                                <div class="form-group">
                                    <label for="total-precipitation-display">æ€»é™æ°´</label>
                                    <input type="text" id="total-precipitation-display" class="form-control" placeholder="ä¾‹å¦‚ï¼šçº¦5å¤©æœ‰é™æ°´">
                                </div>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“ ä¸‹æœˆè®¡åˆ’</h3>
                            <div class="form-group">
                                <textarea id="next-month-plan" class="form-control" rows="8" placeholder="è¯·è¾“å…¥ä¸‹æœˆè®¡åˆ’ï¼Œæ¯è¡Œä¸€æ¡..."></textarea>
                            </div>
                        </div>

                        <!-- ç»Ÿä¸€ä¿å­˜æŒ‰é’® -->
                        <div class="save-button-container" style="margin-top: 2rem; display: flex; gap: 1rem; align-items: flex-start;">
                            <div style="flex: 1;">
                                <button type="button" class="btn" onclick="saveAllSummaryChanges()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ€»ç»“ä¿®æ”¹</button>
                                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                                    ä¿å­˜åå°†æ›´æ–°æ‰€æœ‰å·²ä¿®æ”¹çš„ç»Ÿè®¡æ•°æ®
                                </p>
                            </div>
                            <div id="delete-summary-container" style="display: none;">
                                <button type="button" class="btn btn-danger" onclick="deleteCurrentSummary()">ğŸ—‘ï¸ åˆ é™¤æ­¤æœˆæ€»ç»“</button>
                                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                                    æ­¤æ“ä½œä¸å¯æ’¤é”€
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI åŠ©æ‰‹é›†æˆ -->
    <script src="https://o.alicdn.com/appflow/chatbot/v1/AppflowChatSDK.js"></script>
    <script>
        window.APPFLOW_CHAT_SDK.init({
            integrateConfig: {
                integrateId: 'cit-4d7f8b8ad2c5463ca79e',
                domain: { requestDomain: 'https://1524787808648067.appflow.aliyunnest.com' },
                draggable: true
            }
        });
    </script>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let mainImageUrl = '';
        let galleryUrls = [];
        let topGalleryUrls = []; // é¡¶éƒ¨å½±åƒç”»å»Š URL æ•°ç»„
        let availablePlots = [];
        let existingDates = [];
        let currentSummaryId = null;
        
        // æ—¥å†ç›¸å…³å˜é‡
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth(); // 0-11
        let selectedDate = null;
        let monthLogsData = {}; // å­˜å‚¨å½“æœˆçš„æ—¥å¿—æ•°æ® {date: logData}
        let monthHarvestDates = new Set(); // å­˜å‚¨å½“æœˆæœ‰é‡‡æ‘˜è®°å½•çš„æ—¥æœŸ
        
        // æ—¶é—´è½´ç›¸å…³å˜é‡
        let currentTimelineYear = new Date().getFullYear();
        let monthlySummaries = {}; // å­˜å‚¨å·²ç”Ÿæˆçš„æœˆåº¦æ€»ç»“
        let monthlyLogsCount = {}; // å­˜å‚¨æ¯æœˆçš„æ—¥å¿—æ•°é‡
        
        const FARM_ACTIVITY_ENUM_TO_LABEL = {
            NONE: 'æ— ',
            æ— : 'æ— ',
            FERTILIZE: 'æ–½è‚¥',
            æ–½è‚¥: 'æ–½è‚¥',
            PRUNE: 'ä¿®å‰ª',
            ä¿®å‰ª: 'ä¿®å‰ª',
            IRRIGATE: 'çŒæº‰',
            çŒæº‰: 'çŒæº‰',
            HARVEST: 'é‡‡æ‘˜',
            é‡‡æ‘˜: 'é‡‡æ‘˜',
            ABNORMAL: 'å¼‚å¸¸',
            å¼‚å¸¸: 'å¼‚å¸¸'
        };

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('log-date').value = today;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            loadPlots();
            loadRecorders(); // åŠ è½½è®°å½•äººåˆ—è¡¨
            loadWeatherOptions(); // åŠ è½½å¤©æ°”é€‰é¡¹
            setupEventListeners();
            setupTabNavigation();
            updateSyncFields();
            
            // åˆå§‹åŒ–æ—¥å†
            initCalendar();
            initYearSelector();
            renderCalendar();
            loadMonthLogs(); // åŠ è½½å½“æœˆæ—¥å¿—æ•°æ®
            
            // åˆå§‹åŒ–æ—¶é—´è½´
            initTimeline();
            
            // åŠ è½½æœˆåº¦æ€»ç»“åˆ—è¡¨ - å·²åºŸå¼ƒï¼Œä½¿ç”¨æ—¶é—´è½´ä»£æ›¿
            // fetchAndRenderSummaries();
            
            // è®¾ç½®é¡¶éƒ¨ç”»å»Šä¸Šä¼ äº‹ä»¶
            document.getElementById('gallery-upload-input').addEventListener('change', handleTopGalleryUpload);
        });

        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰æ ‡ç­¾
                    button.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');
                });
            });
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadPlots() {
            try {
                const response = await fetch('/api/plots');
                const result = await response.json();
                if (result.success && result.data) {
                    availablePlots = result.data;
                    const plotSelect = document.getElementById('plot-id');
                    plotSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°å—</option>';
                    result.data.forEach(plot => {
                        const option = document.createElement('option');
                        option.value = plot._id;
                        option.textContent = plot.name;
                        plotSelect.appendChild(option);
                    });
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªåœ°å—');
                }
            } catch (error) {
                console.error('åŠ è½½åœ°å—åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('plot-id').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        async function loadExistingDates() {
            // åœ¨æ–°çš„æ—¥å†è§†å›¾ä¸­ï¼Œæ­¤å‡½æ•°å·²åºŸå¼ƒ
            // æ—¥æœŸæ•°æ®é€šè¿‡ loadMonthLogs() å’Œ monthLogsData ç®¡ç†
            console.log('loadExistingDates() å·²åºŸå¼ƒï¼Œä½¿ç”¨ loadMonthLogs() ä»£æ›¿');
        }

        async function loadRecorders() {
            try {
                const response = await fetch('/api/personnel?role=è®°å½•äºº');
                const result = await response.json();
                if (result.success && result.data) {
                    const recorderSelect = document.getElementById('recorder-name');
                    recorderSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è®°å½•äºº</option>';
                    result.data.forEach(recorder => {
                        const option = document.createElement('option');
                        option.value = recorder.name;
                        option.textContent = recorder.name;
                        option.dataset.avatar = resolveAvatarUrl(recorder);
                        recorderSelect.appendChild(option);
                    });
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªè®°å½•äºº');
                }
            } catch (error) {
                console.error('åŠ è½½è®°å½•äººåˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('recorder-name').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        /**
         * ç»Ÿä¸€å¤„ç†ä¸åŒå­—æ®µå‘½åä¸è·¯å¾„çš„å¤´åƒ URL
         */
        function resolveAvatarUrl(recorder) {
            if (!recorder || typeof recorder !== 'object') {
                return '';
            }

            const avatarCandidates = [
                recorder.avatar_url,
                recorder.avatarUrl,
                recorder.avatarURL,
                recorder.avatar?.url,
            ].filter(url => typeof url === 'string' && url.trim() !== '');

            if (avatarCandidates.length === 0) {
                return '';
            }

            const rawUrl = avatarCandidates[0].trim();

            // ç»å¯¹æˆ–åè®®ç›¸å¯¹åœ°å€ç›´æ¥è¿”å›
            if (/^https?:\/\//i.test(rawUrl) || rawUrl.startsWith('//')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('/')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('uploads/')) {
                return `/${rawUrl}`;
            }

            return `/uploads/avatars/${rawUrl}`;
        }

        /**
         * è§„èŒƒå¤©æ°”å›¾æ ‡è·¯å¾„ï¼Œå…¼å®¹å¤šç§å­˜å‚¨æ ¼å¼
         */
        function resolveWeatherIconUrl(iconValue) {
            if (!iconValue) return '';

            const rawUrl = (typeof iconValue === 'string' ? iconValue : iconValue?.icon || '').trim();
            if (!rawUrl) return '';

            if (/^https?:\/\//i.test(rawUrl) || rawUrl.startsWith('//')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('/')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('public/')) {
                return `/${rawUrl.replace(/^public\//, '')}`;
            }

            if (rawUrl.startsWith('uploads/')) {
                return `/${rawUrl}`;
            }

            if (rawUrl.startsWith('weather/')) {
                return `/${rawUrl}`;
            }

            return `/weather/${rawUrl}`;
        }

        // å¤©æ°”å›¾æ ‡æ˜ å°„è¡¨ï¼ˆå…¨å±€å˜é‡ï¼‰
        let weatherIconMap = {};
        
        // åŠ è½½å¤©æ°”é€‰é¡¹ï¼ˆä»å¤©æ°”æ¨¡æ¿APIè·å–ï¼‰
        async function loadWeatherOptions() {
            try {
                const response = await fetch('/api/weather-templates?active_only=true');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const weatherSelect = document.getElementById('weather');
                    weatherSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¤©æ°”</option>';
                    
                    // æ¸…ç©ºå¹¶é‡å»ºå›¾æ ‡æ˜ å°„
                    weatherIconMap = {};
                    
                    result.data.forEach(weather => {
                        const option = document.createElement('option');
                        option.value = weather.name;
                        option.textContent = weather.name;
                        const iconSource = weather.svg_icon ?? weather.svgIcon ?? weather.icon ?? null;
                        const iconUrl = resolveWeatherIconUrl(iconSource);
                        if (iconUrl) {
                            option.dataset.icon = iconUrl;
                            weatherIconMap[weather.name] = iconUrl;
                        } else {
                            option.dataset.icon = '';
                        }
                        weatherSelect.appendChild(option);
                    });
                    
                    // æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨æ¥æ›´æ–°å›¾æ ‡
                    weatherSelect.removeEventListener('change', updateWeatherIcon); // å…ˆç§»é™¤æ—§ç›‘å¬å™¨
                    weatherSelect.addEventListener('change', updateWeatherIcon);
                    
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªå¤©æ°”é€‰é¡¹');
                }
            } catch (error) {
                console.error('åŠ è½½å¤©æ°”é€‰é¡¹å¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çš„å¤©æ°”é€‰é¡¹
                const weatherSelect = document.getElementById('weather');
                weatherSelect.innerHTML = `
                    <option value="">è¯·é€‰æ‹©å¤©æ°”</option>
                    <option value="æ™´å¤©">æ™´å¤©</option>
                    <option value="å¤šäº‘">å¤šäº‘</option>
                    <option value="é˜´å¤©">é˜´å¤©</option>
                    <option value="é›¨å¤©">é›¨å¤©</option>
                `;
                console.warn('âš ï¸ ä½¿ç”¨é»˜è®¤å¤©æ°”é€‰é¡¹');
            }
        }
        
        // æ›´æ–°å¤©æ°”å›¾æ ‡æ˜¾ç¤º
        function updateWeatherIcon() {
            const weatherSelect = document.getElementById('weather');
            const weatherIconPreview = document.getElementById('weather-icon-preview');
            const selectedWeather = weatherSelect.value;
            const selectedOption = weatherSelect.options[weatherSelect.selectedIndex];
            const iconUrlFromMap = weatherIconMap[selectedWeather];
            const iconUrl = iconUrlFromMap || selectedOption?.dataset.icon || '';
            
            if (selectedWeather && iconUrl) {
                weatherIconPreview.src = iconUrl;
                weatherIconPreview.style.display = 'block';
            } else {
                weatherIconPreview.style.display = 'none';
                weatherIconPreview.src = '';
            }
        }

        // ==================== æ—¥å†ç›¸å…³åŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–æ—¥å†
        function initCalendar() {
            currentCalendarYear = new Date().getFullYear();
            currentCalendarMonth = new Date().getMonth();
        }
        
        // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
        function initYearSelector() {
            const yearSelect = document.getElementById('calendar-year-select');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            // ç”Ÿæˆè¿‘3å¹´çš„é€‰é¡¹
            for (let i = -1; i <= 1; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                if (year === currentCalendarYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }
        
        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const year = currentCalendarYear;
            const month = currentCalendarMonth;
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('calendar-title').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay(); // 0-6
            const daysInMonth = lastDay.getDate();
            
            // ç”Ÿæˆæ—¥å†æ ¼å­
            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';
            
            // å¡«å……ç©ºç™½æ ¼å­
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                daysContainer.appendChild(emptyDay);
            }
            
            // å¡«å……æ—¥æœŸæ ¼å­
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                dayDiv.dataset.date = dateStr;
                
                // åˆ¤æ–­æ—¥æœŸç±»å‹
                const logData = monthLogsData[dateStr];
                const dateType = getDateType(logData, dateStr);
                
                if (dateType === 'harvest') {
                    dayDiv.classList.add('has-harvest');
                } else if (dateType === 'farming') {
                    dayDiv.classList.add('has-farming');
                } else if (dateType === 'normal') {
                    dayDiv.classList.add('has-record');
                } else {
                    dayDiv.classList.add('no-record');
                }
                
                // ä»Šå¤©æ ‡è®°
                if (dateStr === todayStr) {
                    dayDiv.classList.add('today');
                }
                
                // é€‰ä¸­æ ‡è®°
                if (selectedDate === dateStr) {
                    dayDiv.classList.add('selected');
                }
                
                // ç‚¹å‡»äº‹ä»¶
                dayDiv.addEventListener('click', () => onDateClick(dateStr, logData));
                
                daysContainer.appendChild(dayDiv);
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateCalendarStats();
        }
        
        // åˆ¤æ–­æ—¥æœŸç±»å‹
        function getDateType(logData, dateStr) {
            // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰é‡‡æ‘˜è®°å½•ï¼ˆä»æ‰¹æ¬¡è¿½æº¯ç®¡ç†ï¼‰
            if (monthHarvestDates.has(dateStr)) {
                return 'harvest'; // ğŸŸ¢ é‡‡æ‘˜æ—¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            }
            
            if (!logData) return 'empty';
            
            // å…¼å®¹æ—§æ•°æ®ï¼šæ£€æŸ¥æ¯æ—¥æ—¥å¿—ä¸­çš„é‡‡æ‘˜è®°å½•
            if (logData.harvest_weight_kg > 0 || logData.farm_activity_type === 'é‡‡æ‘˜') {
                return 'harvest'; // ğŸŸ¢ é‡‡æ‘˜æ—¥
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†œäº‹æ´»åŠ¨
            if (logData.farm_activity_type && logData.farm_activity_type !== 'æ— ') {
                return 'farming'; // ğŸ”µ å†œäº‹æ—¥
            }
            
            // å…¶ä»–æœ‰è®°å½•çš„æƒ…å†µ
            return 'normal'; // ğŸŸ¡ æ™®é€šè®°å½•
        }
        
        // æ—¥æœŸç‚¹å‡»äº‹ä»¶
        async function onDateClick(dateStr, logData) {
            selectedDate = dateStr;
            
            // æ›´æ–°æ—¥å†æ˜¾ç¤º
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
                if (day.dataset.date === dateStr) {
                    day.classList.add('selected');
                }
            });
            
            // å¦‚æœæœ‰æ•°æ®ï¼ŒåŠ è½½ç¼–è¾‘
            if (logData) {
                await editLogByDate(dateStr);
            } else {
                // æ–°å¢æ¨¡å¼
                startNewLog(dateStr);
            }
        }
        
        function mapFarmActivityToDisplay(value) {
            if (!value) return 'æ— ';
            const cleanValue = String(value).trim();
            return FARM_ACTIVITY_ENUM_TO_LABEL[cleanValue] || cleanValue || 'æ— ';
        }
        
        function normalizeLogForForm(rawLog) {
            if (!rawLog || typeof rawLog !== 'object') return null;
            
            const normalized = { ...rawLog };
            
            // ç»Ÿä¸€ ID
            normalized._id = rawLog._id || rawLog.id || rawLog.log_id || null;
            normalized.id = normalized._id || rawLog.id || null;
            
            // æ—¥æœŸç»Ÿä¸€ä¸º ISO å­—ç¬¦ä¸²
            try {
                normalized.date = typeof rawLog.date === 'string' 
                    ? rawLog.date 
                    : new Date(rawLog.date).toISOString();
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•æ ¼å¼åŒ–æ—¥å¿—æ—¥æœŸ:', rawLog.date, error);
                normalized.date = rawLog.date || '';
            }
            
            // è®°å½•äºº
            normalized.recorder_name = rawLog.recorder_name 
                || rawLog.recorderName 
                || rawLog.recorder?.name 
                || '';
            
            // åœ°å—
            normalized.plot_id = rawLog.plot_id 
                || rawLog.plotId 
                || rawLog.plot?._id 
                || rawLog.plot?.id 
                || '';
            
            // ä¸»å›¾
            normalized.main_image_url = rawLog.main_image_url 
                || rawLog.mainImageUrl 
                || rawLog.main_image?.url 
                || '';
            
            // å¤©æ°”
            normalized.weather = rawLog.weather 
                || rawLog.weather_info 
                || (rawLog.weatherIcon ? { icon: rawLog.weatherIcon } : null) 
                || null;
            
            // ç”»å»Š
            normalized.detail_gallery = rawLog.detail_gallery 
                || rawLog.detailGallery 
                || rawLog.gallery 
                || [];
            
            // å†œäº‹ç›¸å…³
            normalized.farm_activity_type = mapFarmActivityToDisplay(
                rawLog.farm_activity_type || rawLog.farmActivityType || ''
            );
            normalized.farm_activity_log = rawLog.farm_activity_log 
                || rawLog.farmActivityLog 
                || '';
            
            // ç¯å¢ƒæ•°æ®
            normalized.environment_data = rawLog.environment_data 
                || rawLog.environmentData 
                || null;
            
            normalized.phenological_observation = rawLog.phenological_observation 
                || rawLog.phenologicalObservation 
                || '';
            
            normalized.abnormal_event = rawLog.abnormal_event 
                || rawLog.abnormalEvent 
                || null;
            
            normalized.harvest_weight_kg = rawLog.harvest_weight_kg 
                || rawLog.harvestWeightKg 
                || 0;
            
            normalized.summary = rawLog.summary || rawLog.fullSummary || '';
            normalized.recorder_id = rawLog.recorder_id || rawLog.recorderId || rawLog.recorder?.id || null;
            const recorderAvatarPayload = rawLog.recorder
                ? {
                    ...rawLog.recorder,
                    avatar_url: rawLog.recorder.avatar_url ?? rawLog.recorder_avatar ?? rawLog.recorder?.avatarUrl,
                }
                : rawLog.recorder_avatar
                    ? { avatar_url: rawLog.recorder_avatar }
                    : null;
            normalized.recorder_avatar = resolveAvatarUrl(recorderAvatarPayload) || '';
            
            return normalized;
        }
        
        function populateFormWithLocalLog(log) {
            const normalizedLog = normalizeLogForForm(log);
            if (!normalizedLog) return;
            
            const logId = normalizedLog._id || normalizedLog.id || '';
            const dateOnly = normalizedLog.date ? normalizedLog.date.split('T')[0] : '';
            
            document.getElementById('editing-log-id').value = logId;
            document.getElementById('editing-mode-banner').classList.remove('hidden');
            document.getElementById('log-date').value = dateOnly || '';
            document.getElementById('editing-date-display').textContent = dateOnly 
                ? `- æ­£åœ¨ç¼–è¾‘ï¼š${formatDateChinese(dateOnly)}`
                : '';
            
            fillFormWithLogData(normalizedLog);
            
            // è®°å½•äººå¤´åƒ
            if (normalizedLog.recorder_avatar) {
                updateAvatar('recorder-avatar', normalizedLog.recorder_avatar);
            } else if (normalizedLog.recorder_name) {
                // å¦‚æœå¤´åƒç¼ºå¤±ä½†é€‰æ‹©ä¸­å«æœ‰ avatar æ•°æ®ï¼Œå°è¯•åŒ¹é…
                const recorderSelect = document.getElementById('recorder-name');
                if (recorderSelect) {
                    const option = Array.from(recorderSelect.options).find(opt => opt.value === normalizedLog.recorder_name);
                    const avatarUrl = option?.dataset.avatar || '';
                    updateAvatar('recorder-avatar', avatarUrl);
                }
            } else {
                updateAvatar('recorder-avatar', '');
            }
            
            document.getElementById('save-btn').innerHTML = logId ? 'ğŸ’¾ æ›´æ–°æ­¤æ¡æ—¥å¿—' : 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
            document.getElementById('card-info-section').style.display = 'block';
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('step-indicator-1').classList.add('active');
            document.getElementById('step-indicator-2').classList.remove('active');
            
            const formContainer = document.querySelector('.content-main');
            if (formContainer) {
                formContainer.scrollTop = 0;
            }
            
            showMessage(`âœ… å·²åŠ è½½ ${dateOnly ? formatDateChinese(dateOnly) : 'å½“å‰'} çš„æ—¥å¿—ï¼Œå¯ä»¥ç»§ç»­ç¼–è¾‘`, 'success');
        }
        
        // æ ¹æ®ç‚¹å‡»æ—¥æœŸæŸ¥æ‰¾å®Œæ•´æ—¥å¿—ï¼ˆå…¼å®¹ä¸åŒæ—¶é—´æ ¼å¼ï¼‰
        function getGrowthLogDetail(dateStr) {
            let log = monthLogsData[dateStr];
            
            if (!log) {
                const logs = Object.values(monthLogsData);
                log = logs.find(entry => {
                    if (!entry || !entry.date) return false;
                    
                    try {
                        const dateValue = typeof entry.date === 'string' ? entry.date : new Date(entry.date).toISOString();
                        return dateValue.startsWith(dateStr);
                    } catch (error) {
                        console.warn('âš ï¸ æ— æ³•è§£ææ—¥å¿—æ—¥æœŸ:', entry.date, error);
                        return false;
                    }
                }) || null;
            }
            
            if (log) {
                const normalizedLog = normalizeLogForForm(log);
                populateFormWithLocalLog(normalizedLog);
                return normalizedLog;
            }
            
            return null;
        }
        
        // æ ¹æ®æ—¥æœŸç¼–è¾‘æ—¥å¿—
        async function editLogByDate(dateStr) {
            const logData = getGrowthLogDetail(dateStr);
            if (!logData) {
                console.warn('âš ï¸ æœªåœ¨ monthLogsData ä¸­æ‰¾åˆ°å¯¹åº”æ—¥æœŸçš„æ—¥å¿—ï¼Œè¿›å…¥æ–°å¢æ¨¡å¼:', dateStr);
                startNewLog(dateStr);
            }
        }
        
        // å¼€å§‹æ–°å¢æ—¥å¿—
        function startNewLog(dateStr) {
            clearForm();
            document.getElementById('log-date').value = dateStr;
            document.getElementById('editing-log-id').value = '';
            document.getElementById('editing-mode-banner').classList.add('hidden');
            document.getElementById('editing-date-display').textContent = '';
            document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
            
            // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
            document.querySelector('.content-main').scrollTop = 0;
            
            showMessage(`å‡†å¤‡æ–°å¢ ${formatDateChinese(dateStr)} çš„è®°å½•`, 'info');
        }
        
        // åŠ è½½å½“æœˆæ—¥å¿—æ•°æ®
        async function loadMonthLogs() {
            try {
                const yearMonth = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}`;
                
                // 1. åŠ è½½æ¯æ—¥ç”Ÿé•¿æ—¥å¿—
                const response = await fetch(`/api/growth-logs?month=${yearMonth}`);
                const result = await response.json();
                
                if (result.success) {
                    monthLogsData = {};
                    result.data.forEach(log => {
                        const dateStr = log.date.split('T')[0];
                        monthLogsData[dateStr] = log;
                    });
                    console.log('âœ… åŠ è½½å½“æœˆæ—¥å¿—:', Object.keys(monthLogsData).length, 'æ¡');
                } else {
                    console.error('åŠ è½½æœˆä»½æ—¥å¿—å¤±è´¥:', result.message);
                }
                
                // 2. åŠ è½½é‡‡æ‘˜è®°å½•ï¼ˆæ‰¹æ¬¡è¿½æº¯ç®¡ç†ï¼‰
                await loadMonthHarvestRecords(yearMonth);
                
                // 3. æ¸²æŸ“æ—¥å†
                renderCalendar();
                
            } catch (error) {
                console.error('åŠ è½½æœˆä»½æ—¥å¿—å‡ºé”™:', error);
            }
        }
        
        // åŠ è½½å½“æœˆé‡‡æ‘˜è®°å½•
        async function loadMonthHarvestRecords(yearMonth) {
            try {
                const response = await fetch(`/api/harvest-records?month=${yearMonth}`);
                const result = await response.json();
                
                if (result.success) {
                    monthHarvestDates.clear();
                    result.data.forEach(record => {
                        const harvestDateValue = record.harvest_date || record.harvestDate;
                        if (!harvestDateValue) {
                            console.warn('âš ï¸ é‡‡æ‘˜è®°å½•ç¼ºå°‘ harvest_date å­—æ®µï¼Œå·²è·³è¿‡:', record.id || record);
                            return;
                        }
                        const dateStr = harvestDateValue.split('T')[0];
                        monthHarvestDates.add(dateStr);
                    });
                    console.log('âœ… åŠ è½½å½“æœˆé‡‡æ‘˜è®°å½•:', monthHarvestDates.size, 'å¤©');
                } else {
                    console.error('åŠ è½½é‡‡æ‘˜è®°å½•å¤±è´¥:', result.message);
                    monthHarvestDates.clear();
                }
            } catch (error) {
                console.error('åŠ è½½é‡‡æ‘˜è®°å½•å‡ºé”™:', error);
                monthHarvestDates.clear();
            }
        }
        
        // æ›´æ–°æ—¥å†ç»Ÿè®¡
        function updateCalendarStats() {
            let harvestCount = 0;
            let farmingCount = 0;
            let normalCount = 0;
            let totalDays = 0;
            
            // è·å–æœ¬æœˆæ€»å¤©æ•°
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            totalDays = lastDay.getDate();
            
            // ç»Ÿè®¡å„ç±»å‹æ—¥æœŸ
            // 1. å…ˆç»Ÿè®¡æ¯æ—¥æ—¥å¿—
            Object.entries(monthLogsData).forEach(([dateStr, log]) => {
                const type = getDateType(log, dateStr);
                if (type === 'harvest') harvestCount++;
                else if (type === 'farming') farmingCount++;
                else if (type === 'normal') normalCount++;
            });
            
            // 2. å†ç»Ÿè®¡æ²¡æœ‰æ¯æ—¥æ—¥å¿—ä½†æœ‰é‡‡æ‘˜è®°å½•çš„æ—¥æœŸ
            monthHarvestDates.forEach(dateStr => {
                // å¦‚æœè¿™ä¸ªæ—¥æœŸæ²¡æœ‰æ¯æ—¥æ—¥å¿—ï¼Œåˆ™è®¡å…¥é‡‡æ‘˜æ—¥
                if (!monthLogsData[dateStr]) {
                    harvestCount++;
                }
            });
            
            const recordedCount = harvestCount + farmingCount + normalCount;
            const emptyCount = totalDays - recordedCount;
            const rate = Math.round((recordedCount / totalDays) * 100);
            
            document.getElementById('stat-harvest').textContent = `${harvestCount} å¤©`;
            document.getElementById('stat-farming').textContent = `${farmingCount} å¤©`;
            document.getElementById('stat-normal').textContent = `${normalCount} å¤©`;
            document.getElementById('stat-empty').textContent = `${emptyCount} å¤©`;
            document.getElementById('stat-rate').textContent = `${rate}%`;
        }
        
        // åˆ‡æ¢æœˆä»½
        function changeMonth(offset) {
            currentCalendarMonth += offset;
            
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            
            renderCalendar();
            loadMonthLogs();
        }
        
        // åˆ‡æ¢å¹´ä»½
        function changeYear(year) {
            currentCalendarYear = parseInt(year);
            renderCalendar();
            loadMonthLogs();
        }
        
        // å¿«é€Ÿè·³è½¬åˆ°ä»Šå¤©
        function jumpToToday() {
            const today = new Date();
            currentCalendarYear = today.getFullYear();
            currentCalendarMonth = today.getMonth();
            initYearSelector();
            renderCalendar();
            loadMonthLogs();
        }
        
        // å¿«é€Ÿæ–°å¢ä»Šæ—¥è®°å½•
        function quickAddToday() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // è·³è½¬åˆ°ä»Šå¤©
            jumpToToday();
            
            // å»¶è¿Ÿä¸€ç‚¹å†é€‰ä¸­æ—¥æœŸ
            setTimeout(() => {
                const logData = monthLogsData[todayStr];
                if (logData) {
                    showMessage('ä»Šå¤©å·²æœ‰è®°å½•ï¼Œåˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼', 'info');
                    onDateClick(todayStr, logData);
                } else {
                    onDateClick(todayStr, null);
                }
            }, 300);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºä¸­æ–‡
        function formatDateChinese(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }

        // ==================== æ—¶é—´è½´é€‰æ‹©å™¨åŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–æ—¶é—´è½´
        function initTimeline() {
            initTimelineYearSelector();
            renderTimeline();
            loadTimelineData();
        }
        
        // åˆå§‹åŒ–æ—¶é—´è½´å¹´ä»½é€‰æ‹©å™¨
        function initTimelineYearSelector() {
            const quickSelectContainer = document.getElementById('year-quick-select');
            const currentYear = new Date().getFullYear();
            quickSelectContainer.innerHTML = '';
            
            // ç”Ÿæˆè¿‘3å¹´çš„å¿«é€Ÿé€‰æ‹©æŒ‰é’®
            for (let i = -1; i <= 1; i++) {
                const year = currentYear + i;
                const btn = document.createElement('button');
                btn.className = 'year-quick-btn';
                btn.textContent = year + 'å¹´';
                btn.onclick = () => selectTimelineYear(year);
                
                if (year === currentTimelineYear) {
                    btn.classList.add('active');
                }
                
                quickSelectContainer.appendChild(btn);
            }
        }
        
        // æ¸²æŸ“æ—¶é—´è½´
        function renderTimeline() {
            document.getElementById('timeline-year').textContent = currentTimelineYear + 'å¹´';
            
            const monthsContainer = document.getElementById('timeline-months');
            monthsContainer.innerHTML = '';
            
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                               'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€', 'åäºŒ'];
            
            for (let month = 0; month < 12; month++) {
                const monthKey = `${currentTimelineYear}-${String(month + 1).padStart(2, '0')}`;
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                
                // åˆ¤æ–­æœˆä»½çŠ¶æ€
                const hasSummary = monthlySummaries[monthKey];
                const logsCount = monthlyLogsCount[monthKey] || 0;
                
                if (hasSummary) {
                    monthCard.classList.add('has-summary');
                    monthCard.innerHTML = `
                        <div class="month-name">${monthNames[month]}</div>
                        <div class="month-status">âœ“ å·²ç”Ÿæˆ</div>
                    `;
                } else if (logsCount > 0) {
                    monthCard.classList.add('has-logs');
                    monthCard.innerHTML = `
                        <div class="month-name">${monthNames[month]}</div>
                        <div class="month-status">${logsCount}æ¡è®°å½•</div>
                    `;
                } else {
                    monthCard.classList.add('empty');
                    monthCard.innerHTML = `
                        <div class="month-name">${monthNames[month]}</div>
                        <div class="month-status">æ— æ•°æ®</div>
                    `;
                }
                
                // ç‚¹å‡»äº‹ä»¶
                monthCard.onclick = () => onMonthCardClick(currentTimelineYear, month, hasSummary, logsCount);
                
                monthsContainer.appendChild(monthCard);
            }
        }
        
        // æœˆä»½å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        function onMonthCardClick(year, month, hasSummary, logsCount) {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.month-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.target.closest('.month-card').classList.add('selected');
            
            if (hasSummary) {
                // åŠ è½½å¹¶æ˜¾ç¤ºå·²æœ‰æ€»ç»“
                loadAndDisplaySummary(monthKey);
            } else if (logsCount > 0) {
                // æç¤ºç”Ÿæˆæ€»ç»“
                if (confirm(`${year}å¹´${month + 1}æœˆå…±æœ‰${logsCount}æ¡è®°å½•ã€‚\n\næ˜¯å¦ç”Ÿæˆè¯¥æœˆçš„æœˆåº¦æ€»ç»“ï¼Ÿ`)) {
                    generateSummaryForMonth(monthKey);
                }
            } else {
                // æ— æ•°æ®
                showMessage(`${year}å¹´${month + 1}æœˆæš‚æ— è®°å½•`, 'error');
            }
        }
        
        // åŠ è½½å¹¶æ˜¾ç¤ºæ€»ç»“
        async function loadAndDisplaySummary(monthKey) {
            try {
                showMessage(`æ­£åœ¨åŠ è½½ ${monthKey} çš„æ€»ç»“...`, 'info');
                
                // ä»å·²ç¼“å­˜çš„æ•°æ®ä¸­è·å–
                let summary = monthlySummaries[monthKey];
                
                // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä»æœåŠ¡å™¨é‡æ–°è·å–
                if (!summary || !summary._id) {
                    const response = await fetch(`/api/monthly-summaries?year_month=${monthKey}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        summary = result.data;
                        monthlySummaries[monthKey] = summary;
                    } else {
                        showMessage(`âŒ åŠ è½½å¤±è´¥ï¼šæœªæ‰¾åˆ° ${monthKey} çš„æ€»ç»“`, 'error');
                        return;
                    }
                }
                
                // æ˜¾ç¤ºæ€»ç»“æ•°æ®
                displaySummary(summary);
                
                // åŒæ­¥æ›´æ–°æœˆä»½é€‰æ‹©å™¨
                document.getElementById('summary-month').value = monthKey;
                
                // æ»šåŠ¨åˆ°ç¼–è¾‘è¡¨å•
                setTimeout(() => {
                    const summaryDisplay = document.getElementById('summary-display');
                    if (summaryDisplay && !summaryDisplay.classList.contains('hidden')) {
                        summaryDisplay.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 100);
                
                showMessage(`âœ… å·²åŠ è½½ ${monthKey} çš„æ€»ç»“ï¼Œå¯ä»¥è¿›è¡Œç¼–è¾‘`, 'success');
                console.log('âœ… æ—¶é—´è½´ï¼šå·²åŠ è½½æ€»ç»“æ•°æ®', summary);
                
            } catch (error) {
                console.error('åŠ è½½æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ä¸ºæŒ‡å®šæœˆä»½ç”Ÿæˆæ€»ç»“
        async function generateSummaryForMonth(monthKey) {
            try {
                showMessage('æ­£åœ¨ç”Ÿæˆæœˆåº¦æ€»ç»“...', 'info');
                
                const response = await fetch('/api/summaries/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: monthKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('âœ… æœˆåº¦æ€»ç»“ç”ŸæˆæˆåŠŸï¼', 'success');
                    monthlySummaries[monthKey] = result.data;
                    renderTimeline();
                    displaySummary(result.data);
                } else {
                    showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæœˆåº¦æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // åˆ‡æ¢æ—¶é—´è½´å¹´ä»½
        function changeTimelineYear(offset) {
            currentTimelineYear += offset;
            initTimelineYearSelector();
            renderTimeline();
            loadTimelineData();
        }
        
        // é€‰æ‹©æ—¶é—´è½´å¹´ä»½
        function selectTimelineYear(year) {
            currentTimelineYear = year;
            initTimelineYearSelector();
            renderTimeline();
            loadTimelineData();
        }
        
        // åŠ è½½æ—¶é—´è½´æ•°æ®
        async function loadTimelineData() {
            try {
                // åŠ è½½è¯¥å¹´ä»½æ‰€æœ‰æœˆä»½çš„æ€»ç»“çŠ¶æ€
                const response = await fetch(`/api/summaries?year=${currentTimelineYear}`);
                const result = await response.json();
                
                if (result.success) {
                    monthlySummaries = {};
                    result.data.forEach(summary => {
                        monthlySummaries[summary.year_month] = summary;
                    });
                }
                
                // åŠ è½½è¯¥å¹´ä»½å„æœˆçš„æ—¥å¿—æ•°é‡
                for (let month = 0; month < 12; month++) {
                    const monthKey = `${currentTimelineYear}-${String(month + 1).padStart(2, '0')}`;
                    const countResponse = await fetch(`/api/growth-logs/count?month=${monthKey}`);
                    const countResult = await countResponse.json();
                    
                    if (countResult.success) {
                        monthlyLogsCount[monthKey] = countResult.count || 0;
                    }
                }
                
                renderTimeline();
                console.log('âœ… æ—¶é—´è½´æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½æ—¶é—´è½´æ•°æ®å¤±è´¥:', error);
            }
        }

        // ==================== äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ====================
        function setupEventListeners() {
            document.getElementById('main-image-input').addEventListener('change', handleMainImageUpload);
            document.getElementById('gallery-input').addEventListener('change', handleGalleryUpload);
            document.getElementById('farm-activity-type').addEventListener('change', handleFarmActivityChange);
            document.getElementById('log-date').addEventListener('change', handleDateChange);
            document.getElementById('plot-id').addEventListener('change', updateSyncFields);
            document.getElementById('recorder-name').addEventListener('input', updateSyncFields);
            document.getElementById('recorder-name').addEventListener('change', handleRecorderChange);
        }

        /**
         * å¤„ç†è®°å½•äººé€‰æ‹©å˜åŒ–ï¼Œæ›´æ–°å¤´åƒæ˜¾ç¤º
         */
        function handleRecorderChange() {
            const recorderSelect = document.getElementById('recorder-name');
            const selectedOption = recorderSelect.options[recorderSelect.selectedIndex];
            const avatarUrl = selectedOption.dataset.avatar || '';
            
            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            updateAvatar('recorder-avatar', avatarUrl);
        }

        /**
         * æ›´æ–°äººå‘˜å¤´åƒæ˜¾ç¤º
         * @param {string} containerId - å¤´åƒå®¹å™¨çš„ID
         * @param {string} avatarUrl - å¤´åƒURL
         */
        function updateAvatar(containerId, avatarUrl) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (avatarUrl && avatarUrl.trim() !== '') {
                // æœ‰å¤´åƒï¼Œæ˜¾ç¤ºå›¾ç‰‡
                container.innerHTML = `<img src="${avatarUrl}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
                container.innerHTML = '<span style="color: #999; font-size: 0.8rem;">æš‚æ— </span>';
            }
        }

        function handleDateChange() {
            const dateInput = document.getElementById('log-date').value;
            const editingId = document.getElementById('editing-log-id').value;
            
            // åœ¨æ–°çš„æ—¥å†è§†å›¾ä¸­ï¼Œé‡å¤æ—¥æœŸæ£€æŸ¥ç”±æ—¥å†æœ¬èº«å¤„ç†
            // ç”¨æˆ·é€šè¿‡ç‚¹å‡»æ—¥å†æ—¥æœŸæ¥ç¼–è¾‘å·²æœ‰è®°å½•
            if (!editingId && dateInput && monthLogsData[dateInput]) {
                const dateObj = new Date(dateInput);
                const dateStr = dateObj.toLocaleDateString('zh-CN');
                
                setTimeout(() => {
                    if (confirm(`è¯¥æ—¥æœŸï¼ˆ${dateStr}ï¼‰å·²æœ‰è®°å½•ã€‚\n\næ˜¯å¦è¦åŠ è½½è¯¥è®°å½•è¿›è¡Œç¼–è¾‘ï¼Ÿ`)) {
                        // é€šè¿‡æ—¥å†åŠŸèƒ½åŠ è½½è®°å½•
                        const logData = monthLogsData[dateInput];
                        if (logData && logData._id) {
                            editLog(logData._id);
                        }
                    } else {
                        // æ¸…ç©ºæ—¥æœŸï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
                        document.getElementById('log-date').value = '';
                    }
                }, 300);
            } else {
                updateSyncFields();
            }
        }

        function handleFarmActivityChange() {
            const activityType = document.getElementById('farm-activity-type').value;
            const detailSection = document.getElementById('farm-activity-detail-section');
            const activityLabel = document.getElementById('activity-details-label');
            const abnormalSection = document.getElementById('abnormal-event-section');
            
            // æ§åˆ¶å†œäº‹æ´»åŠ¨è¯¦æƒ…æ¡†
            if (activityType && activityType !== 'æ— ') {
                detailSection.classList.remove('hidden');
                
                const cleanActivityType = activityType.replace(/^[\u{1F000}-\u{1F9FF}]\s*/u, '').trim();
                activityLabel.textContent = cleanActivityType + 'è¯¦æƒ…';
                
                console.log('ğŸ”„ å†œäº‹æ´»åŠ¨æ ‡ç­¾å·²æ›´æ–°ä¸º:', cleanActivityType + 'è¯¦æƒ…');
            } else {
                detailSection.classList.add('hidden');
                activityLabel.textContent = 'æ´»åŠ¨è¯¦ç»†è®°å½•';
            }
            
            // æ§åˆ¶å¼‚å¸¸äº‹ä»¶è®°å½•æ˜¾ç¤º/éšè—
            const cleanActivityType = activityType.replace(/^[\u{1F000}-\u{1F9FF}]\s*/u, '').trim();
            if (cleanActivityType === 'å¼‚å¸¸') {
                abnormalSection.classList.remove('hidden');
                console.log('âš ï¸ å·²æ˜¾ç¤ºå¼‚å¸¸äº‹ä»¶è®°å½•ç¼–è¾‘æ¡†');
            } else {
                abnormalSection.classList.add('hidden');
                // éšè—æ—¶æ¸…ç©ºå¼‚å¸¸äº‹ä»¶å­—æ®µ
                document.getElementById('abnormal-title').value = '';
                document.getElementById('abnormal-description').value = '';
                document.getElementById('abnormal-measures').value = '';
                console.log('âœ… å·²éšè—å¼‚å¸¸äº‹ä»¶è®°å½•ç¼–è¾‘æ¡†');
            }
            
            // âŒ é‡‡æ‘˜ç›¸å…³é€»è¾‘å·²ç§»é™¤ - é‡‡æ‘˜è®°å½•ç»Ÿä¸€åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­ç®¡ç†
        }

        // ==================== æŸ¥è¯¢åŠŸèƒ½ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰====================
        // æ³¨ï¼šåœ¨æ–°çš„æ—¥å†è§†å›¾ä¸­ï¼Œè¿™äº›å‡½æ•°å·²ä¸å†ä½¿ç”¨
        // ç”¨æˆ·é€šè¿‡ç‚¹å‡»æ—¥å†æ—¥æœŸæ¥æŸ¥çœ‹å’Œç¼–è¾‘è®°å½•
        async function queryLogs() {
            // ç©ºå‡½æ•°ï¼Œä¿ç•™å…¼å®¹æ€§
            console.log('queryLogs() å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ—¥å†è§†å›¾');
        }

        function displayLogsList(logs) {
            // ç©ºå‡½æ•°ï¼Œä¿ç•™å…¼å®¹æ€§
            console.log('displayLogsList() å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ—¥å†è§†å›¾');
        }

        // ==================== ç¼–è¾‘åŠŸèƒ½ ====================
        async function editLog(id) {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...', 'info');
                
                const response = await fetch(`/api/growth-logs/${id}`);
                const result = await response.json();

                if (result.success) {
                    const log = result.data;
                    
                    document.getElementById('editing-log-id').value = id;
                    document.getElementById('editing-mode-banner').classList.remove('hidden');
                    
                    // æ˜¾ç¤ºç¼–è¾‘æ—¥æœŸ
                    const dateStr = log.date.split('T')[0];
                    document.getElementById('editing-date-display').textContent = `- æ­£åœ¨ç¼–è¾‘ï¼š${formatDateChinese(dateStr)}`;
                    
                    fillFormWithLogData(log);
                    
                    document.getElementById('save-btn').innerHTML = 'ğŸ’¾ æ›´æ–°æ­¤æ¡æ—¥å¿—';
                    
                    // ç¡®ä¿æ˜¾ç¤ºç¬¬ä¸€é¡µ
                    document.getElementById('detail-section').style.display = 'none';
                    document.getElementById('card-info-section').style.display = 'block';
                    document.getElementById('step-indicator-2').classList.remove('active');
                    document.getElementById('step-indicator-1').classList.add('active');
                    
                    // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
                    document.querySelector('.content-main').scrollTop = 0;
                    
                    showMessage('âœ… æ—¥å¿—æ•°æ®å·²åŠ è½½ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»æ›´æ–°æŒ‰é’®', 'success');
                    console.log('âœ… ç¼–è¾‘æ¨¡å¼ï¼šå·²åŠ è½½æ—¥å¿—æ•°æ®', log);
                } else {
                    showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function fillFormWithLogData(log) {
            document.getElementById('log-date').value = log.date.split('T')[0];
            document.getElementById('recorder-name').value = log.recorder_name || '';
            
            // æ›´æ–°è®°å½•äººå¤´åƒ
            const recorderSelect = document.getElementById('recorder-name');
            const selectedOption = recorderSelect.options[recorderSelect.selectedIndex];
            if (selectedOption) {
                const avatarUrl = selectedOption.dataset.avatar || '';
                updateAvatar('recorder-avatar', avatarUrl);
            }
            
            document.getElementById('summary').value = log.summary || '';
            
            mainImageUrl = log.main_image_url || '';
            document.getElementById('main-image-url').value = mainImageUrl;
            
            const mainImagePreview = document.getElementById('main-image-preview');
            const mainImagePreviewContainer = document.getElementById('main-image-preview-container');
            
            if (!mainImagePreview || !mainImagePreviewContainer) {
                console.warn('âš ï¸ ä¸»å›¾é¢„è§ˆèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæ— æ³•å¡«å……æ—¥å¿—ä¸»å›¾');
            } else if (mainImageUrl) {
                mainImagePreview.src = mainImageUrl;
                mainImagePreviewContainer.classList.remove('hidden');
            } else {
                // æ²¡æœ‰ä¸»å›¾æ—¶ç¡®ä¿é¢„è§ˆè¢«é‡ç½®
                mainImagePreview.src = '';
                mainImagePreviewContainer.classList.add('hidden');
            }
            
            document.getElementById('weather').value = log.weather?.icon || '';
            // æ›´æ–°å¤©æ°”å›¾æ ‡æ˜¾ç¤º
            updateWeatherIcon();
            
            // è§£ææ¸©åº¦èŒƒå›´
            const tempRange = log.weather?.temperature_range || '';
            if (tempRange) {
                // ç§»é™¤â„ƒç¬¦å·å¹¶æŒ‰~åˆ†å‰²
                const cleanTemp = tempRange.replace(/â„ƒ/g, '').trim();
                const temps = cleanTemp.split('~');
                if (temps.length === 2) {
                    document.getElementById('min-temperature').value = temps[0].trim();
                    document.getElementById('max-temperature').value = temps[1].trim();
                } else if (temps.length === 1) {
                    // åªæœ‰ä¸€ä¸ªå€¼ï¼Œæ”¾åœ¨æœ€ä½æ¸©åº¦
                    document.getElementById('min-temperature').value = temps[0].trim();
                    document.getElementById('max-temperature').value = '';
                }
            } else {
                document.getElementById('min-temperature').value = '';
                document.getElementById('max-temperature').value = '';
            }
            
            document.getElementById('plot-id').value = log.plot_id?._id || log.plot_id || '';
            const farmActivitySelect = document.getElementById('farm-activity-type');
            if (farmActivitySelect) {
                const normalizedValue = mapFarmActivityToDisplay(log.farm_activity_type);
                
                // å¦‚æœé€‰é¡¹åˆ—è¡¨ä¸­ä¸å­˜åœ¨è¯¥å€¼ï¼Œåˆ™å¼ºåˆ¶å›é€€åˆ°â€œæ— â€
                const hasOption = Array.from(farmActivitySelect.options).some(option => option.value === normalizedValue);
                farmActivitySelect.value = hasOption ? normalizedValue : 'æ— ';
            }
            // âŒ é‡‡æ‘˜é‡é‡å­—æ®µå·²ç§»é™¤
            
            handleFarmActivityChange();
            
            galleryUrls = log.detail_gallery || [];
            renderGallery();
            
            document.getElementById('sunshine-hours').value = log.environment_data?.sunshine_hours || '';
            document.getElementById('rainfall').value = log.environment_data?.rainfall || '';
            document.getElementById('avg-temperature').value = log.environment_data?.temperature || '';
            document.getElementById('humidity').value = log.environment_data?.humidity || '';
            
            document.getElementById('full-log').value = log.full_log || '';
            document.getElementById('phenological-observation').value = log.phenological_observation || '';
            document.getElementById('farm-activity-log').value = log.farm_activity_log || '';
            
            // å¡«å……å¼‚å¸¸äº‹ä»¶æ•°æ®
            document.getElementById('abnormal-title').value = log.abnormal_event?.title || '';
            document.getElementById('abnormal-description').value = log.abnormal_event?.description || '';
            document.getElementById('abnormal-measures').value = log.abnormal_event?.measures_taken || '';
            
            updateSyncFields();
        }

        function cancelEdit() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('editing-log-id').value = '';
                document.getElementById('editing-mode-banner').classList.add('hidden');
                document.getElementById('editing-date-display').textContent = '';
                document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
                
                clearForm();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('log-date').value = today;
                
                // å–æ¶ˆæ—¥å†é€‰ä¸­çŠ¶æ€
                selectedDate = null;
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('selected');
                });
                
                showMessage('å·²å–æ¶ˆç¼–è¾‘ï¼Œå¯ä»¥æ–°å¢æ—¥å¿—', 'info');
            }
        }

        // ==================== è¡¨å•å¯¼èˆªåŠŸèƒ½ ====================
        function cancelCardEdit() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('editing-log-id').value = '';
                document.getElementById('editing-mode-banner').classList.add('hidden');
                document.getElementById('editing-date-display').textContent = '';
                document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
                
                clearForm();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('log-date').value = today;
                
                // å–æ¶ˆæ—¥å†é€‰ä¸­çŠ¶æ€
                selectedDate = null;
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('selected');
                });
                
                showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
            }
        }

        function goToDetailSection() {
            // æ£€æŸ¥å¿…å¡«å­—æ®µ
            const date = document.getElementById('log-date').value;
            const summary = document.getElementById('summary').value.trim();
            const mainImage = document.getElementById('main-image-url').value;

            if (!date) {
                showMessage('è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'error');
                document.getElementById('log-date').focus();
                return;
            }

            if (!mainImage) {
                showMessage('è¯·å…ˆä¸Šä¼ ä¸»å›¾', 'error');
                return;
            }

            if (!summary) {
                showMessage('è¯·å…ˆå¡«å†™æ ¸å¿ƒæ—¥å¿—æ‘˜è¦', 'error');
                document.getElementById('summary').focus();
                return;
            }

            // åˆ‡æ¢åˆ°ç¬¬äºŒé¡µ
            document.getElementById('card-info-section').style.display = 'none';
            document.getElementById('detail-section').style.display = 'block';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById('step-indicator-1').classList.remove('active');
            document.getElementById('step-indicator-2').classList.add('active');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            const formContainer = document.querySelector('.content-main');
            if (formContainer) {
                formContainer.scrollTop = 0;
            }
            
            showMessage('âœ“ åŸºæœ¬ä¿¡æ¯å¡«å†™å®Œæ•´ï¼Œè¯·ç»§ç»­å¡«å†™è¯¦æƒ…é¡µä¿¡æ¯', 'success');
        }

        function goToPreviousPage() {
            // è¿”å›ç¬¬ä¸€é¡µ
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('card-info-section').style.display = 'block';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById('step-indicator-2').classList.remove('active');
            document.getElementById('step-indicator-1').classList.add('active');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            const formContainer = document.querySelector('.content-main');
            if (formContainer) {
                formContainer.scrollTop = 0;
            }
            
            showMessage('å·²è¿”å›å¡ç‰‡ä¿¡æ¯ç¼–è¾‘', 'info');
        }

        function clearForm() {
            document.getElementById('daily-log-form').reset();
            
            mainImageUrl = '';
            document.getElementById('main-image-url').value = '';
            document.getElementById('main-image-preview').src = '';
            document.getElementById('main-image-preview-container').classList.add('hidden');
            document.getElementById('main-image-input').value = '';
            
            galleryUrls = [];
            renderGallery();
            
            document.getElementById('farm-activity-detail-section').classList.add('hidden');
            // âŒ harvest-weight-section å·²ç§»é™¤
            
            // æ¸…ç©ºè®°å½•äººå¤´åƒ
            updateAvatar('recorder-avatar', '');
            
            // æ¸…ç©ºå¤©æ°”å›¾æ ‡
            document.getElementById('weather-icon-preview').style.display = 'none';
            document.getElementById('weather-icon-preview').src = '';
            
            updateSyncFields();
            
            // è¿”å›ç¬¬ä¸€é¡µ
            document.getElementById('detail-section').style.display = 'none';
            document.getElementById('card-info-section').style.display = 'block';
            document.getElementById('step-indicator-2').classList.remove('active');
            document.getElementById('step-indicator-1').classList.add('active');
        }

        // ==================== åˆ é™¤åŠŸèƒ½ ====================
        async function deleteLog(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åˆ é™¤æ—¥å¿—...', 'info');
                
                const response = await fetch(`/api/growth-logs/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æ—¥å¿—å·²æˆåŠŸåˆ é™¤', 'success');
                    // åˆ·æ–°æ—¥å†æ•°æ®
                    loadMonthLogs();
                    console.log('âœ… å·²åˆ é™¤æ—¥å¿—:', id);
                } else {
                    showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== ä¿å­˜åŠŸèƒ½ ====================
        async function saveLog() {
            try {
                const logDate = document.getElementById('log-date').value;
                const summary = document.getElementById('summary').value.trim();
                
                if (!logDate) {
                    showMessage('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                    return;
                }
                if (!summary) {
                    showMessage('è¯·å¡«å†™æ ¸å¿ƒæ—¥å¿—æ‘˜è¦', 'error');
                    return;
                }

                const editingId = document.getElementById('editing-log-id').value;
                const isEditMode = !!editingId;

                if (!isEditMode && !mainImageUrl) {
                    if (!confirm('å°šæœªä¸Šä¼ ä¸»å›¾ï¼Œç¡®å®šè¦ç»§ç»­ä¿å­˜å—ï¼Ÿ')) {
                        return;
                    }
                }

                // æ·»åŠ ä¿å­˜ç¡®è®¤
                const confirmMessage = isEditMode 
                    ? 'ç¡®å®šè¦ä¿å­˜å¯¹è¯¥æ—¥å¿—çš„ä¿®æ”¹å—ï¼Ÿ' 
                    : 'ç¡®å®šè¦ä¿å­˜è¿™æ¡æ—¥å¿—å—ï¼Ÿ';
                
                if (!confirm(confirmMessage)) {
                    showMessage('å·²å–æ¶ˆä¿å­˜', 'info');
                    return;
                }

                const farmActivityType = document.getElementById('farm-activity-type').value;
                const farmActivityLog = (farmActivityType === 'æ— ' || farmActivityType === '') 
                    ? '' 
                    : document.getElementById('farm-activity-log').value.trim();
                
                // âŒ é‡‡æ‘˜é‡é‡å­—æ®µå·²ç§»é™¤ - é‡‡æ‘˜è®°å½•ç»Ÿä¸€åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­ç®¡ç†
                const harvestWeight = 0;
                
                // æ”¶é›†å¼‚å¸¸äº‹ä»¶æ•°æ®
                const abnormalTitle = document.getElementById('abnormal-title').value.trim();
                const abnormalData = abnormalTitle ? {
                    title: abnormalTitle,
                    description: document.getElementById('abnormal-description').value.trim(),
                    severity: 'low',  // é»˜è®¤å€¼ï¼Œä¿æŒæ•°æ®åº“æ¨¡å‹å…¼å®¹
                    measures_taken: document.getElementById('abnormal-measures').value.trim()
                } : {
                    title: '',
                    description: '',
                    severity: 'low',
                    measures_taken: ''
                };
                
                // ç»„åˆæ¸©åº¦èŒƒå›´
                const minTemp = document.getElementById('min-temperature').value.trim();
                const maxTemp = document.getElementById('max-temperature').value.trim();
                let temperatureRange = '';
                if (minTemp && maxTemp) {
                    temperatureRange = `${minTemp}~${maxTemp}â„ƒ`;
                } else if (minTemp) {
                    temperatureRange = `${minTemp}â„ƒ`;
                } else if (maxTemp) {
                    temperatureRange = `${maxTemp}â„ƒ`;
                }
                
                const logData = {
                    date: logDate,
                    main_image_url: mainImageUrl,
                    recorder_name: document.getElementById('recorder-name').value.trim(),
                    plot_id: document.getElementById('plot-id').value || undefined,
                    farm_activity_type: farmActivityType,
                    harvest_weight_kg: harvestWeight,
                    weather: {
                        icon: document.getElementById('weather').value,
                        temperature_range: temperatureRange
                    },
                    summary: summary,
                    detail_gallery: galleryUrls,
                    photo_info: {
                        photographer: document.getElementById('recorder-name').value.trim(),
                        location: document.getElementById('photo-plot').value
                    },
                    environment_data: {
                        sunshine_hours: document.getElementById('sunshine-hours').value.trim(),
                        rainfall: document.getElementById('rainfall').value.trim(),
                        temperature: document.getElementById('avg-temperature').value.trim(),
                        humidity: document.getElementById('humidity').value.trim()
                    },
                    full_log: document.getElementById('full-log').value.trim(),
                    phenological_observation: document.getElementById('phenological-observation').value.trim(),
                    farm_activity_log: farmActivityLog,
                    abnormal_event: abnormalData
                };

                console.log('ğŸ“¤ å‡†å¤‡æäº¤æ—¥å¿—æ•°æ®:', logData);
                showMessage(isEditMode ? 'æ­£åœ¨æ›´æ–°æ—¥å¿—...' : 'æ­£åœ¨ä¿å­˜æ—¥å¿—...', 'info');

                const url = isEditMode ? `/api/growth-logs/${editingId}` : '/api/growth-logs';
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(isEditMode ? 'âœ… æ—¥å¿—æ›´æ–°æˆåŠŸï¼' : 'âœ… æ—¥å¿—ä¿å­˜æˆåŠŸï¼', 'success');
                    console.log(isEditMode ? 'âœ… æ—¥å¿—æ›´æ–°æˆåŠŸ:' : 'âœ… æ—¥å¿—ä¿å­˜æˆåŠŸ:', result.data);
                    
                    // åˆ·æ–°æ—¥å†æ•°æ®
                    loadMonthLogs();
                    
                    document.getElementById('editing-log-id').value = '';
                    document.getElementById('editing-mode-banner').classList.add('hidden');
                    document.getElementById('editing-date-display').textContent = '';
                    document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
                    
                    setTimeout(() => {
                        if (confirm('æ“ä½œæˆåŠŸï¼æ˜¯å¦ç»§ç»­æ·»åŠ æ–°æ—¥å¿—ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"æ¸…ç©ºè¡¨å•ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ä»ªè¡¨æ¿')) {
                            clearForm();
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('log-date').value = today;
                            selectedDate = null;
                            document.querySelectorAll('.calendar-day').forEach(day => {
                                day.classList.remove('selected');
                            });
                            document.querySelector('.content-main').scrollTop = 0;
                        } else {
                            window.location.href = '/dashboard';
                        }
                    }, 1500);
                } else {
                    showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
                    console.error('ä¿å­˜å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('ä¿å­˜æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== å›¾ç‰‡å¤„ç† ====================
        async function handleMainImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showMessage('æ­£åœ¨ä¸Šä¼ ä¸»å›¾...', 'info');
            try {
                const url = await uploadImage(file);
                if (url) {
                    mainImageUrl = url;
                    document.getElementById('main-image-url').value = url;
                    const preview = document.getElementById('main-image-preview');
                    const container = document.getElementById('main-image-preview-container');
                    preview.src = url;
                    container.classList.remove('hidden');
                    showMessage('ä¸»å›¾ä¸Šä¼ æˆåŠŸï¼', 'success');
                    console.log('âœ… ä¸»å›¾ä¸Šä¼ æˆåŠŸ:', url);
                }
            } catch (error) {
                showMessage('ä¸»å›¾ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function removeMainImage() {
            if (confirm('ç¡®å®šè¦åˆ é™¤ä¸»å›¾å—ï¼Ÿ')) {
                mainImageUrl = '';
                document.getElementById('main-image-url').value = '';
                document.getElementById('main-image-preview').src = '';
                document.getElementById('main-image-preview-container').classList.add('hidden');
                document.getElementById('main-image-input').value = '';
                showMessage('ä¸»å›¾å·²åˆ é™¤', 'info');
            }
        }

        async function handleGalleryUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            showMessage(`æ­£åœ¨ä¸Šä¼  ${files.length} å¼ å›¾ç‰‡...`, 'info');
            for (let file of files) {
                try {
                    const url = await uploadImage(file);
                    if (url) {
                        galleryUrls.push(url);
                        console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', url);
                    }
                } catch (error) {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                }
            }
            renderGallery();
            showMessage(`æˆåŠŸä¸Šä¼  ${files.length} å¼ å›¾ç‰‡ï¼`, 'success');
            event.target.value = '';
        }

        function renderGallery() {
            const container = document.getElementById('gallery-preview');
            if (galleryUrls.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = galleryUrls.map((url, index) => `
                <div class="gallery-item">
                    <img src="${url}" alt="å›¾ç‰‡ ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeGalleryImage(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removeGalleryImage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                galleryUrls.splice(index, 1);
                renderGallery();
                showMessage('å›¾ç‰‡å·²åˆ é™¤', 'info');
            }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                return result.data.fullUrl;
            } else {
                throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
            }
        }

        function updateSyncFields() {
            const logDate = document.getElementById('log-date').value;
            document.getElementById('photo-date').value = logDate || '';
            const plotId = document.getElementById('plot-id').value;
            const selectedPlot = availablePlots.find(p => p._id === plotId);
            document.getElementById('photo-plot').value = selectedPlot ? selectedPlot.name : '';
            const recorderName = document.getElementById('recorder-name').value;
            document.getElementById('photo-person').value = recorderName || '';
        }

        // ==================== é¡¶éƒ¨å½±åƒç”»å»Šç®¡ç† ====================
        
        // å¤„ç†é¡¶éƒ¨ç”»å»Šä¸Šä¼ 
        async function handleTopGalleryUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            showMessage(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`, 'info');
            
            for (let file of files) {
                try {
                    const url = await uploadImage(file);
                    if (url) {
                        topGalleryUrls.push(url);
                        console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', url);
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                }
            }
            
            renderTopGallery();
            showMessage(`æˆåŠŸä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶ï¼`, 'success');
            event.target.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }

        // æ¸²æŸ“é¡¶éƒ¨å½±åƒç”»å»Š
        function renderTopGallery() {
            const container = document.getElementById('top-gallery-preview');
            
            if (topGalleryUrls.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">æš‚æ— å½±åƒï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹ä¸Šä¼ </p>';
                return;
            }
            
            container.innerHTML = topGalleryUrls.map((url, index) => {
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯è§†é¢‘
                const isVideo = url.toLowerCase().match(/\.(mp4|webm|ogg)$/);
                
                return `
                    <div class="gallery-item">
                        ${isVideo ? 
                            `<video src="${url}" style="width: 100%; height: 150px; object-fit: cover;"></video>` :
                            `<img src="${url}" alt="å½±åƒ ${index + 1}">`
                        }
                        <button type="button" class="remove-btn" onclick="removeTopGalleryImage(${index})">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤é¡¶éƒ¨ç”»å»Šä¸­çš„å›¾ç‰‡
        function removeTopGalleryImage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                topGalleryUrls.splice(index, 1);
                renderTopGallery();
                showMessage('æ–‡ä»¶å·²åˆ é™¤', 'info');
            }
        }

        // ==================== æœˆä»½æ€»ç»“åŠŸèƒ½ ====================
        
        // è·å–å¹¶æ¸²æŸ“æ‰€æœ‰å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“åˆ—è¡¨ - å·²åºŸå¼ƒï¼Œä½¿ç”¨æ—¶é—´è½´ä»£æ›¿
        async function fetchAndRenderSummaries() {
            try {
                const response = await fetch('/api/summaries');
                const result = await response.json();

                if (result.success) {
                    displaySummaryList(result.data);
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªæœˆåº¦æ€»ç»“');
                } else {
                    showMessage('âŒ åŠ è½½åˆ—è¡¨å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('è·å–æœˆåº¦æ€»ç»“åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ¸²æŸ“æœˆåº¦æ€»ç»“åˆ—è¡¨ - å·²åºŸå¼ƒï¼Œä½¿ç”¨æ—¶é—´è½´ä»£æ›¿
        function displaySummaryList(summaries) {
            const container = document.getElementById('summary-list-container');
            
            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ
            if (!container) {
                console.log('âš ï¸ summary-list-container ä¸å­˜åœ¨ï¼Œæ­¤åŠŸèƒ½å·²è¢«æ—¶é—´è½´é€‰æ‹©å™¨å–ä»£');
                return;
            }
            
            if (!summaries || summaries.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">æš‚æ— å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“</p>';
                return;
            }

            container.innerHTML = summaries.map(summary => {
                // æ ¼å¼åŒ–å¹´æœˆæ˜¾ç¤º
                const [year, month] = summary.year_month.split('-');
                const displayMonth = `${year}å¹´${parseInt(month)}æœˆ`;
                
                // æå–å…³é”®ç»Ÿè®¡ä¿¡æ¯
                const harvestCount = summary.harvest_stats?.count || 0;
                const harvestWeight = summary.harvest_stats?.total_weight || 0;
                const farmActivitiesCount = summary.farm_calendar ? summary.farm_calendar.split('\n').filter(line => line.trim()).length : 0;
                
                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <h4>ğŸ“… ${displayMonth} æ€»ç»“</h4>
                            <p>é‡‡æ‘˜ ${harvestCount} æ¬¡ / ${harvestWeight}kg Â· å†œäº‹æ´»åŠ¨ ${farmActivitiesCount} é¡¹ Â· å›¾ç‰‡ ${summary.detail_gallery?.length || 0} å¼ </p>
                        </div>
                        <div class="log-item-actions">
                            <button class="btn btn-secondary btn-small" onclick="editSummary('${summary._id}')">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteSummary('${summary._id}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç¼–è¾‘æœˆåº¦æ€»ç»“
        async function editSummary(id) {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ€»ç»“æ•°æ®...', 'info');
                
                const response = await fetch(`/api/monthly-summaries/${id}`);
                const result = await response.json();

                if (result.success) {
                    const summary = result.data;
                    
                    // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                    document.getElementById('editing-summary-id').value = id;
                    document.getElementById('editing-summary-banner').classList.remove('hidden');
                    
                    // å¡«å……æ•°æ®åˆ°è¡¨å•
                    displaySummary(summary);
                    
                    // æ»šåŠ¨åˆ°ç¼–è¾‘è¡¨å•
                    document.getElementById('summary-display').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    showMessage('âœ… æ€»ç»“æ•°æ®å·²åŠ è½½ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»ä¿å­˜æŒ‰é’®', 'success');
                    console.log('âœ… ç¼–è¾‘æ¨¡å¼ï¼šå·²åŠ è½½æ€»ç»“æ•°æ®', summary);
                } else {
                    showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ€»ç»“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // åˆ é™¤æœˆåº¦æ€»ç»“ï¼ˆä»åˆ—è¡¨ä¸­åˆ é™¤ï¼‰
        async function deleteSummary(id) {
            // è·å–è¦åˆ é™¤çš„æ€»ç»“ä¿¡æ¯
            const summaryElement = event.target.closest('.log-item');
            const summaryTitle = summaryElement.querySelector('h4').textContent;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${summaryTitle}"å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åˆ é™¤æ€»ç»“...', 'info');
                
                const response = await fetch(`/api/monthly-summaries/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æ€»ç»“å·²æˆåŠŸåˆ é™¤', 'success');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                    
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘è¿™æ¡è®°å½•ï¼Œå–æ¶ˆç¼–è¾‘æ¨¡å¼
                    if (document.getElementById('editing-summary-id').value === id) {
                        cancelSummaryEdit();
                    }
                    
                    console.log('âœ… å·²åˆ é™¤æ€»ç»“:', id);
                } else {
                    showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å½“å‰æŸ¥çœ‹/ç¼–è¾‘çš„æœˆåº¦æ€»ç»“
        async function deleteCurrentSummary() {
            // è·å–å½“å‰æ€»ç»“ID
            const editingId = document.getElementById('editing-summary-id').value;
            const summaryId = editingId || currentSummaryId;
            
            if (!summaryId) {
                showMessage('âŒ æ— æ³•åˆ é™¤ï¼šæœªæ‰¾åˆ°æ€»ç»“ID', 'error');
                return;
            }
            
            // è·å–æœˆä»½ä¿¡æ¯
            const monthValue = document.getElementById('summary-month').value;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${monthValue} çš„æœˆåº¦æ€»ç»“å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åˆ é™¤æ€»ç»“...', 'info');
                
                const response = await fetch(`/api/monthly-summaries/${summaryId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æ€»ç»“å·²æˆåŠŸåˆ é™¤', 'success');
                    
                    // æ¸…ç©ºå½“å‰æ€»ç»“
                    currentSummaryId = null;
                    document.getElementById('editing-summary-id').value = '';
                    
                    // éšè—æ€»ç»“æ˜¾ç¤ºåŒºåŸŸå’Œåˆ é™¤æŒ‰é’®
                    document.getElementById('summary-display').classList.add('hidden');
                    document.getElementById('delete-summary-container').style.display = 'none';
                    
                    // éšè—ç¼–è¾‘æ¨¡å¼æ¨ªå¹…
                    document.getElementById('editing-summary-banner').classList.add('hidden');
                    
                    // åˆ·æ–°æ—¶é—´è½´å’Œåˆ—è¡¨
                    await loadTimelineData();
                    renderTimeline();
                    
                    // å¦‚æœæœ‰æ—§ç‰ˆåˆ—è¡¨ï¼Œä¹Ÿåˆ·æ–°
                    if (typeof fetchAndRenderSummaries === 'function') {
                        fetchAndRenderSummaries();
                    }
                    
                    console.log('âœ… å·²åˆ é™¤æ€»ç»“:', summaryId);
                } else {
                    showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å–æ¶ˆç¼–è¾‘æ€»ç»“
        function cancelSummaryEdit() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('editing-summary-id').value = '';
                document.getElementById('editing-summary-banner').classList.add('hidden');
                document.getElementById('summary-display').classList.add('hidden');
                document.getElementById('delete-summary-container').style.display = 'none';
                currentSummaryId = null;
                
                // æ¸…ç©ºé¡¶éƒ¨ç”»å»Š
                topGalleryUrls = [];
                renderTopGallery();
                
                showMessage('å·²å–æ¶ˆç¼–è¾‘ï¼Œå¯ä»¥ç”Ÿæˆæ–°çš„æ€»ç»“', 'info');
            }
        }

        async function generateSummary() {
            const month = document.getElementById('summary-month').value;
            if (!month) {
                showMessage('è¯·é€‰æ‹©è¦ç”Ÿæˆæ€»ç»“çš„æœˆä»½', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ä¸º ${month} ç”Ÿæˆæœˆåº¦æ€»ç»“å—ï¼Ÿ\nå¦‚æœè¯¥æœˆå·²æœ‰æ€»ç»“ï¼Œå°†ä¼šè¢«æ›´æ–°ã€‚`)) {
                return;
            }

            try {
                showMessage('æ­£åœ¨ç”Ÿæˆæœˆåº¦æ€»ç»“...', 'info');
                
                const response = await fetch('/api/summaries/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: month })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æœˆåº¦æ€»ç»“ç”ŸæˆæˆåŠŸï¼', 'success');
                    console.log('âœ… æœˆåº¦æ€»ç»“:', result.data);
                    
                    // è‡ªåŠ¨æ˜¾ç¤ºç”Ÿæˆçš„æ€»ç»“
                    displaySummary(result.data);
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                } else {
                    showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæœˆåº¦æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
            }
        }


        function displaySummary(summary) {
            // å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè®¾ç½® currentSummaryId
            const editingId = document.getElementById('editing-summary-id').value;
            if (!editingId) {
                currentSummaryId = summary._id;
            }
            
            // å¡«å……é‡‡æ‘˜ç»Ÿè®¡åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†
            document.getElementById('harvest-count').value = summary.harvest_stats?.count || 0;
            document.getElementById('harvest-weight').value = summary.harvest_stats?.total_weight || 0;
            
            // å¡«å……å†œäº‹æ—¥å†åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            document.getElementById('farm-calendar-display').value = summary.farm_calendar || '';
            
            // å¡«å……å¼‚å¸¸äº‹ä»¶æ±‡æ€»åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            const abnormalDisplay = document.getElementById('abnormal-events-display');
            if (summary.abnormal_summary && summary.abnormal_summary.length > 0) {
                // å°†å¼‚å¸¸äº‹ä»¶æ•°ç»„è½¬æ¢ä¸ºå¯ç¼–è¾‘çš„æ–‡æœ¬æ ¼å¼
                const abnormalText = summary.abnormal_summary.map(event => 
                    `${event.date} ${event.issue}ï¼Œ${event.measures}`
                ).join('\n');
                abnormalDisplay.value = abnormalText;
            } else {
                abnormalDisplay.value = '';
            }
            
            // å¡«å……æ°”å€™æ€»ç»“åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†
            document.getElementById('avg-temp-display').value = summary.climate_summary?.avg_temp || '';
            document.getElementById('total-precipitation-display').value = summary.climate_summary?.total_precipitation || '';
            
            // å¡«å……é¡¶éƒ¨å½±åƒç”»å»Š
            topGalleryUrls = summary.detail_gallery || [];
            renderTopGallery();
            
            // å¡«å……ä¸‹æœˆè®¡åˆ’åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            const plans = summary.next_month_plan || [];
            document.getElementById('next-month-plan').value = plans.join('\n');
            
            // æ˜¾ç¤ºæ€»ç»“åŒºåŸŸ
            document.getElementById('summary-display').classList.remove('hidden');
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼ˆå¦‚æœæœ‰æ€»ç»“IDï¼‰
            if (summary._id) {
                document.getElementById('delete-summary-container').style.display = 'block';
            } else {
                document.getElementById('delete-summary-container').style.display = 'none';
            }
            
            console.log('âœ… æœˆåº¦æ€»ç»“æ•°æ®å·²å¡«å……åˆ°è¡¨å•ï¼Œå¯ä»¥è¿›è¡Œç¼–è¾‘');
        }

        async function saveAllSummaryChanges() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è¦ä¿å­˜çš„æ€»ç»“ï¼ˆç¼–è¾‘æ¨¡å¼æˆ–ç”Ÿæˆåçš„æ€»ç»“ï¼‰
            const editingId = document.getElementById('editing-summary-id').value;
            const summaryId = editingId || currentSummaryId;
            
            if (!summaryId) {
                showMessage('è¯·å…ˆç”Ÿæˆæˆ–åŠ è½½æœˆåº¦æ€»ç»“', 'error');
                return;
            }

            // æ·»åŠ ä¿å­˜ç¡®è®¤
            if (!confirm('ç¡®å®šè¦ä¿å­˜æœˆåº¦æ€»ç»“çš„æ‰€æœ‰ä¿®æ”¹å—ï¼Ÿ')) {
                showMessage('å·²å–æ¶ˆä¿å­˜', 'info');
                return;
            }

            try {
                // 1. æ”¶é›†é‡‡æ‘˜ç»Ÿè®¡æ•°æ®ï¼ˆåªè¯»ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼‰
                // æ³¨æ„ï¼šé‡‡æ‘˜ç»Ÿè®¡æ•°æ®æ¥è‡ª"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­çš„é‡‡æ‘˜è®°å½•ï¼Œæ­¤å¤„åªè¯»å–ç³»ç»Ÿè®¡ç®—çš„å€¼
                const harvestCount = parseInt(document.getElementById('harvest-count').value) || 0;
                const harvestWeight = parseFloat(document.getElementById('harvest-weight').value) || 0;
                
                // 2. æ”¶é›†å†œäº‹æ—¥å†æ•°æ®
                const farmCalendar = document.getElementById('farm-calendar-display').value.trim();
                
                // 3. æ”¶é›†å¹¶è§£æå¼‚å¸¸äº‹ä»¶æ±‡æ€»
                const abnormalText = document.getElementById('abnormal-events-display').value.trim();
                const abnormalSummary = [];
                if (abnormalText) {
                    // ç®€å•è§£æï¼šæ¯è¡Œä¸€ä¸ªäº‹ä»¶ï¼Œæ ¼å¼ï¼šæ—¥æœŸ é—®é¢˜ï¼Œæªæ–½
                    const lines = abnormalText.split('\n').filter(line => line.trim());
                    lines.forEach(line => {
                        // å°è¯•æå–æ—¥æœŸã€é—®é¢˜å’Œæªæ–½
                        const match = line.match(/^(\S+)\s+(.+?)ï¼Œ(.+)$/);
                        if (match) {
                            abnormalSummary.push({
                                date: match[1],
                                issue: match[2],
                                measures: match[3]
                            });
                        } else {
                            // å¦‚æœæ ¼å¼ä¸åŒ¹é…ï¼Œå°†æ•´è¡Œä½œä¸ºé—®é¢˜
                            abnormalSummary.push({
                                date: '',
                                issue: line,
                                measures: ''
                            });
                        }
                    });
                }
                
                // 4. æ”¶é›†æ°”å€™æ€»ç»“æ•°æ®
                const avgTemp = document.getElementById('avg-temp-display').value.trim();
                const totalPrecipitation = document.getElementById('total-precipitation-display').value.trim();
                
                // 5. æ”¶é›†ä¸‹æœˆè®¡åˆ’æ•°æ®
                const planText = document.getElementById('next-month-plan').value.trim();
                const nextMonthPlan = planText.split('\n').filter(line => line.trim()).map(line => line.trim());

                // 6. æ„å»ºå®Œæ•´çš„æ›´æ–°å¯¹è±¡
                const summaryData = {
                    detail_gallery: topGalleryUrls, // åŒ…å«é¡¶éƒ¨å½±åƒç”»å»Š
                    harvest_stats: {
                        count: harvestCount,
                        total_weight: harvestWeight
                    },
                    farm_calendar: farmCalendar,
                    abnormal_summary: abnormalSummary,
                    climate_summary: {
                        avg_temp: avgTemp,
                        total_precipitation: totalPrecipitation
                    },
                    next_month_plan: nextMonthPlan
                };

                console.log('ğŸ“¤ å‡†å¤‡ä¿å­˜æœˆåº¦æ€»ç»“:', summaryData);
                showMessage('æ­£åœ¨ä¿å­˜æ‰€æœ‰ä¿®æ”¹...', 'info');
                
                // 7. å‘é€ PUT è¯·æ±‚æ›´æ–°æ•°æ®
                const response = await fetch(`/api/monthly-summaries/${summaryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(summaryData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æœˆåº¦æ€»ç»“ä¿å­˜æˆåŠŸï¼æ‰€æœ‰ä¿®æ”¹å·²æ›´æ–°', 'success');
                    console.log('âœ… æœˆåº¦æ€»ç»“å·²æ›´æ–°:', result.data);
                    
                    // é‡æ–°æ˜¾ç¤ºæ›´æ–°åçš„æ•°æ®
                    displaySummary(result.data);
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                    
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
                    if (editingId) {
                        document.getElementById('editing-summary-id').value = '';
                        document.getElementById('editing-summary-banner').classList.add('hidden');
                        currentSummaryId = result.data._id;
                    }
                } else {
                    showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜æœˆåº¦æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== æ¶ˆæ¯æç¤º ====================
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const className = type === 'success' ? 'success-message' : 
                            type === 'error' ? 'error-message' : 'info-box';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            if (type !== 'error') {
                setTimeout(() => { container.innerHTML = ''; }, 5000);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>


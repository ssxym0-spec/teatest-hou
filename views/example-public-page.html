<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒ¶å›­è¿½æº¯ - å…¬å¼€å±•ç¤ºé¡µé¢ç¤ºä¾‹</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2e7d32; text-align: center; margin-bottom: 2rem; }
        
        /* äººå‘˜ä¿¡æ¯å¡ç‰‡ */
        .person-card {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .person-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
            border: 3px solid #66bb6a;
        }
        .person-info { flex: 1; }
        .person-name { font-size: 1.2rem; font-weight: 600; color: #333; margin-bottom: 0.3rem; }
        .person-role { color: #666; font-size: 0.9rem; }
        .person-experience { color: #999; font-size: 0.85rem; }
        
        /* æ—¥å¿—å¡ç‰‡ */
        .log-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .log-date { font-size: 1.1rem; font-weight: 600; color: #2e7d32; }
        .log-summary { margin-top: 0.5rem; color: #555; line-height: 1.6; }
        
        /* æ‰¹æ¬¡å¡ç‰‡ */
        .batch-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .batch-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #d84315;
            margin-bottom: 1rem;
        }
        .batch-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ èŒ¶å›­è¿½æº¯ç³»ç»Ÿ - å…¬å¼€å±•ç¤ºé¡µé¢</h1>
        
        <h2 style="color: #2e7d32; margin-top: 2rem; margin-bottom: 1rem;">ğŸ“… ç”Ÿé•¿æ—¥å¿—</h2>
        <div id="growth-logs-container"></div>
        
        <h2 style="color: #d84315; margin-top: 3rem; margin-bottom: 1rem;">ğŸ“¦ åˆ¶ä½œæ‰¹æ¬¡</h2>
        <div id="batches-container"></div>
    </div>

    <script>
        // ============================================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºäººå‘˜å¡ç‰‡
        // ============================================================
        function renderPersonCard(personData, defaultName = 'æœªçŸ¥') {
            // æ£€æŸ¥æ˜¯å¦æœ‰ populate åçš„äººå‘˜æ•°æ®
            if (personData && typeof personData === 'object' && personData.name) {
                // âœ… æœ‰å®Œæ•´çš„äººå‘˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¤´åƒï¼‰
                return `
                    <div class="person-card">
                        <img 
                            src="${personData.avatar_url || '/default-avatar.png'}" 
                            alt="${personData.name}"
                            class="person-avatar"
                            onerror="this.src='/default-avatar.png'"
                        >
                        <div class="person-info">
                            <div class="person-name">${personData.name}</div>
                            <div class="person-role">${personData.role || ''}</div>
                            ${personData.experience_years ? `<div class="person-experience">ç»éªŒï¼š${personData.experience_years}å¹´</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                // âŒ åªæœ‰å§“åï¼ˆæ—§æ•°æ®æˆ–æœªå…³è”ï¼‰
                return `
                    <div class="person-card">
                        <img 
                            src="/default-avatar.png" 
                            alt="${defaultName}"
                            class="person-avatar"
                        >
                        <div class="person-info">
                            <div class="person-name">${defaultName}</div>
                            <div class="person-role" style="color: #999;">æš‚æ— è¯¦ç»†ä¿¡æ¯</div>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================================
        // åŠ è½½ç”Ÿé•¿æ—¥å¿—
        // ============================================================
        async function loadGrowthLogs() {
            const container = document.getElementById('growth-logs-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                // è·å–å½“å‰æœˆä»½
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                
                const response = await fetch(`/api/public/growth-data?month=${currentMonth}`);
                const result = await response.json();
                
                if (!result.success || !result.data || !result.data.dailyLogs) {
                    container.innerHTML = '<div class="error-message">æš‚æ— ç”Ÿé•¿æ—¥å¿—æ•°æ®</div>';
                    return;
                }
                
                const logs = result.data.dailyLogs;
                
                if (logs.length === 0) {
                    container.innerHTML = '<div class="error-message">æœ¬æœˆæš‚æ— ç”Ÿé•¿æ—¥å¿—</div>';
                    return;
                }
                
                container.innerHTML = logs.map(log => {
                    // æ ¼å¼åŒ–æ—¥æœŸ
                    const date = new Date(log.date).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    // âœ… å…³é”®ï¼šä½¿ç”¨ recorder_idï¼ˆpopulateåçš„å¯¹è±¡ï¼‰æ¥æ˜¾ç¤ºå¤´åƒ
                    // å¦‚æœæ²¡æœ‰ recorder_idï¼Œåˆ™ä½¿ç”¨ recorder_name
                    const recorderName = log.recorder_id?.name || log.recorder_name || 'æœªçŸ¥';
                    
                    return `
                        <div class="log-card">
                            <div class="log-header">
                                <div class="log-date">ğŸ“… ${date}</div>
                                <div class="log-summary">${log.summary || 'æš‚æ— æ‘˜è¦'}</div>
                            </div>
                            
                            <div class="batch-section">
                                <div class="section-title">ğŸ‘¤ è®°å½•äºº</div>
                                ${renderPersonCard(log.recorder_id, recorderName)}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('åŠ è½½ç”Ÿé•¿æ—¥å¿—å¤±è´¥:', error);
                container.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        // ============================================================
        // åŠ è½½åˆ¶ä½œæ‰¹æ¬¡
        // ============================================================
        async function loadBatches() {
            const container = document.getElementById('batches-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch('/api/public/batches');
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    container.innerHTML = '<div class="error-message">æš‚æ— æ‰¹æ¬¡æ•°æ®</div>';
                    return;
                }
                
                const batches = result.data;
                
                if (batches.length === 0) {
                    container.innerHTML = '<div class="error-message">æš‚æ— å·²å‘å¸ƒçš„æ‰¹æ¬¡</div>';
                    return;
                }
                
                container.innerHTML = batches.map(batch => {
                    // âœ… å…³é”®ï¼šä½¿ç”¨ tea_master_idï¼ˆpopulateåçš„å¯¹è±¡ï¼‰æ¥æ˜¾ç¤ºå¤´åƒ
                    const teaMasterName = batch.tea_master_id?.name || batch.tea_master?.name || 'æœªçŸ¥';
                    
                    return `
                        <div class="batch-card">
                            <div class="batch-header">ğŸ“¦ ${batch.batch_number || 'æœªçŸ¥æ‰¹æ¬¡'}</div>
                            <div><strong>å“ç±»ï¼š</strong>${batch.category_name || 'æœªçŸ¥'}</div>
                            
                            <div class="batch-section">
                                <div class="section-title">ğŸ‘¨â€ğŸ³ åˆ¶èŒ¶å¸ˆ</div>
                                ${renderPersonCard(batch.tea_master_id, teaMasterName)}
                            </div>
                            
                            <button onclick="viewBatchDetail('${batch._id}')" 
                                    style="margin-top: 1rem; padding: 0.5rem 1rem; background: #d84315; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('åŠ è½½æ‰¹æ¬¡å¤±è´¥:', error);
                container.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        // ============================================================
        // æŸ¥çœ‹æ‰¹æ¬¡è¯¦æƒ…
        // ============================================================
        async function viewBatchDetail(batchId) {
            try {
                const response = await fetch(`/api/public/batches/${batchId}`);
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    alert('åŠ è½½æ‰¹æ¬¡è¯¦æƒ…å¤±è´¥');
                    return;
                }
                
                const batch = result.data;
                
                // æ„å»ºè¯¦æƒ…HTML
                let detailHTML = `
                    <h2>æ‰¹æ¬¡è¯¦æƒ…ï¼š${batch.batch_number}</h2>
                    <p><strong>å“ç±»ï¼š</strong>${batch.category_name}</p>
                    <hr style="margin: 1rem 0;">
                `;
                
                // âœ… åˆ¶èŒ¶å¸ˆä¿¡æ¯
                if (batch.tea_master_id) {
                    detailHTML += `
                        <h3>ğŸ‘¨â€ğŸ³ åˆ¶èŒ¶å¸ˆ</h3>
                        ${renderPersonCard(batch.tea_master_id, batch.tea_master?.name)}
                        <hr style="margin: 1rem 0;">
                    `;
                }
                
                // âœ… é‡‡æ‘˜è®°å½•ï¼ˆå«é‡‡æ‘˜é˜Ÿé•¿ï¼‰
                if (batch.harvest_records_ids && batch.harvest_records_ids.length > 0) {
                    detailHTML += '<h3>ğŸŒ¿ é‡‡æ‘˜è®°å½•</h3>';
                    batch.harvest_records_ids.forEach((record, index) => {
                        const harvestDate = new Date(record.harvest_date).toLocaleDateString('zh-CN');
                        const teamLeaderName = record.harvest_team_id?.name || record.harvest_team?.leader_name || 'æœªçŸ¥';
                        
                        detailHTML += `
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 5px;">
                                <p><strong>é‡‡æ‘˜æ—¥æœŸï¼š</strong>${harvestDate}</p>
                                <p><strong>é²œå¶é‡é‡ï¼š</strong>${record.fresh_leaf_weight_kg || 0} kg</p>
                                <div style="margin-top: 1rem;">
                                    <strong>ğŸ‘¥ é‡‡æ‘˜é˜Ÿé•¿</strong>
                                    ${renderPersonCard(record.harvest_team_id, teamLeaderName)}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // æ˜¾ç¤ºåœ¨å¼¹çª—æˆ–æ–°é¡µé¢
                const detailWindow = window.open('', '_blank', 'width=800,height=600');
                detailWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>æ‰¹æ¬¡è¯¦æƒ…</title>
                        <style>
                            body { font-family: Arial; padding: 2rem; }
                            .person-card { display: flex; align-items: center; background: white; border-radius: 10px; padding: 1rem; margin: 0.5rem 0; border: 1px solid #ddd; }
                            .person-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 1rem; border: 2px solid #66bb6a; }
                            .person-info { flex: 1; }
                            .person-name { font-weight: 600; }
                            .person-role { color: #666; font-size: 0.9rem; }
                        </style>
                    </head>
                    <body>
                        ${detailHTML}
                    </body>
                    </html>
                `);
                
            } catch (error) {
                console.error('åŠ è½½æ‰¹æ¬¡è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥');
            }
        }

        // ============================================================
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadGrowthLogs();
            loadBatches();
        });
    </script>
</body>
</html>


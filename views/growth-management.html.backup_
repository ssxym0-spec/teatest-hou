<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿé•¿è¿‡ç¨‹ç®¡ç† - å®Œæ•´ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .header h1 { color: #2e7d32; font-size: 1.8rem; margin-bottom: 0.5rem; }
        .header .subtitle { color: #666; font-size: 0.9rem; }
        .nav-buttons { margin-top: 1rem; display: flex; gap: 1rem; }
        .nav-btn {
            background: #6c757d; color: white; text-decoration: none;
            padding: 0.5rem 1rem; border-radius: 5px; font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        .nav-btn:hover { background: #5a6268; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem 4rem; }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs-navigation {
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-button {
            flex: 1;
            padding: 1.2rem;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .tab-button.active {
            background: white;
            color: #2e7d32;
            border-bottom-color: #66bb6a;
        }
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .tab-content.active {
            display: block;
        }
        
        /* è¡¨å•å¡ç‰‡æ ·å¼ */
        .form-card {
            background: white; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; margin-bottom: 2rem;
        }
        .card-header {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white; padding: 1.5rem 2rem;
            font-size: 1.3rem; font-weight: 600;
        }
        .card-header-secondary {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }
        .card-body { padding: 2rem; }
        .section-title {
            color: #2e7d32; font-size: 1.1rem; font-weight: 600;
            margin-bottom: 1rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid #66bb6a;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block; color: #333; font-weight: 500; margin-bottom: 0.5rem;
        }
        .form-group label .required { color: #dc3545; margin-left: 3px; }
        .form-control {
            width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 0.9rem; transition: all 0.3s;
        }
        .form-control:focus {
            outline: none; border-color: #66bb6a;
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.1);
        }
        textarea.form-control {
            min-height: 100px; resize: vertical; font-family: inherit;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .image-upload-area {
            border: 2px dashed #66bb6a; border-radius: 8px; padding: 2rem;
            text-align: center; background: #f5f5f5; cursor: pointer;
            transition: all 0.3s;
        }
        .image-upload-area:hover {
            background: #e8f5e9; border-color: #43a047;
        }
        .image-preview-container { margin-top: 1rem; position: relative; }
        .image-preview {
            max-width: 100%; max-height: 300px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .image-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem; margin-top: 1rem;
        }
        .gallery-item {
            position: relative; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .gallery-item img {
            width: 100%; height: 150px; object-fit: cover;
        }
        .gallery-item .remove-btn {
            position: absolute; top: 5px; right: 5px; background: #dc3545;
            color: white; border: none; border-radius: 50%;
            width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .gallery-item .remove-btn:hover {
            background: #c82333; transform: scale(1.1);
        }
        .btn {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white; border: none; padding: 0.75rem 2rem;
            border-radius: 8px; cursor: pointer; font-size: 1rem;
            font-weight: 600; transition: all 0.3s; display: inline-block;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #78909c 0%, #546e7a 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
        }
        .btn-small {
            padding: 0.5rem 1rem; font-size: 0.85rem;
        }
        .readonly-field {
            background: #f8f9fa; color: #666; cursor: not-allowed;
        }
        .info-box {
            background: #e3f2fd; border-left: 4px solid #2196f3;
            padding: 1rem; border-radius: 5px; margin-bottom: 1rem;
        }
        .info-box .info-icon {
            display: inline-block; margin-right: 0.5rem; font-weight: 600;
        }
        .success-message {
            background: #d4edda; color: #155724; padding: 1rem;
            border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da; color: #721c24; padding: 1rem;
            border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f5c6cb;
        }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .save-button-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        .save-button-container .btn {
            font-size: 1.1rem;
            padding: 1rem 3rem;
        }
        .logs-list {
            margin-top: 1rem;
        }
        .log-item {
            background: #f8f9fa;
            border-left: 4px solid #42a5f5;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .log-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .log-item-info h4 {
            color: #1e88e5;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        .log-item-info p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }
        .log-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .query-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }
        .query-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .editing-mode-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editing-mode-banner strong {
            font-size: 1.05rem;
        }
        
        /* æœˆä»½æ€»ç»“ç‰¹å®šæ ·å¼ */
        .summary-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .summary-section {
            margin-bottom: 2rem;
        }
        .summary-section h3 {
            color: #2e7d32;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2e7d32;
        }
        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            .card-body { padding: 1.5rem; }
            .form-row { grid-template-columns: 1fr; }
            .tab-button { font-size: 0.95rem; padding: 1rem; }
            .log-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .log-item-actions {
                margin-top: 1rem;
                width: 100%;
            }
            .log-item-actions .btn {
                flex: 1;
            }
            .query-row {
                flex-direction: column;
            }
            .query-row .form-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ¿ ç”Ÿé•¿è¿‡ç¨‹ç®¡ç†</h1>
        <p class="subtitle">è®°å½•å¹¶ç®¡ç†èŒ¶å›­çš„æ¯æ—¥ç”Ÿé•¿æƒ…å†µå’Œæœˆåº¦æ€»ç»“</p>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">â† è¿”å›ä»ªè¡¨æ¿</a>
        </div>
    </div>

    <div class="container">
        <!-- æç¤ºä¿¡æ¯ -->
        <div id="message-container"></div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs-navigation">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="daily">ğŸ“… æ¯æ—¥ç”Ÿé•¿ç®¡ç†</button>
                <button class="tab-button" data-tab="monthly">ğŸ“Š æœˆä»½æ€»ç»“</button>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <!-- ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µï¼šæ¯æ—¥ç”Ÿé•¿ç®¡ç† -->
        <div id="daily-tab" class="tab-content active">
            <!-- æŸ¥è¯¢ä¸ç¼–è¾‘ä»¥å¾€è®°å½• -->
            <div class="form-card">
                <div class="card-header card-header-secondary">ğŸ” æŸ¥è¯¢ä¸ç¼–è¾‘ä»¥å¾€è®°å½•</div>
                <div class="card-body">
                    <div class="query-row">
                        <div class="form-group">
                            <label for="query-month">é€‰æ‹©æœˆä»½</label>
                            <input type="month" id="query-month" class="form-control">
                        </div>
                        <button type="button" class="btn" onclick="queryLogs()">ğŸ” æŸ¥è¯¢è®°å½•</button>
                    </div>

                    <div id="logs-list-container" class="logs-list">
                        <p style="color: #999; text-align: center;">è¯·é€‰æ‹©æœˆä»½å¹¶ç‚¹å‡»"æŸ¥è¯¢è®°å½•"æŒ‰é’®</p>
                    </div>
                </div>
            </div>

            <!-- ç¼–è¾‘æ¨¡å¼æç¤º -->
            <div id="editing-mode-banner" class="editing-mode-banner hidden">
                <div>
                    <strong>ğŸ“ ç¼–è¾‘æ¨¡å¼</strong>
                    <p style="margin: 0.25rem 0 0 0;">æ­£åœ¨ç¼–è¾‘æ—¥å¿—ï¼Œä¿®æ”¹å®Œæˆåç‚¹å‡»ä¿å­˜æŒ‰é’®</p>
                </div>
                <button type="button" class="btn btn-warning btn-small" onclick="cancelEdit()">
                    âŒ å–æ¶ˆç¼–è¾‘ / æ–°å¢æ—¥å¿—
                </button>
            </div>

            <!-- éšè—å­—æ®µï¼šå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„æ—¥å¿—ID -->
            <input type="hidden" id="editing-log-id">

            <!-- ä¸»è¡¨å• -->
            <form id="daily-log-form">
                <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šå¡ç‰‡ä¿¡æ¯ -->
                <div class="form-card">
                    <div class="card-header">ğŸ“‹ æ¯æ—¥æ—¥å¿—å¡ç‰‡ä¿¡æ¯</div>
                    <div class="card-body">
                        <!-- ä¸»å›¾ -->
                        <div class="form-group">
                            <label>ä¸»å›¾ <span class="required">*</span></label>
                            <div class="image-upload-area" onclick="document.getElementById('main-image-input').click()">
                                <p style="margin: 0; font-size: 1rem; color: #666;">
                                    ğŸ“· ç‚¹å‡»ä¸Šä¼ ä¸»å›¾<br>
                                    <small style="color: #999;">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 5MB</small>
                                </p>
                            </div>
                            <input type="file" id="main-image-input" accept="image/*" style="display: none;">
                            
                            <div id="main-image-preview-container" class="image-preview-container hidden">
                                <img id="main-image-preview" class="image-preview" alt="ä¸»å›¾é¢„è§ˆ">
                                <div class="image-actions">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('main-image-input').click()">
                                        ğŸ”„ æ›¿æ¢å›¾ç‰‡
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="removeMainImage()">
                                        ğŸ—‘ï¸ åˆ é™¤ä¸»å›¾
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="main-image-url">
                        </div>

                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-date">æ—¥æœŸ <span class="required">*</span></label>
                                <input type="date" id="log-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="weather">å¤©æ°”</label>
                                <select id="weather" class="form-control">
                                    <option value="">è¯·é€‰æ‹©å¤©æ°”</option>
                                    <option value="æ™´å¤©">â˜€ï¸ æ™´å¤©</option>
                                    <option value="å¤šäº‘">â›… å¤šäº‘</option>
                                    <option value="é˜´å¤©">â˜ï¸ é˜´å¤©</option>
                                    <option value="é›¨å¤©">ğŸŒ§ï¸ é›¨å¤©</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ¸©åº¦èŒƒå›´</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="min-temperature" class="form-control" placeholder="æœ€ä½æ¸©" style="flex: 1;">
                                    <span>~</span>
                                    <input type="number" id="max-temperature" class="form-control" placeholder="æœ€é«˜æ¸©" style="flex: 1;">
                                    <span>â„ƒ</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plot-id">åœ°å—ä¿¡æ¯</label>
                                <select id="plot-id" class="form-control">
                                    <option value="">åŠ è½½ä¸­...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recorder-name">è®°å½•äºº</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div id="recorder-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: #999; font-size: 0.8rem;">æš‚æ— </span>
                                    </div>
                                    <select id="recorder-name" class="form-control" style="flex: 1;">
                                        <option value="">é€‰æ‹©è®°å½•äºº...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="farm-activity-type">å†œäº‹æ´»åŠ¨</label>
                                <select id="farm-activity-type" class="form-control">
                                    <option value="æ— ">æ— </option>
                                    <option value="æ–½è‚¥">ğŸŒ± æ–½è‚¥</option>
                                    <option value="ä¿®å‰ª">âœ‚ï¸ ä¿®å‰ª</option>
                                    <option value="çŒæº‰">ğŸ’§ çŒæº‰</option>
                                    <!-- âŒ é‡‡æ‘˜é€‰é¡¹å·²ç§»é™¤ - è¯·åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­å½•å…¥é‡‡æ‘˜è®°å½• -->
                                    <option value="å¼‚å¸¸">âš ï¸ å¼‚å¸¸</option>
                                </select>
                            </div>
                        </div>

                        <!-- â„¹ï¸ é‡‡æ‘˜è®°å½•ç»Ÿä¸€ç®¡ç†è¯´æ˜ -->
                        <div class="info-box" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                            <strong>ğŸ“¢ é‡‡æ‘˜è®°å½•ç®¡ç†è¯´æ˜ï¼š</strong>
                            <p style="margin: 0.5rem 0 0 0;">
                                æ‰€æœ‰é‡‡æ‘˜è®°å½•è¯·å‰å¾€ <a href="/admin/traceability-management" style="color: #d84315; font-weight: 600; text-decoration: none;">ğŸ” æ‰¹æ¬¡è¿½æº¯ç®¡ç†</a> é¡µé¢è¿›è¡Œç»Ÿä¸€å½•å…¥å’Œç®¡ç†ã€‚
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="summary">æ ¸å¿ƒæ—¥å¿—æ‘˜è¦ <span class="required">*</span></label>
                            <textarea id="summary" class="form-control" rows="4" required placeholder="è¯·ç®€è¦æè¿°ä»Šæ—¥èŒ¶å›­ç”Ÿé•¿æƒ…å†µ..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¦æƒ…é¡µä¿¡æ¯ -->
                <div class="form-card">
                    <div class="card-header">ğŸ“¸ æ¯æ—¥ç”Ÿé•¿è¯¦æƒ…é¡µä¿¡æ¯</div>
                    <div class="card-body">
                        <!-- å›¾ç‰‡ç”»å»Š -->
                        <div class="form-group">
                            <label>å›¾ç‰‡ç”»å»Š</label>
                            <div class="image-upload-area" onclick="document.getElementById('gallery-input').click()">
                                <p style="margin: 0; font-size: 1rem; color: #666;">
                                    ğŸ“· ç‚¹å‡»ä¸Šä¼ å¤šå¼ å›¾ç‰‡<br>
                                    <small style="color: #999;">å¯ä¸€æ¬¡é€‰æ‹©å¤šå¼ å›¾ç‰‡</small>
                                </p>
                            </div>
                            <input type="file" id="gallery-input" accept="image/*" multiple style="display: none;">
                            <div id="gallery-preview" class="gallery-grid"></div>
                        </div>

                        <!-- åªè¯»è”åŠ¨ä¿¡æ¯ -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸ“Œ æ‹æ‘„ä¿¡æ¯ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</div>
                        <div class="info-box">
                            <span class="info-icon">â„¹ï¸</span>
                            ä»¥ä¸‹ä¿¡æ¯å°†è‡ªåŠ¨ä»ä¸Šæ–¹"å¡ç‰‡ä¿¡æ¯"ä¸­åŒæ­¥
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ‹æ‘„æ—¥æœŸ</label>
                                <input type="text" id="photo-date" class="form-control readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label>åœ°å—ä¿¡æ¯</label>
                                <input type="text" id="photo-plot" class="form-control readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label>æ‹æ‘„äºº</label>
                                <input type="text" id="photo-person" class="form-control readonly-field" readonly>
                            </div>
                        </div>

                        <!-- ç¯å¢ƒæ•°æ® -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸŒ¡ï¸ ç¯å¢ƒæ•°æ®</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sunshine-hours">æ—¥ç…§æ—¶é—´</label>
                                <input type="text" id="sunshine-hours" class="form-control" placeholder="ä¾‹å¦‚ï¼š8å°æ—¶">
                            </div>
                            <div class="form-group">
                                <label for="rainfall">ä»Šæ—¥é™æ°´</label>
                                <input type="text" id="rainfall" class="form-control" placeholder="ä¾‹å¦‚ï¼š5mm">
                            </div>
                            <div class="form-group">
                                <label for="avg-temperature">å¹³å‡æ¸©åº¦</label>
                                <input type="text" id="avg-temperature" class="form-control" placeholder="ä¾‹å¦‚ï¼š22Â°C">
                            </div>
                            <div class="form-group">
                                <label for="humidity">æ¹¿åº¦</label>
                                <input type="text" id="humidity" class="form-control" placeholder="ä¾‹å¦‚ï¼š65%">
                            </div>
                        </div>

                        <!-- è¯¦ç»†æ—¥è®° -->
                        <div class="section-title" style="margin-top: 2rem;">ğŸ“ è¯¦ç»†æ—¥è®°</div>
                        <div class="form-group">
                            <label for="full-log">ç”Ÿé•¿æ—¥è®°</label>
                            <textarea id="full-log" class="form-control" rows="6" placeholder="è¯¦ç»†è®°å½•ä»Šæ—¥èŒ¶å›­ç”Ÿé•¿æƒ…å†µ..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="phenological-observation">ç‰©å€™è§‚å¯Ÿ</label>
                            <textarea id="phenological-observation" class="form-control" rows="4" placeholder="è®°å½•æ¤ç‰©ç”Ÿé•¿é˜¶æ®µã€ç‰©å€™ç°è±¡ç­‰..."></textarea>
                        </div>

                        <!-- å†œäº‹æ´»åŠ¨è¯¦æƒ… -->
                        <div id="farm-activity-detail-section" class="hidden">
                            <div class="section-title" style="margin-top: 2rem;">ğŸšœ å†œäº‹æ´»åŠ¨è¯¦æƒ…</div>
                            <div class="form-group">
                                <label id="activity-details-label" for="farm-activity-log">æ´»åŠ¨è¯¦ç»†è®°å½•</label>
                                <textarea id="farm-activity-log" class="form-control" rows="5" placeholder="è¯¦ç»†æè¿°å†œäº‹æ´»åŠ¨çš„å†…å®¹ã€è¿‡ç¨‹ç­‰..."></textarea>
                            </div>
                        </div>

                        <!-- å¼‚å¸¸äº‹ä»¶è®°å½• -->
                        <div id="abnormal-event-section" class="hidden">
                            <div class="section-title" style="margin-top: 2rem;">âš ï¸ å¼‚å¸¸äº‹ä»¶è®°å½•</div>
                            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1rem;">
                                <span class="info-icon">ğŸ’¡</span>
                                å¦‚æœå½“å¤©å‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼ˆå¦‚ç—…è™«å®³ã€è‡ªç„¶ç¾å®³ç­‰ï¼‰ï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ã€‚
                            </div>
                            <div class="form-group">
                                <label for="abnormal-title">å¼‚å¸¸æ ‡é¢˜</label>
                                <input type="text" id="abnormal-title" class="form-control" placeholder="ä¾‹å¦‚ï¼šå‘ç°ç—…è™«å®³">
                            </div>
                            <div class="form-group">
                                <label for="abnormal-description">å¼‚å¸¸æè¿°</label>
                                <textarea id="abnormal-description" class="form-control" rows="3" placeholder="è¯¦ç»†æè¿°å¼‚å¸¸æƒ…å†µ..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="abnormal-measures">å·²é‡‡å–æªæ–½</label>
                                <input type="text" id="abnormal-measures" class="form-control" placeholder="ä¾‹å¦‚ï¼šå·²å–·æ´’æœ‰æœºå†œè¯">
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- ä¿å­˜æŒ‰é’® -->
            <div class="save-button-container">
                <button type="button" class="btn" onclick="saveLog()" id="save-btn">ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—</button>
                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    ä¿å­˜åæ‚¨å¯ä»¥é€‰æ‹©ç»§ç»­æ·»åŠ æ–°æ—¥å¿—æˆ–è¿”å›ä»ªè¡¨æ¿
                </p>
            </div>
        </div>

        <!-- ç¬¬äºŒä¸ªæ ‡ç­¾é¡µï¼šæœˆä»½æ€»ç»“ -->
        <div id="monthly-tab" class="tab-content">
            <!-- å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“åˆ—è¡¨ -->
            <div class="form-card">
                <div class="card-header card-header-secondary">ğŸ“‹ å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“</div>
                <div class="card-body">
                    <div id="summary-list-container" class="logs-list">
                        <p style="color: #999; text-align: center;">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ç¼–è¾‘æ¨¡å¼æç¤º -->
            <div id="editing-summary-banner" class="editing-mode-banner hidden">
                <div>
                    <strong>ğŸ“ ç¼–è¾‘æ¨¡å¼</strong>
                    <p style="margin: 0.25rem 0 0 0;">æ­£åœ¨ç¼–è¾‘æœˆåº¦æ€»ç»“ï¼Œä¿®æ”¹å®Œæˆåç‚¹å‡»ä¿å­˜æŒ‰é’®</p>
                </div>
                <button type="button" class="btn btn-warning btn-small" onclick="cancelSummaryEdit()">
                    âŒ å–æ¶ˆç¼–è¾‘ / æ–°å¢æ€»ç»“
                </button>
            </div>

            <!-- éšè—å­—æ®µï¼šå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„æ€»ç»“ID -->
            <input type="hidden" id="editing-summary-id">

            <div class="form-card">
                <div class="card-header">ğŸ“Š æœˆåº¦æ±‡æ€»ç®¡ç†</div>
                <div class="card-body">
                    <div class="query-row">
                        <div class="form-group">
                            <label for="summary-month">é€‰æ‹©æœˆä»½</label>
                            <input type="month" id="summary-month" class="form-control">
                        </div>
                        <button type="button" class="btn" onclick="generateSummary()">ğŸ”„ ç”Ÿæˆ/åˆ·æ–°æœ¬æœˆæ€»ç»“</button>
                    </div>

                    <!-- æ±‡æ€»æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="summary-display" class="summary-display hidden">
                        <div class="info-box" style="background: #e8f5e9; border-left-color: #66bb6a;">
                            <span class="info-icon">âœï¸</span>
                            æ‰€æœ‰æ•°æ®å‡å¯æ‰‹åŠ¨ç¼–è¾‘ã€‚ä¿®æ”¹åè¯·ç‚¹å‡»åº•éƒ¨çš„"ä¿å­˜æ‰€æœ‰æ€»ç»“ä¿®æ”¹"æŒ‰é’®ã€‚
                        </div>

                        <!-- é¡¶éƒ¨å½±åƒç”»å»Šç®¡ç† -->
                        <div class="summary-section">
                            <h3>ğŸ–¼ï¸ é¡¶éƒ¨å½±åƒç”»å»Š</h3>
                            <div class="form-group">
                                <label>ä¸Šä¼ å›¾ç‰‡/è§†é¢‘</label>
                                <div class="image-upload-area" onclick="document.getElementById('gallery-upload-input').click()">
                                    <p style="margin: 0; font-size: 1rem; color: #666;">
                                        ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘<br>
                                        <small style="color: #999;">å¯ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ”¯æŒ JPGã€PNGã€MP4 ç­‰æ ¼å¼</small>
                                    </p>
                                </div>
                                <input type="file" id="gallery-upload-input" accept="image/*,video/*" multiple style="display: none;">
                            </div>

                            <!-- ç”»å»Šé¢„è§ˆåŒºåŸŸ -->
                            <div id="top-gallery-preview" class="gallery-grid"></div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“ˆ é‡‡æ‘˜ç»Ÿè®¡</h3>
                            <div class="info-box" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                                <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    é‡‡æ‘˜ç»Ÿè®¡æ•°æ®ç”±ç³»ç»Ÿè‡ªåŠ¨ä» <a href="/admin/traceability-management" style="color: #d84315; font-weight: 600; text-decoration: none;">ğŸ” æ‰¹æ¬¡è¿½æº¯ç®¡ç†</a> ä¸­çš„é‡‡æ‘˜è®°å½•è®¡ç®—ç”Ÿæˆã€‚
                                    <br>å¦‚éœ€ä¿®æ”¹é‡‡æ‘˜æ•°æ®ï¼Œè¯·å‰å¾€è¯¥é¡µé¢è¿›è¡Œç®¡ç†ã€‚
                                </p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="harvest-count">é‡‡æ‘˜æ¬¡æ•°ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                                    <input type="number" id="harvest-count" class="form-control" min="0" step="1" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label for="harvest-weight">æ€»é‡é‡ï¼ˆå…¬æ–¤ï¼‰ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                                    <input type="number" id="harvest-weight" class="form-control" min="0" step="0.1" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“… å†œäº‹æ—¥å†</h3>
                            <div class="form-group">
                                <textarea id="farm-calendar-display" class="form-control" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;3æ—¥ æ–½è‚¥&#10;15æ—¥ ä¿®å‰ª&#10;28æ—¥ é‡‡æ‘˜"></textarea>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>âš ï¸ å¼‚å¸¸äº‹ä»¶æ±‡æ€»</h3>
                            <div class="form-group">
                                <textarea id="abnormal-events-display" class="form-control" rows="5" placeholder="ä¾‹å¦‚ï¼š&#10;2025-01-15 å‘ç°ç—…è™«å®³ï¼Œå·²å–·æ´’æœ‰æœºå†œè¯&#10;2025-01-20 éƒ¨åˆ†èŒ¶æ ‘å¶ç‰‡å‘é»„ï¼Œå¢åŠ æ–½è‚¥"></textarea>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸŒ¤ï¸ æ°”å€™æ€»ç»“</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="avg-temp-display">å¹³å‡æ¸©åº¦</label>
                                    <input type="text" id="avg-temp-display" class="form-control" placeholder="ä¾‹å¦‚ï¼š17~25â„ƒ">
                                </div>
                                <div class="form-group">
                                    <label for="total-precipitation-display">æ€»é™æ°´</label>
                                    <input type="text" id="total-precipitation-display" class="form-control" placeholder="ä¾‹å¦‚ï¼šçº¦5å¤©æœ‰é™æ°´">
                                </div>
                            </div>
                        </div>

                        <div class="summary-section">
                            <h3>ğŸ“ ä¸‹æœˆè®¡åˆ’</h3>
                            <div class="form-group">
                                <textarea id="next-month-plan" class="form-control" rows="8" placeholder="è¯·è¾“å…¥ä¸‹æœˆè®¡åˆ’ï¼Œæ¯è¡Œä¸€æ¡..."></textarea>
                            </div>
                        </div>

                        <!-- ç»Ÿä¸€ä¿å­˜æŒ‰é’® -->
                        <div class="save-button-container" style="margin-top: 2rem;">
                            <button type="button" class="btn" onclick="saveAllSummaryChanges()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ€»ç»“ä¿®æ”¹</button>
                            <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                                ä¿å­˜åå°†æ›´æ–°æ‰€æœ‰å·²ä¿®æ”¹çš„ç»Ÿè®¡æ•°æ®
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI åŠ©æ‰‹é›†æˆ -->
    <script src="https://o.alicdn.com/appflow/chatbot/v1/AppflowChatSDK.js"></script>
    <script>
        window.APPFLOW_CHAT_SDK.init({
            integrateConfig: {
                integrateId: 'cit-4d7f8b8ad2c5463ca79e',
                domain: { requestDomain: 'https://1524787808648067.appflow.aliyunnest.com' },
                draggable: true
            }
        });
    </script>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let mainImageUrl = '';
        let galleryUrls = [];
        let topGalleryUrls = []; // é¡¶éƒ¨å½±åƒç”»å»Š URL æ•°ç»„
        let availablePlots = [];
        let existingDates = [];
        let currentSummaryId = null;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('log-date').value = today;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('query-month').value = currentMonth;
            document.getElementById('summary-month').value = currentMonth;
            
            loadPlots();
            loadRecorders(); // åŠ è½½è®°å½•äººåˆ—è¡¨
            loadExistingDates();
            setupEventListeners();
            setupTabNavigation();
            updateSyncFields();
            
            // åŠ è½½æœˆåº¦æ€»ç»“åˆ—è¡¨
            fetchAndRenderSummaries();
            
            // è®¾ç½®é¡¶éƒ¨ç”»å»Šä¸Šä¼ äº‹ä»¶
            document.getElementById('gallery-upload-input').addEventListener('change', handleTopGalleryUpload);
        });

        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰æ ‡ç­¾
                    button.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');
                });
            });
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadPlots() {
            try {
                const response = await fetch('/api/plots');
                const result = await response.json();
                if (result.success && result.data) {
                    availablePlots = result.data;
                    const plotSelect = document.getElementById('plot-id');
                    plotSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°å—</option>';
                    result.data.forEach(plot => {
                        const option = document.createElement('option');
                        option.value = plot._id;
                        option.textContent = plot.name;
                        plotSelect.appendChild(option);
                    });
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªåœ°å—');
                }
            } catch (error) {
                console.error('åŠ è½½åœ°å—åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('plot-id').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        async function loadExistingDates() {
            try {
                const response = await fetch('/api/growth-logs/existing-dates');
                const result = await response.json();
                if (result.success && result.data) {
                    existingDates = result.data;
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªå·²å­˜åœ¨çš„æ—¥å¿—æ—¥æœŸ');
                }
            } catch (error) {
                console.error('åŠ è½½å·²æœ‰æ—¥æœŸåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function loadRecorders() {
            try {
                const response = await fetch('/api/personnel?role=è®°å½•äºº');
                const result = await response.json();
                if (result.success && result.data) {
                    const recorderSelect = document.getElementById('recorder-name');
                    recorderSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è®°å½•äºº</option>';
                    result.data.forEach(recorder => {
                        const option = document.createElement('option');
                        option.value = recorder.name;
                        option.textContent = recorder.name;
                        option.dataset.avatar = recorder.avatar_url || '';
                        recorderSelect.appendChild(option);
                    });
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªè®°å½•äºº');
                }
            } catch (error) {
                console.error('åŠ è½½è®°å½•äººåˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('recorder-name').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // ==================== äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ====================
        function setupEventListeners() {
            document.getElementById('main-image-input').addEventListener('change', handleMainImageUpload);
            document.getElementById('gallery-input').addEventListener('change', handleGalleryUpload);
            document.getElementById('farm-activity-type').addEventListener('change', handleFarmActivityChange);
            document.getElementById('log-date').addEventListener('change', handleDateChange);
            document.getElementById('plot-id').addEventListener('change', updateSyncFields);
            document.getElementById('recorder-name').addEventListener('input', updateSyncFields);
            document.getElementById('recorder-name').addEventListener('change', handleRecorderChange);
        }

        /**
         * å¤„ç†è®°å½•äººé€‰æ‹©å˜åŒ–ï¼Œæ›´æ–°å¤´åƒæ˜¾ç¤º
         */
        function handleRecorderChange() {
            const recorderSelect = document.getElementById('recorder-name');
            const selectedOption = recorderSelect.options[recorderSelect.selectedIndex];
            const avatarUrl = selectedOption.dataset.avatar || '';
            
            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            updateAvatar('recorder-avatar', avatarUrl);
        }

        /**
         * æ›´æ–°äººå‘˜å¤´åƒæ˜¾ç¤º
         * @param {string} containerId - å¤´åƒå®¹å™¨çš„ID
         * @param {string} avatarUrl - å¤´åƒURL
         */
        function updateAvatar(containerId, avatarUrl) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (avatarUrl && avatarUrl.trim() !== '') {
                // æœ‰å¤´åƒï¼Œæ˜¾ç¤ºå›¾ç‰‡
                container.innerHTML = `<img src="${avatarUrl}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
                container.innerHTML = '<span style="color: #999; font-size: 0.8rem;">æš‚æ— </span>';
            }
        }

        function handleDateChange() {
            const selectedDate = document.getElementById('log-date').value;
            const editingId = document.getElementById('editing-log-id').value;
            
            if (!editingId && selectedDate && existingDates.includes(selectedDate)) {
                const dateObj = new Date(selectedDate);
                const dateStr = dateObj.toLocaleDateString('zh-CN');
                
                showMessage(`âš ï¸ è¯¥æ—¥æœŸï¼ˆ${dateStr}ï¼‰å·²å­˜åœ¨æ—¥å¿—è®°å½•ï¼è¯·é€‰æ‹©å…¶ä»–æ—¥æœŸæˆ–æŸ¥è¯¢å¹¶ç¼–è¾‘å·²æœ‰è®°å½•ã€‚`, 'error');
                
                document.getElementById('log-date').value = '';
                
                setTimeout(() => {
                    if (confirm(`è¯¥æ—¥æœŸï¼ˆ${dateStr}ï¼‰å·²æœ‰è®°å½•ã€‚\n\næ˜¯å¦è¦æŸ¥è¯¢å¹¶æŸ¥çœ‹è¯¥è®°å½•ï¼Ÿ`)) {
                        const yearMonth = selectedDate.substring(0, 7);
                        document.getElementById('query-month').value = yearMonth;
                        queryLogs();
                        document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
                    }
                }, 500);
            } else {
                updateSyncFields();
            }
        }

        function handleFarmActivityChange() {
            const activityType = document.getElementById('farm-activity-type').value;
            const detailSection = document.getElementById('farm-activity-detail-section');
            const activityLabel = document.getElementById('activity-details-label');
            const abnormalSection = document.getElementById('abnormal-event-section');
            
            // æ§åˆ¶å†œäº‹æ´»åŠ¨è¯¦æƒ…æ¡†
            if (activityType && activityType !== 'æ— ') {
                detailSection.classList.remove('hidden');
                
                const cleanActivityType = activityType.replace(/^[\u{1F000}-\u{1F9FF}]\s*/u, '').trim();
                activityLabel.textContent = cleanActivityType + 'è¯¦æƒ…';
                
                console.log('ğŸ”„ å†œäº‹æ´»åŠ¨æ ‡ç­¾å·²æ›´æ–°ä¸º:', cleanActivityType + 'è¯¦æƒ…');
            } else {
                detailSection.classList.add('hidden');
                activityLabel.textContent = 'æ´»åŠ¨è¯¦ç»†è®°å½•';
            }
            
            // æ§åˆ¶å¼‚å¸¸äº‹ä»¶è®°å½•æ˜¾ç¤º/éšè—
            const cleanActivityType = activityType.replace(/^[\u{1F000}-\u{1F9FF}]\s*/u, '').trim();
            if (cleanActivityType === 'å¼‚å¸¸') {
                abnormalSection.classList.remove('hidden');
                console.log('âš ï¸ å·²æ˜¾ç¤ºå¼‚å¸¸äº‹ä»¶è®°å½•ç¼–è¾‘æ¡†');
            } else {
                abnormalSection.classList.add('hidden');
                // éšè—æ—¶æ¸…ç©ºå¼‚å¸¸äº‹ä»¶å­—æ®µ
                document.getElementById('abnormal-title').value = '';
                document.getElementById('abnormal-description').value = '';
                document.getElementById('abnormal-measures').value = '';
                console.log('âœ… å·²éšè—å¼‚å¸¸äº‹ä»¶è®°å½•ç¼–è¾‘æ¡†');
            }
            
            // âŒ é‡‡æ‘˜ç›¸å…³é€»è¾‘å·²ç§»é™¤ - é‡‡æ‘˜è®°å½•ç»Ÿä¸€åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­ç®¡ç†
        }

        // ==================== æŸ¥è¯¢åŠŸèƒ½ ====================
        async function queryLogs() {
            const month = document.getElementById('query-month').value;
            if (!month) {
                showMessage('è¯·é€‰æ‹©è¦æŸ¥è¯¢çš„æœˆä»½', 'error');
                return;
            }

            try {
                showMessage('æ­£åœ¨æŸ¥è¯¢æ—¥å¿—...', 'info');
                
                const response = await fetch(`/api/growth-logs?month=${month}`);
                const result = await response.json();

                if (result.success) {
                    displayLogsList(result.data);
                    showMessage(`âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${result.data.length} æ¡è®°å½•`, 'success');
                    console.log('âœ… æŸ¥è¯¢åˆ°', result.data.length, 'æ¡æ—¥å¿—');
                } else {
                    showMessage('âŒ æŸ¥è¯¢å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('æŸ¥è¯¢æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ æŸ¥è¯¢å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function displayLogsList(logs) {
            const container = document.getElementById('logs-list-container');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">è¯¥æœˆä»½æš‚æ— è®°å½•</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const date = new Date(log.date).toLocaleDateString('zh-CN');
                const summary = log.summary ? (log.summary.length > 50 ? log.summary.substring(0, 50) + '...' : log.summary) : 'æ— æ‘˜è¦';
                
                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <h4>ğŸ“… ${date} ${log.recorder_name ? '- ' + log.recorder_name : ''}</h4>
                            <p>${summary}</p>
                        </div>
                        <div class="log-item-actions">
                            <button class="btn btn-secondary btn-small" onclick="editLog('${log._id}')">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteLog('${log._id}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== ç¼–è¾‘åŠŸèƒ½ ====================
        async function editLog(id) {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...', 'info');
                
                const response = await fetch(`/api/growth-logs/${id}`);
                const result = await response.json();

                if (result.success) {
                    const log = result.data;
                    
                    document.getElementById('editing-log-id').value = id;
                    document.getElementById('editing-mode-banner').classList.remove('hidden');
                    
                    fillFormWithLogData(log);
                    
                    document.getElementById('save-btn').innerHTML = 'ğŸ’¾ æ›´æ–°æ­¤æ¡æ—¥å¿—';
                    document.getElementById('daily-log-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    showMessage('âœ… æ—¥å¿—æ•°æ®å·²åŠ è½½ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»æ›´æ–°æŒ‰é’®', 'success');
                    console.log('âœ… ç¼–è¾‘æ¨¡å¼ï¼šå·²åŠ è½½æ—¥å¿—æ•°æ®', log);
                } else {
                    showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function fillFormWithLogData(log) {
            document.getElementById('log-date').value = log.date.split('T')[0];
            document.getElementById('recorder-name').value = log.recorder_name || '';
            
            // æ›´æ–°è®°å½•äººå¤´åƒ
            const recorderSelect = document.getElementById('recorder-name');
            const selectedOption = recorderSelect.options[recorderSelect.selectedIndex];
            if (selectedOption) {
                const avatarUrl = selectedOption.dataset.avatar || '';
                updateAvatar('recorder-avatar', avatarUrl);
            }
            
            document.getElementById('summary').value = log.summary || '';
            
            mainImageUrl = log.main_image_url || '';
            document.getElementById('main-image-url').value = mainImageUrl;
            if (mainImageUrl) {
                document.getElementById('main-image-preview').src = mainImageUrl;
                document.getElementById('main-image-preview-container').classList.remove('hidden');
            }
            
            document.getElementById('weather').value = log.weather?.icon || '';
            
            // è§£ææ¸©åº¦èŒƒå›´
            const tempRange = log.weather?.temperature_range || '';
            if (tempRange) {
                // ç§»é™¤â„ƒç¬¦å·å¹¶æŒ‰~åˆ†å‰²
                const cleanTemp = tempRange.replace(/â„ƒ/g, '').trim();
                const temps = cleanTemp.split('~');
                if (temps.length === 2) {
                    document.getElementById('min-temperature').value = temps[0].trim();
                    document.getElementById('max-temperature').value = temps[1].trim();
                } else if (temps.length === 1) {
                    // åªæœ‰ä¸€ä¸ªå€¼ï¼Œæ”¾åœ¨æœ€ä½æ¸©åº¦
                    document.getElementById('min-temperature').value = temps[0].trim();
                    document.getElementById('max-temperature').value = '';
                }
            } else {
                document.getElementById('min-temperature').value = '';
                document.getElementById('max-temperature').value = '';
            }
            
            document.getElementById('plot-id').value = log.plot_id?._id || log.plot_id || '';
            document.getElementById('farm-activity-type').value = log.farm_activity_type || 'æ— ';
            // âŒ é‡‡æ‘˜é‡é‡å­—æ®µå·²ç§»é™¤
            
            handleFarmActivityChange();
            
            galleryUrls = log.detail_gallery || [];
            renderGallery();
            
            document.getElementById('sunshine-hours').value = log.environment_data?.sunshine_hours || '';
            document.getElementById('rainfall').value = log.environment_data?.rainfall || '';
            document.getElementById('avg-temperature').value = log.environment_data?.temperature || '';
            document.getElementById('humidity').value = log.environment_data?.humidity || '';
            
            document.getElementById('full-log').value = log.full_log || '';
            document.getElementById('phenological-observation').value = log.phenological_observation || '';
            document.getElementById('farm-activity-log').value = log.farm_activity_log || '';
            
            // å¡«å……å¼‚å¸¸äº‹ä»¶æ•°æ®
            document.getElementById('abnormal-title').value = log.abnormal_event?.title || '';
            document.getElementById('abnormal-description').value = log.abnormal_event?.description || '';
            document.getElementById('abnormal-measures').value = log.abnormal_event?.measures_taken || '';
            
            updateSyncFields();
        }

        function cancelEdit() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('editing-log-id').value = '';
                document.getElementById('editing-mode-banner').classList.add('hidden');
                document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
                
                clearForm();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('log-date').value = today;
                
                showMessage('å·²å–æ¶ˆç¼–è¾‘ï¼Œå¯ä»¥æ–°å¢æ—¥å¿—', 'info');
            }
        }

        function clearForm() {
            document.getElementById('daily-log-form').reset();
            
            mainImageUrl = '';
            document.getElementById('main-image-url').value = '';
            document.getElementById('main-image-preview').src = '';
            document.getElementById('main-image-preview-container').classList.add('hidden');
            document.getElementById('main-image-input').value = '';
            
            galleryUrls = [];
            renderGallery();
            
            document.getElementById('farm-activity-detail-section').classList.add('hidden');
            // âŒ harvest-weight-section å·²ç§»é™¤
            
            // æ¸…ç©ºè®°å½•äººå¤´åƒ
            updateAvatar('recorder-avatar', '');
            
            updateSyncFields();
        }

        // ==================== åˆ é™¤åŠŸèƒ½ ====================
        async function deleteLog(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åˆ é™¤æ—¥å¿—...', 'info');
                
                const response = await fetch(`/api/growth-logs/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æ—¥å¿—å·²æˆåŠŸåˆ é™¤', 'success');
                    loadExistingDates();
                    queryLogs();
                    console.log('âœ… å·²åˆ é™¤æ—¥å¿—:', id);
                } else {
                    showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== ä¿å­˜åŠŸèƒ½ ====================
        async function saveLog() {
            try {
                const logDate = document.getElementById('log-date').value;
                const summary = document.getElementById('summary').value.trim();
                
                if (!logDate) {
                    showMessage('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                    return;
                }
                if (!summary) {
                    showMessage('è¯·å¡«å†™æ ¸å¿ƒæ—¥å¿—æ‘˜è¦', 'error');
                    return;
                }

                const editingId = document.getElementById('editing-log-id').value;
                const isEditMode = !!editingId;

                if (!isEditMode && !mainImageUrl) {
                    if (!confirm('å°šæœªä¸Šä¼ ä¸»å›¾ï¼Œç¡®å®šè¦ç»§ç»­ä¿å­˜å—ï¼Ÿ')) {
                        return;
                    }
                }

                // æ·»åŠ ä¿å­˜ç¡®è®¤
                const confirmMessage = isEditMode 
                    ? 'ç¡®å®šè¦ä¿å­˜å¯¹è¯¥æ—¥å¿—çš„ä¿®æ”¹å—ï¼Ÿ' 
                    : 'ç¡®å®šè¦ä¿å­˜è¿™æ¡æ—¥å¿—å—ï¼Ÿ';
                
                if (!confirm(confirmMessage)) {
                    showMessage('å·²å–æ¶ˆä¿å­˜', 'info');
                    return;
                }

                const farmActivityType = document.getElementById('farm-activity-type').value;
                const farmActivityLog = (farmActivityType === 'æ— ' || farmActivityType === '') 
                    ? '' 
                    : document.getElementById('farm-activity-log').value.trim();
                
                // âŒ é‡‡æ‘˜é‡é‡å­—æ®µå·²ç§»é™¤ - é‡‡æ‘˜è®°å½•ç»Ÿä¸€åœ¨"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­ç®¡ç†
                const harvestWeight = 0;
                
                // æ”¶é›†å¼‚å¸¸äº‹ä»¶æ•°æ®
                const abnormalTitle = document.getElementById('abnormal-title').value.trim();
                const abnormalData = abnormalTitle ? {
                    title: abnormalTitle,
                    description: document.getElementById('abnormal-description').value.trim(),
                    severity: 'low',  // é»˜è®¤å€¼ï¼Œä¿æŒæ•°æ®åº“æ¨¡å‹å…¼å®¹
                    measures_taken: document.getElementById('abnormal-measures').value.trim()
                } : {
                    title: '',
                    description: '',
                    severity: 'low',
                    measures_taken: ''
                };
                
                // ç»„åˆæ¸©åº¦èŒƒå›´
                const minTemp = document.getElementById('min-temperature').value.trim();
                const maxTemp = document.getElementById('max-temperature').value.trim();
                let temperatureRange = '';
                if (minTemp && maxTemp) {
                    temperatureRange = `${minTemp}~${maxTemp}â„ƒ`;
                } else if (minTemp) {
                    temperatureRange = `${minTemp}â„ƒ`;
                } else if (maxTemp) {
                    temperatureRange = `${maxTemp}â„ƒ`;
                }
                
                const logData = {
                    date: logDate,
                    main_image_url: mainImageUrl,
                    recorder_name: document.getElementById('recorder-name').value.trim(),
                    plot_id: document.getElementById('plot-id').value || undefined,
                    farm_activity_type: farmActivityType,
                    harvest_weight_kg: harvestWeight,
                    weather: {
                        icon: document.getElementById('weather').value,
                        temperature_range: temperatureRange
                    },
                    summary: summary,
                    detail_gallery: galleryUrls,
                    photo_info: {
                        photographer: document.getElementById('recorder-name').value.trim(),
                        location: document.getElementById('photo-plot').value
                    },
                    environment_data: {
                        sunshine_hours: document.getElementById('sunshine-hours').value.trim(),
                        rainfall: document.getElementById('rainfall').value.trim(),
                        temperature: document.getElementById('avg-temperature').value.trim(),
                        humidity: document.getElementById('humidity').value.trim()
                    },
                    full_log: document.getElementById('full-log').value.trim(),
                    phenological_observation: document.getElementById('phenological-observation').value.trim(),
                    farm_activity_log: farmActivityLog,
                    abnormal_event: abnormalData
                };

                console.log('ğŸ“¤ å‡†å¤‡æäº¤æ—¥å¿—æ•°æ®:', logData);
                showMessage(isEditMode ? 'æ­£åœ¨æ›´æ–°æ—¥å¿—...' : 'æ­£åœ¨ä¿å­˜æ—¥å¿—...', 'info');

                const url = isEditMode ? `/api/growth-logs/${editingId}` : '/api/growth-logs';
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(isEditMode ? 'âœ… æ—¥å¿—æ›´æ–°æˆåŠŸï¼' : 'âœ… æ—¥å¿—ä¿å­˜æˆåŠŸï¼', 'success');
                    console.log(isEditMode ? 'âœ… æ—¥å¿—æ›´æ–°æˆåŠŸ:' : 'âœ… æ—¥å¿—ä¿å­˜æˆåŠŸ:', result.data);
                    
                    loadExistingDates();
                    
                    document.getElementById('editing-log-id').value = '';
                    document.getElementById('editing-mode-banner').classList.add('hidden');
                    document.getElementById('save-btn').innerHTML = 'ğŸ’¾ ä¿å­˜æ­¤æ¡æ—¥å¿—';
                    
                    const queryMonth = document.getElementById('query-month').value;
                    if (queryMonth) {
                        queryLogs();
                    }
                    
                    setTimeout(() => {
                        if (confirm('æ“ä½œæˆåŠŸï¼æ˜¯å¦ç»§ç»­æ·»åŠ æ–°æ—¥å¿—ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"æ¸…ç©ºè¡¨å•ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ä»ªè¡¨æ¿')) {
                            clearForm();
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('log-date').value = today;
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        } else {
                            window.location.href = '/dashboard';
                        }
                    }, 1500);
                } else {
                    showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
                    console.error('ä¿å­˜å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('ä¿å­˜æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== å›¾ç‰‡å¤„ç† ====================
        async function handleMainImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showMessage('æ­£åœ¨ä¸Šä¼ ä¸»å›¾...', 'info');
            try {
                const url = await uploadImage(file);
                if (url) {
                    mainImageUrl = url;
                    document.getElementById('main-image-url').value = url;
                    const preview = document.getElementById('main-image-preview');
                    const container = document.getElementById('main-image-preview-container');
                    preview.src = url;
                    container.classList.remove('hidden');
                    showMessage('ä¸»å›¾ä¸Šä¼ æˆåŠŸï¼', 'success');
                    console.log('âœ… ä¸»å›¾ä¸Šä¼ æˆåŠŸ:', url);
                }
            } catch (error) {
                showMessage('ä¸»å›¾ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function removeMainImage() {
            if (confirm('ç¡®å®šè¦åˆ é™¤ä¸»å›¾å—ï¼Ÿ')) {
                mainImageUrl = '';
                document.getElementById('main-image-url').value = '';
                document.getElementById('main-image-preview').src = '';
                document.getElementById('main-image-preview-container').classList.add('hidden');
                document.getElementById('main-image-input').value = '';
                showMessage('ä¸»å›¾å·²åˆ é™¤', 'info');
            }
        }

        async function handleGalleryUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            showMessage(`æ­£åœ¨ä¸Šä¼  ${files.length} å¼ å›¾ç‰‡...`, 'info');
            for (let file of files) {
                try {
                    const url = await uploadImage(file);
                    if (url) {
                        galleryUrls.push(url);
                        console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', url);
                    }
                } catch (error) {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                }
            }
            renderGallery();
            showMessage(`æˆåŠŸä¸Šä¼  ${files.length} å¼ å›¾ç‰‡ï¼`, 'success');
            event.target.value = '';
        }

        function renderGallery() {
            const container = document.getElementById('gallery-preview');
            if (galleryUrls.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = galleryUrls.map((url, index) => `
                <div class="gallery-item">
                    <img src="${url}" alt="å›¾ç‰‡ ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeGalleryImage(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removeGalleryImage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                galleryUrls.splice(index, 1);
                renderGallery();
                showMessage('å›¾ç‰‡å·²åˆ é™¤', 'info');
            }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                return result.data.fullUrl;
            } else {
                throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
            }
        }

        function updateSyncFields() {
            const logDate = document.getElementById('log-date').value;
            document.getElementById('photo-date').value = logDate || '';
            const plotId = document.getElementById('plot-id').value;
            const selectedPlot = availablePlots.find(p => p._id === plotId);
            document.getElementById('photo-plot').value = selectedPlot ? selectedPlot.name : '';
            const recorderName = document.getElementById('recorder-name').value;
            document.getElementById('photo-person').value = recorderName || '';
        }

        // ==================== é¡¶éƒ¨å½±åƒç”»å»Šç®¡ç† ====================
        
        // å¤„ç†é¡¶éƒ¨ç”»å»Šä¸Šä¼ 
        async function handleTopGalleryUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            showMessage(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`, 'info');
            
            for (let file of files) {
                try {
                    const url = await uploadImage(file);
                    if (url) {
                        topGalleryUrls.push(url);
                        console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', url);
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                }
            }
            
            renderTopGallery();
            showMessage(`æˆåŠŸä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶ï¼`, 'success');
            event.target.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }

        // æ¸²æŸ“é¡¶éƒ¨å½±åƒç”»å»Š
        function renderTopGallery() {
            const container = document.getElementById('top-gallery-preview');
            
            if (topGalleryUrls.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">æš‚æ— å½±åƒï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹ä¸Šä¼ </p>';
                return;
            }
            
            container.innerHTML = topGalleryUrls.map((url, index) => {
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯è§†é¢‘
                const isVideo = url.toLowerCase().match(/\.(mp4|webm|ogg)$/);
                
                return `
                    <div class="gallery-item">
                        ${isVideo ? 
                            `<video src="${url}" style="width: 100%; height: 150px; object-fit: cover;"></video>` :
                            `<img src="${url}" alt="å½±åƒ ${index + 1}">`
                        }
                        <button type="button" class="remove-btn" onclick="removeTopGalleryImage(${index})">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤é¡¶éƒ¨ç”»å»Šä¸­çš„å›¾ç‰‡
        function removeTopGalleryImage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                topGalleryUrls.splice(index, 1);
                renderTopGallery();
                showMessage('æ–‡ä»¶å·²åˆ é™¤', 'info');
            }
        }

        // ==================== æœˆä»½æ€»ç»“åŠŸèƒ½ ====================
        
        // è·å–å¹¶æ¸²æŸ“æ‰€æœ‰å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“åˆ—è¡¨
        async function fetchAndRenderSummaries() {
            try {
                const response = await fetch('/api/summaries');
                const result = await response.json();

                if (result.success) {
                    displaySummaryList(result.data);
                    console.log('âœ… æˆåŠŸåŠ è½½', result.data.length, 'ä¸ªæœˆåº¦æ€»ç»“');
                } else {
                    showMessage('âŒ åŠ è½½åˆ—è¡¨å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('è·å–æœˆåº¦æ€»ç»“åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ¸²æŸ“æœˆåº¦æ€»ç»“åˆ—è¡¨
        function displaySummaryList(summaries) {
            const container = document.getElementById('summary-list-container');
            
            if (!summaries || summaries.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">æš‚æ— å·²ä¿å­˜çš„æœˆåº¦æ€»ç»“</p>';
                return;
            }

            container.innerHTML = summaries.map(summary => {
                // æ ¼å¼åŒ–å¹´æœˆæ˜¾ç¤º
                const [year, month] = summary.year_month.split('-');
                const displayMonth = `${year}å¹´${parseInt(month)}æœˆ`;
                
                // æå–å…³é”®ç»Ÿè®¡ä¿¡æ¯
                const harvestCount = summary.harvest_stats?.count || 0;
                const harvestWeight = summary.harvest_stats?.total_weight || 0;
                const farmActivitiesCount = summary.farm_calendar ? summary.farm_calendar.split('\n').filter(line => line.trim()).length : 0;
                
                return `
                    <div class="log-item">
                        <div class="log-item-info">
                            <h4>ğŸ“… ${displayMonth} æ€»ç»“</h4>
                            <p>é‡‡æ‘˜ ${harvestCount} æ¬¡ / ${harvestWeight}kg Â· å†œäº‹æ´»åŠ¨ ${farmActivitiesCount} é¡¹ Â· å›¾ç‰‡ ${summary.detail_gallery?.length || 0} å¼ </p>
                        </div>
                        <div class="log-item-actions">
                            <button class="btn btn-secondary btn-small" onclick="editSummary('${summary._id}')">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteSummary('${summary._id}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç¼–è¾‘æœˆåº¦æ€»ç»“
        async function editSummary(id) {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ€»ç»“æ•°æ®...', 'info');
                
                const response = await fetch(`/api/monthly-summaries/${id}`);
                const result = await response.json();

                if (result.success) {
                    const summary = result.data;
                    
                    // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                    document.getElementById('editing-summary-id').value = id;
                    document.getElementById('editing-summary-banner').classList.remove('hidden');
                    
                    // å¡«å……æ•°æ®åˆ°è¡¨å•
                    displaySummary(summary);
                    
                    // æ»šåŠ¨åˆ°ç¼–è¾‘è¡¨å•
                    document.getElementById('summary-display').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    showMessage('âœ… æ€»ç»“æ•°æ®å·²åŠ è½½ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»ä¿å­˜æŒ‰é’®', 'success');
                    console.log('âœ… ç¼–è¾‘æ¨¡å¼ï¼šå·²åŠ è½½æ€»ç»“æ•°æ®', summary);
                } else {
                    showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ€»ç»“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // åˆ é™¤æœˆåº¦æ€»ç»“
        async function deleteSummary(id) {
            // è·å–è¦åˆ é™¤çš„æ€»ç»“ä¿¡æ¯
            const summaryElement = event.target.closest('.log-item');
            const summaryTitle = summaryElement.querySelector('h4').textContent;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${summaryTitle}"å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åˆ é™¤æ€»ç»“...', 'info');
                
                const response = await fetch(`/api/monthly-summaries/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æ€»ç»“å·²æˆåŠŸåˆ é™¤', 'success');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                    
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘è¿™æ¡è®°å½•ï¼Œå–æ¶ˆç¼–è¾‘æ¨¡å¼
                    if (document.getElementById('editing-summary-id').value === id) {
                        cancelSummaryEdit();
                    }
                    
                    console.log('âœ… å·²åˆ é™¤æ€»ç»“:', id);
                } else {
                    showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å–æ¶ˆç¼–è¾‘æ€»ç»“
        function cancelSummaryEdit() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('editing-summary-id').value = '';
                document.getElementById('editing-summary-banner').classList.add('hidden');
                document.getElementById('summary-display').classList.add('hidden');
                currentSummaryId = null;
                
                // æ¸…ç©ºé¡¶éƒ¨ç”»å»Š
                topGalleryUrls = [];
                renderTopGallery();
                
                showMessage('å·²å–æ¶ˆç¼–è¾‘ï¼Œå¯ä»¥ç”Ÿæˆæ–°çš„æ€»ç»“', 'info');
            }
        }

        async function generateSummary() {
            const month = document.getElementById('summary-month').value;
            if (!month) {
                showMessage('è¯·é€‰æ‹©è¦ç”Ÿæˆæ€»ç»“çš„æœˆä»½', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ä¸º ${month} ç”Ÿæˆæœˆåº¦æ€»ç»“å—ï¼Ÿ\nå¦‚æœè¯¥æœˆå·²æœ‰æ€»ç»“ï¼Œå°†ä¼šè¢«æ›´æ–°ã€‚`)) {
                return;
            }

            try {
                showMessage('æ­£åœ¨ç”Ÿæˆæœˆåº¦æ€»ç»“...', 'info');
                
                const response = await fetch('/api/summaries/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ month: month })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æœˆåº¦æ€»ç»“ç”ŸæˆæˆåŠŸï¼', 'success');
                    console.log('âœ… æœˆåº¦æ€»ç»“:', result.data);
                    
                    // è‡ªåŠ¨æ˜¾ç¤ºç”Ÿæˆçš„æ€»ç»“
                    displaySummary(result.data);
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                } else {
                    showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæœˆåº¦æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
            }
        }


        function displaySummary(summary) {
            // å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè®¾ç½® currentSummaryId
            const editingId = document.getElementById('editing-summary-id').value;
            if (!editingId) {
                currentSummaryId = summary._id;
            }
            
            // å¡«å……é‡‡æ‘˜ç»Ÿè®¡åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†
            document.getElementById('harvest-count').value = summary.harvest_stats?.count || 0;
            document.getElementById('harvest-weight').value = summary.harvest_stats?.total_weight || 0;
            
            // å¡«å……å†œäº‹æ—¥å†åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            document.getElementById('farm-calendar-display').value = summary.farm_calendar || '';
            
            // å¡«å……å¼‚å¸¸äº‹ä»¶æ±‡æ€»åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            const abnormalDisplay = document.getElementById('abnormal-events-display');
            if (summary.abnormal_summary && summary.abnormal_summary.length > 0) {
                // å°†å¼‚å¸¸äº‹ä»¶æ•°ç»„è½¬æ¢ä¸ºå¯ç¼–è¾‘çš„æ–‡æœ¬æ ¼å¼
                const abnormalText = summary.abnormal_summary.map(event => 
                    `${event.date} ${event.issue}ï¼Œ${event.measures}`
                ).join('\n');
                abnormalDisplay.value = abnormalText;
            } else {
                abnormalDisplay.value = '';
            }
            
            // å¡«å……æ°”å€™æ€»ç»“åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†
            document.getElementById('avg-temp-display').value = summary.climate_summary?.avg_temp || '';
            document.getElementById('total-precipitation-display').value = summary.climate_summary?.total_precipitation || '';
            
            // å¡«å……é¡¶éƒ¨å½±åƒç”»å»Š
            topGalleryUrls = summary.detail_gallery || [];
            renderTopGallery();
            
            // å¡«å……ä¸‹æœˆè®¡åˆ’åˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
            const plans = summary.next_month_plan || [];
            document.getElementById('next-month-plan').value = plans.join('\n');
            
            // æ˜¾ç¤ºæ€»ç»“åŒºåŸŸ
            document.getElementById('summary-display').classList.remove('hidden');
            
            console.log('âœ… æœˆåº¦æ€»ç»“æ•°æ®å·²å¡«å……åˆ°è¡¨å•ï¼Œå¯ä»¥è¿›è¡Œç¼–è¾‘');
        }

        async function saveAllSummaryChanges() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è¦ä¿å­˜çš„æ€»ç»“ï¼ˆç¼–è¾‘æ¨¡å¼æˆ–ç”Ÿæˆåçš„æ€»ç»“ï¼‰
            const editingId = document.getElementById('editing-summary-id').value;
            const summaryId = editingId || currentSummaryId;
            
            if (!summaryId) {
                showMessage('è¯·å…ˆç”Ÿæˆæˆ–åŠ è½½æœˆåº¦æ€»ç»“', 'error');
                return;
            }

            // æ·»åŠ ä¿å­˜ç¡®è®¤
            if (!confirm('ç¡®å®šè¦ä¿å­˜æœˆåº¦æ€»ç»“çš„æ‰€æœ‰ä¿®æ”¹å—ï¼Ÿ')) {
                showMessage('å·²å–æ¶ˆä¿å­˜', 'info');
                return;
            }

            try {
                // 1. æ”¶é›†é‡‡æ‘˜ç»Ÿè®¡æ•°æ®ï¼ˆåªè¯»ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼‰
                // æ³¨æ„ï¼šé‡‡æ‘˜ç»Ÿè®¡æ•°æ®æ¥è‡ª"æ‰¹æ¬¡è¿½æº¯ç®¡ç†"ä¸­çš„é‡‡æ‘˜è®°å½•ï¼Œæ­¤å¤„åªè¯»å–ç³»ç»Ÿè®¡ç®—çš„å€¼
                const harvestCount = parseInt(document.getElementById('harvest-count').value) || 0;
                const harvestWeight = parseFloat(document.getElementById('harvest-weight').value) || 0;
                
                // 2. æ”¶é›†å†œäº‹æ—¥å†æ•°æ®
                const farmCalendar = document.getElementById('farm-calendar-display').value.trim();
                
                // 3. æ”¶é›†å¹¶è§£æå¼‚å¸¸äº‹ä»¶æ±‡æ€»
                const abnormalText = document.getElementById('abnormal-events-display').value.trim();
                const abnormalSummary = [];
                if (abnormalText) {
                    // ç®€å•è§£æï¼šæ¯è¡Œä¸€ä¸ªäº‹ä»¶ï¼Œæ ¼å¼ï¼šæ—¥æœŸ é—®é¢˜ï¼Œæªæ–½
                    const lines = abnormalText.split('\n').filter(line => line.trim());
                    lines.forEach(line => {
                        // å°è¯•æå–æ—¥æœŸã€é—®é¢˜å’Œæªæ–½
                        const match = line.match(/^(\S+)\s+(.+?)ï¼Œ(.+)$/);
                        if (match) {
                            abnormalSummary.push({
                                date: match[1],
                                issue: match[2],
                                measures: match[3]
                            });
                        } else {
                            // å¦‚æœæ ¼å¼ä¸åŒ¹é…ï¼Œå°†æ•´è¡Œä½œä¸ºé—®é¢˜
                            abnormalSummary.push({
                                date: '',
                                issue: line,
                                measures: ''
                            });
                        }
                    });
                }
                
                // 4. æ”¶é›†æ°”å€™æ€»ç»“æ•°æ®
                const avgTemp = document.getElementById('avg-temp-display').value.trim();
                const totalPrecipitation = document.getElementById('total-precipitation-display').value.trim();
                
                // 5. æ”¶é›†ä¸‹æœˆè®¡åˆ’æ•°æ®
                const planText = document.getElementById('next-month-plan').value.trim();
                const nextMonthPlan = planText.split('\n').filter(line => line.trim()).map(line => line.trim());

                // 6. æ„å»ºå®Œæ•´çš„æ›´æ–°å¯¹è±¡
                const summaryData = {
                    detail_gallery: topGalleryUrls, // åŒ…å«é¡¶éƒ¨å½±åƒç”»å»Š
                    harvest_stats: {
                        count: harvestCount,
                        total_weight: harvestWeight
                    },
                    farm_calendar: farmCalendar,
                    abnormal_summary: abnormalSummary,
                    climate_summary: {
                        avg_temp: avgTemp,
                        total_precipitation: totalPrecipitation
                    },
                    next_month_plan: nextMonthPlan
                };

                console.log('ğŸ“¤ å‡†å¤‡ä¿å­˜æœˆåº¦æ€»ç»“:', summaryData);
                showMessage('æ­£åœ¨ä¿å­˜æ‰€æœ‰ä¿®æ”¹...', 'info');
                
                // 7. å‘é€ PUT è¯·æ±‚æ›´æ–°æ•°æ®
                const response = await fetch(`/api/monthly-summaries/${summaryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(summaryData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… æœˆåº¦æ€»ç»“ä¿å­˜æˆåŠŸï¼æ‰€æœ‰ä¿®æ”¹å·²æ›´æ–°', 'success');
                    console.log('âœ… æœˆåº¦æ€»ç»“å·²æ›´æ–°:', result.data);
                    
                    // é‡æ–°æ˜¾ç¤ºæ›´æ–°åçš„æ•°æ®
                    displaySummary(result.data);
                    
                    // åˆ·æ–°åˆ—è¡¨
                    fetchAndRenderSummaries();
                    
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
                    if (editingId) {
                        document.getElementById('editing-summary-id').value = '';
                        document.getElementById('editing-summary-banner').classList.add('hidden');
                        currentSummaryId = result.data._id;
                    }
                } else {
                    showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜æœˆåº¦æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== æ¶ˆæ¯æç¤º ====================
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const className = type === 'success' ? 'success-message' : 
                            type === 'error' ? 'error-message' : 'info-box';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            if (type !== 'error') {
                setTimeout(() => { container.innerHTML = ''; }, 5000);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘å…»èŒ¶å›­ç®¡ç† - åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .header h1 {
            color: #333;
            font-size: 1.5rem;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            position: absolute;
            left: 2rem;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            background: white;
            border: none;
            padding: 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .tab-button:hover:not(.active) {
            background: #f5f5f5;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        /* è¡¨å•æ ·å¼ */
        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: #555;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* åŠ¨æ€åˆ—è¡¨æ ·å¼ */
        .dynamic-list {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .dynamic-list h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .section-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .toggle-icon {
            font-size: 1rem;
            transition: transform 0.3s ease;
            color: #667eea;
            display: inline-block;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .toggle-icon:not(.collapsed) {
            transform: rotate(0deg);
        }

        .list-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .list-item {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .list-item-title {
            font-weight: 600;
            color: #333;
        }

        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* åª’ä½“é¢„è§ˆ */
        .media-preview {
            margin-top: 0.5rem;
            max-width: 200px;
        }

        .media-preview img,
        .media-preview video {
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }

        .add-item-btn {
            margin-top: 1rem;
        }

        /* åµŒå¥—åˆ—è¡¨æ ·å¼ï¼ˆç”¨äºå¥—é¤æƒç›Šï¼‰ */
        .nested-list {
            margin-top: 1rem;
            padding-left: 1rem;
        }

        .nested-item {
            background: #f8f9fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 1rem;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #ddd;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .tab-buttons {
                flex-direction: column;
            }

            .tab-content {
                padding: 1rem;
            }

            .form-section,
            .dynamic-list {
                padding: 1rem;
            }

            .list-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .modal-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/dashboard" class="back-btn">è¿”å›ä»ªè¡¨ç›˜</a>
        <h1>ğŸµ äº‘å…»èŒ¶å›­ç®¡ç†</h1>
    </header>

    <div class="container">
        <div id="message" class="message"></div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="private">ç§äººå®šåˆ¶ç®¡ç†</button>
                <button class="tab-button" data-tab="enterprise">ä¼ä¸šå®šåˆ¶ç®¡ç†</button>
                <button class="tab-button" data-tab="b2b">Bç«¯ç®¡ç†</button>
            </div>

            <!-- ç§äººå®šåˆ¶ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="private-tab" class="tab-content active">
                <!-- è¥é”€æ ‡é¢˜ -->
                <div class="form-section">
                    <h3 onclick="toggleSection(this)">
                        <span>è¥é”€æ ‡é¢˜</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div class="form-group">
                            <label>ä¸»æ ‡é¢˜</label>
                            <input type="text" id="private-title" placeholder="ä¸»æ ‡é¢˜">
                        </div>
                        <div class="form-group">
                            <label>å‰¯æ ‡é¢˜</label>
                            <input type="text" id="private-subtitle" placeholder="å‰¯æ ‡é¢˜">
                        </div>
                        <button class="btn btn-success" onclick="saveMarketingHeader('private')" style="width: 100%; margin-top: 0.5rem;">ğŸ’¾ ä¿å­˜æ ‡é¢˜</button>
                    </div>
                </div>

                <!-- æ ¸å¿ƒä»·å€¼ä¸»å¼  -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>æ ¸å¿ƒä»·å€¼ä¸»å¼ </span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="private-value-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addValueProposition()">+ æ·»åŠ ä»·å€¼ä¸»å¼ </button>
                    </div>
                </div>

                <!-- å®¢æˆ·æ¡ˆä¾‹ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>å®¢æˆ·æ¡ˆä¾‹</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="private-cases-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addCustomerCase('private')">+ æ·»åŠ å®¢æˆ·æ¡ˆä¾‹</button>
                    </div>
                </div>

                <!-- åœºæ™¯åŒ–åº”ç”¨ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>åœºæ™¯åŒ–åº”ç”¨</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="private-scenarios-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addScenario('private')">+ æ·»åŠ åº”ç”¨åœºæ™¯</button>
                    </div>
                </div>

                <!-- å®šåˆ¶å¥—é¤ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>å®šåˆ¶å¥—é¤</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="private-packages-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addPackage()">+ æ·»åŠ å¥—é¤</button>
                    </div>
                </div>

                <!-- é¢†å…»æµç¨‹ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>é¢†å…»æµç¨‹</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="private-process-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addProcessStep('private')">+ æ·»åŠ æµç¨‹æ­¥éª¤</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-success" style="padding: 1rem 3rem; font-size: 1.1rem;" onclick="saveCurrentPlan()">ğŸ’¾ ä¿å­˜æ‰€æœ‰å†…å®¹</button>
                </div>
            </div>

            <!-- ä¼ä¸šå®šåˆ¶ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="enterprise-tab" class="tab-content">
                <!-- è¥é”€æ ‡é¢˜ -->
                <div class="form-section">
                    <h3 onclick="toggleSection(this)">
                        <span>è¥é”€æ ‡é¢˜</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div class="form-group">
                            <label>ä¸»æ ‡é¢˜</label>
                            <input type="text" id="enterprise-title" placeholder="ä¸»æ ‡é¢˜">
                        </div>
                        <div class="form-group">
                            <label>å‰¯æ ‡é¢˜</label>
                            <input type="text" id="enterprise-subtitle" placeholder="å‰¯æ ‡é¢˜">
                        </div>
                        <button class="btn btn-success" onclick="saveMarketingHeader('enterprise')" style="width: 100%; margin-top: 0.5rem;">ğŸ’¾ ä¿å­˜æ ‡é¢˜</button>
                    </div>
                </div>

                <!-- å®¢æˆ·æ¡ˆä¾‹å±•ç¤º -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>å®¢æˆ·æ¡ˆä¾‹å±•ç¤º</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="enterprise-cases-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addCustomerCase('enterprise')">+ æ·»åŠ å®¢æˆ·æ¡ˆä¾‹å±•ç¤º</button>
                    </div>
                </div>

                <!-- ä½¿ç”¨åœºæ™¯ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>ä½¿ç”¨åœºæ™¯</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="enterprise-scenarios-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addScenario('enterprise')">+ æ·»åŠ ä½¿ç”¨åœºæ™¯</button>
                    </div>
                </div>

                <!-- æœåŠ¡å†…å®¹ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>æœåŠ¡å†…å®¹</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="enterprise-services-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addServiceContent()">+ æ·»åŠ æœåŠ¡å†…å®¹</button>
                    </div>
                </div>

                <!-- åˆä½œæµç¨‹ -->
                <div class="dynamic-list">
                    <h3 onclick="toggleSection(this)">
                        <span>åˆä½œæµç¨‹</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div id="enterprise-process-list" class="list-items"></div>
                        <button class="btn btn-primary add-item-btn" onclick="addProcessStep('enterprise')">+ æ·»åŠ æµç¨‹æ­¥éª¤</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-success" style="padding: 1rem 3rem; font-size: 1.1rem;" onclick="saveCurrentPlan()">ğŸ’¾ ä¿å­˜æ‰€æœ‰å†…å®¹</button>
                </div>
            </div>

            <!-- Bç«¯ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="b2b-tab" class="tab-content">
                <div class="form-section">
                    <h3 onclick="toggleSection(this)">
                        <span>Bç«¯åˆä½œç®€ä»‹</span>
                        <span class="toggle-icon collapsed">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div class="form-group">
                            <label>ç®€ä»‹å†…å®¹</label>
                            <textarea id="b2b-description" rows="6" placeholder="è¾“å…¥Bç«¯åˆä½œçš„ç®€ä»‹å†…å®¹..."></textarea>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-success" style="padding: 1rem 3rem; font-size: 1.1rem;" onclick="saveCurrentPlan()">ğŸ’¾ ä¿å­˜å†…å®¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">ç¼–è¾‘</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-success" style="flex: 1;" onclick="saveModalData()">ä¿å­˜</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        let privateData = null;
        let enterpriseData = null;
        let b2bData = null;
        let currentTab = 'private';
        let modalCallback = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupTabSwitching();
            loadAllPlans();
        });

        // ========== æŠ˜å /å±•å¼€åŠŸèƒ½ ==========
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content && content.classList.contains('section-content')) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }
        }

        // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
        function setupTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;
        }

        // åŠ è½½æ‰€æœ‰æ–¹æ¡ˆæ•°æ®
        async function loadAllPlans() {
            try {
                await Promise.all([
                    loadPlan('private'),
                    loadPlan('enterprise'),
                    loadPlan('b2b')
                ]);
                showMessage('æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                showMessage('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½å•ä¸ªæ–¹æ¡ˆ
        async function loadPlan(type) {
            try {
                const response = await fetch(`/api/adoption-plans/${type}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const result = await response.json();
                const data = result.data || result; // å…¼å®¹æ–°æ—§æ ¼å¼
                
                // è°ƒè¯•æ—¥å¿—ï¼šæŸ¥çœ‹åŠ è½½çš„æ•°æ®
                console.log(`ğŸ“¥ ä»æœåŠ¡å™¨åŠ è½½${type}æ–¹æ¡ˆæ•°æ®:`, data);
                console.log(`ğŸ“¥ å®¢æˆ·æ¡ˆä¾‹æ•°æ®:`, data.customer_cases);
                
                if (type === 'private') {
                    privateData = data;
                    renderPrivatePlan(data);
                } else if (type === 'enterprise') {
                    enterpriseData = data;
                    renderEnterprisePlan(data);
                } else if (type === 'b2b') {
                    b2bData = data;
                    renderB2BPlan(data);
                }
            } catch (error) {
                console.error(`åŠ è½½${type}æ–¹æ¡ˆå¤±è´¥:`, error);
            }
        }

        // æ¸²æŸ“ç§äººå®šåˆ¶æ–¹æ¡ˆ
        function renderPrivatePlan(data) {
            // è¥é”€æ ‡é¢˜
            document.getElementById('private-title').value = data.marketing_header?.title || '';
            document.getElementById('private-subtitle').value = data.marketing_header?.subtitle || '';

            // æ ¸å¿ƒä»·å€¼ä¸»å¼ 
            renderList('private-value-list', data.value_propositions || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${item.icon} ${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editValueProposition(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteValueProposition(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${item.description}</div>
                </div>
            `);

            // å®¢æˆ·æ¡ˆä¾‹
            renderList('private-cases-list', data.customer_cases || [], (item, index) => {
                const mediaPreview = item.image_url ? (
                    item.media_type === 'video' 
                    ? `<div class="media-preview"><video src="${item.image_url}" controls></video></div>`
                    : `<div class="media-preview"><img src="${item.image_url}" alt="æ¡ˆä¾‹å›¾ç‰‡"></div>`
                ) : '';
                
                return `
                    <div class="list-item">
                        <div class="list-item-header">
                            <span class="list-item-title">æ¡ˆä¾‹ ${index + 1}</span>
                            <div class="list-item-actions">
                                <button class="btn btn-primary btn-small" onclick="editCustomerCase('private', ${index})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-small" onclick="deleteCustomerCase('private', ${index})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div>${item.text}</div>
                        ${mediaPreview}
                    </div>
                `;
            });

            // åœºæ™¯åŒ–åº”ç”¨
            renderList('private-scenarios-list', data.scenario_applications || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editScenario('private', ${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteScenario('private', ${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${(item.content || item.application || '')?.substring(0, 150)}...</div>
                </div>
            `);

            // å®šåˆ¶å¥—é¤
            renderList('private-packages-list', data.packages || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${item.name} - ${item.price}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editPackage(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deletePackage(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div><strong>é¢å‘å®¢ç¾¤:</strong> ${item.target_audience || 'æœªè®¾ç½®'}</div>
                    <div><strong>åœ°å—ç‰¹è‰²:</strong> ${item.area_features || 'æœªè®¾ç½®'}</div>
                    <div><strong>ä¸“å±äº§å‡º:</strong> ${item.exclusive_output || item.tagline || 'æœªè®¾ç½®'}</div>
                    <div style="margin-top: 0.5rem;">
                        <strong>æ ¸å¿ƒæƒç›Š (${item.rights?.length || 0}é¡¹):</strong>
                        ${(item.rights || []).map(r => `<div>${r.icon ? r.icon + ' ' : ''}${r.title}</div>`).join('')}
                    </div>
                </div>
            `);

            // é¢†å…»æµç¨‹
            renderList('private-process-list', data.process_steps || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">æ­¥éª¤ ${item.step}: ${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editProcessStep('private', ${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProcessStep('private', ${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${item.description?.substring(0, 100)}...</div>
                </div>
            `);
        }

        // æ¸²æŸ“ä¼ä¸šé¢†å…»æ–¹æ¡ˆ
        function renderEnterprisePlan(data) {
            document.getElementById('enterprise-title').value = data.marketing_header?.title || '';
            document.getElementById('enterprise-subtitle').value = data.marketing_header?.subtitle || '';

            // å®¢æˆ·æ¡ˆä¾‹å±•ç¤º
            renderList('enterprise-cases-list', data.customer_cases || [], (item, index) => {
                const mediaPreview = item.image_url ? (
                    item.media_type === 'video' 
                    ? `<div class="media-preview"><video src="${item.image_url}" controls></video></div>`
                    : `<div class="media-preview"><img src="${item.image_url}" alt="æ¡ˆä¾‹å›¾ç‰‡"></div>`
                ) : '';
                
                return `
                    <div class="list-item">
                        <div class="list-item-header">
                            <span class="list-item-title">æ¡ˆä¾‹å±•ç¤º ${index + 1}</span>
                            <div class="list-item-actions">
                                <button class="btn btn-primary btn-small" onclick="editCustomerCase('enterprise', ${index})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-small" onclick="deleteCustomerCase('enterprise', ${index})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div>${item.text}</div>
                        ${mediaPreview}
                    </div>
                `;
            });

            // ä½¿ç”¨åœºæ™¯
            renderList('enterprise-scenarios-list', data.use_scenarios || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editScenario('enterprise', ${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteScenario('enterprise', ${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${(item.content || item.application || '')?.substring(0, 150)}...</div>
                </div>
            `);

            // æœåŠ¡å†…å®¹
            renderList('enterprise-services-list', data.service_contents || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${item.icon} ${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editServiceContent(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteServiceContent(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${item.description}</div>
                </div>
            `);

            // åˆä½œæµç¨‹
            renderList('enterprise-process-list', data.process_steps || [], (item, index) => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">æ­¥éª¤ ${item.step}: ${item.title}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-primary btn-small" onclick="editProcessStep('enterprise', ${index})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProcessStep('enterprise', ${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div>${item.description?.substring(0, 100)}...</div>
                </div>
            `);
        }

        // æ¸²æŸ“Bç«¯æ–¹æ¡ˆ
        function renderB2BPlan(data) {
            document.getElementById('b2b-description').value = data.description || '';
        }

        // é€šç”¨åˆ—è¡¨æ¸²æŸ“å‡½æ•°
        function renderList(containerId, items, renderItem) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (items.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 1rem;">æš‚æ— æ•°æ®</div>';
            } else {
                container.innerHTML = items.map(renderItem).join('');
            }
        }

        // ========== è¥é”€æ ‡é¢˜å•ç‹¬ä¿å­˜ ==========
        async function saveMarketingHeader(type) {
            try {
                const data = type === 'private' ? privateData : enterpriseData;
                const titleField = document.getElementById(`${type}-title`).value;
                const subtitleField = document.getElementById(`${type}-subtitle`).value;
                
                data.marketing_header = {
                    title: titleField,
                    subtitle: subtitleField
                };

                const response = await fetch(`/api/adoption-plans/${type}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');
                
                showMessage('è¥é”€æ ‡é¢˜ä¿å­˜æˆåŠŸï¼', 'success');
                await loadPlan(type);
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== æ ¸å¿ƒä»·å€¼ä¸»å¼ ç®¡ç† ==========
        function addValueProposition() {
            openModal('æ·»åŠ ä»·å€¼ä¸»å¼ ', `
                <div class="form-group">
                    <label>å›¾æ ‡ (emoji)</label>
                    <input type="text" id="modal-icon" placeholder="å¦‚: ğŸ‘‘">
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" placeholder="æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="modal-description" rows="3" placeholder="æè¿°å†…å®¹"></textarea>
                </div>
            `, async () => {
                const newItem = {
                    icon: document.getElementById('modal-icon').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                privateData.value_propositions.push(newItem);
                renderPrivatePlan(privateData);
                closeModal();
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan('private');
            });
        }

        function editValueProposition(index) {
            const item = privateData.value_propositions[index];
            openModal('ç¼–è¾‘ä»·å€¼ä¸»å¼ ', `
                <div class="form-group">
                    <label>å›¾æ ‡ (emoji)</label>
                    <input type="text" id="modal-icon" value="${item.icon || ''}" placeholder="å¦‚: ğŸ‘‘">
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" value="${item.title || ''}" placeholder="æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="modal-description" rows="3" placeholder="æè¿°å†…å®¹">${item.description || ''}</textarea>
                </div>
            `, async () => {
                privateData.value_propositions[index] = {
                    icon: document.getElementById('modal-icon').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                renderPrivatePlan(privateData);
                closeModal();
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan('private');
            });
        }

        async function deleteValueProposition(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»·å€¼ä¸»å¼ å—ï¼Ÿ')) {
                privateData.value_propositions.splice(index, 1);
                renderPrivatePlan(privateData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan('private');
            }
        }

        // ========== å®¢æˆ·æ¡ˆä¾‹ç®¡ç†ï¼ˆæ”¯æŒå›¾ç‰‡/è§†é¢‘ä¸Šä¼ ï¼‰==========
        function addCustomerCase(type) {
            openModal('æ·»åŠ å®¢æˆ·æ¡ˆä¾‹', `
                <div class="form-group">
                    <label>æ¡ˆä¾‹æ–‡æ¡ˆ</label>
                    <textarea id="modal-text" rows="3" placeholder="æ¡ˆä¾‹æè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡/è§†é¢‘</label>
                    <div class="upload-area" onclick="document.getElementById('modal-file-input').click()">
                        <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘</p>
                        <input type="file" id="modal-file-input" accept="image/*,video/*">
                    </div>
                    <div id="upload-preview" style="margin-top: 1rem;"></div>
                </div>
            `, async () => {
                const text = document.getElementById('modal-text').value;
                const fileInput = document.getElementById('modal-file-input');
                let image_url = '';
                let media_type = 'image';
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    media_type = file.type.startsWith('video') ? 'video' : 'image';
                    
                    const formData = new FormData();
                    formData.append('media', file);
                    formData.append('category', 'misc');
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            image_url = result.url || result.fileUrl; // å…¼å®¹æ–°æ—§æ ¼å¼
                            console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ŒURL:', image_url);
                        } else {
                            const error = await response.json();
                            showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            return; // ä¸Šä¼ å¤±è´¥åˆ™ä¸ç»§ç»­ä¿å­˜
                        }
                    } catch (error) {
                        console.error('ä¸Šä¼ å¤±è´¥:', error);
                        showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                        return; // ä¸Šä¼ å¤±è´¥åˆ™ä¸ç»§ç»­ä¿å­˜
                    }
                }
                
                const newItem = { text, image_url, media_type };
                const data = type === 'private' ? privateData : enterpriseData;
                data.customer_cases.push(newItem);
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                closeModal();
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan(type);
            });

            // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            setTimeout(() => {
                const fileInput = document.getElementById('modal-file-input');
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('upload-preview');
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            if (file.type.startsWith('video')) {
                                preview.innerHTML = `<video src="${e.target.result}" controls style="max-width: 100%; border-radius: 5px;"></video>`;
                            } else {
                                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 5px;">`;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }, 100);
        }

        function editCustomerCase(type, index) {
            const data = type === 'private' ? privateData : enterpriseData;
            const item = data.customer_cases[index];
            
            // è°ƒè¯•æ—¥å¿—ï¼šæŸ¥çœ‹ç¼–è¾‘æ—¶çš„æ•°æ®
            console.log(`ğŸ“ ç¼–è¾‘å®¢æˆ·æ¡ˆä¾‹ - ç±»å‹: ${type}, ç´¢å¼•: ${index}`);
            console.log(`ğŸ“ å½“å‰æ•°æ®å¯¹è±¡:`, data);
            console.log(`ğŸ“ å®¢æˆ·æ¡ˆä¾‹é¡¹:`, item);
            console.log(`ğŸ“ å›¾ç‰‡URL:`, item.image_url);
            console.log(`ğŸ“ åª’ä½“ç±»å‹:`, item.media_type);
            
            const currentPreview = item.image_url ? (
                item.media_type === 'video'
                ? `<video src="${item.image_url}" controls style="max-width: 100%; border-radius: 5px;"></video>`
                : `<img src="${item.image_url}" style="max-width: 100%; border-radius: 5px;">`
            ) : '';
            
            openModal('ç¼–è¾‘å®¢æˆ·æ¡ˆä¾‹', `
                <div class="form-group">
                    <label>æ¡ˆä¾‹æ–‡æ¡ˆ</label>
                    <textarea id="modal-text" rows="3" placeholder="æ¡ˆä¾‹æè¿°">${item.text || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>å½“å‰åª’ä½“</label>
                    <div id="current-preview">${currentPreview || 'æ— '}</div>
                </div>
                <div class="form-group">
                    <label>æ›¿æ¢å›¾ç‰‡/è§†é¢‘ (å¯é€‰)</label>
                    <div class="upload-area" onclick="document.getElementById('modal-file-input').click()">
                        <p>ç‚¹å‡»ä¸Šä¼ æ–°çš„å›¾ç‰‡æˆ–è§†é¢‘</p>
                        <input type="file" id="modal-file-input" accept="image/*,video/*">
                    </div>
                    <div id="upload-preview" style="margin-top: 1rem;"></div>
                </div>
            `, async () => {
                const text = document.getElementById('modal-text').value;
                const fileInput = document.getElementById('modal-file-input');
                let image_url = item.image_url;
                let media_type = item.media_type;
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    media_type = file.type.startsWith('video') ? 'video' : 'image';
                    
                    const formData = new FormData();
                    formData.append('media', file);
                    formData.append('category', 'misc');
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            image_url = result.url || result.fileUrl; // å…¼å®¹æ–°æ—§æ ¼å¼
                            console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ŒURL:', image_url);
                        } else {
                            const error = await response.json();
                            showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            return; // ä¸Šä¼ å¤±è´¥åˆ™ä¸ç»§ç»­ä¿å­˜
                        }
                    } catch (error) {
                        console.error('ä¸Šä¼ å¤±è´¥:', error);
                        showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                        return; // ä¸Šä¼ å¤±è´¥åˆ™ä¸ç»§ç»­ä¿å­˜
                    }
                }
                
                data.customer_cases[index] = { text, image_url, media_type };
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                closeModal();
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan(type);
            });

            // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            setTimeout(() => {
                const fileInput = document.getElementById('modal-file-input');
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('upload-preview');
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            if (file.type.startsWith('video')) {
                                preview.innerHTML = `<video src="${e.target.result}" controls style="max-width: 100%; border-radius: 5px;"></video>`;
                            } else {
                                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 5px;">`;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }, 100);
        }

        async function deleteCustomerCase(type, index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·æ¡ˆä¾‹å—ï¼Ÿ')) {
                const data = type === 'private' ? privateData : enterpriseData;
                data.customer_cases.splice(index, 1);
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan(type);
            }
        }

        // ========== åœºæ™¯åŒ–åº”ç”¨/ä½¿ç”¨åœºæ™¯ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰==========
        function addScenario(type) {
            openModal('æ·»åŠ åœºæ™¯', `
                <div class="form-group">
                    <label>åœºæ™¯æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" placeholder="åœºæ™¯æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>åœºæ™¯å†…å®¹</label>
                    <textarea id="modal-content" rows="8" placeholder="åœºæ™¯çš„è¯¦ç»†å†…å®¹æè¿°"></textarea>
                </div>
            `, () => {
                const newItem = {
                    title: document.getElementById('modal-title-field').value,
                    content: document.getElementById('modal-content').value
                };
                if (type === 'private') {
                    privateData.scenario_applications.push(newItem);
                    renderPrivatePlan(privateData);
                } else {
                    enterpriseData.use_scenarios.push(newItem);
                    renderEnterprisePlan(enterpriseData);
                }
                closeModal();
            });
        }

        function editScenario(type, index) {
            const data = type === 'private' ? privateData : enterpriseData;
            const items = type === 'private' ? data.scenario_applications : data.use_scenarios;
            const item = items[index];
            
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæœ‰ application å’Œ effectï¼Œåˆå¹¶åˆ° content
            const content = item.content || `${item.application || ''}\n\n${item.effect || ''}`;
            
            openModal('ç¼–è¾‘åœºæ™¯', `
                <div class="form-group">
                    <label>åœºæ™¯æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" value="${item.title || ''}" placeholder="åœºæ™¯æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>åœºæ™¯å†…å®¹</label>
                    <textarea id="modal-content" rows="8" placeholder="åœºæ™¯çš„è¯¦ç»†å†…å®¹æè¿°">${content}</textarea>
                </div>
            `, () => {
                items[index] = {
                    title: document.getElementById('modal-title-field').value,
                    content: document.getElementById('modal-content').value
                };
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                closeModal();
            });
        }

        async function deleteScenario(type, index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœºæ™¯å—ï¼Ÿ')) {
                const data = type === 'private' ? privateData : enterpriseData;
                const items = type === 'private' ? data.scenario_applications : data.use_scenarios;
                items.splice(index, 1);
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan(type);
            }
        }

        // ========== å®šåˆ¶å¥—é¤ç®¡ç†ï¼ˆæ–°å¢åœ°å—ç‰¹è‰²ï¼‰==========
        let tempPackageRights = []; // ä¸´æ—¶å­˜å‚¨æ–°å¥—é¤çš„æƒç›Š

        function addPackage() {
            tempPackageRights = []; // é‡ç½®ä¸´æ—¶æƒç›Š
            
            openModal('æ·»åŠ å¥—é¤', `
                <div class="form-group">
                    <label>å¥—é¤åç§°</label>
                    <input type="text" id="modal-name" placeholder="å¦‚: æ ‡å‡†å¥—é¤">
                </div>
                <div class="form-group">
                    <label>å¥—é¤ä»·æ ¼</label>
                    <input type="text" id="modal-price" placeholder="å¦‚: Â¥18,800/å¹´">
                </div>
                <div class="form-group">
                    <label>é¢å‘å®¢ç¾¤</label>
                    <input type="text" id="modal-target-audience" placeholder="å¦‚: çƒ­çˆ±èŒ¶æ–‡åŒ–ã€æ³¨é‡å“è´¨ä¸æ€§ä»·æ¯”çš„èŒ¶å‹">
                </div>
                <div class="form-group">
                    <label>åœ°å—ç‰¹è‰²</label>
                    <input type="text" id="modal-area-features" placeholder="å¦‚: 0.3äº©ä½äºè§„èŒƒç®¡ç†çš„ä¼˜è´¨ç”Ÿæ€èŒ¶åŒº">
                </div>
                <div class="form-group">
                    <label>ä¸“å±äº§å‡º</label>
                    <input type="text" id="modal-exclusive-output" placeholder="å¦‚: å¹´äº§ç²¾åˆ¶é«˜çº§ç»¿èŒ¶çº¦5-8æ–¤">
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 1rem; color: #333;">æ ¸å¿ƒæƒç›Šç®¡ç†</h4>
                    <div id="temp-rights-list"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addTempPackageRight()" style="margin-top: 0.5rem;">+ æ·»åŠ æƒç›Š</button>
                </div>
            `, () => {
                const newPackage = {
                    name: document.getElementById('modal-name').value,
                    price: document.getElementById('modal-price').value,
                    target_audience: document.getElementById('modal-target-audience').value,
                    area_features: document.getElementById('modal-area-features').value,
                    exclusive_output: document.getElementById('modal-exclusive-output').value,
                    tagline: '',
                    features: '',
                    rights: tempPackageRights
                };
                privateData.packages.push(newPackage);
                renderPrivatePlan(privateData);
                closeModal();
            });
            
            // åˆå§‹æ¸²æŸ“ç©ºçš„æƒç›Šåˆ—è¡¨
            setTimeout(() => renderTempPackageRights(), 100);
        }

        function renderTempPackageRights() {
            const container = document.getElementById('temp-rights-list');
            if (!container) return;
            
            if (tempPackageRights.length === 0) {
                container.innerHTML = '<div style="color: #999; padding: 0.5rem; text-align: center;">æš‚æ— æƒç›Šï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>';
            } else {
                container.innerHTML = tempPackageRights.map((right, rightIndex) => `
                    <div class="nested-item" style="margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #555;">æƒç›Š ${rightIndex + 1}</strong>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-success btn-small" onclick="saveTempPackageRight(${rightIndex})">ğŸ’¾ ä¿å­˜</button>
                                <button type="button" class="btn btn-danger btn-small" onclick="deleteTempPackageRight(${rightIndex})">åˆ é™¤</button>
                            </div>
                        </div>
                        <input type="text" 
                               id="temp-right-icon-${rightIndex}"
                               value="${right.icon || ''}" 
                               placeholder="å›¾æ ‡ (emojiï¼Œå¦‚: âœ… ä¸è®¾ç½®è¡¨ç¤ºä¸æ˜¾ç¤ºå›¾æ ‡)"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <input type="text" 
                               id="temp-right-title-${rightIndex}"
                               value="${right.title}" 
                               placeholder="æƒç›Šæ ‡é¢˜"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <textarea 
                               id="temp-right-desc-${rightIndex}"
                               placeholder="æƒç›Šè¯¦ç»†å†…å®¹"
                               rows="2"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;">${right.description}</textarea>
                    </div>
                `).join('');
            }
        }

        function saveTempPackageRight(rightIndex) {
            const iconInput = document.getElementById(`temp-right-icon-${rightIndex}`);
            const titleInput = document.getElementById(`temp-right-title-${rightIndex}`);
            const descInput = document.getElementById(`temp-right-desc-${rightIndex}`);
            
            if (iconInput && titleInput && descInput) {
                tempPackageRights[rightIndex].icon = iconInput.value;
                tempPackageRights[rightIndex].title = titleInput.value;
                tempPackageRights[rightIndex].description = descInput.value;
                showMessage(`æƒç›Š ${rightIndex + 1} å·²ä¿å­˜`, 'success');
            }
        }

        function addTempPackageRight() {
            tempPackageRights.push({
                icon: '',
                title: '',
                description: ''
            });
            renderTempPackageRights();
        }

        function deleteTempPackageRight(rightIndex) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæƒç›Šå—ï¼Ÿ')) {
                tempPackageRights.splice(rightIndex, 1);
                renderTempPackageRights();
            }
        }

        function editPackage(index) {
            const pkg = privateData.packages[index];
            openModal('ç¼–è¾‘å¥—é¤', `
                <div class="form-group">
                    <label>å¥—é¤åç§°</label>
                    <input type="text" id="modal-name" value="${pkg.name || ''}" placeholder="å¦‚: æ ‡å‡†å¥—é¤">
                </div>
                <div class="form-group">
                    <label>å¥—é¤ä»·æ ¼</label>
                    <input type="text" id="modal-price" value="${pkg.price || ''}" placeholder="å¦‚: Â¥18,800/å¹´">
                </div>
                <div class="form-group">
                    <label>é¢å‘å®¢ç¾¤</label>
                    <input type="text" id="modal-target-audience" value="${pkg.target_audience || ''}" placeholder="å¦‚: çƒ­çˆ±èŒ¶æ–‡åŒ–ã€æ³¨é‡å“è´¨ä¸æ€§ä»·æ¯”çš„èŒ¶å‹">
                </div>
                <div class="form-group">
                    <label>åœ°å—ç‰¹è‰²</label>
                    <input type="text" id="modal-area-features" value="${pkg.area_features || ''}" placeholder="å¦‚: 0.3äº©ä½äºè§„èŒƒç®¡ç†çš„ä¼˜è´¨ç”Ÿæ€èŒ¶åŒº">
                </div>
                <div class="form-group">
                    <label>ä¸“å±äº§å‡º</label>
                    <input type="text" id="modal-exclusive-output" value="${pkg.exclusive_output || pkg.tagline || ''}" placeholder="å¦‚: å¹´äº§ç²¾åˆ¶é«˜çº§ç»¿èŒ¶çº¦5-8æ–¤">
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 1rem; color: #333;">æ ¸å¿ƒæƒç›Šç®¡ç†</h4>
                    <div id="rights-list"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addPackageRight(${index})" style="margin-top: 0.5rem;">+ æ·»åŠ æƒç›Š</button>
                </div>
            `, () => {
                privateData.packages[index].name = document.getElementById('modal-name').value;
                privateData.packages[index].price = document.getElementById('modal-price').value;
                privateData.packages[index].target_audience = document.getElementById('modal-target-audience').value;
                privateData.packages[index].area_features = document.getElementById('modal-area-features').value;
                privateData.packages[index].exclusive_output = document.getElementById('modal-exclusive-output').value;
                renderPrivatePlan(privateData);
                closeModal();
            });
            
            renderPackageRights(index);
        }

        function renderPackageRights(packageIndex) {
            const rights = privateData.packages[packageIndex].rights || [];
            const container = document.getElementById('rights-list');
            if (!container) return;
            
            if (rights.length === 0) {
                container.innerHTML = '<div style="color: #999; padding: 0.5rem; text-align: center;">æš‚æ— æƒç›Šï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>';
            } else {
                container.innerHTML = rights.map((right, rightIndex) => `
                    <div class="nested-item" style="margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #555;">æƒç›Š ${rightIndex + 1}</strong>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-success btn-small" onclick="savePackageRight(${packageIndex}, ${rightIndex})">ğŸ’¾ ä¿å­˜</button>
                                <button type="button" class="btn btn-danger btn-small" onclick="deletePackageRight(${packageIndex}, ${rightIndex})">åˆ é™¤</button>
                            </div>
                        </div>
                        <input type="text" 
                               id="right-icon-${packageIndex}-${rightIndex}"
                               value="${right.icon || ''}" 
                               placeholder="å›¾æ ‡ (emojiï¼Œå¦‚: âœ… ä¸è®¾ç½®è¡¨ç¤ºä¸æ˜¾ç¤ºå›¾æ ‡)"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <input type="text" 
                               id="right-title-${packageIndex}-${rightIndex}"
                               value="${right.title}" 
                               placeholder="æƒç›Šæ ‡é¢˜"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <textarea 
                               id="right-desc-${packageIndex}-${rightIndex}"
                               placeholder="æƒç›Šè¯¦ç»†å†…å®¹"
                               rows="2"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;">${right.description}</textarea>
                    </div>
                `).join('');
            }
        }

        function savePackageRight(packageIndex, rightIndex) {
            const iconInput = document.getElementById(`right-icon-${packageIndex}-${rightIndex}`);
            const titleInput = document.getElementById(`right-title-${packageIndex}-${rightIndex}`);
            const descInput = document.getElementById(`right-desc-${packageIndex}-${rightIndex}`);
            
            if (iconInput && titleInput && descInput) {
                privateData.packages[packageIndex].rights[rightIndex].icon = iconInput.value;
                privateData.packages[packageIndex].rights[rightIndex].title = titleInput.value;
                privateData.packages[packageIndex].rights[rightIndex].description = descInput.value;
                showMessage(`æƒç›Š ${rightIndex + 1} å·²ä¿å­˜`, 'success');
            }
        }

        function addPackageRight(packageIndex) {
            privateData.packages[packageIndex].rights.push({
                icon: '',
                title: '',
                description: ''
            });
            renderPackageRights(packageIndex);
        }

        function deletePackageRight(packageIndex, rightIndex) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæƒç›Šå—ï¼Ÿ')) {
                privateData.packages[packageIndex].rights.splice(rightIndex, 1);
                renderPackageRights(packageIndex);
            }
        }

        async function deletePackage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥—é¤å—ï¼Ÿ')) {
                privateData.packages.splice(index, 1);
                renderPrivatePlan(privateData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan('private');
            }
        }

        // ========== æµç¨‹æ­¥éª¤ç®¡ç† ==========
        function addProcessStep(type) {
            openModal('æ·»åŠ æµç¨‹æ­¥éª¤', `
                <div class="form-group">
                    <label>æ­¥éª¤ç¼–å·</label>
                    <input type="text" id="modal-step" placeholder="å¦‚: 1 æˆ– ç¬¬ä¸€æ­¥">
                </div>
                <div class="form-group">
                    <label>æ­¥éª¤æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" placeholder="æ­¥éª¤æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æ­¥éª¤æè¿°</label>
                    <textarea id="modal-description" rows="4" placeholder="è¯¦ç»†æè¿°"></textarea>
                </div>
            `, () => {
                const newStep = {
                    step: document.getElementById('modal-step').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                const data = type === 'private' ? privateData : enterpriseData;
                data.process_steps.push(newStep);
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                closeModal();
            });
        }

        function editProcessStep(type, index) {
            const data = type === 'private' ? privateData : enterpriseData;
            const item = data.process_steps[index];
            
            openModal('ç¼–è¾‘æµç¨‹æ­¥éª¤', `
                <div class="form-group">
                    <label>æ­¥éª¤ç¼–å·</label>
                    <input type="text" id="modal-step" value="${item.step || ''}" placeholder="å¦‚: 1 æˆ– ç¬¬ä¸€æ­¥">
                </div>
                <div class="form-group">
                    <label>æ­¥éª¤æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" value="${item.title || ''}" placeholder="æ­¥éª¤æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æ­¥éª¤æè¿°</label>
                    <textarea id="modal-description" rows="4" placeholder="è¯¦ç»†æè¿°">${item.description || ''}</textarea>
                </div>
            `, () => {
                data.process_steps[index] = {
                    step: document.getElementById('modal-step').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                closeModal();
            });
        }

        async function deleteProcessStep(type, index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµç¨‹æ­¥éª¤å—ï¼Ÿ')) {
                const data = type === 'private' ? privateData : enterpriseData;
                data.process_steps.splice(index, 1);
                type === 'private' ? renderPrivatePlan(privateData) : renderEnterprisePlan(enterpriseData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan(type);
            }
        }

        // ========== ä¼ä¸šé¢†å…» - æœåŠ¡å†…å®¹ç®¡ç† ==========
        function addServiceContent() {
            openModal('æ·»åŠ æœåŠ¡å†…å®¹', `
                <div class="form-group">
                    <label>å›¾æ ‡ (emoji)</label>
                    <input type="text" id="modal-icon" placeholder="å¦‚: ğŸ†">
                </div>
                <div class="form-group">
                    <label>æœåŠ¡æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" placeholder="æœåŠ¡æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æœåŠ¡æè¿°</label>
                    <textarea id="modal-description" rows="3" placeholder="æœåŠ¡æè¿°"></textarea>
                </div>
            `, () => {
                const newItem = {
                    icon: document.getElementById('modal-icon').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                enterpriseData.service_contents.push(newItem);
                renderEnterprisePlan(enterpriseData);
                closeModal();
            });
        }

        function editServiceContent(index) {
            const item = enterpriseData.service_contents[index];
            openModal('ç¼–è¾‘æœåŠ¡å†…å®¹', `
                <div class="form-group">
                    <label>å›¾æ ‡ (emoji)</label>
                    <input type="text" id="modal-icon" value="${item.icon || ''}" placeholder="å¦‚: ğŸ†">
                </div>
                <div class="form-group">
                    <label>æœåŠ¡æ ‡é¢˜</label>
                    <input type="text" id="modal-title-field" value="${item.title || ''}" placeholder="æœåŠ¡æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æœåŠ¡æè¿°</label>
                    <textarea id="modal-description" rows="3" placeholder="æœåŠ¡æè¿°">${item.description || ''}</textarea>
                </div>
            `, () => {
                enterpriseData.service_contents[index] = {
                    icon: document.getElementById('modal-icon').value,
                    title: document.getElementById('modal-title-field').value,
                    description: document.getElementById('modal-description').value
                };
                renderEnterprisePlan(enterpriseData);
                closeModal();
            });
        }

        async function deleteServiceContent(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœåŠ¡å†…å®¹å—ï¼Ÿ')) {
                enterpriseData.service_contents.splice(index, 1);
                renderEnterprisePlan(enterpriseData);
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                await autoSavePlan('enterprise');
            }
        }

        // ========== æ¨¡æ€æ¡†ç®¡ç† ==========
        function openModal(title, bodyHTML, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = bodyHTML;
            modalCallback = callback;
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            modalCallback = null;
        }

        function saveModalData() {
            if (modalCallback) {
                modalCallback();
            }
        }

        // ========== è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ==========
        async function autoSavePlan(type) {
            try {
                let data;
                
                if (type === 'private') {
                    data = privateData;
                } else if (type === 'enterprise') {
                    data = enterpriseData;
                } else if (type === 'b2b') {
                    data = b2bData;
                }

                // è°ƒè¯•æ—¥å¿—ï¼šæŸ¥çœ‹ä¿å­˜çš„æ•°æ®
                console.log(`ğŸ’¾ å‡†å¤‡ä¿å­˜${type}æ–¹æ¡ˆåˆ°æœåŠ¡å™¨`);
                console.log(`ğŸ’¾ ä¿å­˜çš„å®¢æˆ·æ¡ˆä¾‹æ•°æ®:`, data.customer_cases);

                const response = await fetch(`/api/adoption-plans/${type}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('è‡ªåŠ¨ä¿å­˜å¤±è´¥');

                console.log(`âœ… ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡é‡æ–°åŠ è½½æ•°æ®`);

                // ä¿å­˜æˆåŠŸåé‡æ–°ä»æœåŠ¡å™¨åŠ è½½æœ€æ–°æ•°æ®
                await loadPlan(type);
                
                showMessage('âœ“ å·²è‡ªåŠ¨ä¿å­˜', 'success');
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                showMessage('è‡ªåŠ¨ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== ä¿å­˜åŠŸèƒ½ ==========
        async function saveCurrentPlan() {
            try {
                let type, data;
                
                if (currentTab === 'private') {
                    type = 'private';
                    privateData.marketing_header = {
                        title: document.getElementById('private-title').value,
                        subtitle: document.getElementById('private-subtitle').value
                    };
                    data = privateData;
                } else if (currentTab === 'enterprise') {
                    type = 'enterprise';
                    enterpriseData.marketing_header = {
                        title: document.getElementById('enterprise-title').value,
                        subtitle: document.getElementById('enterprise-subtitle').value
                    };
                    data = enterpriseData;
                } else if (currentTab === 'b2b') {
                    type = 'b2b';
                    b2bData.description = document.getElementById('b2b-description').value;
                    data = b2bData;
                }

                const response = await fetch(`/api/adoption-plans/${type}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');

                const result = await response.json();
                showMessage('ä¿å­˜æˆåŠŸï¼', 'success');
                
                await loadPlan(type);
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== æ¶ˆæ¯æç¤º ==========
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>

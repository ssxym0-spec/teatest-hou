<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批次追溯管理 - 茶园管理系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fff5e6 0%, #ffe0b2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .header h1 { 
            color: #d84315; 
            font-size: 1.8rem; 
            margin-bottom: 0.5rem; 
        }
        
        .header .subtitle { 
            color: #666; 
            font-size: 0.9rem; 
        }
        
        .nav-buttons { 
            margin-top: 1rem; 
            display: flex; 
            gap: 1rem; 
        }
        
        .nav-btn {
            background: #6c757d; 
            color: white; 
            text-decoration: none;
            padding: 0.5rem 1rem; 
            border-radius: 5px; 
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .nav-btn:hover { background: #5a6268; }
        
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 0 2rem 4rem; 
        }
        
        /* 标签页样式 */
        .tabs-navigation {
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }
        
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-button {
            flex: 1;
            padding: 1.2rem;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            background: #fff3e0;
            color: #d84315;
        }
        
        .tab-button.active {
            background: white;
            color: #d84315;
            border-bottom-color: #ff6b6b;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 左右分栏布局 */
        .split-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            min-height: 600px;
        }
        
        /* 左侧批次列表区域 */
        .batch-list-panel {
            border-right: 2px solid #e0e0e0;
            padding-right: 2rem;
        }
        
        .batch-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .batch-list-header h3 {
            color: #d84315;
            font-size: 1.2rem;
        }
        
        .batch-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* 品类分组样式 */
        .category-group {
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .category-header {
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .category-header:hover {
            filter: brightness(1.1);
            transform: translateX(3px);
        }
        
        .category-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .category-icon {
            font-size: 1.1rem;
        }
        
        .category-name {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .category-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .category-toggle {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        
        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .category-batches {
            background: #fafafa;
            padding: 0.5rem;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .category-batches.collapsed {
            max-height: 0;
            padding: 0;
            opacity: 0;
        }
        
        .batch-list-item {
            background: white;
            border-radius: 6px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
        
        .batch-list-item:last-child {
            margin-bottom: 0;
        }
        
        .batch-list-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(3px);
        }
        
        .batch-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .batch-number {
            color: #d84315;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .batch-status {
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            color: white;
        }
        
        .batch-item-info {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }
        
        .batch-info-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        .batch-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .batch-list-item h4 {
            color: #d84315;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }
        
        .batch-list-item p {
            color: #666;
            font-size: 0.8rem;
            margin: 0;
        }
        
        /* 品类渐变色方案 */
        .category-spring { background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); }
        .category-summer { background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); }
        .category-autumn { background: linear-gradient(135deg, #EF5350 0%, #E53935 100%); }
        .category-mingqian { background: linear-gradient(135deg, #AB47BC 0%, #8E24AA 100%); }
        .category-yuqian { background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); }
        .category-default { background: linear-gradient(135deg, #78909C 0%, #546E7A 100%); }
        
        /* 右侧详情编辑区域 */
        .batch-detail-panel {
            padding-left: 2rem;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            color: #0d47a1;
        }
        
        .info-box strong {
            color: #1565c0;
        }
        
        .welcome-message {
            text-align: center;
            padding: 4rem 2rem;
            color: #999;
        }
        
        .welcome-message h2 {
            color: #d84315;
            margin-bottom: 1rem;
        }
        
        /* 表单卡片 */
        .form-card {
            background: white; 
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; 
            padding: 1.5rem 2rem;
            font-size: 1.3rem; 
            font-weight: 600;
        }
        
        .card-header-secondary {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }
        
        .card-body { 
            padding: 2rem; 
        }
        
        .section-title {
            color: #d84315; 
            font-size: 1.1rem; 
            font-weight: 600;
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ff6b6b;
        }
        
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        
        .form-group label {
            display: block; 
            color: #333; 
            font-weight: 500; 
            margin-bottom: 0.5rem;
        }
        
        .form-group label .required { 
            color: #dc3545; 
            margin-left: 3px; 
        }
        
        .form-control {
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #e0e0e0;
            border-radius: 8px; 
            font-size: 0.9rem; 
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none; 
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px; 
            resize: vertical; 
            font-family: inherit;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; 
            border: none; 
            padding: 0.75rem 2rem;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600; 
            transition: all 0.3s; 
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #78909c 0%, #546e7a 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
        }
        
        .btn-small {
            padding: 0.5rem 1rem; 
            font-size: 0.85rem;
        }
        
        .info-box {
            background: #e3f2fd; 
            border-left: 4px solid #2196f3;
            padding: 1rem; 
            border-radius: 5px; 
            margin-bottom: 1rem;
        }
        
        .info-box.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        /* 日期选择器带箭头样式 */
        .date-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .date-input-wrapper .form-control {
            flex: 1;
        }
        
        .date-nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .date-nav-btn {
            width: 32px;
            height: 24px;
            background: #66bb6a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
        }
        
        .date-nav-btn:hover {
            background: #43a047;
            transform: scale(1.05);
        }
        
        .date-nav-btn:active {
            transform: scale(0.95);
        }
        
        .success-message {
            background: #d4edda; 
            color: #155724; 
            padding: 1rem;
            border-radius: 8px; 
            margin-bottom: 1rem; 
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da; 
            color: #721c24; 
            padding: 1rem;
            border-radius: 8px; 
            margin-bottom: 1rem; 
            border: 1px solid #f5c6cb;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .loading { 
            text-align: center; 
            padding: 2rem; 
            color: #666; 
        }
        
        /* 列表样式 */
        .records-list {
            margin-top: 1rem;
        }
        
        /* 品类卡片筛选器样式 */
        .category-filter-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px dashed #e0e0e0;
        }

        .category-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .category-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ffa726);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .category-card:hover {
            border-color: #ff6b6b;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
        }

        .category-card:hover::before {
            opacity: 1;
        }

        .category-card.active {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border-color: #ff6b6b;
            border-width: 3px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .category-card.active::before {
            opacity: 1;
        }

        .category-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
        }

        .category-card-emoji {
            font-size: 1.5rem;
        }

        .category-card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .category-card.active .category-card-name {
            color: #d84315;
        }

        .category-card-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.3s;
        }

        .category-card.active .category-card-check {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        .category-card-info {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .category-card-count {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ff6b6b;
        }

        .category-card.active .category-card-count {
            color: #d84315;
        }

        .category-card-period {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .category-card-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.5rem;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .category-card-total-weight {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.3rem;
        }

        /* 品类记录分组卡片样式 */
        .category-record-group {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #e0e0e0;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .category-record-group:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border-color: #ff6b6b;
        }
        
        .category-record-group.unclassified {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff8e1 100%);
        }
        
        .category-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            margin-bottom: 0;
            border-bottom: none;
            cursor: pointer;
            user-select: none;
        }
        
        .category-record-header:hover .category-name {
            color: #ff6b6b;
        }
        
        .category-record-group.collapsed .category-record-header {
            padding-bottom: 0;
            margin-bottom: 0;
        }
        
        .category-record-group:not(.collapsed) .category-record-header {
            border-bottom: 2px dashed #e0e0e0;
            margin-bottom: 1rem;
        }
        
        .category-record-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .category-record-title .category-emoji {
            font-size: 2rem;
        }
        
        .category-record-title .category-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #d84315;
        }
        
        .category-record-group.unclassified .category-name {
            color: #f57c00;
        }
        
        .current-season-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }
        
        .unclassified-tip {
            font-size: 0.85rem;
            color: #666;
            font-weight: normal;
        }
        
        .category-record-stats {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .category-record-stats .period-text {
            font-size: 0.9rem;
            color: #666;
            background: #f0f0f0;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
        }
        
        .category-record-stats .record-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ff6b6b;
        }
        
        .category-record-stats .total-weight {
            font-size: 0.95rem;
            color: #666;
            font-weight: 600;
        }
        
        .category-record-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .category-record-group.collapsed .category-record-list {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        
        .toggle-icon {
            font-size: 1.2rem;
            color: #666;
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
        }
        
        .category-record-group.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        /* 移动端响应式布局 */
        @media (max-width: 768px) {
            .category-record-group {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .category-record-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .category-record-title {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .category-record-title .category-emoji {
                font-size: 1.5rem;
            }
            
            .category-record-title .category-name {
                font-size: 1.2rem;
            }
            
            .toggle-icon {
                font-size: 1rem;
                margin-left: auto;
            }
            
            .current-season-badge {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
            
            .category-record-stats {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .category-record-stats .period-text,
            .category-record-stats .record-count,
            .category-record-stats .total-weight {
                font-size: 0.85rem;
            }
            
            .unclassified-tip {
                font-size: 0.75rem;
                display: block;
                width: 100%;
                margin-top: 0.25rem;
            }
        }
        
        @media (max-width: 480px) {
            .category-record-group {
                padding: 0.75rem;
                border-radius: 12px;
            }
            
            .category-record-title .category-emoji {
                font-size: 1.3rem;
            }
            
            .category-record-title .category-name {
                font-size: 1.1rem;
            }
            
            .category-record-stats {
                gap: 0.4rem;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.75rem;
            }
            
            .record-item-info h4 {
                font-size: 0.95rem;
            }
            
            .record-item-info p {
                font-size: 0.8rem;
            }
            
            .record-item-actions {
                width: 100%;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }
        }

        .record-item {
            background: white;
            border-left: 4px solid #ff6b6b;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 2px solid #f0f0f0;
        }
        
        .record-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
            border-color: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.15);
        }
        
        .record-item-info h4 {
            color: #d84315;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        
        .record-item-info p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }
        
        .record-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* 复选框列表 */
        .checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .checkbox-item {
            padding: 0.75rem;
            background: white;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .checkbox-item:hover {
            border-color: #ff6b6b;
            background: #fff3e0;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-item-info {
            flex: 1;
        }
        
        .checkbox-item-info strong {
            color: #d84315;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .checkbox-item-info span {
            color: #666;
            font-size: 0.85rem;
        }
        
        /* Modal 样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h2 {
            color: #d84315;
            margin: 0;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .close-btn:hover {
            background: #c82333;
        }
        
        /* 只读列表样式 */
        .readonly-list {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .readonly-list-item {
            background: white;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            border-left: 3px solid #42a5f5;
        }
        
        .readonly-list-item strong {
            color: #d84315;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .readonly-list-item span {
            color: #666;
            font-size: 0.85rem;
        }
        
        /* 制作步骤卡片 */
        .step-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .step-number {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .step-name {
            color: #d84315;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .step-subsection {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #42a5f5;
        }
        
        .step-subsection h4 {
            color: #42a5f5;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        /* 单选按钮样式（新架构） */
        .radio-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .radio-label:hover {
            background: #f5f5f5;
            border-color: #42a5f5;
        }
        
        .radio-label input[type="radio"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }
        
        .radio-label input[type="radio"]:checked + span,
        .radio-label:has(input[type="radio"]:checked) {
            background: #e3f2fd;
            border-color: #42a5f5;
            color: #1565c0;
            font-weight: bold;
        }
        
        @media (max-width: 1200px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
            
            .batch-list-panel {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                padding-right: 0;
                padding-bottom: 2rem;
            }
            
            .batch-detail-panel {
                padding-left: 0;
                padding-top: 2rem;
            }
        }
        
        @media (max-width: 768px) {
            /* 基础布局优化 */
            .container { 
                padding: 0 0.75rem; 
            }
            
            .header {
                padding: 1rem 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header .subtitle {
                font-size: 0.85rem;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-btn {
                text-align: center;
            }
            
            /* 卡片样式优化 */
            .card-header {
                padding: 1rem;
                font-size: 1.1rem;
            }
            
            .card-body { 
                padding: 1rem; 
            }
            
            .form-card {
                margin-bottom: 1rem;
                border-radius: 10px;
            }
            
            /* 表单布局优化 */
            .form-row { 
                grid-template-columns: 1fr; 
                gap: 0.75rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            
            .form-control {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            textarea.form-control {
                min-height: 80px;
            }
            
            /* 标签页优化 */
            .tab-button { 
                font-size: 0.9rem; 
                padding: 0.85rem 0.5rem; 
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            /* 章节标题优化 */
            .section-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.4rem;
            }
            
            /* 信息提示框优化 */
            .info-box {
                padding: 0.75rem;
                font-size: 0.85rem;
                margin-bottom: 0.75rem;
            }
            
            .info-box p {
                font-size: 0.85rem;
            }
            
            .info-box strong {
                font-size: 0.9rem;
            }
            
            /* 按钮优化 */
            .btn {
                padding: 0.65rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .btn-small {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            /* 采摘记录列表优化 */
            .records-list {
                gap: 0.75rem;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }
            
            .record-item-actions {
                margin-top: 0.75rem;
                width: 100%;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .record-item-actions .btn {
                flex: 1 1 45%;
                min-width: 120px;
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
            
            /* 品类卡片优化 */
            .category-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .category-card {
                padding: 1rem;
            }

            .category-card-emoji {
                font-size: 1.3rem;
            }

            .category-card-name {
                font-size: 1rem;
            }

            .category-card-count {
                font-size: 1.1rem;
            }

            .category-card-period {
                font-size: 0.75rem;
            }
            
            /* 媒体预览优化 */
            #media-preview-list {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .media-preview-item {
                height: 120px;
            }
            
            /* 队长头像优化 */
            #team-leader-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 0.75rem;
            }
            
            /* 天气信息显示框优化 */
            .form-group div[style*="background: #f8f9fa"] {
                padding: 0.6rem !important;
                font-size: 0.85rem;
            }
            
            /* 表单按钮组优化 */
            .form-card .card-body > div[style*="text-align: center"] {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .form-card .card-body > div[style*="text-align: center"] .btn {
                width: 100%;
            }
            
            /* 批次列表面板优化 */
            .batch-list-panel {
                padding: 1rem;
            }
            
            .batch-list-header {
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .batch-list-header h3 {
                font-size: 1.1rem;
            }
            
            .batch-list-header .btn {
                width: 100%;
            }
            
            .batch-detail-panel {
                padding: 1rem;
            }
            
            /* 批次项优化 */
            .batch-item {
                padding: 1rem;
            }
            
            .batch-item-actions {
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }
            
            .batch-item-actions .btn {
                width: 100%;
                font-size: 0.85rem;
            }
            
            /* 筛选行优化 */
            .query-row {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .query-row .form-group {
                width: 100%;
            }
            
            .query-row .btn {
                width: 100%;
            }
            
            /* 制作步骤卡片优化 */
            .step-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .step-card-header {
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .step-number {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .step-name {
                font-size: 1.1rem;
            }
            
            .step-subsection {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .step-subsection h4 {
                font-size: 0.95rem;
            }
            
            /* 工艺类型单选按钮优化 */
            .radio-label {
                font-size: 0.85rem;
                padding: 0.4rem 0.75rem;
                flex: 1;
                justify-content: center;
            }
            
            .radio-label input[type="radio"] {
                margin-right: 0.3rem;
            }
            
            /* 工艺类型选择容器改为垂直布局 */
            .form-group > div[style*="display: flex"][style*="gap: 1.5rem"] {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            /* 媒体画廊网格优化 */
            .media-gallery {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .media-gallery > div {
                height: 120px;
            }
            
            /* 成品鉴赏图片区域优化 */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* 图片预览容器优化 */
            div[id*="preview-container"] {
                height: 180px !important;
            }
            
            /* 鉴赏文案区域优化 */
            div[style*="display: grid"][style*="gap: 2rem"] {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* 采摘记录选择器按钮优化 */
            button[onclick*="openHarvestRecordSelector"],
            button[onclick*="Selector"] {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* 关闭按钮优化 */
            .card-header .btn-small[style*="float: right"] {
                float: none !important;
                display: block !important;
                margin-top: 0.5rem !important;
                width: 100%;
            }
            
            /* 卡片头部按钮布局 */
            .card-header {
                display: flex;
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            /* 批次编辑 - 封面区域优化 */
            #batch-edit-form-container div[style*="display: flex"][style*="gap: 2rem"],
            #new-batch-form div[style*="display: flex"][style*="gap: 2rem"] {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            /* 封面预览容器优化 */
            div[style*="flex: 0 0 300px"] {
                flex: 0 0 auto !important;
                width: 100% !important;
            }
            
            div[id*="cover-preview-container"] {
                width: 100% !important;
                max-width: 100% !important;
                height: 200px !important;
            }
            
            /* 封面操作按钮区域优化 */
            div[style*="flex: 1"] > div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            div[style*="flex: 1"] > div[style*="display: flex"] > label,
            div[style*="flex: 1"] > div[style*="display: flex"] > button {
                width: 100%;
                margin: 0 !important;
            }
            
            /* 采摘记录选择按钮优化（批次编辑） */
            .section-title .btn-small[style*="float: right"] {
                float: none !important;
                display: block !important;
                margin-top: 0.5rem !important;
                width: 100%;
            }
            
            /* 采摘时间参考提示框优化 */
            div[style*="background: #f0f8ff"] {
                font-size: 0.8rem !important;
            }
            
            div[style*="background: #f0f8ff"] p {
                font-size: 0.8rem !important;
            }
        }

        /* 超小屏幕优化（手机竖屏） */
        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header {
                padding: 0.75rem 0.5rem;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .card-header {
                font-size: 1rem;
                padding: 0.85rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .form-group {
                margin-bottom: 0.85rem;
            }
            
            .form-group label {
                font-size: 0.85rem;
            }
            
            .form-control {
                padding: 0.55rem;
                font-size: 0.85rem;
            }
            
            .section-title {
                font-size: 0.95rem;
            }
            
            .info-box {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
            
            .tab-button {
                font-size: 0.85rem;
                padding: 0.75rem 0.4rem;
            }
            
            /* 品类卡片单列显示 */
            .category-cards {
                grid-template-columns: 1fr;
            }
            
            /* 媒体预览单列显示 */
            #media-preview-list {
                grid-template-columns: 1fr !important;
            }
            
            .media-preview-item {
                height: 150px;
            }
            
            #team-leader-avatar {
                width: 35px !important;
                height: 35px !important;
            }
            
            .record-item {
                padding: 0.85rem;
            }
            
            .record-item-actions .btn {
                flex: 1 1 100%;
                min-width: 100%;
            }
            
            .batch-list-panel,
            .batch-detail-panel {
                padding: 0.75rem;
            }
            
            .batch-item {
                padding: 0.85rem;
            }
            
            /* 制作步骤卡片进一步优化 */
            .step-card {
                padding: 0.75rem;
            }
            
            .step-card-header {
                gap: 0.5rem;
            }
            
            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.95rem;
            }
            
            .step-name {
                font-size: 1rem;
            }
            
            .step-subsection {
                padding: 0.6rem;
            }
            
            .step-subsection h4 {
                font-size: 0.9rem;
            }
            
            /* 工艺类型单选按钮进一步优化 */
            .radio-label {
                font-size: 0.8rem;
                padding: 0.35rem 0.6rem;
            }
            
            /* 媒体画廊改为单列 */
            .media-gallery {
                grid-template-columns: 1fr !important;
            }
            
            .media-gallery > div {
                height: 150px;
            }
            
            /* 图片预览容器高度调整 */
            div[id*="preview-container"] {
                height: 200px !important;
            }
            
            /* 批次编辑 - 封面预览容器进一步优化 */
            div[id*="cover-preview-container"] {
                height: 180px !important;
            }
            
            /* 封面建议文字优化 */
            div[style*="flex: 1"] > p {
                font-size: 0.8rem !important;
            }
            
            div[style*="flex: 1"] > p strong {
                font-size: 0.85rem !important;
            }
            
            /* 采摘时间参考提示框进一步优化 */
            div[style*="background: #f0f8ff"] {
                padding: 0.6rem !important;
                font-size: 0.75rem !important;
            }
            
            div[style*="background: #f0f8ff"] p {
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 批次追溯管理</h1>
        <p class="subtitle">管理采摘记录与制作批次，实现从鲜叶到成品的全程追溯</p>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">← 返回仪表板</a>
        </div>
    </div>

    <div class="container">
        <!-- 提示信息 -->
        <div id="message-container"></div>

        <!-- 标签页导航 -->
        <div class="tabs-navigation">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="harvest">🌾 采摘记录管理</button>
                <button class="tab-button" data-tab="batch">📦 制作批次管理</button>
            </div>
        </div>

        <!-- 标签页内容 -->
        <!-- 第一个标签页：采摘记录管理 -->
        <div id="harvest-tab" class="tab-content active">
            <!-- 采摘记录列表 -->
            <div class="form-card">
                <div class="card-header card-header-secondary">📋 采摘记录列表</div>
                <div class="card-body">
                    <!-- 品类卡片筛选器（隐藏，已改为分组显示） -->
                    <div class="category-filter-section" style="display: none;">
                        <div class="section-title" style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>🏷️ 按品类筛选</span>
                            <span id="category-loading" style="color: #999; font-size: 0.85rem; font-weight: normal; display: none;">加载中...</span>
                        </div>
                        <div id="category-cards-container" class="category-cards">
                            <!-- 品类卡片将动态生成 -->
                        </div>
                    </div>

                    <!-- 状态筛选和操作按钮 -->
                    <div class="form-row" style="margin-bottom: 1rem; margin-top: 1.5rem; display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>筛选状态</label>
                            <select id="harvest-filter" class="form-control" onchange="filterHarvestRecords()">
                                <option value="all">全部记录</option>
                                <option value="unassigned">未归属记录</option>
                                <option value="assigned">已归属记录</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <button type="button" class="btn btn-secondary" onclick="reclassifyAllHarvestRecords()" style="white-space: nowrap;">
                                🔄 强制刷新归属
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <button type="button" class="btn btn-info" onclick="syncAllWeatherData()" style="white-space: nowrap; background: #17a2b8; color: white;">
                                🌤️ 同步天气数据
                            </button>
                        </div>
                    </div>
                    
                    <div id="harvest-records-list" class="records-list">
                        <p style="color: #999; text-align: center;">加载中...</p>
                    </div>
                </div>
            </div>

            <!-- 新增/编辑采摘记录表单 -->
            <div class="form-card">
                <div class="card-header">
                    <span id="harvest-form-title">➕ 新增采摘记录</span>
                </div>
                <div class="card-body">
                    <div class="info-box warning">
                        <strong>💡 提示：</strong>采摘记录创建后初始状态为"未归属"，可以在后续创建制作批次时关联。
                    </div>
                    
                    <form id="harvest-record-form">
                        <!-- 隐藏字段：用于存储编辑模式下的记录ID -->
                        <input type="hidden" id="editing-record-id" value="">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="harvest-date">采摘日期 <span class="required">*</span></label>
                                <div class="date-input-wrapper">
                                    <input type="date" id="harvest-date" class="form-control" required>
                                    <div class="date-nav-buttons">
                                        <button type="button" class="date-nav-btn" onclick="changeHarvestMonth(1)" title="下一个月">▲</button>
                                        <button type="button" class="date-nav-btn" onclick="changeHarvestMonth(-1)" title="上一个月">▼</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fresh-leaf-weight">鲜叶重量（公斤） <span class="required">*</span></label>
                                <input type="number" id="fresh-leaf-weight" class="form-control" min="0" step="0.1" required>
                            </div>
                        </div>

                        <div class="section-title" style="margin-top: 1.5rem;">🌤️ 天气信息（自动同步）</div>
                        <div class="info-box">
                            <strong>💡 说明：</strong>选择采摘日期后，系统会自动从"每日生长日志"中同步当天的天气信息。
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>天气</label>
                                <div style="padding: 0.75rem; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 46px; display: flex; align-items: center; gap: 10px;">
                                    <img id="harvest-weather-icon" src="" alt="" style="width: 32px; height: 32px; display: none; object-fit: contain;">
                                    <span id="harvest-weather-display" style="color: #666;">--</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>温度</label>
                                <div style="padding: 0.75rem; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 46px; display: flex; align-items: center;">
                                    <span id="harvest-temp-display" style="color: #666;">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="section-title" style="margin-top: 1.5rem;">📸 图片或视频</div>
                        <div class="form-group">
                            <label for="media-upload">上传媒体文件（支持多选）</label>
                            <input type="file" id="media-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleMediaUpload(event)">
                            <small style="color: #666; display: block; margin-top: 0.5rem;">支持图片和视频格式，单个文件最大50MB，最多20个文件</small>
                        </div>
                        
                        <!-- 媒体预览区域 -->
                        <div id="media-preview-container" style="display: none; margin-top: 1rem;">
                            <strong>已上传的媒体文件：</strong>
                            <div id="media-preview-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <!-- 动态生成预览项 -->
                            </div>
                        </div>

                        <div class="section-title" style="margin-top: 1.5rem;">👥 采摘团队信息</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="team-leader">队长姓名</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div id="team-leader-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: #999; font-size: 0.8rem;">暂无</span>
                                    </div>
                                    <select id="team-leader" class="form-control" style="flex: 1;">
                                        <option value="">选择采摘队长...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="team-member-count">团队人数 <span class="required">*</span></label>
                                <input type="number" id="team-member-count" class="form-control" min="1" step="1" required placeholder="至少1人">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="team-notes">团队备注</label>
                            <textarea id="team-notes" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="harvest-notes">采摘记录备注</label>
                            <textarea id="harvest-notes" class="form-control" rows="3"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                            <button type="button" class="btn" onclick="saveHarvestRecord()">💾 保存采摘记录</button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;" onclick="cancelEditHarvestRecord()">❌ 取消编辑</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 第二个标签页：制作批次管理（双编辑模式设计） -->
        <div id="batch-tab" class="tab-content">
            <div class="split-layout">
                <!-- 左侧：批次列表 -->
                <div class="batch-list-panel">
                    <div class="batch-list-header">
                        <h3>📋 批次列表</h3>
                        <button type="button" class="btn btn-small" onclick="showNewBatchForm()">➕ 新增制作批次</button>
                        </div>
                    <div id="batch-list" class="batch-list">
                        <p style="color: #999; text-align: center;">加载中...</p>
                    </div>
                </div>

                <!-- 右侧：编辑区 -->
                <div class="batch-detail-panel">
                    <!-- 默认状态：提示信息 -->
                    <div id="default-view" class="welcome-message">
                        <h2>👋 欢迎使用制作批次管理</h2>
                        <p>请从左侧选择一个操作：</p>
                        <ul style="text-align: left; max-width: 400px; margin: 2rem auto; line-height: 2;">
                            <li>点击"新增制作批次"按钮创建新批次</li>
                            <li>点击"批次编辑"按钮编辑批次基础信息</li>
                            <li>点击"制作编辑"按钮编辑制作步骤</li>
                        </ul>
            </div>

                    <!-- 新增批次表单 -->
                    <div id="new-batch-view" class="hidden">
            <div class="form-card">
                <div class="card-header">➕ 新增制作批次</div>
                <div class="card-body">
                    <div class="info-box warning">
                        <strong>💡 提示：</strong>创建批次时需要从未归属的采摘记录中选择本次制作所使用的原料。
                    </div>
                    
                                <form id="new-batch-form">
                        <div class="section-title">🔗 关联采摘记录 <span class="required">*</span></div>
                        <div class="info-box">
                            <p>第一步：选择本批次使用的采摘记录（只显示未归属的记录）</p>
                        </div>
                        <div style="background: #f0f8ff; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.75rem; border-left: 3px solid #17a2b8;">
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                <strong>📅 采摘时间参考：</strong>明前茶 3.20-4.4 · 雨前茶 4.4-4.19 · 春茶 4.20-5.5 · 夏茶 5.5-7.7 · 秋茶 7.7-9月中
                            </p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="openHarvestRecordSelector()">📋 选择采摘记录</button>
                                        <span id="new-selected-records-count" style="margin-left: 1rem; color: #666;">已选择: 0 条</span>
                        </div>
                                    <div id="new-selected-records-preview" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>已选择的采摘记录：</strong>
                                        <ul id="new-selected-records-list" style="margin: 0.5rem 0 0 1.5rem; color: #666;"></ul>
                        </div>

                        <div class="section-title" style="margin-top: 1.5rem;">📋 基础信息</div>
                        <div class="form-row">
                            <div class="form-group">
                                            <label for="new-batch-category">茶叶品类 <span class="required">*</span></label>
                                            <select id="new-batch-category" class="form-control" required onchange="handleNewBatchCategoryChange()">
                                                <option value="">-- 请选择品类 --</option>
                                                <!-- 品类选项将从品类信息管理中动态加载 -->
                                            </select>
                            </div>
                            <div class="form-group">
                                            <label for="new-batch-number">批次号 <span class="required">*</span></label>
                                            <input type="text" id="new-batch-number" class="form-control" required placeholder="自动生成，也可手动修改">
                            </div>
                            <div class="form-group">
                                            <label for="new-production-date">生产日期 <span class="required">*</span></label>
                                            <input type="date" id="new-production-date" class="form-control" required onchange="handleNewProductionDateChange()">
                            </div>
                        </div>

                        <div class="section-title" style="margin-top: 1.5rem;">👨‍🍳 制茶师信息</div>
                        <div class="form-row">
                            <div class="form-group">
                                            <label for="new-tea-master-name">制茶师姓名</label>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div id="new-tea-master-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <span style="color: #999; font-size: 0.8rem;">暂无</span>
                                                </div>
                                                <select id="new-tea-master-name" class="form-control" style="flex: 1;">
                                                    <option value="">选择制茶师...</option>
                                                </select>
                                            </div>
                            </div>
                            <div class="form-group">
                                            <label for="new-tea-master-experience">经验年限</label>
                                            <input type="number" id="new-tea-master-experience" class="form-control" min="0" step="1" readonly>
                            </div>
                            <div class="form-group">
                                            <label for="new-tea-master-specialty">擅长领域</label>
                                            <input type="text" id="new-tea-master-specialty" class="form-control">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                            <label for="new-batch-grade">成品等级</label>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div id="new-grade-badge" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <span style="color: #999; font-size: 0.8rem;">🏆</span>
                                                </div>
                                                <select id="new-batch-grade" class="form-control" style="flex: 1;">
                                                    <option value="">-- 请选择等级 --</option>
                                                    <!-- 等级选项将从等级管理模板动态加载 -->
                                                </select>
                                            </div>
                            </div>
                            <div class="form-group">
                                            <label for="new-final-product-weight">成品重量（公斤）</label>
                                            <input type="number" id="new-final-product-weight" class="form-control" min="0" step="0.1">
                            </div>
                        </div>

                        <div class="form-group">
                                        <label for="new-batch-notes">批次备注</label>
                                        <textarea id="new-batch-notes" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="new-batch-detail-title">批次详情标题</label>
                            <textarea id="new-batch-detail-title" class="form-control" rows="2" placeholder="将根据品类自动填充，也可手动编辑..."></textarea>
                        </div>

                        <!-- 批次封面管理区域 -->
                        <div class="section-title" style="margin-top: 1.5rem;">🖼️ 批次封面</div>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 2rem; align-items: flex-start;">
                                <!-- 封面预览区域 -->
                                <div style="flex: 0 0 300px;">
                                    <div id="new-batch-cover-preview-container" style="width: 300px; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                        <img id="new-batch-cover-preview" src="" alt="批次封面预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                        <span id="new-batch-cover-placeholder" style="color: #999; font-size: 0.9rem;">暂无封面</span>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮区域 -->
                                <div style="flex: 1;">
                                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>封面建议：</strong>建议尺寸 800x600px，支持 JPG、PNG、WebP、AVIF 格式，文件不超过 5MB
                                    </p>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <label for="new-batch-cover-upload" class="btn" style="background: #17a2b8; cursor: pointer; margin: 0;">
                                            📤 上传/替换封面
                                            <input type="file" id="new-batch-cover-upload" accept="image/jpeg,image/jpg,image/png,image/webp,image/avif,image/gif" style="display: none;" onchange="handleNewBatchCoverUpload(event)">
                                        </label>
                                        <button type="button" class="btn btn-danger" onclick="deleteNewBatchCover()" id="new-batch-cover-delete-btn" style="display: none;">
                                            🗑️ 删除封面
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 详情页封面管理区域 -->
                        <div class="section-title" style="margin-top: 1.5rem;">🖼️ 详情页封面</div>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 2rem; align-items: flex-start;">
                                <!-- 封面预览区域 -->
                                <div style="flex: 0 0 300px;">
                                    <div id="new-detail-cover-preview-container" style="width: 300px; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                        <img id="new-detail-cover-preview" src="" alt="详情页封面预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                        <span id="new-detail-cover-placeholder" style="color: #999; font-size: 0.9rem;">暂无封面</span>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮区域 -->
                                <div style="flex: 1;">
                                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>封面建议：</strong>详情页顶部大图，建议尺寸 1200x800px
                                    </p>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <label for="new-detail-cover-upload" class="btn" style="background: #17a2b8; cursor: pointer; margin: 0;">
                                            📤 上传/替换封面
                                            <input type="file" id="new-detail-cover-upload" accept="image/jpeg,image/jpg,image/png,image/webp,image/avif,image/gif" style="display: none;" onchange="handleNewDetailCoverUpload(event)">
                                        </label>
                                        <button type="button" class="btn btn-danger" onclick="deleteNewDetailCover()" id="new-detail-cover-delete-btn" style="display: none;">
                                            🗑️ 删除封面
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 成品鉴赏模块 -->
                        <div class="section-title" style="margin-top: 2rem;">
                            🍵 成品鉴赏
                        </div>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <!-- 图片上传区域 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                <!-- 成品干茶图片 -->
                                <div>
                                    <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">成品干茶</label>
                                    <div id="new-dry-tea-preview-container" style="width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; margin-bottom: 0.5rem;">
                                        <img id="new-dry-tea-preview" src="" alt="成品干茶预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                        <span id="new-dry-tea-placeholder" style="color: #999; font-size: 0.9rem;">暂无图片</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button type="button" class="btn btn-small" onclick="document.getElementById('new-dry-tea-upload').click()" style="flex: 1;">📤 上传</button>
                                        <button type="button" class="btn btn-small" onclick="deleteNewDryTeaImage()" style="flex: 1; background: #dc3545;">🗑️ 删除</button>
                                    </div>
                                    <input type="file" id="new-dry-tea-upload" style="display: none;" accept="image/*" onchange="handleNewDryTeaUpload(event)">
                                </div>

                                <!-- 开水泡开图片 -->
                                <div>
                                    <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">开水泡开</label>
                                    <div id="new-brewed-tea-preview-container" style="width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; margin-bottom: 0.5rem;">
                                        <img id="new-brewed-tea-preview" src="" alt="开水泡开预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                        <span id="new-brewed-tea-placeholder" style="color: #999; font-size: 0.9rem;">暂无图片</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button type="button" class="btn btn-small" onclick="document.getElementById('new-brewed-tea-upload').click()" style="flex: 1;">📤 上传</button>
                                        <button type="button" class="btn btn-small" onclick="deleteNewBrewedTeaImage()" style="flex: 1; background: #dc3545;">🗑️ 删除</button>
                                    </div>
                                    <input type="file" id="new-brewed-tea-upload" style="display: none;" accept="image/*" onchange="handleNewBrewedTeaUpload(event)">
                                </div>
                            </div>

                            <!-- 文案区域 -->
                            <div class="form-group">
                                <label for="new-tasting-notes">品鉴笔记</label>
                                <textarea id="new-tasting-notes" class="form-control" rows="4" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="new-brewing-suggestion">冲泡建议</label>
                                <textarea id="new-brewing-suggestion" class="form-control" rows="3" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="new-storage-method">储存方法</label>
                                <textarea id="new-storage-method" class="form-control" rows="3" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                            </div>
                        </div>

                                    <div style="text-align: center; margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                                        <button type="button" class="btn" onclick="saveNewBatch()">💾 保存批次</button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelNewBatch()">❌ 取消</button>
                        </div>
                    </form>
                            </div>
                        </div>
                    </div>

                    <!-- 批次编辑容器 -->
                    <div id="batch-edit-form-container" class="hidden">
                        <div class="form-card">
                            <div class="card-header">
                                📝 批次基础信息编辑
                                <button type="button" class="btn btn-small" onclick="closeBatchEdit()" style="float: right; background: rgba(255,255,255,0.2);">关闭</button>
                            </div>
                            <div class="card-body">
                                <form id="batch-edit-form">
                                    <input type="hidden" id="batch-edit-id" value="">
                                    
                                    <div class="info-box">
                                        <strong>💡 提示：</strong>这里只编辑批次的基础信息。如需编辑制作步骤，请点击"制作编辑"按钮。
                                    </div>

                                    <!-- 批次封面管理区域 -->
                                    <div class="section-title" style="margin-top: 1.5rem;">🖼️ 批次封面</div>
                                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                        <div style="display: flex; gap: 2rem; align-items: flex-start;">
                                            <!-- 封面预览区域 -->
                                            <div style="flex: 0 0 300px;">
                                                <div id="batch-cover-preview-container" style="width: 300px; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                                    <img id="batch-cover-preview" src="" alt="批次封面预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                                    <span id="batch-cover-placeholder" style="color: #999; font-size: 0.9rem;">暂无封面</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 操作按钮区域 -->
                                            <div style="flex: 1;">
                                                <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                                                    <strong>封面建议：</strong>建议尺寸 800x600px，支持 JPG、PNG、WebP、AVIF 格式，文件不超过 5MB
                                                </p>
                                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                                    <label for="batch-cover-upload" class="btn" style="background: #17a2b8; cursor: pointer; margin: 0;">
                                                        📤 上传/替换封面
                                                        <input type="file" id="batch-cover-upload" accept="image/jpeg,image/jpg,image/png,image/webp,image/avif,image/gif" style="display: none;" onchange="handleBatchCoverUpload(event)">
                                                    </label>
                                                    <button type="button" class="btn btn-danger" onclick="deleteBatchCover()" id="batch-cover-delete-btn" style="display: none;">
                                                        🗑️ 删除封面
                                                    </button>
                                                </div>
                                                <div id="batch-cover-upload-progress" style="margin-top: 1rem; display: none;">
                                                    <div style="color: #17a2b8; font-size: 0.9rem; margin-bottom: 0.5rem;">正在上传...</div>
                                                    <div style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                                        <div style="height: 100%; background: #17a2b8; width: 0%; transition: width 0.3s;" id="batch-cover-progress-bar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 详情页封面管理区域 -->
                                    <div class="section-title" style="margin-top: 1.5rem;">🖼️ 详情页封面</div>
                                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                        <div style="display: flex; gap: 2rem; align-items: flex-start;">
                                            <!-- 封面预览区域 -->
                                            <div style="flex: 0 0 300px;">
                                                <div id="detail-cover-preview-container" style="width: 300px; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                                    <img id="detail-cover-preview" src="" alt="详情页封面预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                                    <span id="detail-cover-placeholder" style="color: #999; font-size: 0.9rem;">暂无封面</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 操作按钮区域 -->
                                            <div style="flex: 1;">
                                                <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                                                    <strong>封面建议：</strong>建议尺寸 800x600px，支持 JPG、PNG、WebP、AVIF 格式，文件不超过 5MB
                                                </p>
                                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                                    <label for="detail-cover-upload" class="btn" style="background: #17a2b8; cursor: pointer; margin: 0;">
                                                        📤 上传/替换封面
                                                        <input type="file" id="detail-cover-upload" accept="image/jpeg,image/jpg,image/png,image/webp,image/avif,image/gif" style="display: none;" onchange="handleDetailCoverUpload(event)">
                                                    </label>
                                                    <button type="button" class="btn btn-danger" onclick="deleteDetailCover()" id="detail-cover-delete-btn" style="display: none;">
                                                        🗑️ 删除封面
                                                    </button>
                                                </div>
                                                <div id="detail-cover-upload-progress" style="margin-top: 1rem; display: none;">
                                                    <div style="color: #17a2b8; font-size: 0.9rem; margin-bottom: 0.5rem;">正在上传...</div>
                                                    <div style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                                        <div style="height: 100%; background: #17a2b8; width: 0%; transition: width 0.3s;" id="detail-cover-progress-bar"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-title" style="margin-top: 1.5rem;">
                                        🔗 关联的采摘记录
                                        <button type="button" class="btn btn-small" onclick="openBatchEditHarvestSelector()" style="float: right; margin-top: -5px;">➕ 选择采摘记录</button>
                                    </div>
                                    <div style="background: #f0f8ff; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.75rem; border-left: 3px solid #17a2b8;">
                                        <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                            <strong>📅 采摘时间参考：</strong>明前茶 3.20-4.4 · 雨前茶 4.4-4.19 · 春茶 4.20-5.5 · 夏茶 5.5-7.7 · 秋茶 7.7-9月中
                                        </p>
                                    </div>
                                    <div id="batch-edit-selected-records-count" style="color: #666; margin-bottom: 0.5rem;">
                                        已选择: 0 条
                                    </div>
                                    <div id="batch-edit-selected-records-preview" class="readonly-list">
                                        <p style="color: #999; text-align: center;">暂无关联记录</p>
                                    </div>

                                    <div class="section-title" style="margin-top: 1.5rem;">📋 基础信息</div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="batch-edit-category">茶叶品类</label>
                                            <select id="batch-edit-category" class="form-control" onchange="handleBatchCategoryChange()">
                                                <option value="">-- 请选择品类 --</option>
                                                <!-- 品类选项将从品类信息管理中动态加载 -->
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="batch-edit-number">批次号 <span class="required">*</span></label>
                                            <input type="text" id="batch-edit-number" class="form-control" placeholder="自动生成，也可手动修改">
                                        </div>
                                        <div class="form-group">
                                            <label for="batch-edit-production-date">生产日期</label>
                                            <input type="date" id="batch-edit-production-date" class="form-control" onchange="handleBatchEditProductionDateChange()">
                                        </div>
                                    </div>

                                    <div class="section-title" style="margin-top: 1.5rem;">👨‍🍳 制茶师信息</div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="batch-edit-tea-master-name">制茶师姓名</label>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div id="batch-edit-tea-master-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <span style="color: #999; font-size: 0.8rem;">暂无</span>
                                                </div>
                                                <select id="batch-edit-tea-master-name" class="form-control" style="flex: 1;">
                                                    <option value="">选择制茶师...</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="batch-edit-tea-master-experience">经验年限</label>
                                            <input type="number" id="batch-edit-tea-master-experience" class="form-control" min="0" step="1" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label for="batch-edit-tea-master-specialty">擅长领域</label>
                                            <input type="text" id="batch-edit-tea-master-specialty" class="form-control">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="batch-edit-grade">成品等级</label>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div id="batch-edit-grade-badge" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; background: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <span style="color: #999; font-size: 0.8rem;">🏆</span>
                                                </div>
                                                <select id="batch-edit-grade" class="form-control" style="flex: 1;">
                                                    <option value="">-- 请选择等级 --</option>
                                                    <!-- 等级选项将从等级管理模板动态加载 -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="batch-edit-final-product-weight">成品重量（公斤）</label>
                                            <input type="number" id="batch-edit-final-product-weight" class="form-control" min="0" step="0.1">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="batch-edit-notes">批次备注</label>
                                        <textarea id="batch-edit-notes" class="form-control" rows="3"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="batch-detail-title">批次详情标题</label>
                                        <textarea id="batch-detail-title" name="detail_title" class="form-control" rows="2" placeholder="将根据品类自动填充，也可手动编辑..."></textarea>
                                    </div>

                                    <!-- 成品鉴赏模块 -->
                                    <div class="section-title" style="margin-top: 2rem;">
                                        🍵 成品鉴赏
                                    </div>
                                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                        <!-- 图片上传区域 -->
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                            <!-- 成品干茶图片 -->
                                            <div>
                                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">成品干茶</label>
                                                <div id="dry-tea-preview-container" style="width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; margin-bottom: 0.5rem;">
                                                    <img id="dry-tea-preview" src="" alt="成品干茶预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                                    <span id="dry-tea-placeholder" style="color: #999; font-size: 0.9rem;">暂无图片</span>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <button type="button" class="btn btn-small" onclick="document.getElementById('dry-tea-upload').click()" style="flex: 1;">📤 上传</button>
                                                    <button type="button" class="btn btn-small" onclick="deleteDryTeaImage()" style="flex: 1; background: #dc3545;">🗑️ 删除</button>
                                                </div>
                                                <input type="file" id="dry-tea-upload" style="display: none;" accept="image/*" onchange="handleDryTeaUpload(event)">
                                            </div>

                                            <!-- 开水泡开图片 -->
                                            <div>
                                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">开水泡开</label>
                                                <div id="brewed-tea-preview-container" style="width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; margin-bottom: 0.5rem;">
                                                    <img id="brewed-tea-preview" src="" alt="开水泡开预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                                    <span id="brewed-tea-placeholder" style="color: #999; font-size: 0.9rem;">暂无图片</span>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <button type="button" class="btn btn-small" onclick="document.getElementById('brewed-tea-upload').click()" style="flex: 1;">📤 上传</button>
                                                    <button type="button" class="btn btn-small" onclick="deleteBrewedTeaImage()" style="flex: 1; background: #dc3545;">🗑️ 删除</button>
                                                </div>
                                                <input type="file" id="brewed-tea-upload" style="display: none;" accept="image/*" onchange="handleBrewedTeaUpload(event)">
                                            </div>
                                        </div>

                                        <!-- 文案区域 -->
                                        <div class="form-group">
                                            <label for="tasting-notes">品鉴笔记</label>
                                            <textarea id="tasting-notes" class="form-control" rows="4" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label for="brewing-suggestion">冲泡建议</label>
                                            <textarea id="brewing-suggestion" class="form-control" rows="3" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label for="storage-method">储存方法</label>
                                            <textarea id="storage-method" class="form-control" rows="3" placeholder="将根据茶叶品类自动填充默认文案，也可手动编辑..."></textarea>
                                        </div>
                                    </div>

                        <div style="text-align: center; margin-top: 2rem;">
                                        <button type="button" class="btn btn-success" onclick="saveBatchInfo()">💾 保存批次信息</button>
                                        <button type="button" class="btn btn-danger" onclick="deleteBatchFromEdit()" style="margin-left: 1rem;">🗑️ 删除批次</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

                    <!-- 制作编辑容器 -->
                    <div id="production-edit-form-container" class="hidden">
                        <div class="form-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);">
                                🎨 制作步骤编辑 - 多媒体画廊管理
                                <button type="button" class="btn btn-small" onclick="closeProductionEdit()" style="float: right; background: rgba(255,255,255,0.2);">关闭</button>
                            </div>
                            <div class="card-body">
                                <input type="hidden" id="production-edit-batch-id" value="">
                                
                                <div class="info-box">
                                    <strong>💡 功能说明（新架构）：</strong>每个制作步骤只能选择一种工艺类型：<br>
                                    • <strong>工艺选择</strong>：手工匠心、现代工艺或无<br>
                                    • <strong>媒体上传</strong>：支持多张图片或视频<br>
                                    • <strong>工艺文案</strong>：工艺目的、操作方法、感官变化、工艺价值<br>
                                    • <strong>保存</strong>：保存当前选择的工艺类型及其内容
                                </div>
                                
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <button type="button" class="btn btn-primary" onclick="saveAllProductionSteps()" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                                        💾 保存所有制作步骤
                                    </button>
                                </div>

                                <!-- 步骤1：摊晾 -->
                                <div class="step-card">
                                    <div class="step-card-header">
                                        <div class="step-number">1</div>
                                        <div class="step-name">摊晾</div>
                                    </div>
                                    
                                    <!-- 工艺类型选择 -->
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">🎯 选择工艺类型</label>
                                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                                            <label class="radio-label">
                                                <input type="radio" name="step0-craft-type" value="manual" onchange="handleCraftTypeChange(0)">
                                                ✋ 手工匠心
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step0-craft-type" value="modern" onchange="handleCraftTypeChange(0)">
                                                ⚙️ 现代工艺
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step0-craft-type" value="none" checked onchange="handleCraftTypeChange(0)">
                                                ❌ 无
                                            </label>
                                            <button type="button" class="btn btn-success" onclick="saveSingleProductionStep(0)" style="margin-left: auto;">💾 保存此步骤</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 工艺内容编辑区 -->
                                    <div id="step0-craft-content" class="step-subsection" style="display: none;">
                                        <div class="form-group">
                                            <label>上传媒体文件（多选）</label>
                                            <input type="file" id="step0-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleStepMediaUpload(0, event)">
                                        </div>
                                        <div id="step0-gallery" class="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                            <!-- 动态生成预览 -->
                                        </div>
                                        
                                        <!-- 工艺文案编辑区 -->
                                        <div class="form-group">
                                            <label>工艺目的</label>
                                            <textarea id="step0-purpose" class="form-control" rows="2" placeholder="描述该工艺步骤的目的..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>操作方法</label>
                                            <textarea id="step0-method" class="form-control" rows="3" placeholder="描述具体的操作方法..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>感官变化</label>
                                            <textarea id="step0-sensory-change" class="form-control" rows="2" placeholder="描述茶叶在此工艺中的感官变化..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>工艺价值</label>
                                            <textarea id="step0-value" class="form-control" rows="2" placeholder="描述该工艺的价值和意义..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 步骤2：杀青 -->
                                <div class="step-card">
                                    <div class="step-card-header">
                                        <div class="step-number">2</div>
                                        <div class="step-name">杀青</div>
                                    </div>
                                    
                                    <!-- 工艺类型选择 -->
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">🎯 选择工艺类型</label>
                                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                                            <label class="radio-label">
                                                <input type="radio" name="step1-craft-type" value="manual" onchange="handleCraftTypeChange(1)">
                                                ✋ 手工匠心
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step1-craft-type" value="modern" onchange="handleCraftTypeChange(1)">
                                                ⚙️ 现代工艺
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step1-craft-type" value="none" checked onchange="handleCraftTypeChange(1)">
                                                ❌ 无
                                            </label>
                                            <button type="button" class="btn btn-success" onclick="saveSingleProductionStep(1)" style="margin-left: auto;">💾 保存此步骤</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 工艺内容编辑区 -->
                                    <div id="step1-craft-content" class="step-subsection" style="display: none;">
                                        <div class="form-group">
                                            <label>上传媒体文件（多选）</label>
                                            <input type="file" id="step1-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleStepMediaUpload(1, event)">
                                        </div>
                                        <div id="step1-gallery" class="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
                                        
                                        <div class="form-group">
                                            <label>工艺目的</label>
                                            <textarea id="step1-purpose" class="form-control" rows="2" placeholder="描述该工艺步骤的目的..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>操作方法</label>
                                            <textarea id="step1-method" class="form-control" rows="3" placeholder="描述具体的操作方法..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>感官变化</label>
                                            <textarea id="step1-sensory-change" class="form-control" rows="2" placeholder="描述茶叶在此工艺中的感官变化..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>工艺价值</label>
                                            <textarea id="step1-value" class="form-control" rows="2" placeholder="描述该工艺的价值和意义..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 步骤3：揉捻 -->
                                <div class="step-card">
                                    <div class="step-card-header">
                                        <div class="step-number">3</div>
                                        <div class="step-name">揉捻</div>
                                    </div>
                                    
                                    <!-- 工艺类型选择 -->
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">🎯 选择工艺类型</label>
                                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                                            <label class="radio-label">
                                                <input type="radio" name="step2-craft-type" value="manual" onchange="handleCraftTypeChange(2)">
                                                ✋ 手工匠心
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step2-craft-type" value="modern" onchange="handleCraftTypeChange(2)">
                                                ⚙️ 现代工艺
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step2-craft-type" value="none" checked onchange="handleCraftTypeChange(2)">
                                                ❌ 无
                                            </label>
                                            <button type="button" class="btn btn-success" onclick="saveSingleProductionStep(2)" style="margin-left: auto;">💾 保存此步骤</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 工艺内容编辑区 -->
                                    <div id="step2-craft-content" class="step-subsection" style="display: none;">
                                        <div class="form-group">
                                            <label>上传媒体文件（多选）</label>
                                            <input type="file" id="step2-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleStepMediaUpload(2, event)">
                                        </div>
                                        <div id="step2-gallery" class="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
                                        
                                        <div class="form-group">
                                            <label>工艺目的</label>
                                            <textarea id="step2-purpose" class="form-control" rows="2" placeholder="描述该工艺步骤的目的..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>操作方法</label>
                                            <textarea id="step2-method" class="form-control" rows="3" placeholder="描述具体的操作方法..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>感官变化</label>
                                            <textarea id="step2-sensory-change" class="form-control" rows="2" placeholder="描述茶叶在此工艺中的感官变化..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>工艺价值</label>
                                            <textarea id="step2-value" class="form-control" rows="2" placeholder="描述该工艺的价值和意义..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 步骤4：干燥 -->
                                <div class="step-card">
                                    <div class="step-card-header">
                                        <div class="step-number">4</div>
                                        <div class="step-name">干燥</div>
                                    </div>
                                    
                                    <!-- 工艺类型选择 -->
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">🎯 选择工艺类型</label>
                                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                                            <label class="radio-label">
                                                <input type="radio" name="step3-craft-type" value="manual" onchange="handleCraftTypeChange(3)">
                                                ✋ 手工匠心
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step3-craft-type" value="modern" onchange="handleCraftTypeChange(3)">
                                                ⚙️ 现代工艺
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step3-craft-type" value="none" checked onchange="handleCraftTypeChange(3)">
                                                ❌ 无
                                            </label>
                                            <button type="button" class="btn btn-success" onclick="saveSingleProductionStep(3)" style="margin-left: auto;">💾 保存此步骤</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 工艺内容编辑区 -->
                                    <div id="step3-craft-content" class="step-subsection" style="display: none;">
                                        <div class="form-group">
                                            <label>上传媒体文件（多选）</label>
                                            <input type="file" id="step3-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleStepMediaUpload(3, event)">
                                        </div>
                                        <div id="step3-gallery" class="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
                                        
                                        <div class="form-group">
                                            <label>工艺目的</label>
                                            <textarea id="step3-purpose" class="form-control" rows="2" placeholder="描述该工艺步骤的目的..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>操作方法</label>
                                            <textarea id="step3-method" class="form-control" rows="3" placeholder="描述具体的操作方法..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>感官变化</label>
                                            <textarea id="step3-sensory-change" class="form-control" rows="2" placeholder="描述茶叶在此工艺中的感官变化..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>工艺价值</label>
                                            <textarea id="step3-value" class="form-control" rows="2" placeholder="描述该工艺的价值和意义..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 步骤5：分拣 -->
                                <div class="step-card">
                                    <div class="step-card-header">
                                        <div class="step-number">5</div>
                                        <div class="step-name">分拣</div>
                                    </div>
                                    
                                    <!-- 工艺类型选择 -->
                                    <div class="form-group" style="margin-bottom: 1.5rem;">
                                        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">🎯 选择工艺类型</label>
                                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                                            <label class="radio-label">
                                                <input type="radio" name="step4-craft-type" value="manual" onchange="handleCraftTypeChange(4)">
                                                ✋ 手工匠心
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step4-craft-type" value="modern" onchange="handleCraftTypeChange(4)">
                                                ⚙️ 现代工艺
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="step4-craft-type" value="none" checked onchange="handleCraftTypeChange(4)">
                                                ❌ 无
                                            </label>
                                            <button type="button" class="btn btn-success" onclick="saveSingleProductionStep(4)" style="margin-left: auto;">💾 保存此步骤</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 工艺内容编辑区 -->
                                    <div id="step4-craft-content" class="step-subsection" style="display: none;">
                                        <div class="form-group">
                                            <label>上传媒体文件（多选）</label>
                                            <input type="file" id="step4-upload" class="form-control" multiple accept="image/*,video/*" onchange="handleStepMediaUpload(4, event)">
                                        </div>
                                        <div id="step4-gallery" class="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
                                        
                                        <div class="form-group">
                                            <label>工艺目的</label>
                                            <textarea id="step4-purpose" class="form-control" rows="2" placeholder="描述该工艺步骤的目的..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>操作方法</label>
                                            <textarea id="step4-method" class="form-control" rows="3" placeholder="描述具体的操作方法..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>感官变化</label>
                                            <textarea id="step4-sensory-change" class="form-control" rows="2" placeholder="描述茶叶在此工艺中的感官变化..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>工艺价值</label>
                                            <textarea id="step4-value" class="form-control" rows="2" placeholder="描述该工艺的价值和意义..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 选择采摘记录 -->
    <div id="harvest-selector-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 选择采摘记录</h2>
                <button class="close-btn" onclick="closeHarvestRecordSelector()">关闭</button>
            </div>
            <div class="info-box">
                <p>请勾选本批次使用的采摘记录（只显示未归属的记录）</p>
            </div>
            <div id="unassigned-records-container" class="checkbox-list">
                <p style="color: #999; text-align: center;">加载中...</p>
            </div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button type="button" class="btn btn-success" onclick="confirmHarvestRecordSelection()">✔️ 确认选择</button>
                <button type="button" class="btn btn-secondary" onclick="closeHarvestRecordSelector()">取消</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全局变量 ====================
        let allHarvestRecords = [];
        let allBatches = [];
        let allCategories = []; // 存储品类数据用于排序
        let selectedHarvestRecordIds = [];
        let selectedHarvestRecordsData = [];
        let batchEditSelectedRecordIds = [];
        let batchEditSelectedRecordsData = [];
        let currentMediaUrls = []; // 存储当前表单中的媒体文件URL
        let currentEditingBatchId = null; // 当前正在编辑的批次ID
        let currentBatchCoverUrl = ''; // 存储当前批次的封面URL
        let currentDetailCoverUrl = ''; // 存储当前批次的详情页封面URL
        let currentDryTeaImageUrl = ''; // 存储成品干茶图片URL
        let currentBrewedTeaImageUrl = ''; // 存储开水泡开图片URL
        
        // 新增批次的图片URL存储
        let newBatchCoverUrl = ''; // 新增批次的封面URL
        let newDetailCoverUrl = ''; // 新增批次的详情页封面URL
        let newDryTeaImageUrl = ''; // 新增批次的成品干茶图片URL
        let newBrewedTeaImageUrl = ''; // 新增批次的开水泡开图片URL
        
        // 品类-标题映射配置（从服务器动态加载）
        let categoryTitleMap = {};
        
        // 品类-鉴赏模板映射配置（从服务器动态加载）
        let categoryAppreciationMap = {};
        
        // 品类英文缩写映射
        const categoryCodeMap = {
            '明前茶': 'MQ',
            '雨前茶': 'YQ',
            '春茶': 'CC',
            '夏茶': 'XC',
            '秋茶': 'QC'
        };
        
        // 新架构：存储每个步骤的工艺类型和媒体 URL
        // stepMediaGalleries[stepIndex] = { craftType: 'manual'|'modern'|'none', mediaUrls: [...] }
        let stepMediaGalleries = {
            0: { craftType: 'none', mediaUrls: [] },  // 摊晾
            1: { craftType: 'none', mediaUrls: [] },  // 杀青
            2: { craftType: 'none', mediaUrls: [] },  // 揉捻
            3: { craftType: 'none', mediaUrls: [] },  // 干燥
            4: { craftType: 'none', mediaUrls: [] }   // 分拣
        };

        // 缓存制作步骤模板数据（用于工艺类型切换时自动填充）
        let stepTemplatesCache = {};

        function normalizeHarvestRecord(record = {}) {
            const recordId = record.id ?? record._id ?? record.harvest_record_id ?? record.harvestRecordId ?? null;
            const harvestDateValue = record.harvest_date ?? record.harvestDate ?? record.date ?? null;
            const rawWeight =
                record.fresh_leaf_weight_kg ??
                record.freshLeafWeightKg ??
                record.total_weight ??
                record.total_weight_kg ??
                record.totalWeight ??
                record.totalWeightKg ??
                0;
            const mediaUrls =
                Array.isArray(record.media_urls) && record.media_urls.length > 0
                    ? record.media_urls
                    : Array.isArray(record.mediaUrls)
                        ? record.mediaUrls
                        : [];
            const gallery =
                Array.isArray(record.images_and_videos) && record.images_and_videos.length > 0
                    ? record.images_and_videos
                    : Array.isArray(record.imagesAndVideos)
                        ? record.imagesAndVideos
                        : [];

            return {
                ...record,
                id: recordId,
                _id: recordId,
                harvest_date: harvestDateValue,
                fresh_leaf_weight_kg: Number(rawWeight) || 0,
                assigned_batch_id: record.assigned_batch_id ?? record.assignedBatchId ?? null,
                category_id: record.category_id ?? record.categoryId ?? null,
                category_name: record.category_name ?? record.categoryName ?? null,
                harvest_team: record.harvest_team ?? record.harvestTeam ?? null,
                weather: record.weather ?? record.weatherInfo ?? null,
                media_urls: mediaUrls,
                mediaUrls,
                images_and_videos: gallery,
                imagesAndVideos: gallery,
            };
        }

        function normalizeHarvestRecords(records = []) {
            return records.map(normalizeHarvestRecord);
        }

        function normalizeCategory(category = {}) {
            const categoryId = category._id ?? category.id ?? category.category_id ?? category.categoryId ?? null;
            const yieldValue = category.yield_percentage ?? category.yieldPercentage ?? 0;
            const sortValue = category.sort_order ?? category.sortOrder ?? 999;
            const pickingStart = category.picking_start_date ?? category.pickingStartDate ?? null;
            const pickingEnd = category.picking_end_date ?? category.pickingEndDate ?? null;

            return {
                ...category,
                _id: categoryId,
                id: categoryId,
                picking_start_date: pickingStart,
                pickingStartDate: pickingStart,
                picking_end_date: pickingEnd,
                pickingEndDate: pickingEnd,
                yield_percentage: typeof yieldValue === 'number' ? yieldValue : parseFloat(yieldValue) || 0,
                yieldPercentage: typeof yieldValue === 'number' ? yieldValue : parseFloat(yieldValue) || 0,
                sort_order: typeof sortValue === 'number' ? sortValue : parseInt(sortValue) || 999,
                sortOrder: typeof sortValue === 'number' ? sortValue : parseInt(sortValue) || 999,
                image_url: category.image_url ?? category.imageUrl ?? '',
                imageUrl: category.image_url ?? category.imageUrl ?? '',
            };
        }

        function normalizeCategories(categories = []) {
            return categories.map(normalizeCategory);
        }

        // ==================== 初始化 ====================
        
        /**
         * 从服务器加载批次详情标题模板
         * 将原本硬编码的品类-标题映射关系改为从数据库动态获取
         */
        async function loadTitleTemplates() {
            try {
                const response = await fetch('/api/title-templates');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 将数组转换为映射对象
                    categoryTitleMap = {};
                    result.data.forEach(template => {
                        categoryTitleMap[template.category_name] = template.title_template;
                    });
                    
                    console.log(`✅ 成功加载 ${result.data.length} 个批次详情标题模板`, categoryTitleMap);
                } else {
                console.error('❌ 加载标题模板失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 加载标题模板时发生错误:', error);
            }
        }
        
        /**
         * 从服务器加载鉴赏模板
         * 将原本硬编码的品类默认文案改为从数据库动态获取
         */
        async function loadAppreciationTemplates() {
            try {
                const response = await fetch('/api/appreciation-templates');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 将数组格式的模板数据转换为对象映射
                    categoryAppreciationMap = {};
                    result.data.forEach(template => {
                        categoryAppreciationMap[template.category_name] = {
                            tasting_notes: template.tasting_notes || '',
                            brewing_suggestion: template.brewing_suggestion || '',
                            storage_method: template.storage_method || ''
                        };
                    });
                    console.log(`✅ 成功加载 ${result.data.length} 个鉴赏模板`, Object.keys(categoryAppreciationMap));
                } else {
                    console.error('❌ 加载鉴赏模板失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 加载鉴赏模板时发生错误:', error);
            }
        }

        /**
         * 从等级管理模板加载所有等级，并填充到下拉框中
         */
        async function loadGrades() {
            try {
                const response = await fetch('/api/grades');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const grades = result.data;
                    
                    // 填充新增批次的等级下拉框
                    const newGradeSelect = document.getElementById('new-batch-grade');
                    newGradeSelect.innerHTML = '<option value="">-- 请选择等级 --</option>';
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade.name;
                        option.textContent = grade.name;
                        // 使用驼峰命名 data-badge-url，兼容 badge_url 和 badgeUrl 两种字段名
                        option.dataset.badgeUrl = grade.badge_url || grade.badgeUrl || '';
                        newGradeSelect.appendChild(option);
                    });
                    
                    // 填充编辑批次的等级下拉框
                    const editGradeSelect = document.getElementById('batch-edit-grade');
                    editGradeSelect.innerHTML = '<option value="">-- 请选择等级 --</option>';
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade.name;
                        option.textContent = grade.name;
                        // 使用驼峰命名 data-badge-url，兼容 badge_url 和 badgeUrl 两种字段名
                        option.dataset.badgeUrl = grade.badge_url || grade.badgeUrl || '';
                        editGradeSelect.appendChild(option);
                    });
                    
                    // 设置等级徽章联动事件监听器
                    setupGradeBadgeLinkage();
                    
                    console.log(`✅ 成功加载 ${grades.length} 个产品等级`);
                } else {
                    console.error('❌ 加载等级失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 加载等级时发生错误:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 页面加载完成，开始初始化...');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('harvest-date').value = today;
            document.getElementById('new-production-date').value = today;
            
            // ⭐ 优先设置标签页切换功能（避免其他加载失败影响切换）
            try {
                setupTabNavigation();
                console.log('✅ 标签页导航已设置');
            } catch (error) {
                console.error('❌ 设置标签页导航失败:', error);
            }
            
            // 加载品类数据（用于卡片筛选器）
            loadCategories().catch(err => console.error('加载品类失败:', err));
            
            // 加载批次详情标题模板（从数据库动态获取）
            loadTitleTemplates().catch(err => console.error('加载标题模板失败:', err));
            
            // 加载鉴赏模板（从数据库动态获取）
            loadAppreciationTemplates().catch(err => console.error('加载鉴赏模板失败:', err));
            
            // 加载等级列表（从等级管理模板动态获取）
            loadGrades().catch(err => console.error('加载等级失败:', err));
            
            // 加载人员列表
            loadCaptains().catch(err => console.error('加载采摘队长失败:', err));
            loadTeaMasters().catch(err => console.error('加载制茶师失败:', err));
            
            // 加载天气模板（用于显示图标）
            loadWeatherIcons().catch(err => console.error('加载天气图标失败:', err));
            
            // 加载数据
            loadHarvestRecords().catch(err => console.error('加载采摘记录失败:', err));
            loadBatches().catch(err => console.error('加载批次失败:', err));
            
            // 监听采摘日期变化，自动同步天气
            document.getElementById('harvest-date').addEventListener('change', syncWeatherData);
            
            // 初始化时同步今天的天气
            syncWeatherData();
        });

        // ==================== 天气图标数据加载 ====================
        let weatherIconMap = {}; // 天气图标映射表
        
        // 加载天气图标
        async function loadWeatherIcons() {
            try {
                const response = await fetch('/api/weather-templates?active_only=true');
                const result = await response.json();
                
                if (result.success && result.data) {
                    weatherIconMap = {};
                    result.data.forEach(weather => {
                        if (weather.svg_icon) {
                            weatherIconMap[weather.name] = weather.svg_icon;
                        }
                    });
                    console.log('✅ 成功加载', Object.keys(weatherIconMap).length, '个天气图标');
                }
            } catch (error) {
                console.error('加载天气图标失败:', error);
            }
        }
        
        // 生成带图标的天气HTML
        function getWeatherHTML(weatherName) {
            if (!weatherName || weatherName === '未记录') {
                return '未记录';
            }
            
            const iconUrl = weatherIconMap[weatherName];
            if (iconUrl) {
                return `<img src="${iconUrl}" alt="${weatherName}" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 4px; object-fit: contain;">${weatherName}`;
            }
            return weatherName;
        }
        
        // ==================== 人员数据加载 ====================
        let teaMastersData = []; // 存储制茶师数据以便联动

        async function loadCaptains() {
            try {
                const response = await fetch('/api/personnel?role=采摘队长');
                const result = await response.json();
                if (result.success && result.data) {
                    const captainSelect = document.getElementById('team-leader');
                    captainSelect.innerHTML = '<option value="">请选择采摘队长</option>';
                    result.data.forEach(captain => {
                        const option = document.createElement('option');
                        option.value = captain.name;
                        option.textContent = captain.name;
                        option.dataset.avatarUrl = captain.avatar_url || captain.avatarUrl || '';
                        captainSelect.appendChild(option);
                    });
                    
                    // 添加采摘队长选择变化的事件监听
                    captainSelect.removeEventListener('change', handleCaptainChange);
                    captainSelect.addEventListener('change', handleCaptainChange);
                    updateCaptainAvatarFromSelect();
                    
                    console.log('✅ 成功加载', result.data.length, '个采摘队长');
                }
            } catch (error) {
                console.error('加载采摘队长列表失败:', error);
                document.getElementById('team-leader').innerHTML = '<option value="">加载失败</option>';
            }
        }

        async function loadTeaMasters() {
            try {
                const response = await fetch('/api/personnel?role=制茶师');
                const result = await response.json();
                if (result.success && result.data) {
                    teaMastersData = result.data; // 保存数据用于联动
                    
                    // 填充新增批次的制茶师下拉框
                    const newMasterSelect = document.getElementById('new-tea-master-name');
                    newMasterSelect.innerHTML = '<option value="">请选择制茶师</option>';
                    result.data.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.name;
                        option.textContent = master.name;
                        // 使用 data-experience-years，对应 dataset.experienceYears（驼峰命名）
                        option.dataset.experienceYears = master.experience_years || master.experienceYears || 0;
                        // 使用 avatarUrl（驼峰命名），与采摘队长保持一致
                        option.dataset.avatarUrl = master.avatar_url || master.avatarUrl || '';
                        newMasterSelect.appendChild(option);
                    });
                    
                    // 填充编辑批次的制茶师下拉框
                    const editMasterSelect = document.getElementById('batch-edit-tea-master-name');
                    editMasterSelect.innerHTML = '<option value="">请选择制茶师</option>';
                    result.data.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.name;
                        option.textContent = master.name;
                        // 使用 data-experience-years，对应 dataset.experienceYears（驼峰命名）
                        option.dataset.experienceYears = master.experience_years || master.experienceYears || 0;
                        // 使用 avatarUrl（驼峰命名），与采摘队长保持一致
                        option.dataset.avatarUrl = master.avatar_url || master.avatarUrl || '';
                        editMasterSelect.appendChild(option);
                    });
                    
                    // 设置联动事件监听器（先移除旧监听器，避免重复绑定）
                    setupTeaMasterLinkage();
                    
                    console.log('✅ 成功加载', result.data.length, '个制茶师');
                }
            } catch (error) {
                console.error('加载制茶师列表失败:', error);
                document.getElementById('new-tea-master-name').innerHTML = '<option value="">加载失败</option>';
                document.getElementById('batch-edit-tea-master-name').innerHTML = '<option value="">加载失败</option>';
            }
        }

        // 保存事件处理函数引用，以便移除监听器
        let newTeaMasterChangeHandler = null;
        let editTeaMasterChangeHandler = null;

        function setupTeaMasterLinkage() {
            const newMasterSelect = document.getElementById('new-tea-master-name');
            const editMasterSelect = document.getElementById('batch-edit-tea-master-name');
            
            // 移除旧的事件监听器（如果存在）
            if (newTeaMasterChangeHandler) {
                newMasterSelect.removeEventListener('change', newTeaMasterChangeHandler);
            }
            if (editTeaMasterChangeHandler) {
                editMasterSelect.removeEventListener('change', editTeaMasterChangeHandler);
            }
            
            // 新增批次的制茶师选择联动（复用采摘队长逻辑）
            newTeaMasterChangeHandler = function() {
                const selectedOption = this.options[this.selectedIndex];
                // 使用 dataset.experienceYears 读取 data-experience-years 属性
                const experienceYears = selectedOption?.dataset.experienceYears || 0;
                const rawAvatarUrl = selectedOption?.dataset.avatarUrl || '';
                
                // 更新经验年限
                document.getElementById('new-tea-master-experience').value = experienceYears;
                
                // 使用 resolveAvatarUrl 解析头像路径（复用记录人头像逻辑）
                const teaMasterPayload = rawAvatarUrl ? { avatar_url: rawAvatarUrl } : null;
                const resolvedUrl = resolveAvatarUrl(teaMasterPayload);
                updateAvatar('new-tea-master-avatar', resolvedUrl);
            };
            newMasterSelect.addEventListener('change', newTeaMasterChangeHandler);
            
            // 编辑批次的制茶师选择联动
            editTeaMasterChangeHandler = function() {
                const selectedOption = this.options[this.selectedIndex];
                // 使用 dataset.experienceYears 读取 data-experience-years 属性
                const experienceYears = selectedOption?.dataset.experienceYears || 0;
                const rawAvatarUrl = selectedOption?.dataset.avatarUrl || '';
                
                // 更新经验年限
                document.getElementById('batch-edit-tea-master-experience').value = experienceYears;
                
                // 使用 resolveAvatarUrl 解析头像路径（复用记录人头像逻辑）
                const teaMasterPayload = rawAvatarUrl ? { avatar_url: rawAvatarUrl } : null;
                const resolvedUrl = resolveAvatarUrl(teaMasterPayload);
                updateAvatar('batch-edit-tea-master-avatar', resolvedUrl);
            };
            editMasterSelect.addEventListener('change', editTeaMasterChangeHandler);
        }
        
        /**
         * 统一处理不同字段命名与路径的头像 URL
         * @param {object} person - 人员对象，可能包含 avatar_url、avatarUrl 等字段
         * @returns {string} 解析后的头像 URL
         */
        function resolveAvatarUrl(person) {
            if (!person || typeof person !== 'object') {
                return '';
            }

            const avatarCandidates = [
                person.avatar_url,
                person.avatarUrl,
                person.avatarURL,
                person.avatar?.url,
            ].filter(url => typeof url === 'string' && url.trim() !== '');

            if (avatarCandidates.length === 0) {
                return '';
            }

            const rawUrl = avatarCandidates[0].trim();

            // 绝对或协议相对地址直接返回
            if (/^https?:\/\//i.test(rawUrl) || rawUrl.startsWith('//')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('/')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('uploads/')) {
                return `/${rawUrl}`;
            }

            return `/uploads/avatars/${rawUrl}`;
        }

        /**
         * 统一处理等级徽章 URL
         * @param {string} badgeUrl - 徽章 URL
         * @returns {string} 解析后的徽章 URL
         */
        function resolveBadgeUrl(badgeUrl) {
            if (!badgeUrl || typeof badgeUrl !== 'string') {
                return '';
            }

            const rawUrl = badgeUrl.trim();
            if (!rawUrl) {
                return '';
            }

            // 绝对或协议相对地址直接返回
            if (/^https?:\/\//i.test(rawUrl) || rawUrl.startsWith('//')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('/')) {
                return rawUrl;
            }

            if (rawUrl.startsWith('uploads/')) {
                return `/${rawUrl}`;
            }

            return `/uploads/misc/${rawUrl}`;
        }

        /**
         * 更新人员头像显示
         * @param {string} containerId - 头像容器的ID
         * @param {string} avatarUrl - 头像URL（可以是字符串或对象）
         */
        function updateAvatar(containerId, avatarUrl) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // 如果传入的是对象，使用 resolveAvatarUrl 解析
            let resolvedUrl = '';
            if (typeof avatarUrl === 'object' && avatarUrl !== null) {
                resolvedUrl = resolveAvatarUrl(avatarUrl);
            } else if (typeof avatarUrl === 'string' && avatarUrl.trim() !== '') {
                // 如果是字符串，尝试作为对象处理（兼容旧代码）
                resolvedUrl = resolveAvatarUrl({ avatar_url: avatarUrl });
            }
            
            if (resolvedUrl && resolvedUrl.trim() !== '') {
                // 有头像，显示图片
                container.innerHTML = `<img src="${resolvedUrl}" alt="头像" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // 没有头像，显示默认提示
                container.innerHTML = '<span style="color: #999; font-size: 0.8rem;">暂无</span>';
            }
        }
        
        /**
         * 更新等级徽章显示
         * @param {string} containerId - 徽章容器的ID
         * @param {string} badgeUrl - 徽章URL
         */
        function updateGradeBadge(containerId, badgeUrl) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const resolvedUrl = resolveBadgeUrl(badgeUrl);
            
            if (resolvedUrl && resolvedUrl.trim() !== '') {
                // 有徽章，显示图片
                container.innerHTML = `<img src="${resolvedUrl}" alt="等级徽章" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // 没有徽章，显示默认图标
                container.innerHTML = '<span style="color: #999; font-size: 0.8rem;">🏆</span>';
            }
        }
        
        // 保存等级事件处理函数引用，以便移除监听器
        let newGradeChangeHandler = null;
        let editGradeChangeHandler = null;

        /**
         * 设置等级选择的徽章联动
         */
        function setupGradeBadgeLinkage() {
            const newGradeSelect = document.getElementById('new-batch-grade');
            const editGradeSelect = document.getElementById('batch-edit-grade');
            
            // 移除旧的事件监听器（如果存在）
            if (newGradeChangeHandler) {
                newGradeSelect.removeEventListener('change', newGradeChangeHandler);
            }
            if (editGradeChangeHandler) {
                editGradeSelect.removeEventListener('change', editGradeChangeHandler);
            }
            
            // 新增批次的等级选择联动
            newGradeChangeHandler = function() {
                const selectedOption = this.options[this.selectedIndex];
                // 使用驼峰命名 dataset.badgeUrl 读取 data-badge-url 属性
                const rawBadgeUrl = selectedOption?.dataset.badgeUrl || '';
                
                // 使用 resolveBadgeUrl 解析徽章路径
                const resolvedBadgeUrl = resolveBadgeUrl(rawBadgeUrl);
                updateGradeBadge('new-grade-badge', resolvedBadgeUrl);
            };
            newGradeSelect.addEventListener('change', newGradeChangeHandler);
            
            // 编辑批次的等级选择联动
            editGradeChangeHandler = function() {
                const selectedOption = this.options[this.selectedIndex];
                // 使用驼峰命名 dataset.badgeUrl 读取 data-badge-url 属性
                const rawBadgeUrl = selectedOption?.dataset.badgeUrl || '';
                
                // 使用 resolveBadgeUrl 解析徽章路径
                const resolvedBadgeUrl = resolveBadgeUrl(rawBadgeUrl);
                updateGradeBadge('batch-edit-grade-badge', resolvedBadgeUrl);
            };
            editGradeSelect.addEventListener('change', editGradeChangeHandler);
        }
        
        /**
         * 处理采摘队长选择变化
         */
        function handleCaptainChange() {
            updateCaptainAvatarFromSelect();
        }

        function updateCaptainAvatarFromSelect() {
            const captainSelect = document.getElementById('team-leader');
            if (!captainSelect) return;
            const selectedOption = captainSelect.options[captainSelect.selectedIndex];
            const raw = selectedOption?.dataset.avatarUrl;
            const captainPayload = raw
                ? { avatar_url: raw }
                : null;
            const resolvedUrl = typeof resolveAvatarUrl === 'function'
                ? resolveAvatarUrl(captainPayload)
                : (raw || '');
            updateAvatar('team-leader-avatar', resolvedUrl);
        }

        // ==================== 标签页切换 ====================
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('🔧 设置标签页导航，找到', tabButtons.length, '个按钮，', tabContents.length, '个内容区域');

            tabButtons.forEach((button, index) => {
                console.log(`  按钮 ${index + 1}:`, button.getAttribute('data-tab'));
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    console.log('🔄 点击了标签页:', targetTab);
                    
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    const targetElement = document.getElementById(targetTab + '-tab');
                    
                    if (targetElement) {
                        targetElement.classList.add('active');
                        console.log('✅ 切换到标签页:', targetTab);
                    } else {
                        console.error('❌ 找不到目标元素:', targetTab + '-tab');
                    }
                    
                    // 切换到采摘记录标签页时，重新加载品类数据以获取最新信息
                    if (targetTab === 'harvest') {
                        console.log('🔄 切换到采摘记录标签页，重新加载品类数据...');
                        loadCategories();
                    }
                });
            });
        }

        // ==================== 消息提示 ====================
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const alertClass = type === 'success' ? 'success-message' : 'error-message';
            container.innerHTML = `<div class="${alertClass}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        // ==================== 采摘记录管理 ====================
        // allCategories 已在全局变量区域声明
        let selectedCategoryId = null; // 当前选中的品类ID，null表示"全部"

        // 加载品类数据
        async function loadCategories() {
            try {
                document.getElementById('category-loading').style.display = 'inline';
                // 添加时间戳和禁用缓存的请求头，确保获取最新数据
                const response = await fetch(`/api/categories?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                if (result.success) {
                    allCategories = normalizeCategories(result.data || []);
                    renderCategoryCards();
                    // 动态填充品类下拉框
                    populateCategorySelects();
                    // 重新渲染采摘记录列表以应用最新的品类信息（包括采摘期日期）
                    if (typeof renderHarvestRecords === 'function' && allHarvestRecords.length > 0) {
                        renderHarvestRecords();
                        console.log('🔄 采摘记录列表已更新（使用最新品类数据）');
                    }
                    console.log('✅ 品类数据已加载:', allCategories.length);
                } else {
                    console.error('加载品类失败:', result.message);
                }
            } catch (error) {
                console.error('加载品类时出错:', error);
            } finally {
                document.getElementById('category-loading').style.display = 'none';
            }
        }

        /**
         * 动态填充新增批次和批次编辑的品类下拉框
         */
        function populateCategorySelects() {
            // 填充新增批次的品类下拉框
            const newCategorySelect = document.getElementById('new-batch-category');
            if (newCategorySelect) {
                newCategorySelect.innerHTML = '<option value="">-- 请选择品类 --</option>';
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    // 保存采摘期日期范围数据，供自动选择使用
                    if (category.picking_start_date) {
                        option.dataset.startDate = category.picking_start_date;
                    }
                    if (category.picking_end_date) {
                        option.dataset.endDate = category.picking_end_date;
                    }
                    newCategorySelect.appendChild(option);
                });
                console.log(`✅ 新增批次品类下拉框已填充 ${allCategories.length} 个品类`);
            }

            // 填充批次编辑的品类下拉框
            const editCategorySelect = document.getElementById('batch-edit-category');
            if (editCategorySelect) {
                editCategorySelect.innerHTML = '<option value="">-- 请选择品类 --</option>';
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    // 保存采摘期日期范围数据，供自动选择使用
                    if (category.picking_start_date) {
                        option.dataset.startDate = category.picking_start_date;
                    }
                    if (category.picking_end_date) {
                        option.dataset.endDate = category.picking_end_date;
                    }
                    editCategorySelect.appendChild(option);
                });
                console.log(`✅ 批次编辑品类下拉框已填充 ${allCategories.length} 个品类`);
            }
        }

        /**
         * 根据日期自动判断并返回对应的茶叶品类
         * @param {Date|string} date - 采摘日期
         * @returns {string|null} - 品类名称，如果没有匹配则返回 null
         */
        function findCategoryByDate(date) {
            const searchDate = new Date(date);
            searchDate.setHours(0, 0, 0, 0); // 只比较日期，忽略时间
            
            // 遍历所有品类，找到日期范围匹配的品类
            for (const category of allCategories) {
                if (category.picking_start_date && category.picking_end_date) {
                    const startDate = new Date(category.picking_start_date);
                    const endDate = new Date(category.picking_end_date);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    
                    // 判断日期是否在采摘期范围内
                    if (searchDate >= startDate && searchDate <= endDate) {
                        console.log(`📅 日期 ${searchDate.toLocaleDateString('zh-CN')} 属于品类: ${category.name}`);
                        return category.name;
                    }
                }
            }
            
            console.log(`⚠️ 日期 ${searchDate.toLocaleDateString('zh-CN')} 没有匹配的品类采摘期范围`);
            return null;
        }

        /**
         * 根据选择的采摘记录自动选择品类
         * 如果选择了2条或以上的采摘记录，以最小日期的采摘记录进行归纳
         */
        function autoSelectCategoryFromRecords(recordsData, targetSelectId) {
            if (!recordsData || recordsData.length === 0) {
                return;
            }
            
            // 找出最小日期的采摘记录
            let earliestRecord = recordsData[0];
            let earliestDate = new Date(recordsData[0].harvest_date);
            
            for (let i = 1; i < recordsData.length; i++) {
                const currentDate = new Date(recordsData[i].harvest_date);
                if (currentDate < earliestDate) {
                    earliestDate = currentDate;
                    earliestRecord = recordsData[i];
                }
            }
            
            const harvestDate = earliestRecord.harvest_date;
            
            if (recordsData.length > 1) {
                console.log(`🔍 选择了 ${recordsData.length} 条采摘记录，根据最小日期 ${earliestDate.toLocaleDateString('zh-CN')} 自动选择品类...`);
            } else {
                console.log(`🔍 正在根据采摘记录日期 ${earliestDate.toLocaleDateString('zh-CN')} 自动选择品类...`);
            }
            
            // 根据日期查找品类
            const categoryName = findCategoryByDate(harvestDate);
            
            if (categoryName) {
                // 自动选择品类
                const selectElement = document.getElementById(targetSelectId);
                if (selectElement) {
                    selectElement.value = categoryName;
                    console.log(`✅ 已自动选择品类: ${categoryName}`);
                    
                    // 触发品类变更事件（用于自动填充批次号、标题、文案等）
                    if (targetSelectId === 'new-batch-category') {
                        handleNewBatchCategoryChange();
                    } else if (targetSelectId === 'batch-edit-category') {
                        handleBatchCategoryChange();
                    }
                }
            } else {
                console.log('⚠️ 未能自动选择品类，请手动选择');
                showMessage('未找到对应的茶叶品类，请手动选择', 'warning');
            }
        }

        // 渲染品类卡片
        function renderCategoryCards() {
            const container = document.getElementById('category-cards-container');
            
            if (!container) return;

            // 统计每个品类的记录数量和总重量
            const categoryStats = getCategoryStats();

            // 生成"全部"卡片
            const totalCount = allHarvestRecords.length;
            const totalWeight = allHarvestRecords.reduce((sum, r) => sum + (parseFloat(r.fresh_leaf_weight_kg) || 0), 0);
            
            let cardsHTML = `
                <div class="category-card ${selectedCategoryId === null ? 'active' : ''}" 
                     onclick="selectCategory(null)">
                    <div class="category-card-header">
                        <span class="category-card-emoji">📊</span>
                        <span class="category-card-name">全部采摘</span>
                        <span class="category-card-check">${selectedCategoryId === null ? '✓' : ''}</span>
                    </div>
                    <div class="category-card-info">
                        <div class="category-card-count">${totalCount} 条</div>
                        <div class="category-card-total-weight">总计: ${totalWeight.toFixed(1)} kg</div>
                    </div>
                </div>
            `;

            // 对品类按采摘期开始日期排序（日期越早越靠前）
            const sortedCategories = [...allCategories].sort((a, b) => {
                // 如果都有开始日期，按日期排序
                if (a.picking_start_date && b.picking_start_date) {
                    return new Date(a.picking_start_date) - new Date(b.picking_start_date);
                }
                // 有日期的排在没日期的前面
                if (a.picking_start_date && !b.picking_start_date) return -1;
                if (!a.picking_start_date && b.picking_start_date) return 1;
                // 都没有日期，保持原顺序
                return 0;
            });

            // 生成品类卡片
            sortedCategories.forEach(category => {
                const stats = categoryStats[category._id] || { count: 0, weight: 0 };
                const isActive = selectedCategoryId === category._id;
                const isCurrentSeason = checkIfCurrentSeason(category);
                
                // 格式化采摘期
                let periodText = '';
                if (category.picking_start_date && category.picking_end_date) {
                    const startDate = new Date(category.picking_start_date);
                    const endDate = new Date(category.picking_end_date);
                    periodText = `${startDate.getMonth() + 1}.${startDate.getDate()}-${endDate.getMonth() + 1}.${endDate.getDate()}`;
                } else if (category.picking_period) {
                    periodText = category.picking_period;
                }

                cardsHTML += `
                    <div class="category-card ${isActive ? 'active' : ''}" 
                         onclick="selectCategory('${category._id}')">
                        <div class="category-card-header">
                            <span class="category-card-emoji">${getCategoryEmoji(category.name)}</span>
                            <span class="category-card-name">${category.name}</span>
                            <span class="category-card-check">${isActive ? '✓' : ''}</span>
                        </div>
                        <div class="category-card-info">
                            <div class="category-card-count">${stats.count} 条</div>
                            ${periodText ? `<div class="category-card-period">📅 ${periodText}</div>` : ''}
                            ${stats.weight > 0 ? `<div class="category-card-total-weight">总计: ${stats.weight.toFixed(1)} kg</div>` : ''}
                            ${isCurrentSeason ? '<div class="category-card-badge">当前采摘期</div>' : ''}
                        </div>
                    </div>
                `;
            });

            // 添加"未分类"卡片
            const unclassifiedRecords = allHarvestRecords.filter(r => !r.category_id && !r.category_name);
            const unclassifiedWeight = unclassifiedRecords.reduce((sum, r) => sum + (parseFloat(r.fresh_leaf_weight_kg) || 0), 0);
            
            cardsHTML += `
                <div class="category-card ${selectedCategoryId === 'unclassified' ? 'active' : ''}" 
                     onclick="selectCategory('unclassified')">
                    <div class="category-card-header">
                        <span class="category-card-emoji">⚠️</span>
                        <span class="category-card-name">未分类</span>
                        <span class="category-card-check">${selectedCategoryId === 'unclassified' ? '✓' : ''}</span>
                    </div>
                    <div class="category-card-info">
                        <div class="category-card-count">${unclassifiedRecords.length} 条</div>
                        ${unclassifiedWeight > 0 ? `<div class="category-card-total-weight">总计: ${unclassifiedWeight.toFixed(1)} kg</div>` : ''}
                    </div>
                </div>
            `;

            container.innerHTML = cardsHTML;
        }

        // 统计每个品类的记录数量和总重量
        function getCategoryStats() {
            const stats = {};
            
            allHarvestRecords.forEach(record => {
                const categoryId = record.category_id;
                if (categoryId) {
                    if (!stats[categoryId]) {
                        stats[categoryId] = { count: 0, weight: 0 };
                    }
                    stats[categoryId].count++;
                    stats[categoryId].weight += parseFloat(record.fresh_leaf_weight_kg) || 0;
                }
            });
            
            return stats;
        }

        // 根据品类名称返回对应的emoji
        function getCategoryEmoji(name) {
            const emojiMap = {
                '明前茶': '🌱',
                '雨前茶': '☔',
                '夏茶': '☀️',
                '秋茶': '🍂',
                '冬茶': '❄️',
                '春茶': '🌸'
            };
            
            for (const key in emojiMap) {
                if (name.includes(key)) {
                    return emojiMap[key];
                }
            }
            
            return '🍃'; // 默认emoji
        }

        // 检查品类是否在当前采摘期
        function checkIfCurrentSeason(category) {
            if (!category.picking_start_date || !category.picking_end_date) {
                return false;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(category.picking_start_date);
            startDate.setHours(0, 0, 0, 0);
            
            const endDate = new Date(category.picking_end_date);
            endDate.setHours(23, 59, 59, 999);
            
            return today >= startDate && today <= endDate;
        }

        // 选择品类
        function selectCategory(categoryId) {
            selectedCategoryId = categoryId;
            renderCategoryCards();
            renderHarvestRecords();
        }

        async function loadHarvestRecords() {
            try {
                const response = await fetch('/api/harvest-records');
                const result = await response.json();
                
                if (result.success) {
                    allHarvestRecords = normalizeHarvestRecords(result.data || []);
                    renderCategoryCards(); // 重新渲染品类卡片以更新统计
                    renderHarvestRecords();
                    console.log('✅ 采摘记录已加载:', allHarvestRecords.length);
                } else {
                    showMessage('加载采摘记录失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('加载采摘记录时出错:', error);
                showMessage('加载采摘记录失败: ' + error.message, 'error');
            }
        }

        // 强制重新归类所有采摘记录
        async function reclassifyAllHarvestRecords() {
            if (!confirm('确定要重新归类所有采摘记录吗？\n\n此操作将根据当前品类的采摘期设置重新匹配所有采摘记录。')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                // 显示加载状态
                button.disabled = true;
                button.innerHTML = '⏳ 处理中...';
                showMessage('正在重新归类所有采摘记录...', 'info');
                
                const response = await fetch('/api/categories/reclassify-harvest-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`✅ ${result.message}`, 'success');
                    
                    // 刷新采摘记录列表
                    await loadHarvestRecords();
                    
                    console.log('✅ 采摘记录重新归类完成:', result.count);
                } else {
                    showMessage(`❌ 重新归类失败：${result.message}`, 'error');
                }
            } catch (error) {
                console.error('重新归类采摘记录时发生错误:', error);
                showMessage('❌ 重新归类失败：' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // 批量同步采摘记录的天气数据
        async function syncAllWeatherData() {
            if (!confirm('确定要同步所有采摘记录的天气数据吗？\n\n此操作将从对应日期的生长日记中获取最新的天气数据，更新到采摘记录中。')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                // 显示加载状态
                button.disabled = true;
                button.innerHTML = '⏳ 同步中...';
                showMessage('正在同步天气数据，请稍候...', 'info');
                
                const response = await fetch('/api/harvest-records/sync-weather', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const { total, synced, noData, errors } = result.data;
                    
                    let message = `✅ 天气数据同步完成！\n\n`;
                    message += `📊 总记录数：${total} 条\n`;
                    message += `✅ 成功同步：${synced} 条\n`;
                    message += `⚠️ 无数据：${noData} 条\n`;
                    if (errors > 0) {
                        message += `❌ 失败：${errors} 条\n`;
                    }
                    
                    showMessage(message, 'success');
                    
                    // 刷新采摘记录列表
                    await loadHarvestRecords();
                    
                    console.log('✅ 天气数据同步完成:', result.data);
                    
                    // 显示详细统计
                    if (synced > 0 || noData > 0) {
                        console.log('📊 同步统计详情:');
                        console.log(`   总记录数: ${total}`);
                        console.log(`   成功同步: ${synced}`);
                        console.log(`   无数据: ${noData}`);
                        if (errors > 0) {
                            console.log(`   失败: ${errors}`);
                        }
                    }
                } else {
                    showMessage(`❌ 同步失败：${result.message}`, 'error');
                }
            } catch (error) {
                console.error('同步天气数据时发生错误:', error);
                showMessage('❌ 同步失败：' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function renderHarvestRecords() {
            const container = document.getElementById('harvest-records-list');
            const filter = document.getElementById('harvest-filter').value;
            
            let filteredRecords = allHarvestRecords;
            
            // 根据归属状态筛选
            if (filter === 'unassigned') {
                filteredRecords = filteredRecords.filter(r => !r.assigned_batch_id);
            } else if (filter === 'assigned') {
                filteredRecords = filteredRecords.filter(r => r.assigned_batch_id);
            }
            
            // 按品类分组采摘记录
            const groupedByCategory = groupRecordsByCategory(filteredRecords);
            
            // 生成HTML
            let html = '';
            
            // 对品类按采摘期开始日期排序
            const sortedCategories = [...allCategories].sort((a, b) => {
                if (a.picking_start_date && b.picking_start_date) {
                    return new Date(a.picking_start_date) - new Date(b.picking_start_date);
                }
                if (a.picking_start_date && !b.picking_start_date) return -1;
                if (!a.picking_start_date && b.picking_start_date) return 1;
                return 0;
            });
            
            // 渲染所有品类（即使没有采摘记录也要显示）
            sortedCategories.forEach(category => {
                const categoryRecords = groupedByCategory[category._id] || [];
                html += renderCategoryRecordGroup(category, categoryRecords);
            });
            
            // 渲染未分类的记录
            if (groupedByCategory['unclassified'] && groupedByCategory['unclassified'].length > 0) {
                html += renderUnclassifiedRecordGroup(groupedByCategory['unclassified']);
            }
            
            // 如果没有任何内容，显示提示
            if (html === '' && filteredRecords.length === 0) {
                container.innerHTML = `<p style="color: #999; text-align: center;">暂无采摘记录</p>`;
            } else {
                container.innerHTML = html;
            }
        }
        
        // 将采摘记录按品类分组
        function groupRecordsByCategory(records) {
            const groups = {};
            
            records.forEach(record => {
                if (record.category_id) {
                    if (!groups[record.category_id]) {
                        groups[record.category_id] = [];
                    }
                    groups[record.category_id].push(record);
                } else {
                    if (!groups['unclassified']) {
                        groups['unclassified'] = [];
                    }
                    groups['unclassified'].push(record);
                }
            });
            
            // 对每个分组内的记录按日期排序（最新的在前）
            Object.keys(groups).forEach(key => {
                groups[key].sort((a, b) => new Date(b.harvest_date) - new Date(a.harvest_date));
            });
            
            return groups;
        }
        
        // 渲染品类记录组卡片
        function renderCategoryRecordGroup(category, records) {
            const totalWeight = records.reduce((sum, r) => sum + (parseFloat(r.fresh_leaf_weight_kg) || 0), 0);
            const isCurrentSeason = checkIfCurrentSeason(category);
            
            // 直接使用品类信息管理数据库中的 picking_period 字符串
            // 这样能确保显示的采摘期与品类信息管理页面完全一致
            const periodText = category.picking_period || '未设置';
            
            // 使用品类信息管理数据库中的 name 字段获取对应的 emoji
            const emoji = getCategoryEmoji(category.name);
            
            // 渲染记录列表或空状态提示
            let recordsHTML = '';
            if (records.length > 0) {
                recordsHTML = records.map(record => renderSingleRecord(record)).join('');
            } else {
                recordsHTML = `
                    <div style="text-align: center; padding: 2rem; color: #999; font-size: 0.9rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📭</div>
                        <div>该品类暂无采摘记录</div>
                    </div>
                `;
            }
            
            return `
                <div class="category-record-group collapsed" data-category-id="${category._id}">
                    <div class="category-record-header" onclick="toggleHarvestCategoryGroup('${category._id}')">
                        <div class="category-record-title">
                            <span class="category-emoji">${emoji}</span>
                            <span class="category-name">${category.name}</span>
                            <span class="toggle-icon">▼</span>
                            ${isCurrentSeason ? '<span class="current-season-badge">当前采摘期</span>' : ''}
                        </div>
                        <div class="category-record-stats">
                            ${periodText ? `<span class="period-text">📅 ${periodText}</span>` : ''}
                            <span class="record-count">${records.length} 条记录</span>
                            ${totalWeight > 0 ? `<span class="total-weight">总计: ${totalWeight.toFixed(1)} kg</span>` : ''}
                        </div>
                    </div>
                    <div class="category-record-list">
                        ${recordsHTML}
                    </div>
                </div>
            `;
        }
        
        // 切换采摘记录品类卡片的展开/收起状态
        function toggleHarvestCategoryGroup(categoryId) {
            const groupElement = document.querySelector(`[data-category-id="${categoryId}"]`);
            if (groupElement) {
                groupElement.classList.toggle('collapsed');
            }
        }
        
        // 渲染未分类记录组卡片
        function renderUnclassifiedRecordGroup(records) {
            const totalWeight = records.reduce((sum, r) => sum + (parseFloat(r.fresh_leaf_weight_kg) || 0), 0);
            
            return `
                <div class="category-record-group unclassified collapsed" data-category-id="unclassified">
                    <div class="category-record-header" onclick="toggleHarvestCategoryGroup('unclassified')">
                        <div class="category-record-title">
                            <span class="category-emoji">⚠️</span>
                            <span class="category-name">未分类</span>
                            <span class="toggle-icon">▼</span>
                            <span class="unclassified-tip">（这些记录的日期不在任何品类的采摘期范围内）</span>
                        </div>
                        <div class="category-record-stats">
                            <span class="record-count">${records.length} 条记录</span>
                            <span class="total-weight">总计: ${totalWeight.toFixed(1)} kg</span>
                        </div>
                    </div>
                    <div class="category-record-list">
                        ${records.map(record => renderSingleRecord(record)).join('')}
                    </div>
                </div>
            `;
        }
        
        // 渲染单条采摘记录
        function renderSingleRecord(record) {
            const harvestDateValue = record.harvest_date ?? record.harvestDate ?? null;
            const date = harvestDateValue ? new Date(harvestDateValue).toLocaleDateString('zh-CN') : '未记录';
            const status = record.assigned_batch_id ? '已归属' : '未归属';
            const statusColor = record.assigned_batch_id ? '#28a745' : '#ffc107';
            const weight =
                typeof record.fresh_leaf_weight_kg === 'number'
                    ? record.fresh_leaf_weight_kg
                    : parseFloat(record.freshLeafWeightKg) || 0;
            const recordId = record._id ?? record.id ?? '';
            
            return `
                <div class="record-item">
                    <div class="record-item-info">
                        <h4>${date} - ${weight}kg 
                            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${status}</span>
                        </h4>
                        <p>天气: ${getWeatherHTML(record.weather?.icon)} ${record.weather?.temperature_range || ''} | 团队: ${record.harvest_team?.leader_name || '未记录'} (${record.harvest_team?.member_count || 0}人)</p>
                        ${record.notes ? `<p>备注: ${record.notes}</p>` : ''}
                    </div>
                    <div class="record-item-actions">
                        <button class="btn btn-secondary btn-small" onclick="editHarvestRecord('${recordId}')">✏️ 编辑</button>
                        <button class="btn btn-danger btn-small" onclick="deleteHarvestRecord('${recordId}')">🗑️ 删除</button>
                    </div>
                </div>
            `;
        }

        function filterHarvestRecords() {
            renderHarvestRecords();
        }

        // ==================== 媒体文件管理 ====================
        async function handleMediaUpload(event) {
            const files = event.target.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            if (currentMediaUrls.length + files.length > 20) {
                showMessage('媒体文件总数不能超过20个', 'error');
                event.target.value = '';
                return;
            }
            
            showMessage('正在上传文件...', 'info');
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (file.size > 50 * 1024 * 1024) {
                        showMessage(`文件 ${file.name} 大小超过50MB，已跳过`, 'error');
                        continue;
                    }
                    
                    await uploadSingleMediaFile(file);
                }
                
                showMessage('文件上传成功', 'success');
                event.target.value = '';
                
            } catch (error) {
                console.error('上传文件时出错:', error);
                showMessage('文件上传失败: ' + error.message, 'error');
            }
        }
        
        async function uploadSingleMediaFile(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                const mediaUrl = result.data.url;
                currentMediaUrls.push(mediaUrl);
                addMediaPreview(mediaUrl, file.type);
            } else {
                throw new Error(result.message || '上传失败');
            }
        }
        
        function createMediaPreviewItem(url, fileType) {
            const previewItem = document.createElement('div');
            previewItem.style.cssText = 'position: relative; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #f8f9fa;';
            
            const isVideo = fileType.startsWith('video/');
            
            if (isVideo) {
                previewItem.innerHTML = `
                    <video src="${url}" style="width: 100%; height: 150px; object-fit: cover;" controls></video>
                    <button onclick="removeMediaFromPreview('${url}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
                `;
            } else {
                previewItem.innerHTML = `
                    <img src="${url}" alt="预览" style="width: 100%; height: 150px; object-fit: cover;">
                    <button onclick="removeMediaFromPreview('${url}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
                `;
            }
            
            return previewItem;
        }
        
        function addMediaPreview(url, fileType) {
            const container = document.getElementById('media-preview-container');
            const previewList = document.getElementById('media-preview-list');
            
            container.style.display = 'block';
            
            const previewItem = createMediaPreviewItem(url, fileType);
            previewList.appendChild(previewItem);
        }
        
        function removeMediaFromPreview(url) {
            const index = currentMediaUrls.indexOf(url);
            if (index > -1) {
                currentMediaUrls.splice(index, 1);
            }
            
            renderMediaPreview();
            
            if (currentMediaUrls.length === 0) {
                document.getElementById('media-preview-container').style.display = 'none';
            }
        }
        
        function renderMediaPreview() {
            const container = document.getElementById('media-preview-container');
            const previewList = document.getElementById('media-preview-list');
            
            previewList.innerHTML = '';
            
            if (currentMediaUrls.length > 0) {
                container.style.display = 'block';
                
                currentMediaUrls.forEach((url) => {
                    const isVideo = url.match(/\.(mp4|webm|ogg|mov)$/i);
                    const fileType = isVideo ? 'video/mp4' : 'image/jpeg';
                    
                    const previewItem = createMediaPreviewItem(url, fileType);
                    previewList.appendChild(previewItem);
                });
            } else {
                container.style.display = 'none';
            }
        }
        
        // ==================== 采摘记录编辑功能 ====================
        async function editHarvestRecord(id) {
            try {
                showMessage('正在加载记录...', 'info');
                
                const response = await fetch(`/api/harvest-records/${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('加载记录失败: ' + result.message, 'error');
                    return;
                }
                
                const record = normalizeHarvestRecord(result.data);
                const recordId = record._id ?? record.id ?? '';
                
                document.getElementById('harvest-form-title').textContent = '✏️ 编辑采摘记录';
                document.getElementById('editing-record-id').value = recordId;
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';
                
                const harvestDateValue = record.harvest_date;
                if (harvestDateValue) {
                    const dateObj = new Date(harvestDateValue);
                    const formattedDate = Number.isNaN(dateObj.getTime()) ? '' : dateObj.toISOString().split('T')[0];
                    document.getElementById('harvest-date').value = formattedDate;
                } else {
                    document.getElementById('harvest-date').value = '';
                }
                document.getElementById('fresh-leaf-weight').value = record.fresh_leaf_weight_kg || '';
                
                // 显示天气信息和图标
                const weatherDisplay = document.getElementById('harvest-weather-display');
                const weatherIcon = document.getElementById('harvest-weather-icon');
                const tempDisplay = document.getElementById('harvest-temp-display');
                
                weatherDisplay.textContent = record.weather?.icon || '--';
                weatherDisplay.style.color = record.weather?.icon ? '#333' : '#666';
                
                // 显示天气图标
                if (record.weather?.icon && weatherIconMap[record.weather.icon]) {
                    weatherIcon.src = weatherIconMap[record.weather.icon];
                    weatherIcon.style.display = 'block';
                } else {
                    weatherIcon.style.display = 'none';
                }
                
                tempDisplay.textContent = record.weather?.temperature_range || '--';
                tempDisplay.style.color = record.weather?.temperature_range ? '#333' : '#666';
                
                const teamLeaderName = record.harvest_team?.leader_name || '';
                const captainSelect = document.getElementById('team-leader');
                if (captainSelect) {
                    captainSelect.value = teamLeaderName;
                    updateCaptainAvatarFromSelect();
                }
                document.getElementById('team-member-count').value = record.harvest_team?.member_count || '';
                document.getElementById('team-notes').value = record.harvest_team?.notes || '';
                
                // 显示采摘队长头像（如果有harvest_team_id，从populated数据中获取）
                const harvestLeaderProfile = record.harvestLeader ?? record.harvest_team_id ?? record.harvestTeamId ?? null;
                const leaderAvatar = harvestLeaderProfile?.avatar_url ?? harvestLeaderProfile?.avatarUrl ?? '';
                if (leaderAvatar) {
                    updateAvatar('team-leader-avatar', leaderAvatar);
                } else {
                    updateAvatar('team-leader-avatar', '');
                }
                
                document.getElementById('harvest-notes').value = record.notes || '';
                
                currentMediaUrls = [];
                if (record.media_urls && Array.isArray(record.media_urls) && record.media_urls.length > 0) {
                    currentMediaUrls = [...record.media_urls];
                } else if (record.images_and_videos && Array.isArray(record.images_and_videos) && record.images_and_videos.length > 0) {
                    currentMediaUrls = [...record.images_and_videos];
                }
                
                if (currentMediaUrls.length > 0) {
                    renderMediaPreview();
                } else {
                    document.getElementById('media-preview-container').style.display = 'none';
                    document.getElementById('media-preview-list').innerHTML = '';
                }
                
                document.getElementById('harvest-record-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showMessage('记录已加载，可以开始编辑', 'success');
                
            } catch (error) {
                console.error('加载采摘记录时出错:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }
        
        function cancelEditHarvestRecord() {
            document.getElementById('harvest-form-title').textContent = '➕ 新增采摘记录';
            document.getElementById('editing-record-id').value = '';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            
            document.getElementById('harvest-record-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('harvest-date').value = today;
            
            currentMediaUrls = [];
            document.getElementById('media-preview-container').style.display = 'none';
            document.getElementById('media-preview-list').innerHTML = '';
            
            // 重置天气显示
            document.getElementById('harvest-weather-display').textContent = '--';
            document.getElementById('harvest-weather-display').style.color = '#666';
            document.getElementById('harvest-weather-icon').style.display = 'none';
            document.getElementById('harvest-temp-display').textContent = '--';
            document.getElementById('harvest-temp-display').style.color = '#666';
            
            syncWeatherData();
            
            showMessage('已取消编辑', 'success');
        }

        // ==================== 日期导航功能 ====================
        /**
         * 改变采摘日期的月份
         * @param {number} offset - 月份偏移量（+1表示下一个月，-1表示上一个月）
         */
        function changeHarvestMonth(offset) {
            const dateInput = document.getElementById('harvest-date');
            let currentDate = dateInput.value ? new Date(dateInput.value + 'T00:00:00') : new Date();
            
            // 获取当前日期的年、月、日
            let year = currentDate.getFullYear();
            let month = currentDate.getMonth();
            let day = currentDate.getDate();
            
            // 增加或减少月份
            month += offset;
            
            // 处理跨年情况
            if (month > 11) {
                month = 0;
                year++;
            } else if (month < 0) {
                month = 11;
                year--;
            }
            
            // 处理月末日期问题（例如1月31日 -> 2月28日）
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            if (day > daysInMonth) {
                day = daysInMonth;
            }
            
            // 设置新日期
            const newDate = new Date(year, month, day);
            const formattedDate = newDate.toISOString().split('T')[0];
            dateInput.value = formattedDate;
            
            // 触发天气同步
            syncWeatherData();
            
            console.log(`📅 日期已${offset > 0 ? '增加' : '减少'}一个月: ${formattedDate}`);
        }

        // ==================== 天气自动同步 ====================
        async function syncWeatherData() {
            const date = document.getElementById('harvest-date').value;
            if (!date) {
                return;
            }
            
            try {
                const url = `/api/growth-logs/by-date?date=${date}`;
                const response = await fetch(url);
                const result = await response.json();
                
                const weatherDisplay = document.getElementById('harvest-weather-display');
                const weatherIcon = document.getElementById('harvest-weather-icon');
                const tempDisplay = document.getElementById('harvest-temp-display');
                
                if (result.success && result.data && result.data.weather) {
                    const weather = result.data.weather;
                    
                    weatherDisplay.textContent = weather.icon || '暂无记录';
                    weatherDisplay.style.color = weather.icon ? '#333' : '#999';
                    
                    // 显示天气图标
                    if (weather.icon && weatherIconMap[weather.icon]) {
                        weatherIcon.src = weatherIconMap[weather.icon];
                        weatherIcon.style.display = 'block';
                    } else {
                        weatherIcon.style.display = 'none';
                    }
                    
                    tempDisplay.textContent = weather.temperature_range || '暂无记录';
                    tempDisplay.style.color = weather.temperature_range ? '#333' : '#999';
                } else {
                    weatherDisplay.textContent = '暂无记录';
                    weatherDisplay.style.color = '#999';
                    weatherIcon.style.display = 'none';
                    tempDisplay.textContent = '暂无记录';
                    tempDisplay.style.color = '#999';
                }
            } catch (error) {
                console.error('同步天气数据时出错:', error);
                document.getElementById('harvest-weather-display').textContent = '获取失败';
                document.getElementById('harvest-temp-display').textContent = '获取失败';
                document.getElementById('harvest-weather-icon').style.display = 'none';
            }
        }

        async function saveHarvestRecord() {
            try {
                const editingId = document.getElementById('editing-record-id').value;
                const isEditMode = editingId !== '';
                
                const confirmMessage = isEditMode ? '确定要保存修改吗？' : '确定要保存这条采摘记录吗？';
                if (!confirm(confirmMessage)) {
                    return;
                }

                const harvestDate = document.getElementById('harvest-date').value;
                const freshLeafWeight = document.getElementById('fresh-leaf-weight').value;
                
                if (!harvestDate || !freshLeafWeight) {
                    showMessage('请填写必填字段（日期和重量）', 'error');
                    return;
                }
                
                // 验证团队人数
                const teamMemberCount = parseInt(document.getElementById('team-member-count').value);
                if (!teamMemberCount || teamMemberCount < 1) {
                    showMessage('❌ 采摘团队人数至少1人', 'error');
                    document.getElementById('team-member-count').focus();
                    return;
                }
                
                const weatherIcon = document.getElementById('harvest-weather-display').textContent;
                const temperatureRange = document.getElementById('harvest-temp-display').textContent;
                
                const recordData = {
                    harvest_date: harvestDate,
                    fresh_leaf_weight_kg: parseFloat(freshLeafWeight),
                    weather: {
                        icon: (weatherIcon !== '--' && weatherIcon !== '暂无记录' && weatherIcon !== '获取失败') ? weatherIcon : '',
                        temperature_range: (temperatureRange !== '--' && temperatureRange !== '暂无记录' && temperatureRange !== '获取失败') ? temperatureRange : ''
                    },
                    harvest_team: {
                        leader_name: document.getElementById('team-leader').value.trim(),
                        member_count: teamMemberCount,
                        notes: document.getElementById('team-notes').value.trim()
                    },
                    notes: document.getElementById('harvest-notes').value.trim(),
                    media_urls: currentMediaUrls
                };
                
                showMessage('正在保存...', 'info');
                
                let url, method;
                if (isEditMode) {
                    url = `/api/harvest-records/${editingId}`;
                    method = 'PUT';
                } else {
                    url = '/api/harvest-records';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const successMessage = isEditMode ? '✅ 采摘记录更新成功！' : '✅ 采摘记录保存成功！';
                    showMessage(successMessage, 'success');
                    
                    document.getElementById('harvest-record-form').reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('harvest-date').value = today;
                    
                    currentMediaUrls = [];
                    document.getElementById('media-preview-container').style.display = 'none';
                    document.getElementById('media-preview-list').innerHTML = '';
                    
                    document.getElementById('harvest-form-title').textContent = '➕ 新增采摘记录';
                    document.getElementById('editing-record-id').value = '';
                    document.getElementById('cancel-edit-btn').style.display = 'none';
                    
                    // 重置天气显示
                    document.getElementById('harvest-weather-display').textContent = '--';
                    document.getElementById('harvest-weather-display').style.color = '#666';
                    document.getElementById('harvest-weather-icon').style.display = 'none';
                    document.getElementById('harvest-temp-display').textContent = '--';
                    document.getElementById('harvest-temp-display').style.color = '#666';
                    
                    syncWeatherData();
                    loadHarvestRecords();
                } else {
                    showMessage('❌ 保存失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('保存采摘记录时出错:', error);
                showMessage('❌ 保存失败：' + error.message, 'error');
            }
        }

        async function deleteHarvestRecord(id) {
            if (!confirm('确定要删除这条采摘记录吗？此操作不可撤销！')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/harvest-records/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ 采摘记录已删除', 'success');
                    loadHarvestRecords();
                } else {
                    showMessage('❌ 删除失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('删除采摘记录时出错:', error);
                showMessage('❌ 删除失败：' + error.message, 'error');
            }
        }

        // ==================== 制作批次管理 ====================
        async function loadBatches() {
            try {
                // 确保品类数据已加载（用于分组和排序）
                if (allCategories.length === 0) {
                    console.log('⏳ 品类数据未加载，先加载品类数据...');
                    await loadCategories();
                }
                
                // 获取所有批次
                const response = await fetch('/api/batches');
                const result = await response.json();
                
                if (result.success) {
                    allBatches = result.data || [];
                    renderBatchList();
                    console.log('✅ 制作批次已加载:', allBatches.length);
                } else {
                    showMessage('加载制作批次失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('加载制作批次时出错:', error);
                showMessage('加载制作批次失败: ' + error.message, 'error');
            }
        }

        /**
         * 渲染批次列表 - 按品类分组显示
         */
        function renderBatchList() {
            const container = document.getElementById('batch-list');
            
            if (allBatches.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">暂无制作批次</p>';
                return;
            }
            
            // 按品类分组（兼容 categoryName 和 category_name 两种字段名）
            const groupedBatches = allBatches.reduce((acc, batch) => {
                // 优先使用 categoryName（Prisma 返回的 camelCase 格式），兼容 category_name
                const category = batch.categoryName || batch.category_name || '未分类';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(batch);
                return acc;
            }, {});
            
            // 品类图标和颜色映射
            const categoryConfig = {
                '春茶': { icon: '🌱', colorClass: 'category-spring' },
                '夏茶': { icon: '☀️', colorClass: 'category-summer' },
                '秋茶': { icon: '🍂', colorClass: 'category-autumn' },
                '明前茶': { icon: '💎', colorClass: 'category-mingqian' },
                '雨前茶': { icon: '💧', colorClass: 'category-yuqian' }
            };
            
            // 从 localStorage 读取折叠状态
            const collapsedState = JSON.parse(localStorage.getItem('batchCategoryCollapsed') || '{}');
            
            // 生成分组HTML
            const categoryKeys = Object.keys(groupedBatches);
            console.log('🔍 排序前的品类:', categoryKeys);
            
            const sortedCategories = categoryKeys.sort((a, b) => {
                // 根据品类数据中的 sort_order 排序
                const catA = allCategories.find(c => c.name === a);
                const catB = allCategories.find(c => c.name === b);
                const orderA = catA?.sort_order ?? 999;
                const orderB = catB?.sort_order ?? 999;
                
                console.log(`🔢 ${a}: sort_order=${orderA} vs ${b}: sort_order=${orderB}`);
                
                if (orderA === orderB) {
                    // 如果排序序号相同，按拼音排序
                    return a.localeCompare(b, 'zh-CN');
                }
                
                return orderA - orderB;
            });
            
            console.log('✅ 排序后的品类:', sortedCategories);
            
            container.innerHTML = sortedCategories
                .map(category => {
                    const batches = groupedBatches[category];
                    const config = categoryConfig[category] || { icon: '📦', colorClass: 'category-default' };
                    // 默认折叠，除非localStorage中明确设置为展开（false）
                    const isCollapsed = collapsedState[category] !== false;
                    
                    const batchesHTML = batches.map(batch => {
                        const batchId = batch.id || batch._id || '';
                        // 兼容 batch_number 和 batchNumber 两种字段名
                        const batchNumber = batch.batchNumber || batch.batch_number || '未命名批次';
                        // 兼容 production_date 和 productionDate 两种字段名
                        const dateRaw = batch.productionDate || batch.production_date || null;
                        const date = dateRaw ? new Date(dateRaw).toLocaleDateString('zh-CN') : '未设置';
                        const statusColors = {
                            '进行中': '#ffc107',
                            '已完成': '#28a745',
                            '已发布': '#17a2b8'
                        };
                        const statusColor = statusColors[batch.status] || '#6c757d';
                        // 兼容 tea_master 和 teaMasterRef 两种字段名
                        const teaMasterName = batch.teaMasterRef?.name || batch.tea_master?.name || '';
                        // 计算关联的采摘记录数量
                        const harvestCount = batch.batchHarvestRecords?.length || batch.harvest_records_count || 0;
                        
                        return `
                            <div class="batch-list-item">
                                <div class="batch-item-header">
                                    <span class="batch-number">${batchNumber}</span>
                                    <span class="batch-status" style="background: ${statusColor};">${batch.status}</span>
                                </div>
                                <div class="batch-item-info">
                                    <span class="batch-info-item">📅 ${date}</span>
                                    <span class="batch-info-item">📦 ${harvestCount}条</span>
                                    ${teaMasterName ? `<span class="batch-info-item">👨‍🍳 ${teaMasterName}</span>` : ''}
                                </div>
                                <div class="batch-item-actions">
                                    <button class="btn btn-small" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);" onclick="editBatch('${batchId}')">📝 批次编辑</button>
                                    <button class="btn btn-success btn-small" onclick="editProduction('${batchId}')">🎨 制作编辑</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="category-group">
                            <div class="category-header ${config.colorClass}" onclick="toggleCategoryGroup('${category}')">
                                <div class="category-header-left">
                                    <span class="category-icon">${config.icon}</span>
                                    <span class="category-name">${category}</span>
                                    <span class="category-count">[${batches.length} 条]</span>
                                </div>
                                <span class="category-toggle ${isCollapsed ? 'collapsed' : ''}">▼</span>
                            </div>
                            <div class="category-batches ${isCollapsed ? 'collapsed' : ''}" id="category-${category}">
                                ${batchesHTML}
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        /**
         * 切换品类分组的折叠状态
         */
        function toggleCategoryGroup(category) {
            const batchesContainer = document.getElementById(`category-${category}`);
            const toggleIcon = event.currentTarget.querySelector('.category-toggle');
            
            if (!batchesContainer || !toggleIcon) return;
            
            // 切换折叠状态
            const isCollapsed = batchesContainer.classList.toggle('collapsed');
            toggleIcon.classList.toggle('collapsed');
            
            // 保存到 localStorage
            const collapsedState = JSON.parse(localStorage.getItem('batchCategoryCollapsed') || '{}');
            collapsedState[category] = isCollapsed;
            localStorage.setItem('batchCategoryCollapsed', JSON.stringify(collapsedState));
        }

        /**
         * 处理新增批次的品类选择变更，自动填充批次号前缀、批次详情标题、成品等级和成品鉴赏文案
         */
        function handleNewBatchCategoryChange() {
            const categorySelect = document.getElementById('new-batch-category');
            const gradeSelect = document.getElementById('new-batch-grade');
            const selectedCategory = categorySelect.value;
            
            // 品类与成品等级映射
            const categoryGradeMap = {
                '明前茶': '珍品级',
                '雨前茶': '优品级',
                '春茶': '佳品级',
                '夏茶': '畅饮级',
                '秋茶': '茗香级'
            };
            
            // 自动生成批次号（如果生产日期已填）
            generateBatchNumber();
            
            // 自动填充成品等级
            if (selectedCategory && categoryGradeMap[selectedCategory]) {
                gradeSelect.value = categoryGradeMap[selectedCategory];
                console.log(`✅ 已自动填充成品等级：${categoryGradeMap[selectedCategory]}`);
            } else {
                gradeSelect.value = '';
            }
            
            // 自动填充批次详情标题
            const detailTitleTextarea = document.getElementById('new-batch-detail-title');
            if (selectedCategory && categoryTitleMap[selectedCategory]) {
                detailTitleTextarea.value = categoryTitleMap[selectedCategory];
            } else {
                detailTitleTextarea.value = '';
            }
            
            // 自动填充品鉴模板文案（调用API获取）
            loadAppreciationTemplateForCategory(selectedCategory);
        }
        
        /**
         * 根据品类名称加载品鉴模板并填充表单
         * @param {string} categoryName - 品类名称
         */
        async function loadAppreciationTemplateForCategory(categoryName) {
            if (!categoryName) {
                // 如果没有选择品类，清空品鉴相关字段
                document.getElementById('new-tasting-notes').value = '';
                document.getElementById('new-brewing-suggestion').value = '';
                document.getElementById('new-storage-method').value = '';
                return;
            }
            
            try {
                // 先尝试从缓存中获取（如果已加载）
                const cachedTemplate = categoryAppreciationMap[categoryName];
                if (cachedTemplate) {
                    document.getElementById('new-tasting-notes').value = cachedTemplate.tasting_notes || '';
                    document.getElementById('new-brewing-suggestion').value = cachedTemplate.brewing_suggestion || '';
                    document.getElementById('new-storage-method').value = cachedTemplate.storage_method || '';
                    console.log(`✅ 已从缓存加载品鉴模板: ${categoryName}`);
                    return;
                }
                
                // 如果缓存中没有，尝试调用API获取（使用品类名称）
                // 注意：API可能使用品类名称而不是ID
                const response = await fetch(`/api/appreciation-templates`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // 从所有模板中查找匹配的品类
                        const template = result.data.find(t => 
                            t.category_name === categoryName || 
                            t.categoryName === categoryName
                        );
                        
                        if (template) {
                            // 填充品鉴笔记、冲泡建议和储存方法
                            document.getElementById('new-tasting-notes').value = template.tasting_notes || template.tastingNotes || '';
                            document.getElementById('new-brewing-suggestion').value = template.brewing_suggestion || template.brewingSuggestion || '';
                            document.getElementById('new-storage-method').value = template.storage_method || template.storageMethod || '';
                            console.log(`✅ 已从API加载品鉴模板: ${categoryName}`);
                        } else {
                            // 如果没有找到模板，清空字段
                            document.getElementById('new-tasting-notes').value = '';
                            document.getElementById('new-brewing-suggestion').value = '';
                            document.getElementById('new-storage-method').value = '';
                            console.log(`⚠️ 未找到品类 ${categoryName} 的品鉴模板`);
                        }
                    }
                } else {
                    console.warn(`⚠️ 获取品鉴模板失败: ${response.status}`);
                    // 失败时清空字段
                    document.getElementById('new-tasting-notes').value = '';
                    document.getElementById('new-brewing-suggestion').value = '';
                    document.getElementById('new-storage-method').value = '';
                }
            } catch (error) {
                console.error('加载品鉴模板时出错:', error);
                // 出错时清空字段
                document.getElementById('new-tasting-notes').value = '';
                document.getElementById('new-brewing-suggestion').value = '';
                document.getElementById('new-storage-method').value = '';
            }
        }
        
        /**
         * 根据茶叶品类填充新增批次的默认文案
         */
        function fillNewBatchDefaultTexts(categoryName) {
            const defaults = categoryAppreciationMap[categoryName];
            if (!defaults) {
                // 如果没有匹配的品类，清空文案
                document.getElementById('new-tasting-notes').value = '';
                document.getElementById('new-brewing-suggestion').value = '';
                document.getElementById('new-storage-method').value = '';
                return;
            }
            
            // 填充对应的默认文案
            document.getElementById('new-tasting-notes').value = defaults.tasting_notes || '';
            document.getElementById('new-brewing-suggestion').value = defaults.brewing_suggestion || '';
            document.getElementById('new-storage-method').value = defaults.storage_method || '';
        }

        /**
         * 处理批次编辑时的品类选择变更，自动填充批次详情标题
         */
        function handleBatchCategoryChange() {
            const categorySelect = document.getElementById('batch-edit-category');
            const detailTitleTextarea = document.getElementById('batch-detail-title');
            const selectedCategory = categorySelect.value;
            
            // 自动生成批次号（如果生产日期已填）
            generateBatchEditNumber();
            
            // 如果选择了有效品类，自动填充对应的标题
            if (selectedCategory && categoryTitleMap[selectedCategory]) {
                detailTitleTextarea.value = categoryTitleMap[selectedCategory];
            } else {
                // 如果品类无效或为空，清空标题
                detailTitleTextarea.value = '';
            }
        }
        
        /**
         * 编辑批次时自动填充生产日期（选择采摘记录中的最大日期）
         */
        function autoFillBatchEditProductionDate() {
            if (batchEditSelectedRecordsData.length === 0) return;
            
            // 找到最大的采摘日期
            let maxDate = null;
            batchEditSelectedRecordsData.forEach(record => {
                const date = new Date(record.harvest_date);
                if (!maxDate || date > maxDate) {
                    maxDate = date;
                }
            });
            
            if (maxDate) {
                // 格式化为 YYYY-MM-DD
                const year = maxDate.getFullYear();
                const month = String(maxDate.getMonth() + 1).padStart(2, '0');
                const day = String(maxDate.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                
                document.getElementById('batch-edit-production-date').value = formattedDate;
                
                // 如果已经选择了品类，则自动生成批次号
                const category = document.getElementById('batch-edit-category').value;
                if (category) {
                    generateBatchEditNumber();
                }
            }
        }
        
        /**
         * 编辑批次时自动生成批次号
         * 格式：品类 · 批次 缩写-YYYYMMDD
         */
        function generateBatchEditNumber() {
            const category = document.getElementById('batch-edit-category').value;
            const productionDate = document.getElementById('batch-edit-production-date').value;
            
            if (!category || !productionDate) {
                return;
            }
            
            // 获取品类英文缩写
            const categoryCode = categoryCodeMap[category] || 'XX';
            
            // 格式化日期为 YYYYMMDD
            const dateStr = productionDate.replace(/-/g, '');
            
            // 生成批次号：品类 · 批次 缩写-日期
            const batchNumber = `${category} · 批次 ${categoryCode}-${dateStr}`;
            
            document.getElementById('batch-edit-number').value = batchNumber;
        }
        
        /**
         * 处理编辑批次时生产日期变化，更新批次号
         */
        function handleBatchEditProductionDateChange() {
            const category = document.getElementById('batch-edit-category').value;
            if (category) {
                generateBatchEditNumber();
            }
        }

        function showNewBatchForm() {
            // 隐藏所有编辑区域
            document.getElementById('default-view').classList.add('hidden');
            document.getElementById('batch-edit-form-container').classList.add('hidden');
            document.getElementById('production-edit-form-container').classList.add('hidden');
            // 显示新增表单
            document.getElementById('new-batch-view').classList.remove('hidden');
            
            // 清空表单
            document.getElementById('new-batch-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-production-date').value = today;
            
            selectedHarvestRecordIds = [];
            selectedHarvestRecordsData = [];
            document.getElementById('new-selected-records-count').textContent = '已选择: 0 条';
            document.getElementById('new-selected-records-preview').style.display = 'none';
            
            // 清空图片URL和预览
            newBatchCoverUrl = '';
            newDetailCoverUrl = '';
            newDryTeaImageUrl = '';
            newBrewedTeaImageUrl = '';
            updateNewBatchCoverPreview('');
            updateNewDetailCoverPreview('');
            updateNewDryTeaPreview('');
            updateNewBrewedTeaPreview('');
        }

        function cancelNewBatch() {
            // 清空所有新增批次的数据
            newBatchCoverUrl = '';
            newDetailCoverUrl = '';
            newDryTeaImageUrl = '';
            newBrewedTeaImageUrl = '';
            selectedHarvestRecordIds = [];
            selectedHarvestRecordsData = [];
            
            document.getElementById('new-batch-view').classList.add('hidden');
            document.getElementById('default-view').classList.remove('hidden');
        }

        async function saveNewBatch() {
            try {
                if (!confirm('确定要保存这个制作批次吗？')) {
                    return;
                }

                const batchNumber = document.getElementById('new-batch-number').value.trim();
                const categoryName = document.getElementById('new-batch-category').value.trim();
                const productionDate = document.getElementById('new-production-date').value;
                
                if (!batchNumber || !categoryName || !productionDate) {
                    showMessage('请填写必填字段（批次号、品类、生产日期）', 'error');
                    return;
                }
                
                if (selectedHarvestRecordIds.length === 0) {
                    if (!confirm('尚未选择任何采摘记录，确定要继续吗？')) {
                        return;
                    }
                }
                
                const batchData = {
                    batch_number: batchNumber,
                    category_name: categoryName,
                    production_date: productionDate,
                    cover_image_url: newBatchCoverUrl, // 批次封面
                    detail_cover_image_url: newDetailCoverUrl, // 详情页封面
                    detail_title: document.getElementById('new-batch-detail-title').value.trim(), // 批次详情标题
                    tea_master: {
                        name: document.getElementById('new-tea-master-name').value.trim(),
                        experience_years: parseInt(document.getElementById('new-tea-master-experience').value) || 0,
                        specialty: document.getElementById('new-tea-master-specialty').value.trim()
                    },
                    final_product_weight_kg: parseFloat(document.getElementById('new-final-product-weight').value) || 0,
                    grade: document.getElementById('new-batch-grade').value,
                    notes: document.getElementById('new-batch-notes').value.trim(),
                    harvest_records_ids: selectedHarvestRecordIds,
                    product_appreciation: {
                        dry_tea_image: newDryTeaImageUrl, // 成品干茶图
                        brewed_tea_image: newBrewedTeaImageUrl, // 开水泡开图
                        tasting_notes: document.getElementById('new-tasting-notes').value.trim(),
                        brewing_suggestion: document.getElementById('new-brewing-suggestion').value.trim(),
                        storage_method: document.getElementById('new-storage-method').value.trim()
                    }
                };
                
                showMessage('正在保存...', 'info');
                
                const response = await fetch('/api/batches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(batchData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ 制作批次保存成功！', 'success');
                    
                    // 重新加载批次列表
                    await loadBatches();
                    await loadHarvestRecords();
                    
                    // 返回默认视图
                    cancelNewBatch();
                    
                } else {
                    showMessage('❌ 保存失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('保存制作批次时出错:', error);
                showMessage('❌ 保存失败：' + error.message, 'error');
            }
        }

        // ==================== 批次编辑 ====================
        async function editBatch(batchId) {
            try {
                showMessage('正在加载批次信息...', 'info');
                
                const response = await fetch(`/api/batches/${batchId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('加载批次信息失败: ' + result.message, 'error');
                    return;
                }
                
                const batch = result.data;
                const batchIdValue = batch.id || batch._id || batchId;
                currentEditingBatchId = batchIdValue;
                
                // 隐藏所有其他视图
                document.getElementById('default-view').classList.add('hidden');
                document.getElementById('new-batch-view').classList.add('hidden');
                document.getElementById('production-edit-form-container').classList.add('hidden');
                // 显示批次编辑视图
                document.getElementById('batch-edit-form-container').classList.remove('hidden');
                
                // 填充基础信息
                document.getElementById('batch-edit-id').value = batchIdValue;
                document.getElementById('batch-edit-number').value = batch.batch_number || batch.batchNumber || '';
                document.getElementById('batch-edit-category').value = batch.category_name || batch.categoryName || '';
                
                // 安全处理生产日期
                const productionDateRaw = batch.production_date || batch.productionDate || null;
                let productionDateValue = '';
                if (productionDateRaw) {
                    if (typeof productionDateRaw === 'string') {
                        productionDateValue = productionDateRaw.split('T')[0];
                    } else if (productionDateRaw instanceof Date) {
                        productionDateValue = productionDateRaw.toISOString().split('T')[0];
                    }
                }
                document.getElementById('batch-edit-production-date').value = productionDateValue;
                
                const teaMasterData = batch.tea_master || batch.teaMaster || batch.teaMasterRef || null;
                document.getElementById('batch-edit-tea-master-name').value = teaMasterData?.name || '';
                document.getElementById('batch-edit-tea-master-experience').value = teaMasterData?.experience_years || teaMasterData?.experienceYears || '';
                document.getElementById('batch-edit-tea-master-specialty').value = teaMasterData?.specialty || '';
                
                // 显示制茶师头像（兼容多种字段名，使用 resolveAvatarUrl 解析）
                const teaMasterAvatarSource = 
                    batch.teaMasterRef?.avatarUrl ||
                    batch.teaMasterRef?.avatar_url ||
                    teaMasterData?.avatar_url ||
                    teaMasterData?.avatarUrl ||
                    batch.tea_master_id?.avatar_url ||
                    batch.tea_master_id?.avatarUrl ||
                    batch.teaMasterId?.avatar_url ||
                    batch.teaMasterId?.avatarUrl ||
                    '';
                const teaMasterPayload = teaMasterAvatarSource ? { avatar_url: teaMasterAvatarSource } : null;
                const resolvedTeaMasterUrl = resolveAvatarUrl(teaMasterPayload);
                updateAvatar('batch-edit-tea-master-avatar', resolvedTeaMasterUrl);
                
                document.getElementById('batch-edit-final-product-weight').value = batch.final_product_weight_kg || batch.finalProductWeightKg || '';
                document.getElementById('batch-edit-grade').value = batch.grade || '';
                
                // 显示等级徽章（如果有等级，使用 resolveBadgeUrl 解析）
                if (batch.grade) {
                    const gradeSelect = document.getElementById('batch-edit-grade');
                    const selectedOption = gradeSelect.options[gradeSelect.selectedIndex];
                    // 使用驼峰命名 dataset.badgeUrl 读取 data-badge-url 属性
                    if (selectedOption && selectedOption.dataset.badgeUrl) {
                        const rawBadgeUrl = selectedOption.dataset.badgeUrl || '';
                        const resolvedBadgeUrl = resolveBadgeUrl(rawBadgeUrl);
                        updateGradeBadge('batch-edit-grade-badge', resolvedBadgeUrl);
                    }
                }
                
                document.getElementById('batch-edit-notes').value = batch.notes || '';
                
                // 填充批次详情标题 - 如果数据库中有保存则使用，否则根据品类填充
                const detailTitle = batch.detail_title || batch.detailTitle || '';
                const categoryNameForTitle = batch.category_name || batch.categoryName || '';
                if (detailTitle) {
                    document.getElementById('batch-detail-title').value = detailTitle;
                } else if (categoryNameForTitle && categoryTitleMap[categoryNameForTitle]) {
                    document.getElementById('batch-detail-title').value = categoryTitleMap[categoryNameForTitle];
                } else {
                    document.getElementById('batch-detail-title').value = '';
                }
                
                // 初始化选中的采摘记录（兼容多种数据结构）
                const harvestRecordsSource = 
                    batch.harvest_records_ids || 
                    batch.harvestRecordsIds ||
                    batch.batchHarvestRecords ||
                    [];
                
                batchEditSelectedRecordsData = Array.isArray(harvestRecordsSource) 
                    ? harvestRecordsSource.map(r => {
                        // 处理不同的数据结构
                        if (typeof r === 'object' && r !== null) {
                            return r.harvestRecord || r;
                        }
                        return r;
                    })
                    : [];
                
                batchEditSelectedRecordIds = batchEditSelectedRecordsData.map(r => {
                    const recordId = r.id || r._id || r.harvestRecordId || r.harvest_record_id || '';
                    return recordId;
                }).filter(id => id);
                
                // 填充关联的采摘记录
                renderBatchEditHarvestRecords();
                
                // 加载并显示批次封面
                currentBatchCoverUrl = batch.cover_image_url || batch.coverImageUrl || '';
                updateBatchCoverPreview(currentBatchCoverUrl);
                
                // 加载并显示详情页封面
                currentDetailCoverUrl = batch.detail_cover_image_url || batch.detailCoverImageUrl || '';
                updateDetailCoverPreview(currentDetailCoverUrl);
                
                // 加载并显示成品鉴赏数据
                loadProductAppreciation(batch);
                
                // 监听茶叶品类变化，自动填充默认文案
                document.getElementById('batch-edit-category').addEventListener('change', function() {
                    fillDefaultTexts(this.value);
                });
                
                showMessage('批次信息已加载，可以开始编辑', 'success');
                
            } catch (error) {
                console.error('加载批次信息时出错:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }

        // ==================== 成品鉴赏功能 ====================
        
        // 加载成品鉴赏数据
        function loadProductAppreciation(batch) {
            const appreciation = batch.product_appreciation || batch.productAppreciation || {};
            
            // 加载图片（兼容多种字段名）
            currentDryTeaImageUrl = 
                appreciation.dry_tea_image || 
                appreciation.dryTeaImage || 
                '';
            currentBrewedTeaImageUrl = 
                appreciation.brewed_tea_image || 
                appreciation.brewedTeaImage || 
                '';
            
            updateDryTeaPreview(currentDryTeaImageUrl);
            updateBrewedTeaPreview(currentBrewedTeaImageUrl);
            
            // 加载文案，如果数据库中有保存的内容则使用，否则根据品类填充默认文案
            const hasCustomContent = 
                appreciation.tasting_notes || appreciation.tastingNotes ||
                appreciation.brewing_suggestion || appreciation.brewingSuggestion ||
                appreciation.storage_method || appreciation.storageMethod;
            
            if (hasCustomContent) {
                // 如果有自定义内容，加载保存的内容（兼容多种字段名）
                document.getElementById('tasting-notes').value = appreciation.tasting_notes || appreciation.tastingNotes || '';
                document.getElementById('brewing-suggestion').value = appreciation.brewing_suggestion || appreciation.brewingSuggestion || '';
                document.getElementById('storage-method').value = appreciation.storage_method || appreciation.storageMethod || '';
            } else {
                const categoryNameForAppreciation = batch.category_name || batch.categoryName || '';
                if (categoryNameForAppreciation) {
                    // 如果没有自定义内容，根据品类填充默认文案
                    fillDefaultTexts(categoryNameForAppreciation);
                } else {
                    // 没有品类信息，清空字段
                    document.getElementById('tasting-notes').value = '';
                    document.getElementById('brewing-suggestion').value = '';
                    document.getElementById('storage-method').value = '';
                }
            }
        }
        
        // 根据茶叶品类填充默认文案
        function fillDefaultTexts(categoryName) {
            const defaults = categoryAppreciationMap[categoryName];
            if (!defaults) {
                // 如果没有匹配的品类，清空文案
                document.getElementById('tasting-notes').value = '';
                document.getElementById('brewing-suggestion').value = '';
                document.getElementById('storage-method').value = '';
                return;
            }
            
            // 切换品类时自动重置并填充对应的默认文案
            document.getElementById('tasting-notes').value = defaults.tasting_notes || '';
            document.getElementById('brewing-suggestion').value = defaults.brewing_suggestion || '';
            document.getElementById('storage-method').value = defaults.storage_method || '';
        }
        
        // 更新成品干茶图片预览
        function updateDryTeaPreview(url) {
            const previewImg = document.getElementById('dry-tea-preview');
            const placeholder = document.getElementById('dry-tea-placeholder');
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        // 更新开水泡开图片预览
        function updateBrewedTeaPreview(url) {
            const previewImg = document.getElementById('brewed-tea-preview');
            const placeholder = document.getElementById('brewed-tea-placeholder');
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        // 处理成品干茶图片上传
        async function handleDryTeaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            try {
                showMessage('正在上传图片...', 'info');
                
                const formData = new FormData();
                formData.append('media', file);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentDryTeaImageUrl = result.url;
                    updateDryTeaPreview(currentDryTeaImageUrl);
                    showMessage('✅ 图片上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传图片时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            // 清空文件输入
            event.target.value = '';
        }
        
        // 处理开水泡开图片上传
        async function handleBrewedTeaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            try {
                showMessage('正在上传图片...', 'info');
                
                const formData = new FormData();
                formData.append('media', file);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentBrewedTeaImageUrl = result.url;
                    updateBrewedTeaPreview(currentBrewedTeaImageUrl);
                    showMessage('✅ 图片上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传图片时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            // 清空文件输入
            event.target.value = '';
        }
        
        // 删除成品干茶图片
        function deleteDryTeaImage() {
            if (!currentDryTeaImageUrl) {
                showMessage('没有可删除的图片', 'info');
                return;
            }
            
            if (confirm('确定要删除这张图片吗？')) {
                currentDryTeaImageUrl = '';
                updateDryTeaPreview('');
                showMessage('图片已删除，请保存以生效', 'success');
            }
        }
        
        // 删除开水泡开图片
        function deleteBrewedTeaImage() {
            if (!currentBrewedTeaImageUrl) {
                showMessage('没有可删除的图片', 'info');
                return;
            }
            
            if (confirm('确定要删除这张图片吗？')) {
                currentBrewedTeaImageUrl = '';
                updateBrewedTeaPreview('');
                showMessage('图片已删除，请保存以生效', 'success');
            }
        }

        function renderBatchEditHarvestRecords() {
            const countEl = document.getElementById('batch-edit-selected-records-count');
            const previewEl = document.getElementById('batch-edit-selected-records-preview');
            
            countEl.textContent = `已选择: ${batchEditSelectedRecordsData.length} 条`;
            
            if (batchEditSelectedRecordsData.length === 0) {
                previewEl.innerHTML = '<p style="color: #999; text-align: center;">暂无关联记录</p>';
                return;
            }
            
            previewEl.innerHTML = batchEditSelectedRecordsData.map(record => {
                // 兼容处理日期和重量字段
                const harvestDateRaw = record.harvest_date || record.harvestDate || null;
                const date = harvestDateRaw ? new Date(harvestDateRaw).toLocaleDateString('zh-CN') : '未记录';
                const weight = record.fresh_leaf_weight_kg || record.freshLeafWeightKg || 0;
                const recordId = record.id || record._id || '';
                const weatherIcon = record.weather?.icon || '';
                const temperatureRange = record.weather?.temperature_range || record.weather?.temperatureRange || '';
                
                return `
                    <div class="readonly-list-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${date}</strong>
                            <span>重量: ${weight}kg | 天气: ${getWeatherHTML(weatherIcon)} ${temperatureRange}</span>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeBatchEditRecord('${recordId}')">移除</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeBatchEditRecord(recordId) {
            batchEditSelectedRecordIds = batchEditSelectedRecordIds.filter(id => id !== recordId);
            batchEditSelectedRecordsData = batchEditSelectedRecordsData.filter(r => {
                const rId = r.id || r._id || '';
                return rId !== recordId;
            });
            renderBatchEditHarvestRecords();
        }
        
        async function openBatchEditHarvestSelector() {
            try {
                showMessage('正在加载采摘记录...', 'info');
                
                // 获取所有采摘记录（包括已分配和未分配的）
                const response = await fetch('/api/harvest-records');
                const result = await response.json();
                
                if (result.success) {
                    const allRecords = result.data || [];
                    // 显示所有记录供选择
                    renderBatchEditRecordSelector(allRecords);
                    document.getElementById('harvest-selector-modal').style.display = 'block';
                } else {
                    showMessage('加载采摘记录失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('加载采摘记录时出错:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }
        
        function renderBatchEditRecordSelector(records) {
            const container = document.getElementById('unassigned-records-container');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">暂无可用的采摘记录</p>';
                return;
            }
            
            container.innerHTML = records.map(record => {
                // 兼容处理字段名
                const normalizedRecord = normalizeHarvestRecord(record);
                
                // 处理日期：兼容多种格式
                let date = '未记录';
                const harvestDateRaw = normalizedRecord.harvest_date || normalizedRecord.harvestDate || null;
                if (harvestDateRaw) {
                    try {
                        // 如果已经是 Date 对象，直接使用；否则尝试转换
                        const dateObj = harvestDateRaw instanceof Date ? harvestDateRaw : new Date(harvestDateRaw);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        console.warn('日期解析失败:', harvestDateRaw, e);
                    }
                }
                
                // 处理重量：兼容多种字段名和格式
                let weight = 0;
                const weightValue = normalizedRecord.fresh_leaf_weight_kg ?? 
                                   normalizedRecord.freshLeafWeightKg ?? 
                                   normalizedRecord.weight ?? 
                                   0;
                if (typeof weightValue === 'number') {
                    weight = weightValue;
                } else if (typeof weightValue === 'string') {
                    weight = parseFloat(weightValue) || 0;
                }
                
                const recordId = normalizedRecord.id || normalizedRecord._id || '';
                const isSelected = batchEditSelectedRecordIds.includes(recordId);
                const assignedBatchId = normalizedRecord.assigned_batch_id || normalizedRecord.assignedBatchId || null;
                const isAssigned = assignedBatchId && assignedBatchId !== currentEditingBatchId;
                const weatherIcon = normalizedRecord.weather?.icon || '';
                const temperatureRange = normalizedRecord.weather?.temperature_range || normalizedRecord.weather?.temperatureRange || '';
                
                // 处理团队信息
                const teamLeader = normalizedRecord.harvest_team?.leader_name || 
                                  normalizedRecord.harvestTeam?.leader_name ||
                                  normalizedRecord.harvest_team?.leaderName ||
                                  normalizedRecord.harvestTeam?.leaderName ||
                                  '未记录';
                const teamCount = normalizedRecord.harvest_team?.member_count || 
                                normalizedRecord.harvestTeam?.member_count ||
                                normalizedRecord.harvest_team?.memberCount ||
                                normalizedRecord.harvestTeam?.memberCount ||
                                0;
                const teamInfo = teamCount > 0 ? `${teamLeader}(${teamCount}人)` : teamLeader;
                
                return `
                    <div class="record-item ${isSelected ? 'selected' : ''}" style="${isAssigned ? 'opacity: 0.5;' : ''}">
                        <div class="record-item-info">
                            <h4>${date} ${isAssigned ? '（已分配给其他批次）' : ''}</h4>
                            <p>重量: ${weight}kg | 天气: ${getWeatherHTML(weatherIcon)} ${temperatureRange} | 团队: ${teamInfo}</p>
                            ${normalizedRecord.location_info?.garden_area ? `<p>产地: ${normalizedRecord.location_info.garden_area}</p>` : ''}
                        </div>
                        <div class="record-item-actions">
                            ${isSelected ? 
                                `<button class="btn btn-danger btn-small" onclick="toggleBatchEditRecord('${recordId}', false)">取消选择</button>` :
                                `<button class="btn btn-success btn-small" onclick="toggleBatchEditRecord('${recordId}', true)" ${isAssigned ? 'disabled' : ''}>选择</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleBatchEditRecord(recordId, select) {
            if (select) {
                if (!batchEditSelectedRecordIds.includes(recordId)) {
                    const record = allHarvestRecords.find(r => {
                        const rId = r.id || r._id || '';
                        return rId === recordId;
                    });
                    if (record) {
                        batchEditSelectedRecordIds.push(recordId);
                        batchEditSelectedRecordsData.push(record);
                    }
                }
            } else {
                batchEditSelectedRecordIds = batchEditSelectedRecordIds.filter(id => id !== recordId);
                batchEditSelectedRecordsData = batchEditSelectedRecordsData.filter(r => {
                    const rId = r.id || r._id || '';
                    return rId !== recordId;
                });
            }
            
            // 自动填充生产日期（如果有选中的记录）
            if (batchEditSelectedRecordsData.length > 0) {
                autoFillBatchEditProductionDate();
                
                // 🌟 新功能：根据第一个采摘记录的日期自动选择茶叶品类
                // 按日期排序，以最早的日期为准
                const sortedRecords = [...batchEditSelectedRecordsData].sort((a, b) => new Date(a.harvest_date) - new Date(b.harvest_date));
                autoSelectCategoryFromRecords(sortedRecords, 'batch-edit-category');
            }
            
            // 重新渲染选择器
            const response = fetch('/api/harvest-records')
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        renderBatchEditRecordSelector(result.data || []);
                    }
                });
            
            // 重新渲染编辑区的采摘记录列表
            renderBatchEditHarvestRecords();
        }
        
        // ==================== 批次封面管理函数 ====================
        
        /**
         * 处理批次封面上传
         */
        async function handleBatchCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/avif', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('❌ 只支持 JPG、PNG、WebP、AVIF、GIF 格式的图片', 'error');
                event.target.value = ''; // 清空文件选择
                return;
            }
            
            // 验证文件大小（5MB）
            if (file.size > 5 * 1024 * 1024) {
                showMessage('❌ 图片文件不能超过 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                // 显示上传进度
                document.getElementById('batch-cover-upload-progress').style.display = 'block';
                document.getElementById('batch-cover-progress-bar').style.width = '30%';
                
                // 上传到服务器
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                document.getElementById('batch-cover-progress-bar').style.width = '70%';
                
                const result = await response.json();
                
                if (result.success) {
                    // 上传成功，更新预览
                    currentBatchCoverUrl = result.data.url;
                    updateBatchCoverPreview(currentBatchCoverUrl);
                    
                    document.getElementById('batch-cover-progress-bar').style.width = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('batch-cover-upload-progress').style.display = 'none';
                        document.getElementById('batch-cover-progress-bar').style.width = '0%';
                    }, 500);
                    
                    showMessage('✅ 封面上传成功！记得点击"保存批次信息"按钮保存更改', 'success');
                } else {
                    throw new Error(result.message || '上传失败');
                }
                
            } catch (error) {
                console.error('上传封面时出错:', error);
                showMessage('❌ 上传失败: ' + error.message, 'error');
                document.getElementById('batch-cover-upload-progress').style.display = 'none';
                document.getElementById('batch-cover-progress-bar').style.width = '0%';
            }
            
            // 清空文件选择，允许重复上传同一文件
            event.target.value = '';
        }
        
        /**
         * 删除批次封面
         */
        function deleteBatchCover() {
            if (!confirm('确定要删除批次封面吗？')) {
                return;
            }
            
            currentBatchCoverUrl = '';
            updateBatchCoverPreview('');
            showMessage('✅ 封面已删除！记得点击"保存批次信息"按钮保存更改', 'success');
        }
        
        /**
         * 更新封面预览显示
         */
        function updateBatchCoverPreview(url) {
            const previewImg = document.getElementById('batch-cover-preview');
            const placeholder = document.getElementById('batch-cover-placeholder');
            const deleteBtn = document.getElementById('batch-cover-delete-btn');
            
            if (url && url.trim() !== '') {
                // 有封面图片
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                // 无封面图片
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                deleteBtn.style.display = 'none';
            }
        }
        
        // ==================== 详情页封面管理函数 ====================
        
        /**
         * 处理详情页封面上传
         */
        async function handleDetailCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/avif', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('❌ 只支持 JPG、PNG、WebP、AVIF、GIF 格式的图片', 'error');
                event.target.value = ''; // 清空文件选择
                return;
            }
            
            // 验证文件大小（5MB）
            if (file.size > 5 * 1024 * 1024) {
                showMessage('❌ 图片文件不能超过 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                // 显示上传进度
                document.getElementById('detail-cover-upload-progress').style.display = 'block';
                document.getElementById('detail-cover-progress-bar').style.width = '30%';
                
                // 上传到服务器
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                document.getElementById('detail-cover-progress-bar').style.width = '70%';
                
                const result = await response.json();
                
                if (result.success) {
                    // 上传成功，更新预览
                    currentDetailCoverUrl = result.data.url;
                    updateDetailCoverPreview(currentDetailCoverUrl);
                    
                    document.getElementById('detail-cover-progress-bar').style.width = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('detail-cover-upload-progress').style.display = 'none';
                        document.getElementById('detail-cover-progress-bar').style.width = '0%';
                    }, 500);
                    
                    showMessage('✅ 详情页封面上传成功！记得点击"保存批次信息"按钮保存更改', 'success');
                } else {
                    throw new Error(result.message || '上传失败');
                }
                
            } catch (error) {
                console.error('上传详情页封面时出错:', error);
                showMessage('❌ 上传失败: ' + error.message, 'error');
                document.getElementById('detail-cover-upload-progress').style.display = 'none';
                document.getElementById('detail-cover-progress-bar').style.width = '0%';
            }
            
            // 清空文件选择，允许重复上传同一文件
            event.target.value = '';
        }
        
        /**
         * 删除详情页封面
         */
        function deleteDetailCover() {
            if (!confirm('确定要删除详情页封面吗？')) {
                return;
            }
            
            currentDetailCoverUrl = '';
            updateDetailCoverPreview('');
            showMessage('✅ 详情页封面已删除！记得点击"保存批次信息"按钮保存更改', 'success');
        }
        
        /**
         * 更新详情页封面预览显示
         */
        function updateDetailCoverPreview(url) {
            const previewImg = document.getElementById('detail-cover-preview');
            const placeholder = document.getElementById('detail-cover-placeholder');
            const deleteBtn = document.getElementById('detail-cover-delete-btn');
            
            if (url && url.trim() !== '') {
                // 有封面图片
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                // 无封面图片
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                deleteBtn.style.display = 'none';
            }
        }
        
        // ==================== 新增批次图片处理函数 ====================
        
        // 批次封面上传
        async function handleNewBatchCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('❌ 只支持 JPG、PNG、WebP、GIF 格式的图片', 'error');
                event.target.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('❌ 图片文件不能超过 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                showMessage('正在上传...', 'info');
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    newBatchCoverUrl = result.data.url;
                    updateNewBatchCoverPreview(newBatchCoverUrl);
                    showMessage('✅ 批次封面上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传封面时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            event.target.value = '';
        }
        
        function updateNewBatchCoverPreview(url) {
            const previewImg = document.getElementById('new-batch-cover-preview');
            const placeholder = document.getElementById('new-batch-cover-placeholder');
            const deleteBtn = document.getElementById('new-batch-cover-delete-btn');
            
            if (url && url.trim() !== '') {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                deleteBtn.style.display = 'none';
            }
        }
        
        function deleteNewBatchCover() {
            if (!confirm('确定要删除批次封面吗？')) {
                return;
            }
            newBatchCoverUrl = '';
            updateNewBatchCoverPreview('');
            showMessage('✅ 封面已删除', 'success');
        }
        
        // 详情页封面上传
        async function handleNewDetailCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('❌ 只支持 JPG、PNG、WebP、GIF 格式的图片', 'error');
                event.target.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('❌ 图片文件不能超过 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                showMessage('正在上传...', 'info');
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    newDetailCoverUrl = result.data.url;
                    updateNewDetailCoverPreview(newDetailCoverUrl);
                    showMessage('✅ 详情页封面上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传封面时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            event.target.value = '';
        }
        
        function updateNewDetailCoverPreview(url) {
            const previewImg = document.getElementById('new-detail-cover-preview');
            const placeholder = document.getElementById('new-detail-cover-placeholder');
            const deleteBtn = document.getElementById('new-detail-cover-delete-btn');
            
            if (url && url.trim() !== '') {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                deleteBtn.style.display = 'none';
            }
        }
        
        function deleteNewDetailCover() {
            if (!confirm('确定要删除详情页封面吗？')) {
                return;
            }
            newDetailCoverUrl = '';
            updateNewDetailCoverPreview('');
            showMessage('✅ 封面已删除', 'success');
        }
        
        // 成品干茶图片上传
        async function handleNewDryTeaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            try {
                showMessage('正在上传图片...', 'info');
                const formData = new FormData();
                formData.append('media', file);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    newDryTeaImageUrl = result.url;
                    updateNewDryTeaPreview(newDryTeaImageUrl);
                    showMessage('✅ 图片上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传图片时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            event.target.value = '';
        }
        
        function updateNewDryTeaPreview(url) {
            const previewImg = document.getElementById('new-dry-tea-preview');
            const placeholder = document.getElementById('new-dry-tea-placeholder');
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        function deleteNewDryTeaImage() {
            if (!confirm('确定要删除成品干茶图片吗？')) {
                return;
            }
            newDryTeaImageUrl = '';
            updateNewDryTeaPreview('');
            showMessage('✅ 图片已删除', 'success');
        }
        
        // 开水泡开图片上传
        async function handleNewBrewedTeaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            try {
                showMessage('正在上传图片...', 'info');
                const formData = new FormData();
                formData.append('media', file);
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    newBrewedTeaImageUrl = result.url;
                    updateNewBrewedTeaPreview(newBrewedTeaImageUrl);
                    showMessage('✅ 图片上传成功', 'success');
                } else {
                    showMessage('❌ 上传失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('上传图片时出错:', error);
                showMessage('❌ 上传失败：' + error.message, 'error');
            }
            
            event.target.value = '';
        }
        
        function updateNewBrewedTeaPreview(url) {
            const previewImg = document.getElementById('new-brewed-tea-preview');
            const placeholder = document.getElementById('new-brewed-tea-placeholder');
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        function deleteNewBrewedTeaImage() {
            if (!confirm('确定要删除开水泡开图片吗？')) {
                return;
            }
            newBrewedTeaImageUrl = '';
            updateNewBrewedTeaPreview('');
            showMessage('✅ 图片已删除', 'success');
        }
        
        // ==================== 批次编辑相关函数 ====================

        function closeBatchEdit() {
            document.getElementById('batch-edit-form-container').classList.add('hidden');
            document.getElementById('default-view').classList.remove('hidden');
            currentEditingBatchId = null;
            currentBatchCoverUrl = ''; // 清空批次封面URL
            currentDetailCoverUrl = ''; // 清空详情页封面URL
            currentDryTeaImageUrl = ''; // 清空成品干茶图片URL
            currentBrewedTeaImageUrl = ''; // 清空开水泡开图片URL
        }

        async function saveBatchInfo() {
            try {
                if (!confirm('确定要保存批次信息吗？')) {
                    return;
                }
                
                const batchId = document.getElementById('batch-edit-id').value;
                const batchNumber = document.getElementById('batch-edit-number').value.trim();
                
                // 验证必填字段
                if (!batchNumber) {
                    showMessage('❌ 批次号不能为空', 'error');
                    return;
                }
                
                const batchData = {
                    batch_number: batchNumber,
                    category_name: document.getElementById('batch-edit-category').value.trim(),
                    production_date: document.getElementById('batch-edit-production-date').value,
                    cover_image_url: currentBatchCoverUrl, // 批次封面URL
                    detail_cover_image_url: currentDetailCoverUrl, // 详情页封面URL
                    tea_master: {
                        name: document.getElementById('batch-edit-tea-master-name').value.trim(),
                        experience_years: parseInt(document.getElementById('batch-edit-tea-master-experience').value) || 0,
                        specialty: document.getElementById('batch-edit-tea-master-specialty').value.trim()
                    },
                    final_product_weight_kg: parseFloat(document.getElementById('batch-edit-final-product-weight').value) || 0,
                    grade: document.getElementById('batch-edit-grade').value,
                    notes: document.getElementById('batch-edit-notes').value.trim(),
                    detail_title: document.getElementById('batch-detail-title').value.trim(),
                    harvest_records_ids: batchEditSelectedRecordIds,
                    product_appreciation: {
                        dry_tea_image: currentDryTeaImageUrl,
                        brewed_tea_image: currentBrewedTeaImageUrl,
                        tasting_notes: document.getElementById('tasting-notes').value.trim(),
                        brewing_suggestion: document.getElementById('brewing-suggestion').value.trim(),
                        storage_method: document.getElementById('storage-method').value.trim()
                    }
                };
                
                showMessage('正在保存...', 'info');
                
                const response = await fetch(`/api/batches/${batchId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(batchData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ 批次信息保存成功！', 'success');
                    await loadBatches();
                    await loadHarvestRecords();
                } else {
                    showMessage('❌ 保存失败：' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('保存批次信息时出错:', error);
                showMessage('❌ 保存失败：' + error.message, 'error');
            }
        }

        async function deleteBatchFromEdit() {
            if (!confirm('确定要删除这个制作批次吗？此操作不可撤销！')) {
                return;
            }
            
            try {
                const batchId = document.getElementById('batch-edit-id').value;
                
                const response = await fetch(`/api/batches/${batchId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ 制作批次已删除', 'success');
                    closeBatchEdit();
                    await loadBatches();
                    await loadHarvestRecords();
                } else {
                    showMessage('❌ 删除失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('删除制作批次时出错:', error);
                showMessage('❌ 删除失败：' + error.message, 'error');
            }
        }

        // ==================== 制作编辑（新版：10个独立画廊 + 模板预填充） ====================
        async function editProduction(batchId) {
            try {
                showMessage('正在加载制作步骤...', 'info');
                
                const response = await fetch(`/api/batches/${batchId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('加载制作步骤失败: ' + result.message, 'error');
                    return;
                }
                
                const batch = result.data;
                currentEditingBatchId = batchId;
                
                // 隐藏所有其他视图
                document.getElementById('default-view').classList.add('hidden');
                document.getElementById('new-batch-view').classList.add('hidden');
                document.getElementById('batch-edit-form-container').classList.add('hidden');
                // 显示制作编辑视图
                document.getElementById('production-edit-form-container').classList.remove('hidden');
                
                // 保存批次ID
                document.getElementById('production-edit-batch-id').value = batch._id;
                
                // 🎯 始终加载模板缓存（用于工艺类型切换时的自动填充）
                await loadTemplateCache();
                
                // 判断是否需要加载模板
                const needsTemplate = await checkIfNeedsTemplate(batch.production_steps);
                
                if (needsTemplate) {
                    // 加载模板并填充
                    await loadProductionStepsWithTemplate();
                    showMessage(`制作步骤已加载（批次：${batch.batch_number}，使用默认模板）`, 'success');
                } else {
                    // 加载已有数据
                    loadProductionStepsToGalleries(batch.production_steps);
                    showMessage(`制作步骤已加载（批次：${batch.batch_number}）`, 'success');
                }
                
            } catch (error) {
                console.error('加载制作步骤时出错:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }

        /**
         * 检查批次是否需要加载模板
         * 如果 production_steps 为空或所有步骤的工艺类型都是 'none' 且文案都为空，则需要加载模板
         */
        async function checkIfNeedsTemplate(steps) {
            if (!steps || steps.length === 0) {
                return true;
            }
            
            // 检查是否所有步骤都是 'none' 且文案为空
            const allEmpty = steps.every(step => {
                // 新架构：检查 craft_type
                if (step.craft_type) {
                    // 如果明确设置了工艺类型，则不需要模板
                    // 即使是 'none'，也说明用户已经做了选择
                    return false;
                }
                
                // 兼容旧架构：检查 manual_craft 和 modern_craft
                const manualEmpty = !step.manual_craft || 
                    (!step.manual_craft.purpose && !step.manual_craft.method && 
                     !step.manual_craft.sensory_change && !step.manual_craft.value);
                const modernEmpty = !step.modern_craft || 
                    (!step.modern_craft.purpose && !step.modern_craft.method && 
                     !step.modern_craft.sensory_change && !step.modern_craft.value);
                
                return manualEmpty && modernEmpty;
            });
            
            return allEmpty;
        }

        /**
         * 仅加载模板缓存（不填充表单）
         * 用于支持工艺类型切换时的自动填充功能
         */
        async function loadTemplateCache() {
            try {
                const response = await fetch('/api/step-templates');
                const result = await response.json();
                
                if (!result.success) {
                    console.warn('加载模板缓存失败:', result.message);
                    return;
                }
                
                const templates = result.data || [];
                stepTemplatesCache = {};
                
                // 缓存所有步骤的模板数据（兼容 stepName/step_name 和 manualCraft/manual_craft 字段名）
                const stepNames = ['摊晾', '杀青', '揉捻', '干燥', '分拣'];
                templates.forEach(template => {
                    // 兼容 stepName 和 step_name 两种字段名
                    const templateStepName = template.stepName || template.step_name;
                    const stepIndex = stepNames.indexOf(templateStepName);
                    if (stepIndex !== -1) {
                        // 兼容 manualCraft/manual_craft 和 modernCraft/modern_craft 字段名
                        stepTemplatesCache[stepIndex] = {
                            manual_craft: template.manualCraft || template.manual_craft || { purpose: '', method: '', sensory_change: '', value: '' },
                            modern_craft: template.modernCraft || template.modern_craft || { purpose: '', method: '', sensory_change: '', value: '' }
                        };
                    }
                });
                
                console.log('✅ 模板缓存已加载，支持工艺类型自动填充');
                
            } catch (error) {
                console.warn('加载模板缓存时出错:', error);
            }
        }

        /**
         * 加载制作步骤模板（新架构）
         */
        async function loadProductionStepsWithTemplate() {
            try {
                const response = await fetch('/api/step-templates');
                const result = await response.json();
                
                if (!result.success) {
                    console.error('加载模板失败:', result.message);
                    // 如果模板加载失败，仍然显示空表单
                    clearAllStepForms();
                    return;
                }
                
                const templates = result.data || [];
                
                // 检查是否有模板数据
                if (!templates || templates.length === 0) {
                    console.warn('⚠️ 未找到有效步骤模板，API返回的模板列表为空');
                    showMessage('⚠️ 未找到有效步骤模板，请先在"制作步骤模板"页面创建模板', 'warning');
                    clearAllStepForms();
                    return;
                }
                
                // 清空缓存和表单
                stepTemplatesCache = {};
                clearAllStepForms();
                
                // 按顺序填充模板数据（摊晾、杀青、揉捻、干燥、分拣）
                const stepNames = ['摊晾', '杀青', '揉捻', '干燥', '分拣'];
                let loadedCount = 0;
                templates.forEach(template => {
                    // 兼容 stepName 和 step_name 两种字段名
                    const templateStepName = template.stepName || template.step_name;
                    const stepIndex = stepNames.indexOf(templateStepName);
                    if (stepIndex !== -1) {
                        loadedCount++;
                        // 缓存模板数据（兼容 manualCraft/manual_craft 和 modernCraft/modern_craft 两种字段名）
                        const manualCraft = template.manualCraft || template.manual_craft || { purpose: '', method: '', sensory_change: '', value: '' };
                        const modernCraft = template.modernCraft || template.modern_craft || { purpose: '', method: '', sensory_change: '', value: '' };
                        
                        stepTemplatesCache[stepIndex] = {
                            manual_craft: manualCraft,
                            modern_craft: modernCraft
                        };
                        
                        // 判断模板使用哪种工艺类型
                        // 优先使用 craft_type 字段（新架构）
                        let craftType = template.craft_type || template.craftType || 'none';
                        let craftDetails = template.craft_details || template.craftDetails || null;
                        
                        // 兼容旧模板：如果没有 craft_type，检查是否有手工或现代工艺数据
                        if (craftType === 'none') {
                            if (manualCraft && (manualCraft.purpose || manualCraft.method)) {
                                craftType = 'manual';
                                craftDetails = manualCraft;
                            } else if (modernCraft && (modernCraft.purpose || modernCraft.method)) {
                                craftType = 'modern';
                                craftDetails = modernCraft;
                            }
                        }
                        
                        // 设置工艺类型
                        stepMediaGalleries[stepIndex].craftType = craftType;
                        
                        // 选中对应的单选按钮
                        document.querySelector(`input[name="step${stepIndex}-craft-type"][value="${craftType}"]`).checked = true;
                        
                        // 如果有工艺数据，填充文案
                        if (craftType !== 'none' && craftDetails) {
                            // 显示内容编辑区
                            document.getElementById(`step${stepIndex}-craft-content`).style.display = 'block';
                            
                            // 填充文案（不包含媒体，媒体需要用户自己上传）
                            document.getElementById(`step${stepIndex}-purpose`).value = craftDetails.purpose || '';
                            document.getElementById(`step${stepIndex}-method`).value = craftDetails.method || '';
                            document.getElementById(`step${stepIndex}-sensory-change`).value = craftDetails.sensory_change || '';
                            document.getElementById(`step${stepIndex}-value`).value = craftDetails.value || '';
                        }
                    }
                });
                
                // 检查是否成功加载了模板
                if (loadedCount === 0) {
                    console.warn('⚠️ 未找到有效步骤模板，模板数据与步骤名称不匹配');
                    showMessage('⚠️ 未找到有效步骤模板，请检查模板中的步骤名称是否正确（应为：摊晾、杀青、揉捻、干燥、分拣）', 'warning');
                } else {
                    console.log(`✅ 已加载 ${loadedCount} 个步骤模板到表单（新架构）`);
                }
                
            } catch (error) {
                console.error('加载模板时出错:', error);
                showMessage('❌ 加载制作步骤模板失败: ' + error.message, 'error');
                // 如果出错，仍然显示空表单
                clearAllStepForms();
            }
        }

        /**
         * 清空所有步骤表单（新架构）
         */
        function clearAllStepForms() {
            for (let i = 0; i <= 4; i++) {
                stepMediaGalleries[i] = { craftType: 'none', mediaUrls: [] };
                
                // 重置工艺类型单选按钮为"无"
                document.querySelector(`input[name="step${i}-craft-type"][value="none"]`).checked = true;
                
                // 隐藏内容编辑区
                document.getElementById(`step${i}-craft-content`).style.display = 'none';
                
                // 清空画廊
                document.getElementById(`step${i}-gallery`).innerHTML = '';
                
                // 清空文案字段
                document.getElementById(`step${i}-purpose`).value = '';
                document.getElementById(`step${i}-method`).value = '';
                document.getElementById(`step${i}-sensory-change`).value = '';
                document.getElementById(`step${i}-value`).value = '';
            }
        }
        
        /**
         * 处理工艺类型选择变化（新架构）
         * 当切换工艺类型时，自动填充对应的模板文案
         */
        async function handleCraftTypeChange(stepIndex) {
            const selectedType = document.querySelector(`input[name="step${stepIndex}-craft-type"]:checked`).value;
            stepMediaGalleries[stepIndex].craftType = selectedType;
            
            const contentDiv = document.getElementById(`step${stepIndex}-craft-content`);
            
            if (selectedType === 'none') {
                // 隐藏内容编辑区
                contentDiv.style.display = 'none';
                // 清空数据
                stepMediaGalleries[stepIndex].mediaUrls = [];
                document.getElementById(`step${stepIndex}-gallery`).innerHTML = '';
                document.getElementById(`step${stepIndex}-purpose`).value = '';
                document.getElementById(`step${stepIndex}-method`).value = '';
                document.getElementById(`step${stepIndex}-sensory-change`).value = '';
                document.getElementById(`step${stepIndex}-value`).value = '';
            } else {
                // 显示内容编辑区
                contentDiv.style.display = 'block';
                
                // 🎯 核心功能：从模板缓存或API中自动填充对应工艺类型的文案
                let templateData = null;
                
                // 先尝试从缓存中获取
                if (stepTemplatesCache[stepIndex]) {
                    if (selectedType === 'manual') {
                        templateData = stepTemplatesCache[stepIndex].manual_craft;
                    } else if (selectedType === 'modern') {
                        templateData = stepTemplatesCache[stepIndex].modern_craft;
                    }
                }
                
                // 如果缓存中没有数据，调用API获取
                if (!templateData || (!templateData.purpose && !templateData.method && !templateData.sensory_change && !templateData.value)) {
                    try {
                        const stepNames = ['摊晾', '杀青', '揉捻', '干燥', '分拣'];
                        const stepName = stepNames[stepIndex];
                        
                        // 调用API获取制作步骤模板
                        const response = await fetch('/api/step-templates');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            // 查找对应步骤的模板（兼容 stepName 和 step_name 两种字段名）
                            const template = result.data.find(t => 
                                (t.stepName === stepName || t.step_name === stepName)
                            );
                            
                            if (template) {
                                // 更新缓存（兼容 manualCraft/manual_craft 和 modernCraft/modern_craft 两种字段名）
                                if (!stepTemplatesCache[stepIndex]) {
                                    stepTemplatesCache[stepIndex] = {};
                                }
                                const manualCraft = template.manualCraft || template.manual_craft || { purpose: '', method: '', sensory_change: '', value: '' };
                                const modernCraft = template.modernCraft || template.modern_craft || { purpose: '', method: '', sensory_change: '', value: '' };
                                
                                stepTemplatesCache[stepIndex].manual_craft = manualCraft;
                                stepTemplatesCache[stepIndex].modern_craft = modernCraft;
                                
                                // 根据当前选中的radio按钮值（selectedType）获取对应工艺类型的数据
                                if (selectedType === 'manual') {
                                    templateData = manualCraft;
                                } else if (selectedType === 'modern') {
                                    templateData = modernCraft;
                                }
                                
                                console.log(`✅ 已从API加载步骤 ${stepIndex} (${stepName}) 的${selectedType === 'manual' ? '手工匠心' : '现代工艺'}模板`);
                            } else {
                                console.warn(`⚠️ 未找到步骤 ${stepIndex} (${stepName}) 的模板`);
                            }
                        }
                    } catch (error) {
                        console.error('加载制作步骤模板失败:', error);
                    }
                }
                
                // 自动填充文案（如果模板有数据）
                if (templateData) {
                    document.getElementById(`step${stepIndex}-purpose`).value = templateData.purpose || '';
                    document.getElementById(`step${stepIndex}-method`).value = templateData.method || '';
                    document.getElementById(`step${stepIndex}-sensory-change`).value = templateData.sensory_change || '';
                    document.getElementById(`step${stepIndex}-value`).value = templateData.value || '';
                    
                    console.log(`✅ 已自动填充步骤 ${stepIndex} 的${selectedType === 'manual' ? '手工匠心' : '现代工艺'}模板文案`);
                } else {
                    console.warn(`⚠️ 未找到步骤 ${stepIndex} 的${selectedType === 'manual' ? '手工匠心' : '现代工艺'}模板数据`);
                }
            }
        }

        /**
         * 将已保存的步骤数据加载到表单（新架构）
         */
        function loadProductionStepsToGalleries(steps) {
            // 清空所有画廊和文案
            clearAllStepForms();
            
            if (!steps || steps.length === 0) {
                return;
            }
            
            // 填充已有的步骤数据（新架构）
            steps.forEach((step, index) => {
                if (index >= 0 && index <= 4) {
                    // 读取工艺类型
                    const craftType = step.craft_type || 'none';
                    stepMediaGalleries[index].craftType = craftType;
                    
                    // 选中对应的工艺类型单选按钮
                    document.querySelector(`input[name="step${index}-craft-type"][value="${craftType}"]`).checked = true;
                    
                    // 如果不是"无"，加载媒体和文案
                    if (craftType !== 'none' && step.craft_details) {
                        // 显示内容编辑区
                        document.getElementById(`step${index}-craft-content`).style.display = 'block';
                        
                        // 加载媒体
                        if (step.craft_details.media_urls) {
                            stepMediaGalleries[index].mediaUrls = [...step.craft_details.media_urls];
                        }
                        
                        // 加载文案
                        document.getElementById(`step${index}-purpose`).value = step.craft_details.purpose || '';
                        document.getElementById(`step${index}-method`).value = step.craft_details.method || '';
                        document.getElementById(`step${index}-sensory-change`).value = step.craft_details.sensory_change || '';
                        document.getElementById(`step${index}-value`).value = step.craft_details.value || '';
                        
                        // 渲染画廊
                        renderStepGallery(index);
                    }
                }
            });
        }

        /**
         * 渲染步骤画廊（新架构）
         */
        function renderStepGallery(stepIndex) {
            const galleryId = `step${stepIndex}-gallery`;
            const gallery = document.getElementById(galleryId);
            const mediaUrls = stepMediaGalleries[stepIndex].mediaUrls;
            
            if (!mediaUrls || mediaUrls.length === 0) {
                gallery.innerHTML = '<p style="color: #999; text-align: center; grid-column: 1 / -1;">暂无媒体文件</p>';
                return;
            }
            
            gallery.innerHTML = mediaUrls.map((url, idx) => {
                const isVideo = url.match(/\.(mp4|webm|ogg|mov)$/i);
                return `
                    <div style="position: relative; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
                        ${isVideo ? 
                            `<video src="${url}" style="width: 100%; height: 150px; object-fit: cover;" controls></video>` :
                            `<img src="${url}" style="width: 100%; height: 150px; object-fit: cover;" alt="预览">`
                        }
                        <button onclick="removeStepMedia(${stepIndex}, ${idx})" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
                    </div>
                `;
            }).join('');
        }

        /**
         * 处理步骤媒体上传（新架构）
         */
        async function handleStepMediaUpload(stepIndex, event) {
            const files = event.target.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            const currentCount = stepMediaGalleries[stepIndex].mediaUrls.length;
            if (currentCount + files.length > 20) {
                showMessage('每个画廊最多20个文件', 'error');
                event.target.value = '';
                return;
            }
            
            showMessage('正在上传文件...', 'info');
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (file.size > 50 * 1024 * 1024) {
                        showMessage(`文件 ${file.name} 大小超过50MB，已跳过`, 'error');
                        continue;
                    }
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        stepMediaGalleries[stepIndex].mediaUrls.push(result.data.url);
                    } else {
                        throw new Error(result.message || '上传失败');
                    }
                }
                
                renderStepGallery(stepIndex);
                showMessage('文件上传成功', 'success');
                event.target.value = '';
                
            } catch (error) {
                console.error('上传文件时出错:', error);
                showMessage('文件上传失败: ' + error.message, 'error');
            }
        }

        /**
         * 移除步骤媒体（新架构）
         */
        function removeStepMedia(stepIndex, mediaIndex) {
            stepMediaGalleries[stepIndex].mediaUrls.splice(mediaIndex, 1);
            renderStepGallery(stepIndex);
        }

        /**
         * 保存单个制作步骤（新架构）
         */
        async function saveSingleProductionStep(stepIndex) {
            try {
                const batchId = document.getElementById('production-edit-batch-id').value;
                
                if (!batchId) {
                    showMessage('错误：批次ID不存在', 'error');
                    return;
                }
                
                const stepNames = ['摊晾', '杀青', '揉捻', '干燥', '分拣'];
                const stepName = stepNames[stepIndex];
                
                if (!confirm(`确定要保存"${stepName}"步骤吗？`)) {
                    return;
                }
                
                showMessage('正在保存...', 'info');
                
                const craftType = stepMediaGalleries[stepIndex].craftType;
                const mediaUrls = stepMediaGalleries[stepIndex].mediaUrls;
                
                // 收集文案内容
                const purpose = document.getElementById(`step${stepIndex}-purpose`).value.trim();
                const method = document.getElementById(`step${stepIndex}-method`).value.trim();
                const sensoryChange = document.getElementById(`step${stepIndex}-sensory-change`).value.trim();
                const value = document.getElementById(`step${stepIndex}-value`).value.trim();
                
                // 构建此步骤的数据
                const singleStep = {
                    step_name: stepName,
                    step_order: stepIndex + 1,
                    craft_type: craftType,
                    craft_details: {
                        media_urls: mediaUrls,
                        purpose: purpose,
                        method: method,
                        sensory_change: sensoryChange,
                        value: value
                    }
                };
                
                // 获取当前批次的所有步骤数据
                const response = await fetch(`/api/batches/${batchId}`);
                const batchResult = await response.json();
                
                if (!batchResult.success) {
                    throw new Error('获取批次数据失败');
                }
                
                // 更新指定步骤的数据
                let productionSteps = batchResult.data.production_steps || [];
                
                // 如果步骤数组还没有初始化，先创建完整数组
                if (productionSteps.length < 5) {
                    productionSteps = stepNames.map((name, index) => ({
                        step_name: name,
                        step_order: index + 1,
                        craft_type: 'none',
                        craft_details: {
                            media_urls: [],
                            purpose: '',
                            method: '',
                            sensory_change: '',
                            value: ''
                        }
                    }));
                }
                
                // 更新指定的步骤
                productionSteps[stepIndex] = singleStep;
                
                // 发送到服务器
                const updateResponse = await fetch(`/api/batches/${batchId}/production-steps`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ production_steps: productionSteps })
                });
                
                const result = await updateResponse.json();
                
                if (result.success) {
                    showMessage(`✅ "${stepName}"步骤保存成功！`, 'success');
                    
                    // 重新加载批次列表
                    await loadBatches();
                } else {
                    showMessage('❌ 保存失败：' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('保存时出错:', error);
                showMessage('❌ 保存失败：' + error.message, 'error');
            }
        }
        
        /**
         * 保存所有制作步骤（新架构）
         */
        async function saveAllProductionSteps() {
            try {
                const batchId = document.getElementById('production-edit-batch-id').value;
                
                if (!batchId) {
                    showMessage('错误：批次ID不存在', 'error');
                    return;
                }
                
                if (!confirm('确定要保存所有制作步骤吗？')) {
                    return;
                }
                
                showMessage('正在保存...', 'info');
                
                const stepNames = ['摊晾', '杀青', '揉捻', '干燥', '分拣'];
                
                // 构建新的 production_steps 数组
                const productionSteps = stepNames.map((stepName, index) => {
                    const craftType = stepMediaGalleries[index].craftType;
                    const mediaUrls = stepMediaGalleries[index].mediaUrls;
                    
                    // 收集文案内容
                    const purpose = document.getElementById(`step${index}-purpose`).value.trim();
                    const method = document.getElementById(`step${index}-method`).value.trim();
                    const sensoryChange = document.getElementById(`step${index}-sensory-change`).value.trim();
                    const value = document.getElementById(`step${index}-value`).value.trim();
                    
                    return {
                        step_name: stepName,
                        step_order: index + 1,
                        craft_type: craftType,
                        craft_details: {
                            media_urls: mediaUrls,
                            purpose: purpose,
                            method: method,
                            sensory_change: sensoryChange,
                            value: value
                        }
                    };
                });
                
                // 发送到服务器
                const response = await fetch(`/api/batches/${batchId}/production-steps`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ production_steps: productionSteps })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ 所有制作步骤保存成功！', 'success');
                    
                    // 重新加载批次列表
                    await loadBatches();
                } else {
                    showMessage('❌ 保存失败：' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('保存时出错:', error);
                showMessage('❌ 保存失败：' + error.message, 'error');
            }
        }

        /**
         * 关闭制作编辑表单（新架构）
         */
        function closeProductionEdit() {
            document.getElementById('production-edit-form-container').classList.add('hidden');
            document.getElementById('default-view').classList.remove('hidden');
            currentEditingBatchId = null;
            
            // 清空所有画廊数据和文案字段
            clearAllStepForms();
        }


        // ==================== 选择采摘记录功能 ====================
        async function openHarvestRecordSelector() {
            try {
                showMessage('正在加载未归属的采摘记录...', 'info');
                
                const response = await fetch('/api/harvest-records/unassigned');
                const result = await response.json();
                
                if (result.success) {
                    const unassignedRecords = result.data || [];
                    renderUnassignedRecords(unassignedRecords);
                    document.getElementById('harvest-selector-modal').style.display = 'block';
                } else {
                    showMessage('加载未归属记录失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('加载未归属记录时出错:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }

        function renderUnassignedRecords(records) {
            const container = document.getElementById('unassigned-records-container');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">暂无未归属的采摘记录</p>';
                return;
            }
            
            container.innerHTML = records.map(record => {
                // 兼容处理字段名
                const normalizedRecord = normalizeHarvestRecord(record);
                
                // 处理日期：兼容多种格式
                let date = '未记录';
                const harvestDateRaw = normalizedRecord.harvest_date || normalizedRecord.harvestDate || null;
                if (harvestDateRaw) {
                    try {
                        // 如果已经是 Date 对象，直接使用；否则尝试转换
                        const dateObj = harvestDateRaw instanceof Date ? harvestDateRaw : new Date(harvestDateRaw);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        console.warn('日期解析失败:', harvestDateRaw, e);
                    }
                }
                
                // 处理重量：兼容多种字段名和格式
                let weight = 0;
                const weightValue = normalizedRecord.fresh_leaf_weight_kg ?? 
                                   normalizedRecord.freshLeafWeightKg ?? 
                                   normalizedRecord.weight ?? 
                                   0;
                if (typeof weightValue === 'number') {
                    weight = weightValue;
                } else if (typeof weightValue === 'string') {
                    weight = parseFloat(weightValue) || 0;
                }
                
                // 处理团队信息
                const teamLeader = normalizedRecord.harvest_team?.leader_name || 
                                  normalizedRecord.harvestTeam?.leader_name ||
                                  normalizedRecord.harvest_team?.leaderName ||
                                  normalizedRecord.harvestTeam?.leaderName ||
                                  '未记录';
                const teamCount = normalizedRecord.harvest_team?.member_count || 
                                normalizedRecord.harvestTeam?.member_count ||
                                normalizedRecord.harvest_team?.memberCount ||
                                normalizedRecord.harvestTeam?.memberCount ||
                                0;
                const teamInfo = teamCount > 0 ? `${teamLeader}(${teamCount}人)` : teamLeader;
                
                const recordId = normalizedRecord.id || normalizedRecord._id || '';
                const checked = selectedHarvestRecordIds.includes(recordId) ? 'checked' : '';
                const weatherIcon = normalizedRecord.weather?.icon || '';
                const temperatureRange = normalizedRecord.weather?.temperature_range || normalizedRecord.weather?.temperatureRange || '';
                
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="record-${recordId}" value="${recordId}" ${checked}>
                        <div class="checkbox-item-info">
                            <strong>${date}</strong>
                            <span>重量: ${weight}kg | 天气: ${getWeatherHTML(weatherIcon)} ${temperatureRange} | 团队: ${teamInfo}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function closeHarvestRecordSelector() {
            document.getElementById('harvest-selector-modal').style.display = 'none';
            
            // 如果是在批次编辑模式，更新显示
            const batchEditContainer = document.getElementById('batch-edit-form-container');
            if (batchEditContainer && !batchEditContainer.classList.contains('hidden')) {
                renderBatchEditHarvestRecords();
            }
        }

        function confirmHarvestRecordSelection() {
            const checkboxes = document.querySelectorAll('#unassigned-records-container input[type="checkbox"]:checked');
            selectedHarvestRecordIds = Array.from(checkboxes).map(cb => cb.value);
            
            selectedHarvestRecordsData = allHarvestRecords.filter(r => selectedHarvestRecordIds.includes(r._id));
            
            // 按日期排序，第一个记录应该是最早的日期
            selectedHarvestRecordsData.sort((a, b) => new Date(a.harvest_date) - new Date(b.harvest_date));
            
            document.getElementById('new-selected-records-count').textContent = `已选择: ${selectedHarvestRecordIds.length} 条`;
            
            if (selectedHarvestRecordIds.length > 0) {
                const previewList = document.getElementById('new-selected-records-list');
                previewList.innerHTML = selectedHarvestRecordsData.map(record => {
                    const date = new Date(record.harvest_date).toLocaleDateString('zh-CN');
                    return `<li>${date} - ${record.fresh_leaf_weight_kg}kg</li>`;
                }).join('');
                document.getElementById('new-selected-records-preview').style.display = 'block';
                
                // 自动填充生产日期（选择最大日期）
                autoFillProductionDate();
                
                // 🌟 新功能：根据第一个采摘记录的日期自动选择茶叶品类
                autoSelectCategoryFromRecords(selectedHarvestRecordsData, 'new-batch-category');
            } else {
                document.getElementById('new-selected-records-preview').style.display = 'none';
            }
            
            closeHarvestRecordSelector();
            showMessage(`已选择 ${selectedHarvestRecordIds.length} 条采摘记录`, 'success');
        }
        
        /**
         * 自动填充生产日期（选择采摘记录中的最大日期）
         */
        function autoFillProductionDate() {
            if (selectedHarvestRecordsData.length === 0) return;
            
            // 找到最大的采摘日期
            let maxDate = null;
            selectedHarvestRecordsData.forEach(record => {
                const date = new Date(record.harvest_date);
                if (!maxDate || date > maxDate) {
                    maxDate = date;
                }
            });
            
            if (maxDate) {
                // 格式化为 YYYY-MM-DD
                const year = maxDate.getFullYear();
                const month = String(maxDate.getMonth() + 1).padStart(2, '0');
                const day = String(maxDate.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                
                document.getElementById('new-production-date').value = formattedDate;
                
                // 如果已经选择了品类，则自动生成批次号
                const category = document.getElementById('new-batch-category').value;
                if (category) {
                    generateBatchNumber();
                }
            }
        }
        
        /**
         * 自动生成批次号
         * 格式：品类 · 批次 缩写-YYYYMMDD
         */
        function generateBatchNumber() {
            const category = document.getElementById('new-batch-category').value;
            const productionDate = document.getElementById('new-production-date').value;
            
            if (!category || !productionDate) {
                return;
            }
            
            // 获取品类英文缩写
            const categoryCode = categoryCodeMap[category] || 'XX';
            
            // 格式化日期为 YYYYMMDD
            const dateStr = productionDate.replace(/-/g, '');
            
            // 生成批次号：品类 · 批次 缩写-日期
            const batchNumber = `${category} · 批次 ${categoryCode}-${dateStr}`;
            
            document.getElementById('new-batch-number').value = batchNumber;
        }
        
        /**
         * 处理生产日期变化，更新批次号
         */
        function handleNewProductionDateChange() {
            const category = document.getElementById('new-batch-category').value;
            if (category) {
                generateBatchNumber();
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('harvest-selector-modal');
            if (event.target == modal) {
                closeHarvestRecordSelector();
            }
        }
    </script>
</body>
</html>